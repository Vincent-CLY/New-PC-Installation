{"created_by":"Tampermonkey","version":"1","scripts":[{"name":"Change YouTube Icon","options":{"check_for_updates":true,"user_modified":null,"comment":null,"compatopts_for_requires":true,"compat_wrappedjsobject":false,"compat_metadata":false,"compat_foreach":false,"compat_powerful_this":null,"sandbox":null,"noframes":null,"unwrap":null,"run_at":null,"run_in":null,"tags":[],"override":{"use_includes":[],"orig_includes":[],"merge_includes":true,"use_matches":[],"orig_matches":["http*://*.youtube.com/*"],"merge_matches":true,"use_excludes":[],"orig_excludes":[],"merge_excludes":true,"use_connects":[],"orig_connects":[],"merge_connects":true,"use_blockers":[],"orig_run_at":"document-idle","orig_noframes":null,"orig_run_in":[],"orig_tags":[]}},"storage":{"ts":1722480799082,"data":{}},"enabled":true,"position":1,"uuid":"c06b88d9-4c32-44cb-adb8-f3f6b3becfed","source":"Ly8gPT1Vc2VyU2NyaXB0PT0KLy8gQG5hbWUgICAgICAgICBDaGFuZ2UgWW91VHViZSBJY29uCi8vIEBuYW1lc3BhY2UgICAgaHR0cDovL3RhbXBlcm1vbmtleS5uZXQvCi8vIEB2ZXJzaW9uICAgICAgMjAyNC0wNy0yNwovLyBAZGVzY3JpcHRpb24gIHRyeSB0byB0YWtlIG92ZXIgdGhlIHdvcmxkIQovLyBAYXV0aG9yICAgICAgIFlvdQovLyBAbWF0Y2ggICAgICAgIGh0dHAqOi8vKi55b3V0dWJlLmNvbS8qCi8vIEBpY29uICAgICAgICAgZGF0YTppbWFnZS9naWY7YmFzZTY0LFIwbEdPRGxoQVFBQkFBQUFBQ0g1QkFFS0FBRUFMQUFBQUFBQkFBRUFBQUlDVEFFQU93PT0KLy8gQGdyYW50ICAgICAgICBub25lCi8vID09L1VzZXJTY3JpcHQ9PQoKKGZ1bmN0aW9uKCkgewogICAgJ3VzZSBzdHJpY3QnOwoKICAgIC8vIEZ1bmN0aW9uIHRvIGNoYW5nZSB0aGUgWW91VHViZSBpY29uCiAgICBmdW5jdGlvbiBjaGFuZ2VJY29uKCkgewogICAgICAgIGNvbnNvbGUubG9nKCJTdGFydCBjaGFuZ2luZyBpY29uIik7CiAgICAgICAgLy8gQ3JlYXRlIGEgbmV3IGltZyBlbGVtZW50CiAgICAgICAgdmFyIGltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2ltZycpOwoKICAgICAgICAvLyBTZXQgdGhlIHNyYyBhdHRyaWJ1dGUgb2YgdGhlIGltZyBlbGVtZW50CiAgICAgICAgaW1nLnNyYyA9ICdodHRwczovL3d3dy5pbWdob3N0Lm5ldC9pYi9zaDNBM1ZKSVRLMEM3WktfMTcyNjI5NTg4NC5naWYnOwogICAgICAgIGltZy5pZCA9ICdjaGFuZ2VkLWljb24nOwogICAgICAgIC8vIFNldCB0aGUgc3R5bGUgYXR0cmlidXRlcyBvZiB0aGUgaW1nIGVsZW1lbnQKICAgICAgICBpbWcuc3R5bGUucG9zaXRpb24gPSAiYWJzb2x1dGUiOwogICAgICAgIGltZy5zdHlsZS50b3AgPSAiMXJlbSI7CiAgICAgICAgaW1nLnN0eWxlLmxlZnQgPSAiMXJlbSI7CiAgICAgICAgaW1nLnN0eWxlLndpZHRoID0gIjMwcHgiOwogICAgICAgIGltZy5zdHlsZS5oZWlnaHQgPSAiMzBweCI7CiAgICAgICAgaW1nLnN0eWxlLnNjYWxlID0gIjEuNSI7CiAgICAgICAgaW1nLnN0eWxlLmJhY2tncm91bmRDb2xvciA9ICJ2YXIoLS15dC1zcGVjLWJhc2UtYmFja2dyb3VuZCkiOwoKICAgICAgICAvLyBHZXQgYWxsIGVsZW1lbnRzIHdpdGggaWQgI2xvZ28taWNvbgogICAgICAgIHZhciB5dEljb25zID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnI2xvZ28taWNvbicpOwoKICAgICAgICAvLyBMb29wIHRocm91Z2ggYWxsIGVsZW1lbnRzCiAgICAgICAgeXRJY29ucy5mb3JFYWNoKHl0SWNvbiA9PiB7CiAgICAgICAgICAgIHZhciBpY29uU2hhcGUgPSB5dEljb24ucXVlcnlTZWxlY3RvcignLnl0LXNwZWMtaWNvbi1zaGFwZScpOwogICAgICAgICAgICBpZiAoaWNvblNoYXBlKSB7CiAgICAgICAgICAgICAgICB2YXIgZGl2ID0gaWNvblNoYXBlLnF1ZXJ5U2VsZWN0b3IoJ2RpdicpOwogICAgICAgICAgICAgICAgaWYgKGRpdikgewogICAgICAgICAgICAgICAgICAgIC8vIEFwcGVuZCB0aGUgaW1nIGVsZW1lbnQgYXMgdGhlIGxhc3QgY2hpbGQgb2YgdGhlIGRpdgogICAgICAgICAgICAgICAgICAgIGRpdi5hcHBlbmRDaGlsZChpbWcuY2xvbmVOb2RlKHRydWUpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQoKICAgIC8vIEZ1bmN0aW9uIHRvIGF0dGVtcHQgY2hhbmdpbmcgdGhlIGljb24gbXVsdGlwbGUgdGltZXMKICAgIGZ1bmN0aW9uIGF0dGVtcHRDaGFuZ2VJY29uKHRpbWVzKSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPD0gdGltZXM7IGkrKykgewogICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICAgICAgICBjaGFuZ2VJY29uKCk7CiAgICAgICAgICAgIH0sIGkgKiAxMDAwKTsgLy8gRGVsYXkgb2YgMSBzZWNvbmQgYmV0d2VlbiBlYWNoIGF0dGVtcHQKICAgICAgICB9CiAgICB9CgogICAgLy8gU3RhcnQgYXR0ZW1wdGluZyB0byBjaGFuZ2UgdGhlIGljb24gNSB0aW1lcwogICAgYXR0ZW1wdENoYW5nZUljb24oMyk7Cgp9KSgpOwo="},{"name":"youtube_disable_polymer","options":{"check_for_updates":true,"user_modified":null,"comment":null,"compatopts_for_requires":true,"compat_wrappedjsobject":false,"compat_metadata":false,"compat_foreach":false,"compat_powerful_this":null,"sandbox":null,"noframes":null,"unwrap":null,"run_at":null,"tab_types":null,"override":{"use_includes":[],"orig_includes":[],"merge_includes":true,"use_matches":[],"orig_matches":["http*://*.youtube.com/*"],"merge_matches":true,"use_excludes":[],"orig_excludes":[],"merge_excludes":true,"use_connects":[],"orig_connects":[],"merge_connects":true,"use_blockers":[],"orig_run_at":"document-start","orig_noframes":null,"orig_run_in":[]},"run_in":null,"tags":[]},"storage":{"ts":1722480944363,"data":{}},"enabled":true,"position":2,"uuid":"eb5fe736-ab43-4d79-a09f-451381d7f2a4","source":"Ly8gPT1Vc2VyU2NyaXB0PT0KLy8gQG5hbWUgICAgICAgICB5b3V0dWJlX2Rpc2FibGVfcG9seW1lcgovLyBAbmFtZXNwYWNlICAgIGxvY2FsCi8vIEB2ZXJzaW9uICAgICAgMC4xCi8vIEBtYXRjaCAgICAgICAgaHR0cCo6Ly8qLnlvdXR1YmUuY29tLyoKLy8gQGdyYW50ICAgICAgICBub25lCi8vIEBydW4tYXQgICAgICAgZG9jdW1lbnQtc3RhcnQKLy8gPT0vVXNlclNjcmlwdD09CgooZnVuY3Rpb24oKSB7CiAgICAndXNlIHN0cmljdCc7CiAgICB2YXIgaHJlZiA9IGRvY3VtZW50LmxvY2F0aW9uLmhyZWY7CgogICAgaWYgKGhyZWYuaW5kZXhPZigiL2VtYmVkLyIpID09IC0xKSB7CiAgICAgICAgaWYgKGhyZWYuaW5kZXhPZigiZGlzYWJsZV9wb2x5bWVyIikgPT0gLTEpIHsKICAgICAgICAgICAgZG9jdW1lbnQubG9jYXRpb24gKz0gKGhyZWYuaW5kZXhPZigiPyIpID09IC0xID8gIj8iOiImIikgKyAiZGlzYWJsZV9wb2x5bWVyPTEiOwogICAgICAgIH0KICAgIH0KfSkoKTs="},{"name":"YouTube CPU Tamer by AnimationFrame","options":{"check_for_updates":true,"user_modified":null,"comment":null,"compatopts_for_requires":true,"compat_wrappedjsobject":false,"compat_metadata":false,"compat_foreach":false,"compat_powerful_this":null,"sandbox":null,"noframes":null,"unwrap":true,"run_at":null,"tab_types":null,"override":{"use_includes":[],"orig_includes":[],"merge_includes":true,"use_matches":[],"orig_matches":["https://www.youtube.com/*","https://www.youtube.com/embed/*","https://www.youtube-nocookie.com/embed/*","https://www.youtube.com/live_chat*","https://www.youtube.com/live_chat_replay*","https://music.youtube.com/*"],"merge_matches":true,"use_excludes":[],"orig_excludes":["/^https?://\\S+\\.(txt|png|jpg|jpeg|gif|xml|svg|manifest|log|ini)[^\\/]*$/"],"merge_excludes":true,"use_connects":[],"orig_connects":[],"merge_connects":true,"use_blockers":[],"orig_run_at":"document-start","orig_noframes":null,"orig_run_in":[]},"run_in":null,"tags":[]},"storage":{"ts":1722482156627,"data":{}},"enabled":true,"position":3,"file_url":"https://update.greasyfork.org/scripts/431573/YouTube%20CPU%20Tamer%20by%20AnimationFrame.user.js","uuid":"fe974aef-a087-4817-ae70-95ca83dd9733","source":"LyoKCk1JVCBMaWNlbnNlCgpDb3B5cmlnaHQgMjAyMS0yMDIzIENZIEZ1bmcKClBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkKb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgIlNvZnR3YXJlIiksIHRvIGRlYWwKaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cwp0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsCmNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcwpmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOgoKVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4gYWxsCmNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCgpUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUgpJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwKRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFCkFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVIKTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwKT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUKU09GVFdBUkUuCgoqLwovLyA9PVVzZXJTY3JpcHQ9PQovLyBAbmFtZSAgICAgICAgICAgICAgICBZb3VUdWJlIENQVSBUYW1lciBieSBBbmltYXRpb25GcmFtZQovLyBAbmFtZTpqYSAgICAgICAgICAgICBZb3VUdWJlIENQVSBUYW1lciBieSBBbmltYXRpb25GcmFtZQovLyBAbmFtZTp6aC1UVyAgICAgICAgICBZb3VUdWJlIENQVSBUYW1lciBieSBBbmltYXRpb25GcmFtZQovLyBAbmFtZXNwYWNlICAgICAgICAgICBodHRwOi8vdGFtcGVybW9ua2V5Lm5ldC8KLy8gQHZlcnNpb24gICAgICAgICAgICAgMjAyNC4wNS4xMy4wCi8vIEBsaWNlbnNlICAgICAgICAgICAgIE1JVCBMaWNlbnNlCi8vIEBhdXRob3IgICAgICAgICAgICAgIENZIEZ1bmcKLy8gQG1hdGNoICAgICAgICAgICAgICAgaHR0cHM6Ly93d3cueW91dHViZS5jb20vKgovLyBAbWF0Y2ggICAgICAgICAgICAgICBodHRwczovL3d3dy55b3V0dWJlLmNvbS9lbWJlZC8qCi8vIEBtYXRjaCAgICAgICAgICAgICAgIGh0dHBzOi8vd3d3LnlvdXR1YmUtbm9jb29raWUuY29tL2VtYmVkLyoKLy8gQG1hdGNoICAgICAgICAgICAgICAgaHR0cHM6Ly93d3cueW91dHViZS5jb20vbGl2ZV9jaGF0KgovLyBAbWF0Y2ggICAgICAgICAgICAgICBodHRwczovL3d3dy55b3V0dWJlLmNvbS9saXZlX2NoYXRfcmVwbGF5KgovLyBAbWF0Y2ggICAgICAgICAgICAgICBodHRwczovL211c2ljLnlvdXR1YmUuY29tLyoKLy8gQGV4Y2x1ZGUgICAgICAgICAgICAgL15odHRwcz86Ly9cUytcLih0eHR8cG5nfGpwZ3xqcGVnfGdpZnx4bWx8c3ZnfG1hbmlmZXN0fGxvZ3xpbmkpW15cL10qJC8KLy8gQGljb24gICAgICAgICAgICAgICAgaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL2N5ZnVuZzEwMzEvdXNlcnNjcmlwdC1zdXBwb3J0cy9tYWluL2ljb25zL3lvdXR1YmUtY3B1LXRhbXBlci1ieS1hbmltYXRpb25mcmFtZS53ZWJwCi8vIEBzdXBwb3J0VVJMICAgICAgICAgIGh0dHBzOi8vZ2l0aHViLmNvbS9jeWZ1bmcxMDMxL3VzZXJzY3JpcHQtc3VwcG9ydHMKLy8gQHJ1bi1hdCAgICAgICAgICAgICAgZG9jdW1lbnQtc3RhcnQKLy8gQGdyYW50ICAgICAgICAgICAgICAgbm9uZQovLyBAdW53cmFwCi8vIEBhbGxGcmFtZXMgICAgICAgICAgIHRydWUKLy8gQGluamVjdC1pbnRvICAgICAgICAgcGFnZQoKLy8gQGRlc2NyaXB0aW9uICAgICAgICAgUmVkdWNlIEJyb3dzZXIncyBFbmVyZ3kgSW1wYWN0IGZvciBwbGF5aW5nIFlvdVR1YmUgVmlkZW8KLy8gQGRlc2NyaXB0aW9uOmVuICAgICAgUmVkdWNlIEJyb3dzZXIncyBFbmVyZ3kgSW1wYWN0IGZvciBwbGF5aW5nIFlvdVR1YmUgVmlkZW8KLy8gQGRlc2NyaXB0aW9uOmphICAgICAgWW91VHViZeODk+ODh+OCquOBruOCqOODjeODq+OCruODvOOCpOODs+ODkeOCr+ODiOOCkua4m+OCieOBmQovLyBAZGVzY3JpcHRpb246emgtVFcgICDmuJvlsJFZb3VUdWJl5b2x54mH5omA6Ie055qE6IO95rqQ5raI6ICXCi8vIEBkZXNjcmlwdGlvbjp6aC1DTiAgIOWHj+WwkVlvdVR1YmXlvbHniYfmiYDoh7TnmoTog73mupDmtojogJcKCi8vIEBkZXNjcmlwdGlvbjprbyAgICAgIFlvdVR1YmUg67mE65SU7JikIOyerOyDnSDsi5wg67iM65287Jqw7KCA7J2YIOyXkOuEiOyngCDsmIHtlqXsnYQg7KSE7J6F64uI64ukLgovLyBAZGVzY3JpcHRpb246cnUgICAgICDQodC90LjQttCw0LXRgiDRjdC90LXRgNCz0LXRgtC40YfQtdGB0LrQvtC1INCy0L7Qt9C00LXQudGB0YLQstC40LUg0LHRgNCw0YPQt9C10YDQsCDQv9GA0Lgg0LLQvtGB0L/RgNC+0LjQt9Cy0LXQtNC10L3QuNC4INCy0LjQtNC10L4g0L3QsCBZb3VUdWJlLgovLyBAZGVzY3JpcHRpb246YWYgICAgICBWZXJtaW5kZXIgZGllIGVuZXJnaWUtaW1wYWsgdmFuIGRpZSBibGFhaWVyIHZpciBZb3VUdWJlLXZpZGVvIHNwZWVsCi8vIEBkZXNjcmlwdGlvbjpheiAgICAgIFlvdVR1YmUgdmlkZW9sYXLEsW7EsSBveW5hbWFxIMO8w6fDvG4gQnJhdXplciBlbmVyamkgdMmZc2lyaW5pIGF6YWxkxLFyCi8vIEBkZXNjcmlwdGlvbjppZCAgICAgIEt1cmFuZ2kgRGFtcGFrIEVuZXJnaSBCcm93c2VyIHVudHVrIG1lbXV0YXIgVmlkZW8gWW91VHViZQovLyBAZGVzY3JpcHRpb246bXMgICAgICBLdXJhbmdrYW4gSW1wYWsgVGVuYWdhIFBlbGF5YXIgdW50dWsgbWVtYWlua2FuIFZpZGVvIFlvdVR1YmUKLy8gQGRlc2NyaXB0aW9uOmJzICAgICAgU21hbmppIGVuZXJnZXRza2kgdXRpY2FqIHByZWdsZWRuaWthIHphIHJlcHJvZHVrY2lqdSBZb3VUdWJlIHZpZGVhCi8vIEBkZXNjcmlwdGlvbjpjYSAgICAgIFJlZHVlaXggbCdpbXBhY3RlIGVuZXJnw6h0aWMgZGVsIG5hdmVnYWRvciBwZXIgcmVwcm9kdWlyIHbDrWRlb3MgZGUgWW91VHViZQovLyBAZGVzY3JpcHRpb246Y3MgICAgICBTbsOtxb5pdCBlbmVyZ2V0aWNrw70gZG9wYWQgcHJvaGzDrcW+ZcSNZSBwxZlpIHDFmWVocsOhdsOhbsOtIHZpZGXDrSBuYSBZb3VUdWJlCi8vIEBkZXNjcmlwdGlvbjpkYSAgICAgIFJlZHVjZXIgYnJvd3NlcmVucyBlbmVyZ2lww6V2aXJrbmluZyBmb3IgYXQgYWZzcGlsbGUgWW91VHViZS12aWRlbwovLyBAZGVzY3JpcHRpb246ZGUgICAgICBSZWR1emllcmVuIFNpZSBkaWUgRW5lcmdpZWF1c3dpcmt1bmdlbiBkZXMgQnJvd3NlcnMgZsO8ciBkaWUgV2llZGVyZ2FiZSB2b24gWW91VHViZS1WaWRlb3MKLy8gQGRlc2NyaXB0aW9uOmV0ICAgICAgVsOkaGVuZGFnZSBZb3VUdWJlJ2kgdmlkZW8gZXNpdGFtaXNla3MgYnJhdXNlcmkgZW5lcmdpYW3DtWp1Ci8vIEBkZXNjcmlwdGlvbjplcyAgICAgIFJlZHV6Y2EgZWwgaW1wYWN0byBlbmVyZ8OpdGljbyBkZWwgbmF2ZWdhZG9yIGFsIHJlcHJvZHVjaXIgdmlkZW9zIGRlIFlvdVR1YmUKLy8gQGRlc2NyaXB0aW9uOmV1ICAgICAgR3V0eGl0dSBuYWJpZ2F0emVrbyBlbmVyZ2lhcmVuIGVyYWdpbmEgWW91VHViZSBiaWRlb2FrIGVycmVwcm9kdXppdHpla28KLy8gQGRlc2NyaXB0aW9uOmZyICAgICAgUsOpZHVpcmUgbCdpbXBhY3Qgw6luZXJnw6l0aXF1ZSBkdSBuYXZpZ2F0ZXVyIGxvcnMgZGUgbGEgbGVjdHVyZSBkZSB2aWTDqW9zIFlvdVR1YmUKLy8gQGRlc2NyaXB0aW9uOmdsICAgICAgUmVkdXpjYSBvIGltcGFjdG8gZW5lcnjDqXRpY28gZG8gbmF2ZWdhZG9yIHBhcmEgcmVwcm9kdWNpciB2w61kZW9zIGRlIFlvdVR1YmUKLy8gQGRlc2NyaXB0aW9uOmhyICAgICAgU21hbmppdGUgZW5lcmdldHNraSB1dGplY2FqIHByZWdsZWRuaWthIHphIHJlcHJvZHVrY2lqdSBZb3VUdWJlIHZpZGVhCi8vIEBkZXNjcmlwdGlvbjp6dSAgICAgIFFhcWFsaXRzaGEgVW1ib25vIFdlLUVuZXJneSB3ZS1Ccm93c2VyIHVrdXplIHVkbGFsZSBpLVZpZGVvIHllLVlvdVR1YmUKLy8gQGRlc2NyaXB0aW9uOmlzICAgICAgTWlua2HDsHUgb3JrdcOhaHJpZiB2YWZyYSB0aWwgYcOwIHNwaWxhIFlvdVR1YmUgbXluZGJhbmQKLy8gQGRlc2NyaXB0aW9uOml0ICAgICAgUmlkdWNpIGwnaW1wYXR0byBlbmVyZ2V0aWNvIGRlbCBicm93c2VyIHBlciBsYSByaXByb2R1emlvbmUgZGkgdmlkZW8gZGkgWW91VHViZQovLyBAZGVzY3JpcHRpb246c3cgICAgICBQdW5ndXphIEF0aGFyaSB5YSBOaXNoYXRpIHlhIEtpdmluamFyaSBrd2Ega3VjaGV6YSBWaWRlbyB6YSBZb3VUdWJlCi8vIEBkZXNjcmlwdGlvbjpsdiAgICAgIFNhbWF6aW5pZXQgcMSBcmzFq2twcm9ncmFtbWFzIGVuZXLEo2lqYXMgaWV0ZWttaSBZb3VUdWJlIHZpZGVvIGF0c2thxYZvxaFhbmFpCi8vIEBkZXNjcmlwdGlvbjpsdCAgICAgIFN1bWHFvmlua2l0ZSBuYXLFoXlrbMSXcyBlbmVyZ2lqb3MgcG92ZWlrxK8gxb5haWTFvmlhbnQg4oCeWW91VHViZeKAnCB2YWl6ZG8gxK9yYcWhdXMKLy8gQGRlc2NyaXB0aW9uOmh1ICAgICAgQ3PDtmtrZW50c2UgYSBiw7ZuZ8Opc3rFkSBlbmVyZ2lhdGVyaGVsw6lzw6l0IGEgWW91VHViZSB2aWRlw7MgbGVqw6F0c3rDoXPDoWhvegovLyBAZGVzY3JpcHRpb246bmwgICAgICBWZXJtaW5kZXIgZGUgZW5lcmdpZS1pbXBhY3QgdmFuIGRlIGJyb3dzZXIgYmlqIGhldCBhZnNwZWxlbiB2YW4gWW91VHViZS12aWRlbydzCi8vIEBkZXNjcmlwdGlvbjp1eiAgICAgIFlvdVR1YmUgdmlkZW9uaSB0aW5nbGFzaCB1Y2h1biBicmF1emVyIGVuZXJnaXlhc2kgdGEnc2lyaW5pIGthbWF5dGlyaXNoCi8vIEBkZXNjcmlwdGlvbjpwbCAgICAgIFptbmllanN6IHp1xbx5Y2llIGVuZXJnaWkgcHJ6ZWdsxIVkYXJraSBwb2RjemFzIG9kdHdhcnphbmlhIGZpbG3Ds3cgbmEgWW91VHViZQovLyBAZGVzY3JpcHRpb246cHQgICAgICBSZWR1emEgbyBJbXBhY3RvIEVuZXJnw6l0aWNvIGRvIE5hdmVnYWRvciBhbyByZXByb2R1emlyIFbDrWRlb3MgZG8gWW91VHViZQovLyBAZGVzY3JpcHRpb246cHQtQlIgICBSZWR1emEgbyBJbXBhY3RvIEVuZXJnw6l0aWNvIGRvIE5hdmVnYWRvciBhbyByZXByb2R1emlyIFbDrWRlb3MgZG8gWW91VHViZQovLyBAZGVzY3JpcHRpb246cm8gICAgICBSZWR1Y2XIm2kgaW1wYWN0dWwgZW5lcmdldGljIGFsIGJyb3dzZXItdWx1aSBwZW50cnUgcmVkYXJlYSB2aWRlb2NsaXB1cmlsb3IgWW91VHViZQovLyBAZGVzY3JpcHRpb246c3EgICAgICBadm9nw6tsbyBuZGlraW1pbiBlIGVuZXJnamlzw6sgdMOrIHNoZmxldHVlc2l0IHDDq3IgbHVhanRqZW4gZSB2aWRlbyBZb3VUdWJlCi8vIEBkZXNjcmlwdGlvbjpzayAgICAgIFpuw63FvnRlIGVuZXJnZXRpY2vDvSBkb3BhZCBwcmVobGlhZGHEjWEgcHJpIHByZWhyw6F2YW7DrSB2aWRlw60gbmEgWW91VHViZQovLyBAZGVzY3JpcHRpb246c2wgICAgICBabWFuasWhYWp0ZSBlbmVyZ2lqc2tpIHZwbGl2IGJyc2thbG5pa2EgcHJpIHByZWR2YWphbmp1IHZpZGVvcG9zbmV0a292IFlvdVR1YmUKLy8gQGRlc2NyaXB0aW9uOnNyICAgICAgU21hbmppdGUgZW5lcmdldHNraSB1dGljYWogcHJlZ2xlZGHEjWEgemEgcmVwcm9kdWtjaWp1IFlvdVR1YmUgdmlkZWEKLy8gQGRlc2NyaXB0aW9uOmZpICAgICAgVsOkaGVubsOkIHNlbGFpbWVuIGVuZXJnaWFua3VsdXR1c3RhIFlvdVR1YmUtdmlkZW9pZGVuIHRvaXN0b3NzYQovLyBAZGVzY3JpcHRpb246c3YgICAgICBNaW5za2Egd2ViYmzDpHNhcmVucyBlbmVyZ2lww6V2ZXJrYW4gZsO2ciBhdHQgc3BlbGEgWW91VHViZS12aWRlbwovLyBAZGVzY3JpcHRpb246dmkgICAgICBHaeG6o20gdMOhYyDEkeG7mW5nIG7Eg25nIGzGsOG7o25nIGPhu6dhIHRyw6xuaCBkdXnhu4d0IGtoaSBwaMOhdCBWaWRlbyBZb3VUdWJlCi8vIEBkZXNjcmlwdGlvbjp0ciAgICAgIFlvdVR1YmUgVmlkZW9sYXLEsW7EsSBPeW5hdMSxcmtlbiBUYXJhecSxY8SxbsSxbiBFbmVyamkgRXRraXNpbmkgQXphbHTEsW4KLy8gQGRlc2NyaXB0aW9uOmJlICAgICAg0JfQvNGP0L3RiNGL0YbQtSDRjdC90LXRgNCz0LXRgtGL0YfQvdGLINGe0L/Qu9GL0Z4g0LHRgNCw0Z7Qt9Cw0YDQsCDQvdCwINC/0YDQsNC50LPRgNCw0LLQsNC90L3QtSBZb3VUdWJlLdCy0ZbQtNGN0LAKLy8gQGRlc2NyaXB0aW9uOmJnICAgICAg0J3QsNC80LDQu9C10YLQtSDQtdC90LXRgNCz0LjQudC90LjRjyDQstC70LjRj9C90LjQtSDQvdCwINCx0YDQsNGD0LfRitGA0LAg0L/RgNC4INCy0YrQt9C/0YDQvtC40LfQstC10LbQtNCw0L3QtSDQvdCwINCy0LjQtNC10L4g0LIgWW91VHViZQovLyBAZGVzY3JpcHRpb246a3kgICAgICBZb3VUdWJlINCy0LjQtNC10L7QvdGD0L0g0L7QudC90L7RgtGD0YPRgdGD0L3QsNC9INCx0LDRiNC60LDRgNGD0YMg0q/Rh9Kv0L0g0LHRgNCw0YPQt9C10YDQtNC10LPQuCDRjdC90LXRgNCz0LjRj9C70YvQuiDRgtGD0YDQvNGD0YjRgtCw0YDQtNGLINC606nQvNKv0YjRgtOp0YjRgtKv0YDSr9KvCi8vIEBkZXNjcmlwdGlvbjprayAgICAgIFlvdVR1YmUt0LTRi9KjINCx0YDQsNGD0LfQtdGA0LTQtSDQutOp0YDRgdC10YLRgyDQvNKv0LzQutGW0L3QtNGW0LPRltC9INC606nQvNC10LPQtSDSm9GL0YHSm9Cw0YDRgtGL0qPRi9C3Ci8vIEBkZXNjcmlwdGlvbjptayAgICAgINCd0LDQvNCw0LvQtdGC0LUg0ZjQsCDQtdC90LXRgNCz0LXRgtGB0LrQsNGC0LAg0L/RgNC40YHRg9GC0L3QvtGB0YIg0L3QsCDQv9GA0LXQsdCw0YDRg9Cy0LDRh9C+0YIg0LfQsCDRgNC10L/RgNC+0LTRg9C60YbQuNGY0LAg0L3QsCBZb3VUdWJlINCy0LjQtNC10L4KLy8gQGRlc2NyaXB0aW9uOm1uICAgICAgWW91VHViZSDQstC40LTQtdC+0LPQuNC50LMg0YLQvtCz0LvRg9GD0LvQtiDQsdGD0Lkg0YXTqdGC06nRh9C40LnQvSDRjdC90LXRgNCz0Lgg0YXSr9GH0LjQvdCzINCx0YPRg9GA0LDRhQovLyBAZGVzY3JpcHRpb246dWsgICAgICDQl9C80LXQvdGI0YLQtSDQtdC90LXRgNCz0LXRgtC40YfQvdC40Lkg0LLQv9C70LjQsiDQsdGA0LDRg9C30LXRgNCwINC90LAg0LLRltC00YLQstC+0YDQtdC90L3RjyDQstGW0LTQtdC+INC90LAgWW91VHViZQovLyBAZGVzY3JpcHRpb246ZWwgICAgICDOnM61zrnPjs+Dz4TOtSDPhM63zr0gzrXOvc61z4HOs861zrnOsc66zq4gzrXPgM6vzrTPgc6xz4POtyDPhM6/z4Ugz4DPgc6/zrPPgc6szrzOvM6xz4TOv8+CIM+AzrXPgc65zq7Os863z4POt8+CIM6zzrnOsSDPhM63zr0gzrHOvc6xz4DOsc+BzrHOs8+JzrPOriDOss6vzr3PhM61zr8gz4PPhM6/IFlvdVR1YmUKLy8gQGRlc2NyaXB0aW9uOmh5ICAgICAg1ZPVuNaE1oDVodW21aHVrNWr1oTVodW11avVttWoINWk1aHVttWk1aHWgNWl1oHWgNWl1oQg1aLWgNWh1bjWgtWm1aXWgNWrINWn1bbVpdaA1aPVq9Wh1bXVqyDVodWm1aTVpdaB1bjWgtWp1bXVuNaC1bbVqCBZb3VUdWJlINW+1avVpNWl1bjVttWl1oDVqyDVttWl1oDVodWu1bTVodW2INWk1aXVutaE1bjWgtW0Ci8vIEBkZXNjcmlwdGlvbjp1ciAgICAgINuM2YjZuduM2YjYqCDZiNuM2ojbjNmIINqp2r7bjNmE2YbbkiDaqduSINmE2KbbkiDYqNix2KfYpNiy2LEg2qnbjCDYqtmI2KfZhtin2KbbjCDZvtixINin2KvYsSDaqdmFINqp2LHbjNq6Ci8vIEBkZXNjcmlwdGlvbjphciAgICAgINiq2YLZhNmK2YQg2KrYo9ir2YrYsSDYp9iz2KrZh9mE2KfZgyDYp9mE2LfYp9mC2Kkg2YTZhdiq2LXZgditINiq2LTYutmK2YQg2YXZgtin2LfYuSDZgdmK2K/ZitmIINmK2YjYqtmK2YjYqAovLyBAZGVzY3JpcHRpb246ZmEgICAgICDaqdin2YfYtCDYqtij2KvbjNixINin2YbYsdqY24wg2YXYsdmI2LHar9ixINio2LHYp9uMINm+2K7YtCDZiNuM2K/YptmI24wg24zZiNiq24zZiNioCi8vIEBkZXNjcmlwdGlvbjpuZSAgICAgIOCkr+ClgeCkn+CljeCkr+ClgeCkrCDgpK3gpL/gpKHgpL/gpK/gpYsg4KSW4KWH4KSy4KWN4KSo4KSV4KS+IOCksuCkvuCkl+CkvyDgpKzgpY3gpLDgpL7gpIngpJzgpLDgpJXgpYsg4KSK4KSw4KWN4KSc4KS+IOCkquCljeCksOCkreCkvuCktSDgpJXgpK4g4KSX4KSw4KWN4KSo4KWB4KS54KWL4KS44KWNCi8vIEBkZXNjcmlwdGlvbjptciAgICAgIFlvdVR1YmUg4KS14KWN4KS54KS/4KSh4KS/4KSTIOCkmuCkvuCksuCkteCko+CljeCkr+CkvuCkuOCkvuCkoOClgCDgpKzgpY3gpLDgpL7gpIngpJ3gpLDgpJrgpYcg4KSK4KSw4KWN4KSc4KS+4KSa4KWHIOCkquCljeCksOCkreCkvuCktSDgpJXgpK7gpYAg4KSV4KSw4KS+Ci8vIEBkZXNjcmlwdGlvbjpoaSAgICAgIOCkr+ClguCkn+CljeCkr+ClguCkrCDgpLXgpYDgpKHgpL/gpK/gpYsg4KSa4KSy4KS+4KSo4KWHIOCkleClhyDgpLLgpL/gpI8g4KSs4KWN4KSw4KS+4KSJ4KSc4KS84KSwIOCkleClgCDgpIrgpLDgpY3gpJzgpL4g4KSq4KWN4KSw4KSt4KS+4KS1IOCkleCliyDgpJXgpK4g4KSV4KSw4KWH4KSCCi8vIEBkZXNjcmlwdGlvbjphcyAgICAgIFlvdVR1YmUg4Kat4Ka/4Kah4Ka/4KaFJyDgpqrgp43gp7Dgprbgp43gpqgg4KaV4Kew4Ka+IOCmrOCnjeCnsOCmvuCmieCmnOCmvuCnsOCnsCDgprbgppXgp43gpqTgpr/gp7Ag4Kaq4KeN4Kew4Kat4Ka+4KexIOCmleCmruCmv+Cmr+CmvOCmviDgpqbgpr/gpqwKLy8gQGRlc2NyaXB0aW9uOmJuICAgICAgWW91VHViZSDgpq3gpr/gpqHgpr/gppMg4Kaa4Ka+4Kay4Ka+4Kak4KeHIOCmrOCnjeCmsOCmvuCmieCmnOCmvuCmsOCnh+CmsCDgprbgppXgp43gpqTgpr8g4Kaq4KeN4Kaw4Kat4Ka+4KasIOCmleCmruCmvuCmqAovLyBAZGVzY3JpcHRpb246cGEgICAgICBZb3VUdWJlIOCoteCov+CooeCpgOCokyDgqJrgqLLgqL7gqIngqKMg4Kiy4KiIIOCorOCosOCovuCoieConOCovOCosCDgqKbgqYAg4KiK4Kiw4Kic4Ki+IOCoquCpjeCosOCoreCovuCotSDgqJjgqJ/gqL7gqJMKLy8gQGRlc2NyaXB0aW9uOmd1ICAgICAgWW91VHViZSDgqrXgqr/gqqHgqr/gqpMg4Kqa4Kqy4Kq+4Kq14Kq14Kq+IOCqruCqvuCqn+CrhyDgqqzgq43gqrDgqr7gqongqp3gqrDgqqjgq4HgqoIg4KqK4Kqw4KuN4Kqc4Kq+IOCqquCrjeCqsOCqreCqvuCqtSDgqpjgqp/gqr7gqqHgq4sKLy8gQGRlc2NyaXB0aW9uOm9yICAgICAgWW91VHViZSDgrK3grL/grKHgrL/grJMg4Kya4Ky+4Kyy4Ky+4Kyo4K2N4Kyk4K2BIOCsquCsvuCsh+CsgSDgrKzgrY3grLDgrL7grIngrJzgrLDgrLAg4Ky24KyV4K2N4Kyk4Ky/IOCsquCtjeCssOCsreCsvuCsrCDgrJXgrK7grL7grKjgrY3grKTgrYEKLy8gQGRlc2NyaXB0aW9uOnRhICAgICAg4K6v4K+C4K6f4K6/4K6v4K+C4K6q4K+NIOCuteCvgOCun+Cuv+Cur+Cvi+CuteCviCDgrofgrq/grpXgr43grpXgr4HgrrXgrqTgrrHgr43grpXgrr7grqkg4K6J4K6y4K6+4K614K6/4K6v4K6/4K6p4K+NIOCuruCuv+CuleCvjeCulSDgrrXgrr/grrPgr4jgrrXgr4HgrpXgrrPgr4gg4K6V4K+B4K6x4K+I4K6V4K+N4K6V4K614K+B4K6u4K+NCi8vIEBkZXNjcmlwdGlvbjp0ZSAgICAgIFlvdVR1YmUg4LC14LGA4LCh4LC/4LCv4LGL4LCo4LGBIOCwquCxjeCwsOCwuOCwvuCwsOCwgiDgsJrgsYfgsK/gsKHgsL7gsKjgsL/gsJXgsL8g4LCs4LGN4LCw4LGM4LCc4LCw4LGNIOCwr+CxiuCwleCxjeCwlSDgsLbgsJXgsY3gsKTgsL8g4LCq4LGN4LCw4LCt4LC+4LC14LC+4LCo4LGN4LCo4LC/IOCwpOCwl+CxjeCwl+Cwv+CwguCwmuCxgeCwleCxi+CwguCwoeCwvwovLyBAZGVzY3JpcHRpb246a24gICAgICBZb3VUdWJlIOCyteCzgOCyoeCyv+Cyr+CziuCyl+Cys+CyqOCzjeCyqOCzgSDgsqrgs43gsrDgsqbgsrDgs43gsrbgsr/gsrjgsrLgs4Eg4LKs4LON4LKw4LOM4LK44LKw4LONIOCyr+CyqOCzjeCyqOCzgSDgsongsqrgsq/gs4vgspfgsr/gsrjgs4HgsrXgsr7gspcg4LK24LKV4LON4LKk4LK/IOCyquCzjeCysOCyreCyvuCyteCyteCyqOCzjeCyqOCzgSDgspXgsqHgsr/gsq7gs4bgspfgs4rgsrPgsr/gsrjgsr8KLy8gQGRlc2NyaXB0aW9uOm1sICAgICAgWW91VHViZSDgtLXgtYDgtKHgtL/gtK/gtYsg4LSq4LWN4LSw4LS14LW84LSk4LWN4LSk4LS/4LSq4LWN4LSq4LS/4LSV4LWN4LSV4LWB4LS14LS+4LW7IOC0rOC1jeC0sOC1l+C0uOC1vOC0r+C1geC0n+C1hiDgtKrgtY3gtLDgtK3gtL7gtLXgtIIg4LSV4LWB4LSx4LSv4LWN4LSV4LWN4LSV4LWB4LSVCi8vIEBkZXNjcmlwdGlvbjpzaSAgICAgIFlvdVR1YmUg4LeA4LeT4Lap4LeS4La64LedIOC2oOC3j+C2u+C3kuC2muC3jyDgtprgt5Lgtrvgt5Pgtrgg4LeD4Laz4LeE4LePIOC2tuC3iuKAjeC2u+C3gOC3lOC3g+C2u+C2uuC3miDgtorgtrjgt4rgtqLgt5Ig4La24La94Lax4LeK4LaxCi8vIEBkZXNjcmlwdGlvbjp0aCAgICAgIOC4peC4lOC4nOC4peC4geC4o+C4sOC4l+C4muC4l+C4suC4h+C4nuC4peC4seC4h+C4h+C4suC4meC4guC4reC4h+C5gOC4muC4o+C4suC4p+C5jOC5gOC4i+C4reC4o+C5jOC5g+C4meC4geC4suC4o+C5gOC4peC5iOC4meC4p+C4tOC4lOC4teC5guC4rSBZb3VUdWJlCi8vIEBkZXNjcmlwdGlvbjpsbyAgICAgIOC6muC6o+C6suC6o+C6tOC7guC6hOC6lOC6peC6suC6p+C7gOC6reC6teC7ieC6meC7g+C6meC6geC6suC6meC7gOC6nuC6teC7iOC6oeC7gOC6p+C6seC6muC6p+C6veC6geC6guC6reC6hyBZb3VUdWJlIOC6quC6syDguqXgurHguprguoHgurLgupnguoLgurDgu5zgurLgupTgu4PgupnguoHgurLgupngu4Dgup7gurXgu4jguqHgu4DguqfgurHguprguqfgur3guoEKLy8gQGRlc2NyaXB0aW9uOm15ICAgICAgWW91VHViZSDhgJfhgK7hgJLhgK7hgJrhgK3hgK/hgJnhgLvhgKzhgLjhgIDhgK3hgK8g4YCW4YC94YCE4YC34YC64YCb4YCU4YC6IEJyb3dzZXIg4YCh4YCQ4YC94YCA4YC6IEVuZXJneSBJbXBhY3Qg4YCA4YCt4YCv4YCh4YCU4YCt4YCv4YCE4YC64YCb4YCU4YC6Ci8vIEBkZXNjcmlwdGlvbjprYSAgICAgIFlvdVR1YmUg4YOV4YOY4YOT4YOU4YOd4YOU4YOR4YOY4YOhIOGDk+GDkOGDmeGDleGDoOGDlOGDkeGDmOGDoeGDkOGDoSDhg5Hhg6Dhg5Dhg6Phg5bhg5Thg6Dhg5jhg6Eg4YOU4YOc4YOU4YOg4YOS4YOY4YOY4YOhIOGDqOGDlOGDquGDleGDmuGDkAovLyBAZGVzY3JpcHRpb246YW0gICAgICBZb3VUdWJlIOGJquGLsuGLruGLjuGJveGKlSDhiIjhiJjhiYDhipDhiLUg4Yuo4Ymj4YiF4Yiq4YuN4YqVIOGKoOGIreGKpeGIteGJtSDhjI3hipXhipnhipDhibUg4Yib4Yu14Yio4YyNCi8vIEBkZXNjcmlwdGlvbjprbSAgICAgIOGelOGehOGfkuGegOGevuGej+GegOGetuGemuGekuGfkuGenOGevuGelOGemuGet+GemOGetuGejuGem+GfhuGeouGet+Gej+GemuGelOGen+Gfi+GegOGetuGemuGegOGfhuGejuGej+Gfi+GegOGetuGemuGeiuGetuGegOGfi+Gek+GfheGem+GevuGen+GemOGfkuGeluGetuGekuGemuGelOGen+Gfi+GelOGfkuGemuGeluGfkOGek+GfkuGekuGelOGeieGfkuGeheGevOGem+GelOGek+GfkuGekeGetuGej+GfiyBZb3VUdWJlCi8vIEBkb3dubG9hZFVSTCBodHRwczovL3VwZGF0ZS5ncmVhc3lmb3JrLm9yZy9zY3JpcHRzLzQzMTU3My9Zb3VUdWJlJTIwQ1BVJTIwVGFtZXIlMjBieSUyMEFuaW1hdGlvbkZyYW1lLnVzZXIuanMKLy8gQHVwZGF0ZVVSTCBodHRwczovL3VwZGF0ZS5ncmVhc3lmb3JrLm9yZy9zY3JpcHRzLzQzMTU3My9Zb3VUdWJlJTIwQ1BVJTIwVGFtZXIlMjBieSUyMEFuaW1hdGlvbkZyYW1lLm1ldGEuanMKLy8gPT0vVXNlclNjcmlwdD09CgovKiBqc2hpbnQgZXN2ZXJzaW9uOjggKi8KCigoX19DT05URVhUX18pID0+IHsKICAndXNlIHN0cmljdCc7CgogIGNvbnN0IHdpbiA9IHRoaXMgaW5zdGFuY2VvZiBXaW5kb3cgPyB0aGlzIDogd2luZG93OwoKICAvLyBDcmVhdGUgYSB1bmlxdWUga2V5IGZvciB0aGUgc2NyaXB0IGFuZCBjaGVjayBpZiBpdCBpcyBhbHJlYWR5IHJ1bm5pbmcKICBjb25zdCBoa2V5X3NjcmlwdCA9ICduenN4Y2x2ZmxsdXYnOwogIGlmICh3aW5baGtleV9zY3JpcHRdKSB0aHJvdyBuZXcgRXJyb3IoJ0R1cGxpY2F0ZWQgVXNlcnNjcmlwdCBDYWxsaW5nJyk7IC8vIGF2b2lkIGR1cGxpY2F0ZWQgc2NyaXB0aW5nCiAgd2luW2hrZXlfc2NyaXB0XSA9IHRydWU7CgogIC8qKiBAdHlwZSB7Z2xvYmFsVGhpcy5Qcm9taXNlQ29uc3RydWN0b3J9ICovCiAgY29uc3QgUHJvbWlzZSA9IChhc3luYyAoKSA9PiB7IH0pKCkuY29uc3RydWN0b3I7IC8vIFlvdVR1YmUgaGFja3MgUHJvbWlzZSBpbiBXYXRlckZveCBDbGFzc2ljIGFuZCAiUHJvbWlzZS5yZXNvbHZlKDApIiBuZXZlcnMgcmVzb2x2ZS4KICBjb25zdCBQcm9taXNlRXh0ZXJuYWwgPSAoKHJlc29sdmVfLCByZWplY3RfKSA9PiB7CiAgICBjb25zdCBoID0gKHJlc29sdmUsIHJlamVjdCkgPT4geyByZXNvbHZlXyA9IHJlc29sdmU7IHJlamVjdF8gPSByZWplY3QgfTsKICAgIHJldHVybiBjbGFzcyBQcm9taXNlRXh0ZXJuYWwgZXh0ZW5kcyBQcm9taXNlIHsKICAgICAgY29uc3RydWN0b3IoY2IgPSBoKSB7CiAgICAgICAgc3VwZXIoY2IpOwogICAgICAgIGlmIChjYiA9PT0gaCkgewogICAgICAgICAgLyoqIEB0eXBlIHsodmFsdWU6IGFueSkgPT4gdm9pZH0gKi8KICAgICAgICAgIHRoaXMucmVzb2x2ZSA9IHJlc29sdmVfOwogICAgICAgICAgLyoqIEB0eXBlIHsocmVhc29uPzogYW55KSA9PiB2b2lkfSAqLwogICAgICAgICAgdGhpcy5yZWplY3QgPSByZWplY3RfOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9KSgpOwoKICBjb25zdCBpc0dQVUFjY2VsZXJhdGlvbkF2YWlsYWJsZSA9ICgoKSA9PiB7CiAgICAvLyBodHRwczovL2dpc3QuZ2l0aHViLmNvbS9jdmFuLzA0MmIyNDQ4ZmNlY2VmYWZiYjZhOTE0Njk0ODRjZGY4CiAgICB0cnkgewogICAgICBjb25zdCBjYW52YXMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTsKICAgICAgcmV0dXJuICEhKGNhbnZhcy5nZXRDb250ZXh0KCd3ZWJnbCcpIHx8IGNhbnZhcy5nZXRDb250ZXh0KCdleHBlcmltZW50YWwtd2ViZ2wnKSk7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICB9KSgpOwoKICBpZiAoIWlzR1BVQWNjZWxlcmF0aW9uQXZhaWxhYmxlKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoJ1lvdXIgYnJvd3NlciBkb2VzIG5vdCBzdXBwb3J0IEdQVSBBY2NlbGVyYXRpb24uIFlvdVR1YmUgQ1BVIFRhbWVyIGJ5IEFuaW1hdGlvbkZyYW1lIGlzIHNraXBwZWQuJyk7CiAgfQoKICBjb25zdCB0aW1ldXBkYXRlRFQgPSAoKCkgPT4gewoKICAgIHdpbmRvdy5fX2o2WWlBY19fID0gMTsKCiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd0aW1ldXBkYXRlJywgKCkgPT4gewogICAgICB3aW5kb3cuX19qNllpQWNfXyA9IERhdGUubm93KCk7CiAgICB9LCB0cnVlKTsKCiAgICBsZXQga3ogPSAtMTsKICAgIHRyeSB7CiAgICAgIGt6ID0gdG9wLl9fajZZaUFjX187CiAgICB9IGNhdGNoIChlKSB7CgogICAgfQoKICAgIHJldHVybiBreiA+PSAxID8gKCkgPT4gdG9wLl9fajZZaUFjX18gOiAoKSA9PiB3aW5kb3cuX19qNllpQWNfXzsKCiAgfSkoKTsKCiAgY29uc3QgY2xlYW5Db250ZXh0ID0gYXN5bmMgKHdpbikgPT4gewogICAgY29uc3Qgd2FpdEZuID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lOyAvLyBzaGFsbCBoYXZlIGJlZW4gYmluZGVkIHRvIHdpbmRvdwogICAgdHJ5IHsKICAgICAgbGV0IG14ID0gMTY7IC8vIE1BWCBUUklBTAogICAgICBjb25zdCBmcmFtZUlkID0gJ3ZhbmlsbGFqcy1pZnJhbWUtdjEnCiAgICAgIGxldCBmcmFtZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGZyYW1lSWQpOwogICAgICBsZXQgcmVtb3ZlSWZyYW1lRm4gPSBudWxsOwogICAgICBpZiAoIWZyYW1lKSB7CiAgICAgICAgZnJhbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpZnJhbWUnKTsKICAgICAgICBmcmFtZS5pZCA9IGZyYW1lSWQ7CiAgICAgICAgY29uc3QgYmxvYlVSTCA9IHR5cGVvZiB3ZWJraXRDYW5jZWxBbmltYXRpb25GcmFtZSA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2Yga2FnaSA9PT0gJ3VuZGVmaW5lZCcgPyAoZnJhbWUuc3JjID0gVVJMLmNyZWF0ZU9iamVjdFVSTChuZXcgQmxvYihbXSwgeyB0eXBlOiAndGV4dC9odG1sJyB9KSkpIDogbnVsbDsgLy8gYXZvaWQgQnJhdmUgQ3Jhc2gKICAgICAgICBmcmFtZS5zYW5kYm94ID0gJ2FsbG93LXNhbWUtb3JpZ2luJzsgLy8gc2NyaXB0IGNhbm5vdCBiZSBydW4gaW5zaWRlIGlmcmFtZSBidXQgQVBJIGNhbiBiZSBvYnRhaW5lZCBmcm9tIGlmcmFtZQogICAgICAgIGxldCBuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbm9zY3JpcHQnKTsgLy8gd3JhcCBpbnRvIE5PU0NSUElUIHRvIGF2b2lkIHJlZmxvdyAobGF5b3V0aW5nKQogICAgICAgIG4uYXBwZW5kQ2hpbGQoZnJhbWUpOwogICAgICAgIHdoaWxlICghZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50ICYmIG14LS0gPiAwKSBhd2FpdCBuZXcgUHJvbWlzZSh3YWl0Rm4pOyAvLyByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgaGVyZSBjb3VsZCBnZXQgbW9kaWZpZWQgYnkgWW91VHViZSBlbmdpbmUKICAgICAgICBjb25zdCByb290ID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwogICAgICAgIHJvb3QuYXBwZW5kQ2hpbGQobik7IC8vIHRocm93IGVycm9yIGlmIHJvb3QgaXMgbnVsbCBkdWUgdG8gZXhjZWVkaW5nIE1BWCBUUklBTAogICAgICAgIGlmIChibG9iVVJMKSBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IFVSTC5yZXZva2VPYmplY3RVUkwoYmxvYlVSTCkpOwoKICAgICAgICByZW1vdmVJZnJhbWVGbiA9IChzZXRUaW1lb3V0KSA9PiB7CiAgICAgICAgICBjb25zdCByZW1vdmVJZnJhbWVPbkRvY3VtZW50UmVhZHkgPSAoZSkgPT4gewogICAgICAgICAgICBlICYmIHdpbi5yZW1vdmVFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIiwgcmVtb3ZlSWZyYW1lT25Eb2N1bWVudFJlYWR5LCBmYWxzZSk7CiAgICAgICAgICAgIGUgPSBuOwogICAgICAgICAgICBuID0gd2luID0gcmVtb3ZlSWZyYW1lRm4gPSAwOwogICAgICAgICAgICBzZXRUaW1lb3V0ID8gc2V0VGltZW91dCgoKSA9PiBlLnJlbW92ZSgpLCAyMDApIDogZS5yZW1vdmUoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghc2V0VGltZW91dCB8fCBkb2N1bWVudC5yZWFkeVN0YXRlICE9PSAnbG9hZGluZycpIHsKICAgICAgICAgICAgcmVtb3ZlSWZyYW1lT25Eb2N1bWVudFJlYWR5KCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3aW4uYWRkRXZlbnRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsIHJlbW92ZUlmcmFtZU9uRG9jdW1lbnRSZWFkeSwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICB3aGlsZSAoIWZyYW1lLmNvbnRlbnRXaW5kb3cgJiYgbXgtLSA+IDApIGF3YWl0IG5ldyBQcm9taXNlKHdhaXRGbik7CiAgICAgIGNvbnN0IGZjID0gZnJhbWUuY29udGVudFdpbmRvdzsKICAgICAgaWYgKCFmYykgdGhyb3cgIndpbmRvdyBpcyBub3QgZm91bmQuIjsgLy8gdGhyb3cgZXJyb3IgaWYgcm9vdCBpcyBudWxsIGR1ZSB0byBleGNlZWRpbmcgTUFYIFRSSUFMCiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgeyByZXF1ZXN0QW5pbWF0aW9uRnJhbWUsIHNldEludGVydmFsLCBzZXRUaW1lb3V0LCBjbGVhckludGVydmFsLCBjbGVhclRpbWVvdXQgfSA9IGZjOwogICAgICAgIGNvbnN0IHJlcyA9IHsgcmVxdWVzdEFuaW1hdGlvbkZyYW1lLCBzZXRJbnRlcnZhbCwgc2V0VGltZW91dCwgY2xlYXJJbnRlcnZhbCwgY2xlYXJUaW1lb3V0IH07CiAgICAgICAgZm9yIChsZXQgayBpbiByZXMpIHJlc1trXSA9IHJlc1trXS5iaW5kKHdpbik7IC8vIG5lY2Vzc2FyeQogICAgICAgIGlmIChyZW1vdmVJZnJhbWVGbikgUHJvbWlzZS5yZXNvbHZlKHJlcy5zZXRUaW1lb3V0KS50aGVuKHJlbW92ZUlmcmFtZUZuKTsKICAgICAgICByZXR1cm4gcmVzOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgaWYgKHJlbW92ZUlmcmFtZUZuKSByZW1vdmVJZnJhbWVGbigpOwogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGNvbnNvbGUud2FybihlKTsKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CiAgfTsKCiAgY2xlYW5Db250ZXh0KHdpbikudGhlbihfX0NPTlRFWFRfXyA9PiB7CgogICAgaWYgKCFfX0NPTlRFWFRfXykgcmV0dXJuIG51bGw7CgogICAgY29uc3QgeyByZXF1ZXN0QW5pbWF0aW9uRnJhbWUsIHNldFRpbWVvdXQsIHNldEludGVydmFsLCBjbGVhclRpbWVvdXQsIGNsZWFySW50ZXJ2YWwgfSA9IF9fQ09OVEVYVF9fOwoKICAgIC8qKiBAdHlwZSB7RnVuY3Rpb258bnVsbH0gKi8KICAgIGxldCBhZkludGVydXB0ZXIgPSBudWxsOwoKICAgIGNvbnN0IGdldFJBRkhlbHBlciA9ICgpID0+IHsKICAgICAgY29uc3QgYXNjID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYS1mJyk7CiAgICAgIGlmICghKCdvbmFuaW1hdGlvbml0ZXJhdGlvbicgaW4gYXNjKSkgewogICAgICAgIHJldHVybiAocmVzb2x2ZSkgPT4gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGFmSW50ZXJ1cHRlciA9IHJlc29sdmUpOwogICAgICB9CiAgICAgIGFzYy5pZCA9ICdhLWYnOwogICAgICBsZXQgcXIgPSBudWxsOwogICAgICBhc2Mub25hbmltYXRpb25pdGVyYXRpb24gPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKHFyICE9PSBudWxsKSBxciA9IChxcigpLCBudWxsKTsKICAgICAgfQogICAgICBpZiAoIWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhZnNjcmlwdCcpKSB7CiAgICAgICAgY29uc3Qgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdHlsZScpOwogICAgICAgIHN0eWxlLmlkID0gJ2Fmc2NyaXB0JzsKICAgICAgICBzdHlsZS50ZXh0Q29udGVudCA9IGAKICAgICAgICAgIEBrZXlGcmFtZXMgYUYxIHsKICAgICAgICAgICAgMCUgewogICAgICAgICAgICAgIG9yZGVyOiAwOwogICAgICAgICAgICB9CiAgICAgICAgICAgIDEwMCUgewogICAgICAgICAgICAgIG9yZGVyOiAxOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICAjYS1mW2lkXSB7CiAgICAgICAgICAgIHZpc2liaWxpdHk6IGNvbGxhcHNlICFpbXBvcnRhbnQ7CiAgICAgICAgICAgIHBvc2l0aW9uOiBmaXhlZCAhaW1wb3J0YW50OwogICAgICAgICAgICBkaXNwbGF5OiBibG9jayAhaW1wb3J0YW50OwogICAgICAgICAgICB0b3A6IC0xMDBweCAhaW1wb3J0YW50OwogICAgICAgICAgICBsZWZ0OiAtMTAwcHggIWltcG9ydGFudDsKICAgICAgICAgICAgbWFyZ2luOjAgIWltcG9ydGFudDsKICAgICAgICAgICAgcGFkZGluZzowICFpbXBvcnRhbnQ7CiAgICAgICAgICAgIG91dGxpbmU6MCAhaW1wb3J0YW50OwogICAgICAgICAgICBib3JkZXI6MCAhaW1wb3J0YW50OwogICAgICAgICAgICB6LWluZGV4Oi0xICFpbXBvcnRhbnQ7CiAgICAgICAgICAgIHdpZHRoOiAwcHggIWltcG9ydGFudDsKICAgICAgICAgICAgaGVpZ2h0OiAwcHggIWltcG9ydGFudDsKICAgICAgICAgICAgY29udGFpbjogc3RyaWN0ICFpbXBvcnRhbnQ7CiAgICAgICAgICAgIHBvaW50ZXItZXZlbnRzOiBub25lICFpbXBvcnRhbnQ7CiAgICAgICAgICAgIGFuaW1hdGlvbjogMW1zIHN0ZXBzKDIsIGp1bXAtbm9uZSkgMG1zIGluZmluaXRlIGFsdGVybmF0ZSBmb3J3YXJkcyBydW5uaW5nIGFGMSAhaW1wb3J0YW50OwogICAgICAgICAgfQogICAgICAgIGA7CiAgICAgICAgKGRvY3VtZW50LmhlYWQgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KS5hcHBlbmRDaGlsZChzdHlsZSk7CiAgICAgIH0KICAgICAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50Lmluc2VydEJlZm9yZShhc2MsIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5maXJzdENoaWxkKTsKICAgICAgcmV0dXJuIChyZXNvbHZlKSA9PiAocXIgPSBhZkludGVydXB0ZXIgPSByZXNvbHZlKTsKICAgIH07CgogICAgLyoqIEB0eXBlIHsocmVzb2x2ZTogKCkgPT4gdm9pZCl9ICAqLwogICAgY29uc3QgcmFmUE4gPSBnZXRSQUZIZWxwZXIoKTsgLy8gckFGIHdpbGwgbm90IGV4ZWN1dGUgaWYgZG9jdW1lbnQgaXMgaGlkZGVuCgogICAgKCgpID0+IHsKICAgICAgbGV0IGFmUHJvbWlzZVAsIGFmUHJvbWlzZVE7IC8vIG5vbi1udWxsCiAgICAgIGFmUHJvbWlzZVAgPSBhZlByb21pc2VRID0geyByZXNvbHZlZDogdHJ1ZSB9OyAvLyBpbml0aWFsIHN0YXRlIGZvciAhdVAgJiYgIXVRCiAgICAgIGxldCBhZml4ID0gMDsKICAgICAgY29uc3QgYWZSZXNvbHZlID0gYXN5bmMgKHJYKSA9PiB7CiAgICAgICAgYXdhaXQgbmV3IFByb21pc2UocmFmUE4pOwogICAgICAgIHJYLnJlc29sdmVkID0gdHJ1ZTsKICAgICAgICBjb25zdCB0ID0gKythZml4OwogICAgICAgIGlmICh0ID4gOWU5KSBhZml4ID0gOTsKICAgICAgICByZXR1cm4gclgucmVzb2x2ZSh0KSwgdDsKICAgICAgfTsKICAgICAgY29uc3QgZUZ1bmMgPSBhc3luYyAoKSA9PiB7CiAgICAgICAgY29uc3QgdVAgPSAhYWZQcm9taXNlUC5yZXNvbHZlZCA/IGFmUHJvbWlzZVAgOiBudWxsOwogICAgICAgIGNvbnN0IHVRID0gIWFmUHJvbWlzZVEucmVzb2x2ZWQgPyBhZlByb21pc2VRIDogbnVsbDsKICAgICAgICBsZXQgdCA9IDA7CiAgICAgICAgaWYgKHVQICYmIHVRKSB7CiAgICAgICAgICBjb25zdCB0MSA9IGF3YWl0IHVQOwogICAgICAgICAgY29uc3QgdDIgPSBhd2FpdCB1UTsKICAgICAgICAgIHQgPSB0MSA+IHQyICYmIHQxIC0gdDIgPCA4ZTkgPyB0MSA6IHQyOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zdCB2UCA9ICF1UCA/IChhZlByb21pc2VQID0gbmV3IFByb21pc2VFeHRlcm5hbCgpKSA6IG51bGw7CiAgICAgICAgICBjb25zdCB2USA9ICF1USA/IChhZlByb21pc2VRID0gbmV3IFByb21pc2VFeHRlcm5hbCgpKSA6IG51bGw7CiAgICAgICAgICBpZiAodVEpIGF3YWl0IHVROyBlbHNlIGlmICh1UCkgYXdhaXQgdVA7CiAgICAgICAgICBpZiAodlApIHQgPSBhd2FpdCBhZlJlc29sdmUodlApOwogICAgICAgICAgaWYgKHZRKSB0ID0gYXdhaXQgYWZSZXNvbHZlKHZRKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHQ7CiAgICAgIH0KICAgICAgY29uc3QgaW5FeGVjID0gbmV3IFNldCgpOwogICAgICBjb25zdCB3RnVuYyA9IGFzeW5jIChoYW5kbGVyLCB3U3RvcmUpID0+IHsKICAgICAgICB0cnkgewogICAgICAgICAgY29uc3QgY3QgPSBEYXRlLm5vdygpOwogICAgICAgICAgaWYgKGN0IC0gdGltZXVwZGF0ZURUKCkgPCA4MDAgJiYgY3QgLSB3U3RvcmUuZHQgPCA4MDApIHsKICAgICAgICAgICAgY29uc3QgY2lkID0gd1N0b3JlLmNpZDsKICAgICAgICAgICAgaW5FeGVjLmFkZChjaWQpOwogICAgICAgICAgICBjb25zdCB0ID0gYXdhaXQgZUZ1bmMoKTsKICAgICAgICAgICAgY29uc3QgZGlkTm90UmVtb3ZlID0gaW5FeGVjLmRlbGV0ZShjaWQpOyAvLyB0cnVlIGZvciB2YWxpZCBrZXkKICAgICAgICAgICAgaWYgKCFkaWROb3RSZW1vdmUgfHwgdCA9PT0gd1N0b3JlLmxhc3RFeGVjdXRpb24pIHJldHVybjsKICAgICAgICAgICAgd1N0b3JlLmxhc3RFeGVjdXRpb24gPSB0OwogICAgICAgICAgfQogICAgICAgICAgd1N0b3JlLmR0ID0gY3Q7CiAgICAgICAgICBoYW5kbGVyKCk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY29uc29sZS5lcnJvcihlKTsKICAgICAgICAgIHRocm93IGU7CiAgICAgICAgfQogICAgICB9OwogICAgICBjb25zdCBzRnVuYyA9IChwcm9wRnVuYykgPT4gewogICAgICAgIHJldHVybiAoZnVuYywgbXMgPSAwLCAuLi5hcmdzKSA9PiB7CiAgICAgICAgICBpZiAodHlwZW9mIGZ1bmMgPT09ICdmdW5jdGlvbicpIHsgLy8gaWdub3JlIGFsbCBub24tZnVuY3Rpb24gcGFyYW1ldGVyIChlLmcuIHN0cmluZykKICAgICAgICAgICAgY29uc3Qgd1N0b3JlID0geyBkdDogRGF0ZS5ub3coKSB9OwogICAgICAgICAgICByZXR1cm4gKHdTdG9yZS5jaWQgPSBwcm9wRnVuYyh3RnVuYywgbXMsIChhcmdzLmxlbmd0aCA+IDAgPyBmdW5jLmJpbmQobnVsbCwgLi4uYXJncykgOiBmdW5jKSwgd1N0b3JlKSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gcHJvcEZ1bmMoZnVuYywgbXMsIC4uLmFyZ3MpOwogICAgICAgICAgfQogICAgICAgIH07CiAgICAgIH07CiAgICAgIHdpbi5zZXRUaW1lb3V0ID0gc0Z1bmMoc2V0VGltZW91dCk7CiAgICAgIHdpbi5zZXRJbnRlcnZhbCA9IHNGdW5jKHNldEludGVydmFsKTsKCiAgICAgIGNvbnN0IGRGdW5jID0gKHByb3BGdW5jKSA9PiB7CiAgICAgICAgcmV0dXJuIChjaWQpID0+IHsKICAgICAgICAgIGlmIChjaWQpIGluRXhlYy5kZWxldGUoY2lkKSB8fCBwcm9wRnVuYyhjaWQpOwogICAgICAgIH07CiAgICAgIH07CgogICAgICB3aW4uY2xlYXJUaW1lb3V0ID0gZEZ1bmMoY2xlYXJUaW1lb3V0KTsKICAgICAgd2luLmNsZWFySW50ZXJ2YWwgPSBkRnVuYyhjbGVhckludGVydmFsKTsKCiAgICAgIHRyeSB7CiAgICAgICAgd2luLnNldFRpbWVvdXQudG9TdHJpbmcgPSBzZXRUaW1lb3V0LnRvU3RyaW5nLmJpbmQoc2V0VGltZW91dCk7CiAgICAgICAgd2luLnNldEludGVydmFsLnRvU3RyaW5nID0gc2V0SW50ZXJ2YWwudG9TdHJpbmcuYmluZChzZXRJbnRlcnZhbCk7CiAgICAgICAgd2luLmNsZWFyVGltZW91dC50b1N0cmluZyA9IGNsZWFyVGltZW91dC50b1N0cmluZy5iaW5kKGNsZWFyVGltZW91dCk7CiAgICAgICAgd2luLmNsZWFySW50ZXJ2YWwudG9TdHJpbmcgPSBjbGVhckludGVydmFsLnRvU3RyaW5nLmJpbmQoY2xlYXJJbnRlcnZhbCk7CiAgICAgIH0gY2F0Y2ggKGUpIHsgY29uc29sZS53YXJuKGUpIH0KCiAgICB9KSgpOwoKICAgIGxldCBtSW50ZXJ1cHRlciA9IG51bGw7CiAgICBzZXRJbnRlcnZhbCgoKSA9PiB7CiAgICAgIGlmIChtSW50ZXJ1cHRlciA9PT0gYWZJbnRlcnVwdGVyKSB7CiAgICAgICAgaWYgKG1JbnRlcnVwdGVyICE9PSBudWxsKSBhZkludGVydXB0ZXIgPSBtSW50ZXJ1cHRlciA9IChtSW50ZXJ1cHRlcigpLCBudWxsKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBtSW50ZXJ1cHRlciA9IGFmSW50ZXJ1cHRlcjsKICAgICAgfQogICAgfSwgMTI1KTsKICB9KTsKCn0pKG51bGwpOwo="},{"name":"YouTube JS Engine Tamer","options":{"check_for_updates":true,"user_modified":null,"comment":null,"compatopts_for_requires":true,"compat_wrappedjsobject":false,"compat_metadata":false,"compat_foreach":false,"compat_powerful_this":null,"sandbox":null,"noframes":null,"unwrap":true,"run_at":null,"tab_types":null,"override":{"use_includes":[],"orig_includes":[],"merge_includes":true,"use_matches":[],"orig_matches":["https://www.youtube.com/*"],"merge_matches":true,"use_excludes":[],"orig_excludes":[],"merge_excludes":true,"use_connects":[],"orig_connects":[],"merge_connects":true,"use_blockers":[],"orig_run_at":"document-start","orig_noframes":null,"orig_run_in":[]},"run_in":null,"tags":[]},"storage":{"ts":1722482168938,"data":{}},"enabled":true,"position":4,"file_url":"https://update.greasyfork.org/scripts/473972/YouTube%20JS%20Engine%20Tamer.user.js","uuid":"2550dd19-d32f-4ab6-a167-486f88aff601","source":"Ly8gPT1Vc2VyU2NyaXB0PT0KLy8gQG5hbWUgICAgICAgIFlvdVR1YmUgSlMgRW5naW5lIFRhbWVyCi8vIEBuYW1lc3BhY2UgICBVc2VyU2NyaXB0cwovLyBAbWF0Y2ggICAgICAgaHR0cHM6Ly93d3cueW91dHViZS5jb20vKgovLyBAdmVyc2lvbiAgICAgMC4xNi4xNgovLyBAbGljZW5zZSAgICAgTUlUCi8vIEBhdXRob3IgICAgICBDWSBGdW5nCi8vIEBpY29uICAgICAgICBodHRwczovL3Jhdy5naXRodWJ1c2VyY29udGVudC5jb20vY3lmdW5nMTAzMS91c2Vyc2NyaXB0LXN1cHBvcnRzL21haW4vaWNvbnMveXQtZW5naW5lLnBuZwovLyBAZGVzY3JpcHRpb24gVG8gZW5oYW5jZSBZb3VUdWJlIHBlcmZvcm1hbmNlIGJ5IG1vZGlmeWluZyBZb3VUdWJlIEpTIEVuZ2luZQovLyBAZ3JhbnQgICAgICAgbm9uZQovLyBAcmVxdWlyZSAgICAgaHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L2doL2N5ZnVuZzEwMzEvdXNlcnNjcmlwdC1zdXBwb3J0c0A3MjIxYTRlZmZmZDQ5ZDg1MmRlMDA3NGVjNTAzZDRmZWJiOTlmMjhiL2xpYnJhcnkvbmV4dEJyb3dzZXJUaWNrLm1pbi5qcwovLyBAcnVuLWF0ICAgICAgZG9jdW1lbnQtc3RhcnQKLy8gQHVud3JhcAovLyBAaW5qZWN0LWludG8gcGFnZQovLyBAYWxsRnJhbWVzICAgdHJ1ZQovLyBAZG93bmxvYWRVUkwgaHR0cHM6Ly91cGRhdGUuZ3JlYXN5Zm9yay5vcmcvc2NyaXB0cy80NzM5NzIvWW91VHViZSUyMEpTJTIwRW5naW5lJTIwVGFtZXIudXNlci5qcwovLyBAdXBkYXRlVVJMIGh0dHBzOi8vdXBkYXRlLmdyZWFzeWZvcmsub3JnL3NjcmlwdHMvNDczOTcyL1lvdVR1YmUlMjBKUyUyMEVuZ2luZSUyMFRhbWVyLm1ldGEuanMKLy8gPT0vVXNlclNjcmlwdD09CgooKCkgPT4gewoKICBjb25zdCBXZWFrTWFwID0gd2luZG93LldlYWtNYXBPcmlnaW5hbCB8fCB3aW5kb3cuV2Vha01hcDsKCiAgY29uc3QgTkFUSVZFX0NBTlZBU19BTklNQVRJT04gPSBmYWxzZTsgLy8gZm9yICNjaW5lbWF0aWNzCiAgY29uc3QgRklYX3NjaGVkdWxlckluc3RhbmNlSW5zdGFuY2UgPSAyIHwgNDsKICBjb25zdCBGSVhfeXRfcGxheWVyID0gdHJ1ZTsgLy8gRE9OVCBDSEFOR0UKICBjb25zdCBGSVhfQW5pbWF0aW9uX25fdGltZWxpbmUgPSB0cnVlOwogIGNvbnN0IE5PX1BSRUxPQURfR0VORVJBVEVfMjA0ID0gZmFsc2U7CiAgY29uc3QgRU5BQkxFX0NPTVBVVEVEU1RZTEVfQ0FDSEUgPSB0cnVlOwogIGNvbnN0IE5PX1NDSEVEVUxJTkdfRFVFX1RPX0NPTVBVVEVEU1RZTEUgPSB0cnVlOwogIGNvbnN0IENIQU5HRV9hcHBlbmRDaGlsZCA9IHRydWU7IC8vIGRpc2N1c3Npb25zIzIzNjc1OQogIGNvbnN0IEZJWF9iaW5kX3NlbGZfdGhpcyA9IGZhbHNlO+OAgC8vIEVYUEVSSU1FTlRBTCAhISEhISB0aGlzIGFmZmVjdCBwYWdlIHN3aXRjaCBhZnRlciBsaXZlIGVuZHMKICBjb25zdCBGSVhfd2Vha01hcF93ZWFrUmVmID0gZmFsc2U7IC8vIEVYUEVSSU1FTlRBTCAhISEhISBNaWdodCBJbmNvbXBhdGlibGUgdG8gc29tZSB1c2Vyc2NyaXB0cyAoYXMgdGhlIHN0cm9uZyByZWxhdGlvbnNoaXAgaXMgcmVtb3ZlZCkKCiAgY29uc3QgRklYX2Vycm9yX21hbnlfc3RhY2sgPSB0cnVlOyAvLyBzaG91bGQgYmUgYSBidWcgY2F1c2VkIGJ5IHVCbG9jayBPcmlnaW4KICAvLyBjb25zdCBGSVhfZXJyb3JfbWFueV9zdGFja19rZWVwQWxpdmVEdXJhdGlvbiA9IDIwMDsgLy8gbXMKICAvLyBjb25zdCBGSVhfZXJyb3JfbWFueV9zdGFja19rZWVwQWxpdmVEdXJhdGlvbl9jaGVja19pZl9uX2xhcmdlcl90aGFuID0gODsKCiAgY29uc3QgRklYX0lmcmFtZV9OVUxMX1NSQyA9IGZhbHNlOwoKICBjb25zdCBJR05PUkVfYmluZEFuaW1hdGlvbkZvckN1c3RvbUVmZmVjdCA9IHRydWU7IC8vIHByZXZlbnQgYHYuYmluZEFuaW1hdGlvbkZvckN1c3RvbUVmZmVjdCh0aGlzKTtgIGJlaW5nIGV4ZWN1dGVkCgogIGNvbnN0IEZJWF95dGRFeHBhbmRlcl9jaGlsZHJlbkNoYW5nZWQgPSB0cnVlOwogIGNvbnN0IEZJWF9wYXBlcl9yaXBwbGVfYW5pbWF0ZSA9IHRydWU7CiAgY29uc3QgRklYX2F2b2lkX2luY29ycmVjdF92aWRlb19tZXRhID0gdHJ1ZTsgLy8gb21pdCB0aGUgaW5jb3JyZWN0IHl0LWFuaW1hdGVkLXJvbGxpbmctbnVtYmVyCiAgY29uc3QgRklYX2F2b2lkX2luY29ycmVjdF92aWRlb19tZXRhX2VtaXR0ZXJCZWhhdmlvciA9IHRydWU7CgogIGNvbnN0IEZJWF9kb0lkb21SZW5kZXIgPSB0cnVlOwoKICBjb25zdCBGSVhfU2hhZHkgPSB0cnVlOwoKICAvLyBbWyAyMDI0LjA0LjI0IF1dCiAgY29uc3QgTU9ESUZZX1NoYWR5RE9NX09CSiA9IHRydWU7CiAgLy8gPDwgaWYgTU9ESUZZX1NoYWR5RE9NX09CSiA+PgogIGNvbnN0IFdFQUtSRUZfU2hhZHlET00gPSB0cnVlOwogIGNvbnN0IE9NSVRfU2hhZHlET01fRVhQRVJJTUVOVEFMID0gMSB8IDA7IC8vIDEgPT4gZW5hYmxlOyAyID0+IGNvbXBvc2VkUGF0aAogIGNvbnN0IE9NSVRfU2hhZHlET01fc2V0dGluZ3MgPSAwIHwgMCB8IDA7IC8vIDE6IGluVXNlOyAyOiBoYW5kbGVzRHluYW1pY1Njb3Bpbmc7IDQ6IGZvcmNlIC8vIHt7IFBSRUxJTSBURVNUSU5HIFBVUlBPU0UgfX0KICAvLyA8PCBlbmQgPj4KCiAgY29uc3QgV0VBS19SRUZfQklORElOR19DT05UUk9MID0gMSB8IDI7IC8vIDIgLSBjb25mbGljdCBjb250cm9sIHdpdGggU2hhZHlET00gd2Vha3JlZgoKICBjb25zdCBGSVhfeXRBY3Rpb25fID0gdHJ1ZTsgLy8geXRkLWFwcAogIGNvbnN0IEZJWF9vblZpZGVvRGF0YUNoYW5nZSA9IGZhbHNlOwogIC8vIGNvbnN0IEZJWF9vbkNsaWNrID0gdHJ1ZTsKICBjb25zdCBGSVhfb25TdGF0ZUNoYW5nZSA9IHRydWU7CiAgY29uc3QgRklYX29uTG9vcFJhbmdlQ2hhbmdlID0gdHJ1ZTsKICAvLyBjb25zdCBGSVhfbWF5YmVVcGRhdGVGbGV4aWJsZU1lbnUgPSB0cnVlOyAvLyB5dGQtbWVudS1yZW5kZXJlcgogIGNvbnN0IEZJWF9WaWRlb0VWRU5UU192MiA9IHRydWU7IC8vIHRydWUgbWlnaHQgY2F1c2UgYnVnIGluIHN3aXRjaGluZyBwYWdlCgogIGNvbnN0IFNDUklQVExFVF9OT0ZJWF9zZXRUaW1lb3V0ID0gdHJ1ZTsKICBjb25zdCBFTkFCTEVfZGlzY3JldGVUYXNraW5nID0gdHJ1ZTsKICAvLyA8PCBpZiBFTkFCTEVfZGlzY3JldGVUYXNraW5nID4+CiAgY29uc3QgRklYX3N0YW1wRG9tQXJyYXlfc3RhYmxlTGlzdCA9IHRydWU7CiAgY29uc3QgRU5BQkxFX3dlYWtlblN0YW1wUmVmZXJlbmNlcyA9IHRydWU7IC8vIGRpc2FibGVkIGluIG9sZCBicm93c2VycwogIC8vIDw8IGVuZCA+PgoKICBjb25zdCBGSVhfcGVyZk5vdyA9IHRydWU7IC8vIGhpc3Rvcnkgc3RhdGUgaXNzdWU7IHNlZSBodHRwczovL2J1Z3ppbGxhLm1vemlsbGEub3JnL3Nob3dfYnVnLmNnaT9pZD0xNzU2OTcwCiAgY29uc3QgRU5BQkxFX0FTWU5DX0RJU1BBVENIRVZFTlQgPSBmYWxzZTsgLy8gcHJvYmxlbWF0aWMKCiAgY29uc3QgVU5MT0FEX0RFVEFDSEVEX1BPTFlNRVIgPSBmYWxzZTsgLy8gdW5zdGFibGUKICBjb25zdCBGSVhfUG9seW1lcl9kb20gPSB0cnVlOwoKICBjb25zdCBXRUFLX1JFRl9CSU5ESU5HID0gZmFsc2U7IC8vIGZhbHNlIGlmIHlvdXIgYnJvd3NlciBpcyBzbG93IC8vIGRpc2FibGVkIGR1ZSB0byBtZW1vcnkgbGVha2FnZQogIC8vIDw8IGlmIFdFQUtfUkVGX0JJTkRJTkcgPj4KICBjb25zdCBXRUFLX1JFRl9QUk9YWV9ET0xMQVIgPSB0cnVlOyAvLyBmYWxzZSBpZiB5b3VyIGJyb3dzZXIgaXMgc2xvdwogIC8vIDw8IGVuZCA+PgoKICBjb25zdCBTQ1JJUFRMRVRfUkVNT1ZFX1BSVU5FX3Byb3BOZWVkbGVzID0gdHJ1ZTsgLy8gYnJhdmUgc2NyaXB0bGV0IHJlbGF0ZWQKICBjb25zdCBERUJVR19yZW1vdmVQcnVuZSA9IGZhbHNlOyAvLyB0cnVlIGZvciBERUJVRwoKICBjb25zdCBGSVhfWEhSX1JFUVVFU1RJTkcgPSB0cnVlOwogIGNvbnN0IEZJWF9WSURFT19CTE9DS0lORyA9IGZhbHNlOyAvLyB1c3VhbGx5IGl0IGlzIGEgYWRzIGJsb2NrIGlzc3VlIC8vIGRpc2FibGVkIGR1ZSB0byBtZW1vcnkgbGVha2FnZQoKICBjb25zdCBMT0dfRkVUQ0hNRVRBX1VQREFURSA9IGZhbHNlOyAvLyBmb3IgREVCVUcKCiAgY29uc3QgSUdOT1JFX2J1ZmZlcmhlYWx0aF9DSEVDSyA9IGZhbHNlOyAvLyBleHBlcmltZW50YWw7IHRydWUgd2lsbCBtYWtlICJTdGF0cyBmb3IgbmVyZHMiIG5vIGluZm8uCgogIGNvbnN0IERFTllfcmVxdWVzdFN0b3JhZ2VBY2Nlc3MgPSB0cnVlOyAvLyByZW1vdmUgZG9jdW1lbnQucmVxdWVzdFN0b3JhZ2VBY2Nlc3MKICBjb25zdCBESVNBQkxFX0lGUkFNRV9yZXF1ZXN0U3RvcmFnZUFjY2VzcyA9IHRydWU7IC8vIG5vIGVmZmVjdCBpZiBERU5ZX3JlcXVlc3RTdG9yYWdlQWNjZXNzIGlzIHRydWUKCiAgY29uc3QgRElTQUJMRV9DT09MRE9XTl9TQ1JPTExJTkcgPSB0cnVlOyAvLyBZVCBjYXVzZSBzY3JvbGwgaGFuZyBpbiBNYWNPUwoKICBjb25zdCBGSVhfcmVtb3ZlQ2hpbGQgPSB0cnVlOwogIGNvbnN0IEZJWF9maXhfcmVxdWVzdElkbGVDYWxsYmFja190aW1pbmcgPSB0cnVlOwoKICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSBTaG9ydGtleSBLZXlib2FyZCBDb250cm9sIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tCiAgLy8gZGVwZW5kZW5jeTogRklYX3l0X3BsYXllcgoKICBjb25zdCBGSVhfU0hPUlRDVVRLRVlTID0gMjsgLy8gMCAtIG5vIGZpeDsgMSAtIGJhc2ljIGZpeDsgMiAtIGFkdmFuY2VkIGZpeAogIC8vIFswXSBubyBmaXggLSBub3QgcmVjb21tZW5kZWQKICAvLyBbMV0gYmFzaWMgZml4IC0ganVzdCBmaXggdGhlIGdsb2JhbCBmb2N1cyBkZXRlY3Rpb24gdmFyaWFibGUKICAvLyBbMl0gYWR2YW5jZWQgZml4IC0gY2FsbCB0aGUgc2hvcnRjdXQgYWN0aW9ucyBkaXJlY3RseSwgYXV0byBmb3VjcyBjaGFuZ2UsIGRpcmVjdCBjb250cm9sIG9mIHNwYWNlYmFyIGJlaGF2aW9yLCBldGMKICAvLyAobm90ZSkgMCBvciAxIGlmIHlvdSBmaW5kIGNvbmZsaWN0IHdpdGggb3RoZXIgdXNlcnNjcmlwdHMvcGx1Z2luCgogIGNvbnN0IENIQU5HRV9TUEVFRE1BU1RFUl9TUEFDRUJBUl9DT05UUk9MID0gMDsgLy8gMCAtIGRpc2FibGU7IDEgLSBmb3JjZSB0cnVlOyAyIC0gZm9yY2UgZmFsc2UKICBjb25zdCBVU0VfSU1QUk9WRURfUEFVU0VSRVNVTUVfVU5ERVJfTk9fU1BFRURNQVNURVIgPSB0cnVlOyAvLyBvbmx5IGZvciBTUEVFRE1BU1RFUiA9IGZhbHNlICYgRklYX1NIT1JUQ1VUS0VZUyA9IDIKCiAgY29uc3QgUFJPUF9PdmVyUmVJbmNsdXNpb25fQVZPSUQgPSB0cnVlOwogIGNvbnN0IFBST1BfT3ZlclJlSW5jbHVzaW9uX0RFQlVHTE9HID0gZmFsc2U7CiAgY29uc3QgUFJPUF9PdmVyUmVJbmNsdXNpb25fTElTVCA9IG5ldyBTZXQoWwogICAgJ2hvc3RFbGVtZW50NzInLAogICAgJ3BhcmVudENvbXBvbmVudDcyJywKICAgICdsb2NhbFZpc2liaWxpdHlPYnNlcnZlcl83MicsCiAgICAnY2FjaGVkUHJvdmlkZXJOb2RlXzcyJywKICAgICdfX3RlbXBsYXRlNzInLAogICAgJ19fdGVtcGxhdGl6ZU93bmVyNzInLAogICAgJ19fdGVtcGxhdGVJbmZvNzInLAogICAgJ19fZGF0YUhvc3Q3MicsCiAgICAnX19DRV9zaGFkb3dSb290NzInLAogICAgJ2VsZW1lbnRzXzcyJywKCiAgICAna3kzNicsCiAgICAna3o2MicsCiAgICAnbTgyMicsCgoKCiAgICAvLyBUbyBiZSByZXZpZXdlZC4KCiAgICAvLyBjaGF0IG1lc3NhZ2VzCiAgICAnZGlzYWJsZWQnLCAnYWxsb3dlZFByb3BzJywKICAgICdmaWxsZWRCdXR0b25PdmVycmlkZXMnLCAnb3BlblBvcHVwQ29uZmlnJywgJ3N1cHBvcnRzSW5saW5lQWN0aW9uQnV0dG9ucycsICdhbGxvd2VkUHJvcHMnLAoKICAgICdkaW1lbnNpb24nLCAnbG9hZFRpbWUnLCAncGVuZGluZ1BhaW50JywKCiAgICAnY291bnRkb3duRHVyYXRpb25NcycsICdjb3VudGRvd25NcycsICdsYXN0Q291bnRkb3duVGltZU1zJywgJ3JhZklkJywgJ3BsYXllclByb2dyZXNzU2VjJywgJ2RldGxhU2luY2VQYXVzZWRTZWNzJywgJ2JlaGF2aW9yQWN0aW9uTWFwJywgJ3NlbGVjdGVkJywgJ21heExpa2VDb3VudCcsICdtYXhSZXBseUNvdW50JywgJ2lzTW91c2VPdmVyJywKCiAgICAncmVzcGVjdExhbmdEaXInLCAnbm9FbmRwb2ludHMnLAoKCiAgICAnb2JqZWN0VVJMJywKICAgICdidXR0b25PdmVycmlkZXMnLCAncXVldWVkTWVzc2FnZXMnLAogICAgJ1NURVAnLCAnQkxPQ0tfT04nLCAnTUlOX1BST0dFU1MnLCAnTUFYX1BST0dFU1MnLAogICAgJ0RJU01JU1NFRF9DT05URU5UX0tFWVNQQUNFJywgJ2ZvbGxvd1VwRGlhbG9nUHJvbWlzZScsICdmb2xsb3dVcERpYWxvZ1Byb21pc2VSZXNvbHZlJywgJ2ZvbGxvd1VwRGlhbG9nUHJvbWlzZVJlamVjdCcsCiAgICAnaG92ZXJKb2JJZCcsICdKU0MkMTQ1NzNfdG91Y2hlZCcsCgoKICAgIC8vIHRiYwogICAgJ3RvZ2dsZWFibGUnLCAnaXNDb25uZWN0ZWQnLAogICAgJ3Njcm9sbERpc3RhbmNlJywgJ2RyYWdnaW5nJywgJ2RyYWdNb3VzZVN0YXJ0JywgJ2RyYWdPZmZzZXRTdGFydCcsICdjb250YWluZXJXaWR0aERpZmYnLAogICAgJ2Rpc2FibGVEZXNlbGVjdEV2ZW50JywKICAgICdlbW9qaVNpemUnLAoKICAgICdidXR0b25PdmVycmlkZScsCiAgICAnc2hvdWxkVXNlU3RpY2t5UHJlZmVyZW5jZXMnLCAnbG9uZ1ByZXNzVGltZW91dElkJywKCiAgICAvLyBvdGhlcnMKICAgICdvYnNlcnZlVmlzaWJsZU9wdGlvbicsICdvYnNlcnZlSGlkZGVuT3B0aW9uJywgJ29ic2VydmVQcmVzY2FuT3B0aW9uJywgJ3Zpc2liaWxpdHlNb25pdG9yS2V5cycsCiAgICAvLyAnZmlsbGVkQnV0dG9uT3ZlcnJpZGVzJywgJ29wZW5Qb3B1cENvbmZpZycsICdzdXBwb3J0c0lubGluZUFjdGlvbkJ1dHRvbnMnLAogICAgJ29ic2VydmVWaXNpYmxlT3B0aW9uJywgJ29ic2VydmVIaWRkZW5PcHRpb24nLCAnb2JzZXJ2ZVByZXNjYW5PcHRpb24nLCAndmlzaWJpbGl0eU1vbml0b3JLZXlzJywKICAgIC8vICAnZGltZW5zaW9uJywgJ2xvYWRUaW1lJywgJ3BlbmRpbmdQYWludCcsCiAgICAvLyAgJ2Rpc2FibGVkJywgJ2FsbG93ZWRQcm9wcycsCgoKICAgIC8vICdlbmFibGVNc3NMYXp5TG9hZCcsICdwb3B1cENvbnRhaW5lckNvbmZpZycsICdhY3Rpb25Sb3V0ZXJOb2RlJywgJ2FjdGlvblJvdXRlcklzUm9vdCcsICdhY3Rpb25NYXAnLCAnZHluYW1pY0FjdGlvbk1hcCcsCiAgICAvLyAnYWN0aW9uTWFwJywKCiAgICAvLyAnc2hhcmVkVG9vbHRpcFBvc2l0aW9uJywgJ3NoYXJlZFRvb2x0aXBBbmltYXRpb25EZWxheScsICdkaXNhYmxlRW1vamlQaWNrZXJJbmNyZW1lbnRhbExvYWRpbmcnLCAndXNlUmVzb2x2ZUNvbW1hbmQnLCAnYWN0aXZlUmVxdWVzdCcsICdwb3BvdXRXaW5kb3dDaGVja0ludGVydmFsSWQnLCAnc3VwcG9ydGVkVG9vbHRpcFRhcmdldHMnLCAnY2xvc2VBY3Rpb25QYW5lbFRpbWVySWQnLCAnZGVsYXlDbG9zZUFjdGlvblBhbmVsVGltZXJJZCcsICd0b29sdGlwVGltZXJJZHMnLCAncXVldWVkVG9vbHRpcHMnLCAnaXNQb3B1cENvbmZpZ1JlYWR5JywgJ3BvcG91dFdpbmRvdycsICdhY3Rpb25NYXAnLAoKICAgICdjbGVhclRpbWVvdXQnLAogICAgJ3N3aXRjaFRlbXBsYXRlQXRSZWdpc3RyYXRpb24nLCAnaGFzVW5tb3VudGVkJywKICAgICdzd2l0Y2hUZW1wbGF0ZUF0UmVnaXN0cmF0aW9uJywgJ3N0b3BLZXlib2FyZEV2ZW50UHJvcGFnYXRpb24nLAogICAgJ3RhbmdvQ29uZmlndXJhdGlvbicsCiAgICAnaXRlbUlkVG9Eb2NrRHVyYXRpb25NYXAnLAogICAgJ2FjdGlvbk1hcCcsCgogICAgJ2Vtb2ppTWFuYWdlcicsICdpbnB1dE1ldGhvZEVkaXRvckFjdGl2ZScsICdzdWdnZXN0aW9uSW5kZXgnLCAnSlNDJDEwNzQ1X2xhc3RTdWdnZXN0aW9uUmFuZ2UnLAogICAgJ2FjdGlvbk1hcCcsICdhc3luY0hhbmRsZScsICdzaG91bGRBbmltYXRlSW4nLCAnbGFzdEZyYW1lVGltZXN0YW1wJywgJ3Njcm9sbENsYW1wUmFmJywKICAgICdzY3JvbGxSYXRlUGl4ZWxzUGVyU2Vjb25kJywgJ3Njcm9sbFN0YXJ0VGltZScsICdzY3JvbGxTdG9wSGFuZGxlJwoKICAgIC8vICdidXR0b25PdmVycmlkZXMnLCAncXVldWVkTWVzc2FnZXMnLCAnY2xlYXJUaW1lb3V0JywgJ2FjdGlvbk1hcCcsCiAgICAvLyAnc3RvcEtleWJvYXJkRXZlbnRQcm9wYWdhdGlvbicsICdlbW9qaVNpemUnLAogICAgLy8gJ3N3aXRjaFRlbXBsYXRlQXRSZWdpc3RyYXRpb24nLCAnaGFzVW5tb3VudGVkJywKICAgIC8vICdidXR0b25PdmVycmlkZXMnLCAncXVldWVkTWVzc2FnZXMnLCAnY2xlYXJUaW1lb3V0JywgJ2FjdGlvbk1hcCcsCiAgICAvLyAnaXNSZXVzYWJsZScsICd0YW5nb0NvbmZpZ3VyYXRpb24nLAogICAgLy8gJ2l0ZW1JZFRvRG9ja0R1cmF0aW9uTWFwJywgJ2JvdHRvbUFsaWduTWVzc2FnZXMnLCAnYWN0aW9uTWFwJywKICAgIC8vICovCgogIF0pOwoKCiAgLy8gY29uc3QgQ0FOX1RVTkVfVk9MVU1OX0FGVEVSX1JFU1VNRV9PUl9QQVVTRSA9IGZhbHNlOyAvLyBOTyBVU0U7IFRPIEJFIFJFVklFV0VECgogIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tIFNob3J0a2V5IEtleWJvYXJkIENvbnRyb2wgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KCiAgLyoKICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdlZG0nLCgpPT57CiAgICAgIGxldCBwID0gWy4uLnRoaXMub25lcnJvci5lcnJvclRva2Vuc11bMF0udG9rZW47ICgoKT0+eyBjb25zb2xlLmxvZyhwKTsgdGhyb3cgbmV3IEVycm9yKHApO2NvbnNvbGUubG9nKDMzNCxwKSB9KSgpCiAgICB9KTsKCiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignZWRuJywoKT0+ewogICAgICBsZXQgcCA9IFsuLi50aGlzLm9uZXJyb3IuZXJyb3JUb2tlbnNdWzBdLnRva2VuKyJYIjsgKCgpPT57IGNvbnNvbGUubG9nKHApOyB0aHJvdyBuZXcgRXJyb3IocCk7Y29uc29sZS5sb2coMzM0LHApIH0pKCkKICAgIH0pOwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ2VkcicsKCk9PnsKICAgICAgbGV0IHAgPSAnMTIzJzsgKCgpPT57IGNvbnNvbGUubG9nKHApOyB0aHJvdyBuZXcgRXJyb3IocCk7Y29uc29sZS5sb2coMzM0LHApIH0pKCkKICAgIH0pOwogICovCgogIC8vIG9ubHkgZm9yIG1hY09TIHdpdGggQ2hyb21lL0ZpcmVmb3ggMTAwKwogIGNvbnN0IGFkdmFuY2VMb2dnaW5nID0gdHlwZW9mIEFib3J0U2lnbmFsICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgKEFib3J0U2lnbmFsIHx8IDApLnRpbWVvdXQgPT09ICdmdW5jdGlvbicgJiYgdHlwZW9mIG5hdmlnYXRvciAhPT0gJ3VuZGVmaW5lZCcgJiYgL1xiKE1hY2ludG9zaHxNYWNccypPUylcYi9pLnRlc3QoKG5hdmlnYXRvciB8fCAwKS51c2VyQWdlbnQgfHwgJycpOwoKICBjb25zdCB3aW4gPSB0aGlzIGluc3RhbmNlb2YgV2luZG93ID8gdGhpcyA6IHdpbmRvdzsKCiAgLy8gQ3JlYXRlIGEgdW5pcXVlIGtleSBmb3IgdGhlIHNjcmlwdCBhbmQgY2hlY2sgaWYgaXQgaXMgYWxyZWFkeSBydW5uaW5nCiAgY29uc3QgaGtleV9zY3JpcHQgPSAnanN3eWxjb2p2enRzJzsKICBpZiAod2luW2hrZXlfc2NyaXB0XSkgdGhyb3cgbmV3IEVycm9yKCdEdXBsaWNhdGVkIFVzZXJzY3JpcHQgQ2FsbGluZycpOyAvLyBhdm9pZCBkdXBsaWNhdGVkIHNjcmlwdGluZwogIHdpbltoa2V5X3NjcmlwdF0gPSB0cnVlOwoKCgogIGxldCBCWV9QQVNTX0tFWUJPQVJEX0NPTlRST0wgPSBmYWxzZTsKCgogIC8vIGNvbnN0IHNldEltbWVkaWF0ZSA9ICgoc2VsZiB8fCAwKS5qbXQgfHwgMCkuc2V0SW1tZWRpYXRlOwogIC8qKiBAdHlwZSB7KGY6ICgpPT57fSk9Pnt9fSAqLwogIGNvbnN0IG5leHRCcm93c2VyVGljayA9IChzZWxmIHx8IDApLm5leHRCcm93c2VyVGljayB8fCAwOwogIGNvbnN0IG5leHRCcm93c2VyVGlja18gPSBuZXh0QnJvd3NlclRpY2sgfHwgKGYgPT4gZigpKTsKCiAgbGV0IHA1OSA9IDA7CgogIGNvbnN0IFByb21pc2UgPSAoYXN5bmMgKCkgPT4geyB9KSgpLmNvbnN0cnVjdG9yOwoKICBjb25zdCBQcm9taXNlRXh0ZXJuYWwgPSAoKHJlc29sdmVfLCByZWplY3RfKSA9PiB7CiAgICBjb25zdCBoID0gKHJlc29sdmUsIHJlamVjdCkgPT4geyByZXNvbHZlXyA9IHJlc29sdmU7IHJlamVjdF8gPSByZWplY3QgfTsKICAgIHJldHVybiBjbGFzcyBQcm9taXNlRXh0ZXJuYWwgZXh0ZW5kcyBQcm9taXNlIHsKICAgICAgY29uc3RydWN0b3IoY2IgPSBoKSB7CiAgICAgICAgc3VwZXIoY2IpOwogICAgICAgIGlmIChjYiA9PT0gaCkgewogICAgICAgICAgLyoqIEB0eXBlIHsodmFsdWU6IGFueSkgPT4gdm9pZH0gKi8KICAgICAgICAgIHRoaXMucmVzb2x2ZSA9IHJlc29sdmVfOwogICAgICAgICAgLyoqIEB0eXBlIHsocmVhc29uPzogYW55KSA9PiB2b2lkfSAqLwogICAgICAgICAgdGhpcy5yZWplY3QgPSByZWplY3RfOwogICAgICAgIH0KICAgICAgfQogICAgfTsKICB9KSgpOwoKICAvKioKICAgIEBwYXJhbSB7bnVtYmVyfSB4CiAgICBAcGFyYW0ge251bWJlcn0gZCAqLwogIGNvbnN0IHRvRml4ZWQyID0gKHgsIGQpID0+IHsKICAgIGxldCB0ID0geC50b0ZpeGVkKGQpOwogICAgbGV0IHkgPSBgJHsrdH1gOwogICAgcmV0dXJuIHkubGVuZ3RoID4gdC5sZW5ndGggPyB0IDogeTsKICB9CgoKICBsZXQgcGYzMSA9IG5ldyBQcm9taXNlRXh0ZXJuYWwoKTsKCiAgLy8gbmF0aXZlIFJBRgogIGxldCBfX3JlcXVlc3RBbmltYXRpb25GcmFtZV9fID0gdHlwZW9mIHdlYmtpdFJlcXVlc3RBbmltYXRpb25GcmFtZSA9PT0gJ2Z1bmN0aW9uJyA/IHdpbmRvdy53ZWJraXRSZXF1ZXN0QW5pbWF0aW9uRnJhbWUuYmluZCh3aW5kb3cpIDogd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZS5iaW5kKHdpbmRvdyk7CgogIC8vIDFzdCB3cmFwcGVkIFJBRgogIGNvbnN0IGJhc2VSQUYgPSAoY2FsbGJhY2spID0+IHsKICAgIHJldHVybiBwNTkgPyBfX3JlcXVlc3RBbmltYXRpb25GcmFtZV9fKGNhbGxiYWNrKSA6IF9fcmVxdWVzdEFuaW1hdGlvbkZyYW1lX18oKGhSZXMpID0+IHsKICAgICAgcGYzMS50aGVuKCgpID0+IHsKICAgICAgICBjYWxsYmFjayhoUmVzKTsKICAgICAgfSk7CiAgICB9KTsKICB9OwoKICAvLyAybmQgd3JhcHBlZCBSQUYKICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gYmFzZVJBRjsKCiAgY29uc3QgaW5zcCA9IG8gPT4gbyA/IChvLnBvbHltZXJDb250cm9sbGVyIHx8IG8uaW5zdCB8fCBvIHx8IDApIDogKG8gfHwgMCk7CiAgY29uc3QgaW5kciA9IG8gPT4gaW5zcChvKS4kIHx8IG8uJCB8fCAwOwoKICBjb25zdCBwcm90b3R5cGVJbmhlcml0ID0gKGQsIGIpID0+IHsKICAgIGNvbnN0IG0gPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyhiKTsKICAgIGZvciAoY29uc3QgcCBpbiBtKSB7CiAgICAgIGlmICghT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihkLCBwKSkgewogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShkLCBwLCBtW3BdKTsKICAgICAgfQogICAgfQogIH07CgogIC8qKiBAdHlwZSB7KG86IE9iamVjdCB8IG51bGwpID0+IFdlYWtSZWYgfCBudWxsfSAqLwogIGNvbnN0IG1XZWFrUmVmID0gdHlwZW9mIFdlYWtSZWYgPT09ICdmdW5jdGlvbicgPyAobyA9PiBvID8gbmV3IFdlYWtSZWYobykgOiBudWxsKSA6IChvID0+IG8gfHwgbnVsbCk7CgogIC8qKiBAdHlwZSB7KHdyOiBPYmplY3QgfCBudWxsKSA9PiBPYmplY3QgfCBudWxsfSAqLwogIGNvbnN0IGtSZWYgPSAod3IgPT4gKHdyICYmIHdyLmRlcmVmKSA/IHdyLmRlcmVmKCkgOiB3cik7CgogIGlmICh0eXBlb2YgRG9jdW1lbnQucHJvdG90eXBlLnJlcXVlc3RTdG9yYWdlQWNjZXNzRm9yID09PSAnZnVuY3Rpb24nKSB7CiAgICBpZiAoREVOWV9yZXF1ZXN0U3RvcmFnZUFjY2VzcykgewogICAgICAvLyBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvRG9jdW1lbnQvcmVxdWVzdFN0b3JhZ2VBY2Nlc3NGb3IKICAgICAgRG9jdW1lbnQucHJvdG90eXBlLnJlcXVlc3RTdG9yYWdlQWNjZXNzRm9yID0gdW5kZWZpbmVkOwogICAgICBjb25zb2xlLmxvZygnW3l0LWpzLWVuZ2luZS10YW1lcl0nLCAncmVxdWVzdFN0b3JhZ2VBY2Nlc3NGb3IgaXMgcmVtb3ZlZC4nKTsKICAgIH0gZWxzZSBpZiAoRElTQUJMRV9JRlJBTUVfcmVxdWVzdFN0b3JhZ2VBY2Nlc3MgJiYgd2luZG93ICE9PSB0b3ApIHsKICAgICAgRG9jdW1lbnQucHJvdG90eXBlLnJlcXVlc3RTdG9yYWdlQWNjZXNzRm9yID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgICAgICByZWplY3QoKTsKICAgICAgICB9KTsKICAgICAgfTsKICAgIH0KICB9CgogIGlmIChGSVhfYmluZF9zZWxmX3RoaXMgJiYgIUZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kNDg4ICYmICFGdW5jdGlvbi5wcm90b3R5cGUuYmluZDU4OCkgewogICAgLy8gd2luZG93Lm0zYmIgPSBuZXcgU2V0KCk7CgogICAgLy8gY29uc3Qgc21iID0gU3ltYm9sKCk7CiAgICBjb25zdCB2bWIgPSAnZHR6MDInIC8vIFN5bWJvbCgpOyAvLyByZXR1cm4ga1RoaXMgZm9yIHRoaXNBcmcKICAgIGNvbnN0IHZtYyA9ICdkdHowNCcgLy8gU3ltYm9sKCk7IC8vIHdoZXRoZXIgaXQgaXMgcHJveGllZCBmbgogICAgY29uc3Qgdm1kID0gJ2R0ejA4JyAvLyBTeW1ib2woKTsgLy8gc2VsZiBmbiBwcm94eSAoZm4tLWZuKQoKICAgIC8vIGNvbnN0IGZuUHJveHlTZWxmID0gZnVuY3Rpb24gKC4uLmFyZ3MpIHsKICAgIC8vICAgaWYgKGFyZ3NbMF0gPT09IHNtYikgcmV0dXJuIHRoaXM7CiAgICAvLyAgIGNvbnN0IGNudCA9IGtSZWYodGhpcy5yZWYpOwogICAgLy8gICBpZiAoY250KSB7CiAgICAvLyAgICAgaWYgKHR5cGVvZiBjbnRbdGhpcy5wcm9wXSAhPT0gJ2Z1bmN0aW9uJykgY29uc29sZS5lcnJvcihgdGhpcy4ke3RoaXMucHJvcH0gaXMgbm90IGEgZnVuY3Rpb24uIFske2NudC5pcyB8fCAnbmlsJ31dYCkKICAgIC8vICAgICByZXR1cm4gY250W3RoaXMucHJvcF0oLi4uYXJncyk7IC8vIG1pZ2h0IHRocm93IGVycm9yCiAgICAvLyAgIH0KICAgIC8vIH0KICAgIC8vIGZuUHJveHlTZWxmLmJpbmQ1ODggPSBmblByb3h5U2VsZi5iaW5kOwogICAgLy8gY29uc3QgcEZuSGFuZGxlciA9IHsKICAgIC8vICAgZ2V0KHRhcmdldCwgcHJvcCl7CiAgICAvLyAgICAgaWYocHJvcCA9PT0gJ2JpbmQ1ODgnKSByZXR1cm4gMjsKICAgIC8vICAgICBjb25zdCBmblRoaXMgPSB0YXJnZXQoc21iKTsKICAgIC8vICAgICBpZiAoZm5UaGlzICYmIGZuVGhpcy5wcm9wICYmIGZuVGhpcy5yZWYpIHsKICAgIC8vICAgICAgIGNvbnN0IGNudCA9IGtSZWYoZm5UaGlzLnJlZiB8fCBudWxsKSB8fCBudWxsOwogICAgLy8gICAgICAgaWYgKGNudCkgewogICAgLy8gICAgICAgICBjb25zdCBoID0gY250W2ZuVGhpcy5wcm9wXTsKICAgIC8vICAgICAgICAgY29uc3QgdiA9IGhbcHJvcF07CiAgICAvLyAgICAgICAgIGlmICh0eXBlb2YgdiA9PT0gJ2Z1bmN0aW9uJyl7CiAgICAvLyAgICAgICAgICAgaWYodHlwZW9mIGggPT09ICdmdW5jdGlvbicpewogICAgLy8gICAgICAgICAgICAgaWYgKHByb3AgPT09ICdjYWxsJyB8fCBwcm9wID09PSAnYmluZCcgfHwgcHJvcCA9PT0gJ2JpbmQ1ODgnIHx8IHByb3AgPT09ICdiaW5kNDg4JyB8fCBwcm9wID09PSAnYXBwbHknKSB7CiAgICAvLyAgICAgICAgICAgICAgIGlmKGguYmluZDU4OCA9PT0gMSl7CiAgICAvLyAgICAgICAgICAgICAgICAgY29uc3QgZyA9IGZ1bmN0aW9uKC4uLmFyZ3MpewogICAgLy8gICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coMTI4OCwgdGhpcykKICAgIC8vICAgICAgICAgICAgICAgICAgIHJldHVybiBoLmNhbGwodGhpcywgLi4uYXJncyk7CiAgICAvLyAgICAgICAgICAgICAgICAgfTsKICAgIC8vICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygzOTksIGcpCiAgICAvLyAgICAgICAgICAgICAgICAgcmV0dXJuIGdbcHJvcF07CiAgICAvLyAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coMTI3NzgpCiAgICAvLyAgICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2codGFyZ2V0LCB0YXJnZXQuY2FsbCkKICAgIC8vICAgICAgICAgICAgICAgICAvLyByZXR1cm4gdGFyZ2V0W3Byb3BdOwogICAgLy8gICAgICAgICAgICAgICB9CiAgICAvLyAgICAgICAgICAgICAgIC8vIGluZGVwZW5kZW50IG9mIHRoaXMKICAgIC8vICAgICAgICAgICAgICAgcmV0dXJuIHY7IC8vIGZ1bmN0aW9uLmJpbmQsIGZ1bmN0aW9uLmNhbGwsIGZ1bmN0aW9uLmFwcGx5CiAgICAvLyAgICAgICAgICAgICB9CiAgICAvLyAgICAgICAgICAgfQogICAgLy8gICAgICAgICAgIGNvbnNvbGUud2FybignY250W2ZuVGhpcy5wcm9wXVtwcm9wXSBpcyBmdW5jdGlvbjsgbWlnaHQgcmVseSBvbiB0aGlzJywgeyBwcm9wLCBmUHJvcDogZm5UaGlzLnByb3AsIGlzOiBjbnQuaXMsIGg6IGggfSk7CgogICAgLy8gICAgICAgICAgIC8vIHJldHVybiBuZXcgUHJveHkoZm5Qcm94eVNlbGYuYmluZDU4OCh7IHByb3A6IHByb3AsIHJlZjogbmV3IFdlYWtSZWYoY250W2ZuVGhpcy5wcm9wXSkgfSksIHBGbkhhbmRsZXIpOwogICAgLy8gICAgICAgICB9CiAgICAvLyAgICAgICAgIHJldHVybiB2OwogICAgLy8gICAgICAgfQogICAgLy8gICAgIH0KICAgIC8vICAgfSwKICAgIC8vICAgc2V0KHRhcmdldCwgcHJvcCwgdmFsdWUpIHsKICAgIC8vICAgICBjb25zdCBmblRoaXMgPSB0YXJnZXQoc21iKTsKICAgIC8vICAgICBpZiAoZm5UaGlzICYmIGZuVGhpcy5wcm9wICYmIGZuVGhpcy5yZWYpIHsKICAgIC8vICAgICAgIGNvbnN0IGNudCA9IGtSZWYoZm5UaGlzLnJlZiB8fCBudWxsKSB8fCBudWxsOwogICAgLy8gICAgICAgaWYgKGNudCkgewogICAgLy8gICAgICAgICBjb25zdCBoID0gY250W2ZuVGhpcy5wcm9wXTsKICAgIC8vICAgICAgICAgaWYgKGgpIHsKICAgIC8vICAgICAgICAgICBoW3Byb3BdID0gdmFsdWU7CiAgICAvLyAgICAgICAgIH0gZWxzZSB7CiAgICAvLyAgICAgICAgICAgY29uc29sZS5sb2coJ2ggaXMgbm91dCBmb3VuZCcsIHsgcHJvcCwgZlByb3A6IGZuVGhpcy5wcm9wLCBpczogY250LmlzLCBoOiBoIH0pOwogICAgLy8gICAgICAgICB9CiAgICAvLyAgICAgICB9CiAgICAvLyAgICAgfQogICAgLy8gICAgIHJldHVybiB0cnVlOwogICAgLy8gICB9CiAgICAvLyB9OwoKICAgIGNvbnN0IHRoaXNDb252ZXJzaW9uRm4gPSAodGhpc0FyZykgPT4gewogICAgICBpZiAoIXRoaXNBcmcpIHJldHVybiBudWxsOwogICAgICBjb25zdCBrVGhpcyA9IHRoaXNBcmdbdm1iXTsKICAgICAgaWYgKGtUaGlzKSB7CiAgICAgICAgY29uc3QgcmVmID0ga1RoaXMucmVmOwogICAgICAgIHJldHVybiAocmVmID8ga1JlZihyZWYpIDogbnVsbCkgfHwgbnVsbDsKICAgICAgfQogICAgICByZXR1cm4gdGhpc0FyZzsKICAgIH0KCiAgICBjb25zdCBwRm5IYW5kbGVyMiA9IHsKICAgICAgZ2V0KHRhcmdldCwgcHJvcCkgewogICAgICAgIGlmIChwcm9wID09PSB2bWMpIHJldHVybiB0YXJnZXQ7CiAgICAgICAgcmV0dXJuIFJlZmxlY3QuZ2V0KHRhcmdldCwgcHJvcCk7CiAgICAgIH0sCiAgICAgIGFwcGx5KHRhcmdldCwgdGhpc0FyZywgYXJndW1lbnRzTGlzdCkgewogICAgICAgIHRoaXNBcmcgPSB0aGlzQ29udmVyc2lvbkZuKHRoaXNBcmcpOwogICAgICAgIGlmICh0aGlzQXJnKSByZXR1cm4gUmVmbGVjdC5hcHBseSh0YXJnZXQsIHRoaXNBcmcsIGFyZ3VtZW50c0xpc3QpOwogICAgICB9CiAgICB9CgoKICAgIGNvbnN0IHByb3h5U2VsZkhhbmRsZXIgPSB7CiAgICAgIGdldCh0YXJnZXQsIHByb3ApIHsKICAgICAgICBpZihwcm9wID09PSB2bWIpIHJldHVybiB0YXJnZXQ7CiAgICAgICAgY29uc3QgcmVmID0gdGFyZ2V0LnJlZjsKICAgICAgICBjb25zdCBjbnQgPSBrUmVmKHJlZik7CiAgICAgICAgaWYgKCFjbnQpIHJldHVybjsKICAgICAgICBpZiAodHlwZW9mIGNudFtwcm9wXSA9PT0gJ2Z1bmN0aW9uJyAmJiAhY250W3Byb3BdW3ZtY10gJiYgIWNudFtwcm9wXVt2bWJdKSB7CiAgICAgICAgICBpZiAoIWNudFtwcm9wXVt2bWRdKSBjbnRbcHJvcF1bdm1kXSA9IG5ldyBQcm94eShjbnRbcHJvcF0sIHBGbkhhbmRsZXIyKTsKICAgICAgICAgIHJldHVybiBjbnRbcHJvcF1bdm1kXTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGNudFtwcm9wXTsKICAgICAgfSwKICAgICAgc2V0KHRhcmdldCwgcHJvcCwgdmFsdWUpIHsKICAgICAgICBjb25zdCBjbnQgPSBrUmVmKHRhcmdldC5yZWYpOwogICAgICAgIGlmICghY250KSByZXR1cm4gdHJ1ZTsKICAgICAgICBpZih2YWx1ZSAmJiAodmFsdWVbdm1jXSB8fCB2YWx1ZVt2bWJdKSl7CiAgICAgICAgICBjbnRbcHJvcF0gPSB2YWx1ZVt2bWNdIHx8IHRoaXNDb252ZXJzaW9uRm4odmFsdWUpOwogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICAgIGNudFtwcm9wXSA9IHZhbHVlOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9OwoKICAgIGNvbnN0IHdlYWtXcmFwID0gKHRoaXNBcmcpID0+IHsKICAgICAgdGhpc0FyZyA9IHRoaXNDb252ZXJzaW9uRm4odGhpc0FyZyk7CiAgICAgIGlmICghdGhpc0FyZykgewogICAgICAgIGNvbnNvbGUuZXJyb3IoJ3RoaXNBcmcgaXMgbm90IGZvdW5kJyk7CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgICAgcmV0dXJuIG5ldyBQcm94eSh7IHJlZjogbVdlYWtSZWYodGhpc0FyZykgfSwgcHJveHlTZWxmSGFuZGxlcik7CiAgICB9CgogICAgaWYgKCF3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZTUzMyAmJiB0eXBlb2Ygd2luZG93LmdldENvbXB1dGVkU3R5bGUgPT09ICdmdW5jdGlvbicpIHsKICAgICAgd2luZG93LmdldENvbXB1dGVkU3R5bGU1MzMgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZTsKICAgICAgd2luZG93LmdldENvbXB1dGVkU3R5bGUgPSBmdW5jdGlvbiAoYSwgLi4uYXJncykgewogICAgICAgIGEgPSB0aGlzQ29udmVyc2lvbkZuKGEpOwogICAgICAgIGlmIChhKSB7CiAgICAgICAgICByZXR1cm4gZ2V0Q29tcHV0ZWRTdHlsZTUzMyhhLCAuLi5hcmdzKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG51bGw7CiAgICAgIH0KICAgIH0KCiAgICBGdW5jdGlvbi5fY291bnRfYmluZF8wMCA9IDA7CiAgICAvLyBGdW5jdGlvbi5fY291bnRfYmluZF8wMSA9IDA7CgogICAgLy8gbGV0IG1hdGNoTmF0aXZlQ29kZSA9IChPYmplY3QrIiIpOwogICAgLy8gbGV0IG1hdGNoTmF0aXZlQ29kZTEgPSBtYXRjaE5hdGl2ZUNvZGUuaW5jbHVkZXMoIltuYXRpdmUgY29kZV0iKTsKICAgIC8vIGxldCBtYXRjaE5hdGl2ZUxlbiA9IG1hdGNoTmF0aXZlQ29kZS5sZW5ndGggIC0gT2JqZWN0Lm5hbWUubGVuZ3RoOwoKICAgIC8vIGNvbnN0IG1hdGNoQ29uc3RydWN0b3IgPSAodGhpc0FyZykgPT4gewogICAgLy8gICBjb25zdCBmID0gKHRoaXNBcmcgfHwgMCkuY29uc3RydWN0b3IgKyAiIjsKICAgIC8vICAgaWYgKGYubGVuZ3RoID4gNDUpIHJldHVybiB0cnVlOwogICAgLy8gICBpZiAobWF0Y2hOYXRpdmVDb2RlMSAmJiBmLmxlbmd0aCAtIHRoaXNBcmcuY29uc3RydWN0b3IubmFtZS5sZW5ndGggPT09IG1hdGNoTmF0aXZlTGVuKSB7CiAgICAvLyAgICAgaWYgKGYuaW5jbHVkZXMoJ1tuYXRpdmUgY29kZV0nKSl7CiAgICAvLyAgICAgICByZXR1cm4gZmFsc2U7CiAgICAvLyAgICAgfQogICAgLy8gICAgIHJldHVybiB0cnVlOwogICAgLy8gICB9CiAgICAvLyAgIHJldHVybiBmYWxzZTsKICAgIC8vIH0KCiAgICAvLyBjb25zdCBhY2NlcHRUaGlzID0gKHRoaXNBcmcpPT57CiAgICAvLyAgIC8vIGlmKCF0aGlzQXJnIHx8IHR5cGVvZiB0aGlzQXJnICE9PSdvYmplY3QnKSByZXR1cm4gZmFsc2U7CiAgICAvLyAgIC8vIC8vIGlmKCgoKHRoaXNBcmd8fDApLmNvbnN0cnVjdG9yfHwwKS5uYW1lIHx8ICdYWFhYWFhYWCcpLmxlbmd0aCA8IDMpIHJldHVybiB0cnVlOwogICAgLy8gICAvLyBpZih0eXBlb2YgdGhpc0FyZy5wYXRoID09PSAnc3RyaW5nJykgcmV0dXJuIHRydWU7CiAgICAvLyAgIC8vIGlmKHR5cGVvZiB0aGlzQXJnLmZuID09PSAnZnVuY3Rpb24nKSByZXR1cm4gdHJ1ZTsKICAgIC8vICAgLy8gaWYodHlwZW9mIHRoaXNBcmcuaWQgPT09ICdzdHJpbmcnKSByZXR1cm4gdHJ1ZTsKICAgIC8vICAgLy8gaWYodHlwZW9mIHRoaXNBcmcuaXNMb2FkZWQgPT09ICdib29sZWFuJykgcmV0dXJuIHRydWU7CiAgICAvLyAgIHJldHVybiBmYWxzZTsKICAgIC8vIH0KCiAgICBjb25zdCBwYXRjaEZuID0gKGZuKSA9PiB7CgogICAgICBsZXQgcyA9IGAke2ZufWA7CiAgICAgIGlmIChzLmxlbmd0aCA8IDExIHx8IHMuaW5jbHVkZXMoJ1xuJykpIHJldHVybiBmYWxzZTsKICAgICAgaWYocy5pbmNsdWRlcygnYmluZCh0aGlzJykpIHJldHVybiB0cnVlOwogICAgICBpZihzLmluY2x1ZGVzKCc9dGhpcycpICYmIC9bLFxzXVthLXpBLVpfXVthLXpBLVowLTlfXSo9dGhpc1s7LF0vLnRlc3QocykgKSByZXR1cm4gdHJ1ZTsKICAgICAgLy8gdmFyIGE9dGhpczsKICAgICAgLy8gZi5iaW5kKHRoaXMpCgoKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIEZ1bmN0aW9uLnByb3RvdHlwZS5iaW5kNDg4ID0gRnVuY3Rpb24ucHJvdG90eXBlLmJpbmQ7CiAgICBGdW5jdGlvbi5wcm90b3R5cGUuYmluZCA9IGZ1bmN0aW9uKHRoaXNBcmcsIC4uLmFyZ3MpewoKICAgICAgaWYgKHRoaXNDb252ZXJzaW9uRm4odGhpc0FyZykgIT09IHRoaXNBcmcpIHsKICAgICAgICByZXR1cm4gdGhpcy5iaW5kNDg4KHRoaXNBcmcsIC4uLmFyZ3MpOwogICAgICB9CiAgICAgIGlmKCB0aGlzQXJnICYmIHBhdGNoRm4odGhpcykgKXsKCiAgICAgICAgLy8gY29uc29sZS5sb2coNTk5LGAke3RoaXN9YCkKCiAgICAgICAgdHJ5IHsKICAgICAgICAgIC8vIGxldCBiMSA9IHRoaXNBcmcgJiYgdHlwZW9mIHRoaXNBcmcgPT09ICdvYmplY3QnICYmIHR5cGVvZiB0aGlzQXJnLmlzQXR0YWNoZWQgPT09ICdib29sZWFuJyAmJiAhdGhpc0FyZy5kdHowNjsgLy8gcmVhZHkgY250CiAgICAgICAgICAvLyBsZXQgYjIgPSAhYjEgJiYgdGhpc0FyZyAmJiAodGhpc0FyZyBpbnN0YW5jZW9mIE5vZGUpICYmIHR5cGVvZiB0aGlzQXJnLm5vZGVOYW1lID09PSAnc3RyaW5nJyAmJiAhdGhpc0FyZy5kdHowNjsgLy8gZG9tCiAgICAgICAgICAvLyBsZXQgYjMgPSAhYjEgJiYgIWIyICYmIHRoaXNBcmcgJiYgdHlwZW9mIHRoaXNBcmcgPT09ICdvYmplY3QnICYmIHR5cGVvZiB0aGlzQXJnLmlzID09PSAnc3RyaW5nJyAmJiAhdGhpc0FyZy5kdHowNjsgLy8gaW5pdCBzdGFnZSA/CiAgICAgICAgICAvLyAvLyBsZXQgYjQgPSAhYjEgJiYgIWIyICYmICFiMyAmJiB0aGlzQXJnICYmIHR5cGVvZiB0aGlzQXJnID09PSAnb2JqZWN0JyAmJiAhdGhpc0FyZy5kdHowNiAmJiBtYXRjaENvbnN0cnVjdG9yKHRoaXNBcmcpOwogICAgICAgICAgLy8gLy8gbGV0IGI1ID0gIWIxICYmICFiMiAmJiAhYjMgJiYgIWI0ICYmIHRoaXNBcmcgJiYgdHlwZW9mIHRoaXNBcmcgPT09ICdvYmplY3QnICYmICF0aGlzQXJnLmR0ejA2ICYmIGFjY2VwdFRoaXModGhpc0FyZyk7CiAgICAgICAgICAvLyAvLyBsZXQgYjUgPSAhYjEgJiYgIWIyICYmICFiMyAmJiB0aGlzQXJnICYmIHR5cGVvZiB0aGlzQXJnID09PSAnb2JqZWN0JyAmJiAhdGhpc0FyZy5kdHowNiAgJiYgISh0aGlzQXJnIGluc3RhbmNlb2YgV2luZG93KTsKICAgICAgICAgIC8vIC8vIGxldCBiNCA9IGZhbHNlOwogICAgICAgICAgLy8gbGV0IGI0ID0gICFiMSAmJiAhYjIgJiYgIWIzICYmIHRoaXNBcmcgJiYgIXRoaXNBcmcuZHR6MDY7CgogICAgICAgICAgLy8gLy8gYjMgPSBmYWxzZTsKICAgICAgICAgIC8vIC8vIGI0ID0gZmFsc2U7CiAgICAgICAgICAvLyAvLyBiNSA9IGZhbHNlOwoKICAgICAgICAgIC8vIGlmIChiMSB8fCBiMiB8fCBiMyB8fGI0ICApIHsKICAgICAgICAgICAgY29uc3QgZiA9IHRoaXM7CiAgICAgICAgICAgIGNvbnN0IHBzID0gdGhpc0FyZy5fX3Byb3h5U2VsZjBfXyB8fCAodGhpc0FyZy5fX3Byb3h5U2VsZjBfXyA9IHdlYWtXcmFwKHRoaXNBcmcpKTsKICAgICAgICAgICAgaWYgKHBzICYmIHBzW3ZtYl0pIHsKICAgICAgICAgICAgICBGdW5jdGlvbi5fY291bnRfYmluZF8wMCsrOwogICAgICAgICAgICAgIHJldHVybiBmLmJpbmQ0ODgocHMsIC4uLmFyZ3MpCiAgICAgICAgICAgIH0KICAgICAgICAgIC8vIH0KICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBjb25zb2xlLndhcm4oZSkKICAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmJpbmQ0ODgodGhpc0FyZywgLi4uYXJncyk7CiAgICB9CiAgICBGdW5jdGlvbi5wcm90b3R5cGUuYmluZDU4OCA9IDE7CiAgfQoKCiAgaWYgKEZJWF93ZWFrTWFwX3dlYWtSZWYgJiYgIXdpbmRvdy5XZWFrTWFwT3JpZ2luYWwgJiYgdHlwZW9mIHdpbmRvdy5XZWFrTWFwID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiBXZWFrUmVmID09PSAnZnVuY3Rpb24nKSB7CiAgICBjb25zdCBXZWFrTWFwT3JpZ2luYWwgPSB3aW5kb3cuV2Vha01hcE9yaWdpbmFsID0gd2luZG93LldlYWtNYXA7CiAgICBjb25zdCB3bTYgPSBuZXcgV2Vha01hcE9yaWdpbmFsKCk7CgogICAgY29uc3Qgc2tpcFcgPSBuZXcgV2Vha1NldCgpOwoKCiAgICB3aW5kb3cuV2Vha01hcCA9IGNsYXNzIFdlYWtNYXAgZXh0ZW5kcyBXZWFrTWFwT3JpZ2luYWwgewogICAgICBjb25zdHJ1Y3RvcihpdGVyYWJsZSA9IHVuZGVmaW5lZCkgewogICAgICAgIHN1cGVyKCk7CiAgICAgICAgaWYgKGl0ZXJhYmxlICYmIGl0ZXJhYmxlW1N5bWJvbC5pdGVyYXRvcl0pIHsKICAgICAgICAgIGZvciAoY29uc3QgZW50cnkgb2YgaXRlcmFibGUpIHsKICAgICAgICAgICAgZW50cnkgJiYgdGhpcy5zZXQoZW50cnlbMF0sIGVudHJ5WzFdKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgZGVsZXRlKGEpIHsKICAgICAgICBpZiAoIXRoaXMuaGFzKGEpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgc3VwZXIuZGVsZXRlKGEpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIGdldChhKSB7CiAgICAgICAgY29uc3QgcCA9IHN1cGVyLmdldChhKTsKICAgICAgICBpZiAocCAmJiB0eXBlb2YgcCA9PT0gJ29iamVjdCcgJiYgcC5kZXJlZiAmJiAhc2tpcFcuaGFzKHApKSB7CiAgICAgICAgICBsZXQgdiA9IGtSZWYocCk7CiAgICAgICAgICBpZiAoIXYpIHsKICAgICAgICAgICAgc3VwZXIuZGVsZXRlKGEpOwogICAgICAgICAgfQogICAgICAgICAgcmV0dXJuIHYgfHwgdW5kZWZpbmVkOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcDsKICAgICAgfQogICAgICBoYXMoYSkgewogICAgICAgIGlmICghc3VwZXIuaGFzKGEpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgY29uc3QgcCA9IHN1cGVyLmdldChhKTsKICAgICAgICBpZiAocCAmJiB0eXBlb2YgcCA9PT0gJ29iamVjdCcgJiYgcC5kZXJlZiAmJiAhc2tpcFcuaGFzKHApKSB7CiAgICAgICAgICBpZiAoIWtSZWYocCkpIHsKICAgICAgICAgICAgc3VwZXIuZGVsZXRlKGEpOwogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICAgIHNldChhLCBiKSB7CiAgICAgICAgbGV0IHdxID0gYjsKICAgICAgICBpZiAoYiAmJiAodHlwZW9mIGIgPT09ICdmdW5jdGlvbicgfHwgdHlwZW9mIGIgPT09ICdvYmplY3QnKSkgewogICAgICAgICAgaWYgKGIuZGVyZWYpIHsKICAgICAgICAgICAgc2tpcFcuYWRkKGIpOwogICAgICAgICAgICB3cSA9IGI7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3cSA9IHdtNi5nZXQoYik7CiAgICAgICAgICAgIGlmICghd3EpIHsKICAgICAgICAgICAgICB3cSA9IG1XZWFrUmVmKGIpOwogICAgICAgICAgICAgIHdtNi5zZXQoYiwgd3EpOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHN1cGVyLnNldChhLCB3cSk7CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICAgIH0KICAgIH0KICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh3aW5kb3cuV2Vha01hcCwgU3ltYm9sLnRvU3RyaW5nVGFnLCB7CiAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgIHZhbHVlOiAiV2Vha01hcCIsCiAgICAgIHdyaXRhYmxlOiBmYWxzZQogICAgfSk7CiAgfQoKICBjb25zdCBpc1dhdGNoUGFnZVVSTCA9ICh1cmwpID0+IHsKICAgIHVybCA9IHVybCB8fCBsb2NhdGlvbjsKICAgIHJldHVybiBsb2NhdGlvbi5wYXRobmFtZSA9PT0gJy93YXRjaCcgfHwgbG9jYXRpb24ucGF0aG5hbWUuc3RhcnRzV2l0aCgnL2xpdmUvJykKICB9OwoKICBjb25zdCBpc0N1c3RvbUVsZW1lbnRzUHJvdmlkZWQgPSB0eXBlb2YgY3VzdG9tRWxlbWVudHMgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZiAoY3VzdG9tRWxlbWVudHMgfHwgMCkud2hlbkRlZmluZWQgPT09ICJmdW5jdGlvbiI7CgogIGNvbnN0IHByb21pc2VGb3JDdXN0b21ZdEVsZW1lbnRzUmVhZHkgPSBpc0N1c3RvbUVsZW1lbnRzUHJvdmlkZWQgPyBQcm9taXNlLnJlc29sdmUoMCkgOiBuZXcgUHJvbWlzZSgoY2FsbGJhY2spID0+IHsKICAgIGNvbnN0IEVWRU5UX0tFWV9PTl9SRUdJU1RSWV9SRUFEWSA9ICJ5dEktY2UtcmVnaXN0cnktY3JlYXRlZCI7CiAgICBpZiAodHlwZW9mIGN1c3RvbUVsZW1lbnRzID09PSAndW5kZWZpbmVkJykgewogICAgICBpZiAoISgnX19DRV9yZWdpc3RyeScgaW4gZG9jdW1lbnQpKSB7CiAgICAgICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3dlYmNvbXBvbmVudHMvcG9seWZpbGxzLwogICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShkb2N1bWVudCwgJ19fQ0VfcmVnaXN0cnknLCB7CiAgICAgICAgICBnZXQoKSB7CiAgICAgICAgICAgIC8vIHJldHVybiB1bmRlZmluZWQKICAgICAgICAgIH0sCiAgICAgICAgICBzZXQobnYpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBudiA9PSAnb2JqZWN0JykgewogICAgICAgICAgICAgIGRlbGV0ZSB0aGlzLl9fQ0VfcmVnaXN0cnk7CiAgICAgICAgICAgICAgdGhpcy5fX0NFX3JlZ2lzdHJ5ID0gbnY7CiAgICAgICAgICAgICAgdGhpcy5kaXNwYXRjaEV2ZW50KG5ldyBDdXN0b21FdmVudChFVkVOVF9LRVlfT05fUkVHSVNUUllfUkVBRFkpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgIH0sCiAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgIH0pCiAgICAgIH0KICAgICAgbGV0IGV2ZW50SGFuZGxlciA9IChldnQpID0+IHsKICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKEVWRU5UX0tFWV9PTl9SRUdJU1RSWV9SRUFEWSwgZXZlbnRIYW5kbGVyLCBmYWxzZSk7CiAgICAgICAgY29uc3QgZiA9IGNhbGxiYWNrOwogICAgICAgIGNhbGxiYWNrID0gbnVsbDsKICAgICAgICBldmVudEhhbmRsZXIgPSBudWxsOwogICAgICAgIGYoKTsKICAgICAgfTsKICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihFVkVOVF9LRVlfT05fUkVHSVNUUllfUkVBRFksIGV2ZW50SGFuZGxlciwgZmFsc2UpOwogICAgfSBlbHNlIHsKICAgICAgY2FsbGJhY2soKTsKICAgIH0KICB9KTsKCiAgY29uc3Qgd2hlbkNFRGVmaW5lZCA9IGlzQ3VzdG9tRWxlbWVudHNQcm92aWRlZAogICAgPyAobm9kZU5hbWUpID0+IGN1c3RvbUVsZW1lbnRzLndoZW5EZWZpbmVkKG5vZGVOYW1lKQogICAgOiAobm9kZU5hbWUpID0+IHByb21pc2VGb3JDdXN0b21ZdEVsZW1lbnRzUmVhZHkudGhlbigoKSA9PiBjdXN0b21FbGVtZW50cy53aGVuRGVmaW5lZChub2RlTmFtZSkpOwoKICBGSVhfcGVyZk5vdyAmJiBwZXJmb3JtYW5jZS50aW1lT3JpZ2luID4gOSAmJiAoKCkgPT4gewogICAgaWYgKHBlcmZvcm1hbmNlLm5vdzIzIHx8IHBlcmZvcm1hbmNlLm5vdzE2IHx8IHR5cGVvZiBQZXJmb3JtYW5jZS5wcm90b3R5cGUubm93ICE9PSAnZnVuY3Rpb24nKSByZXR1cm47CiAgICBjb25zdCBmID0gcGVyZm9ybWFuY2Uubm93MjMgPSBQZXJmb3JtYW5jZS5wcm90b3R5cGUubm93OwoKICAgIGxldCBrID0gMDsgLy8gMCA8PSBrIDwgOTk5OG0KICAgIGxldCB1ID0gMDsKICAgIGxldCBzID0gKChwZXJmb3JtYW5jZS50aW1lT3JpZ2luICUgNykgKyAxKSAvIDcgLSAxZS0yIC8gNzsgLy8gcyA+IDAuMTQKCiAgICAvLyBCeSBkZWZpbml0aW9uLCBwZXJmb3JtYW5jZS5ub3coKSBpcyBtb25vIGluY3JlYXNpbmcuCiAgICAvLyBGaXhpbmcgaW4gWW91VHViZS5jb20gaXMgcmVxdWlyZWQgdG8gZW5zdXJlIHBlcmZvcm1hbmNlLm5vdygpIGlzIHN0cmljdGx5IGluY3JlYXNpbmcuCiAgICBwZXJmb3JtYW5jZS5ub3cgPSBwZXJmb3JtYW5jZS5ub3cxNiA9IGZ1bmN0aW9uICgpIHsKICAgICAgLyoqCiAgICAgICAqIEJ1ZyAxODQyNDM3IC0gV2hlbiBhdHRlbXB0aW5nIHRvIGdvIGJhY2sgb24geW91dHViZS5jb20sIHRoZSBjb250ZW50IHJlbWFpbnMgdGhlIHNhbWUKICAgICAgICoKICAgICAgICogSWYgY29uc2VjdXRpdmUgc2Vzc2lvbiBoaXN0b3J5IGVudHJpZXMgaGFkIGhpc3Rvcnkuc3RhdGUuZW50cnlUaW1lIHNldCB0byBzYW1lIHZhbHVlLAogICAgICAgKiBiYWNrIGJ1dHRvbiBkb2Vzbid0IHdvcmsgYXMgZXhwZWN0ZWQuIFRoZSBlbnRyeVRpbWUgdmFsdWUgaXMgY29taW5nIGZyb20gcGVyZm9ybWFuY2Uubm93KCkKICAgICAgICogYW5kIG1vZGlmeWluZyBpdHMgcmV0dXJuIHZhbHVlIHNsaWdodGx5IHRvIG1ha2Ugc3VyZSB0d28gY2xvc2UgY29uc2VjdXRpdmUgY2FsbHMgZG9uJ3QKICAgICAgICogZ2V0IHRoZSBzYW1lIHJlc3VsdCBoZWxwZWQgd2l0aCByZXNvbHZpbmcgdGhlIGlzc3VlLgogICAgICAgKi8KICAgICAgLy8gc2VlIGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTE3NTY5NzAKICAgICAgLy8gc2VlIGh0dHBzOi8vYnVnemlsbGEubW96aWxsYS5vcmcvc2hvd19idWcuY2dpP2lkPTE4NDI0MzcKCiAgICAgIGNvbnN0IHYgPSB0eXBlb2YgKHRoaXMgfHwgMCkubm93MjMgPT09ICdmdW5jdGlvbicgPyB0aGlzLm5vdzIzKCkgKyBzIDogZi5jYWxsKHBlcmZvcm1hbmNlKSArIHM7IC8vIHYgPiAwLjE0CiAgICAgIGlmICh1ICsgMC4wMDE1IDwgKHUgPSB2KSkgayA9IDA7IC8vIG5vdGU6IGhSZXMgc2hvdWxkIGJlIGFjY3VyYXRlIHRvIDUgwrVzIGluIGlzb2xhdGVkIGNvbnRleHRzCiAgICAgIGVsc2UgaWYgKGsgPCAwLjAwMTQyOCkgayArPSAxZS02IC8gNzsgLy8gTSA9IDEwMDAwICogbTsgbSAqIDk5OTYgPSAwLjAwMTQyOAogICAgICBlbHNlIHsgLy8gbW9yZSB0aGFuIDk5OTggY29uc2VjdXRpdmUgY2FsbHMKICAgICAgICAvKioKICAgICAgICAgKgogICAgICAgICAqIG1heCBuby4gb2YgY29uc2VjdXRpdmUgY2FsbHMKICAgICAgICAgKgogICAgICAgICAqIFNhbXBsZSBTaXplOiA0ODAwCiAgICAgICAgICogU2FtcGxlIEF2ZyA9IDE1NjUuMzc1CiAgICAgICAgICogU2FtcGxlIE1lZGlhbiA9IDE0NjkuNQogICAgICAgICAqIFNhbXBsZSBNYXggPSA1NjYwIDw8IDc1MDAgPDwgOTk5OQogICAgICAgICAqCiAgICAgICAgICoKICAgICAgICAgKiAgKi8KICAgICAgICBrID0gMDsKICAgICAgICBzICs9IDEgLyA3OwogICAgICB9CiAgICAgIHJldHVybiB2ICsgazsgLy8gMCA8IHYgLSBNIDwgdiAtIE0gKyBrIDwgdgogICAgfQoKICAgIGxldCBsb2dnZXJNc2cgPSAnJzsKICAgIGlmIChgJHtwZXJmb3JtYW5jZS5ub3coKX1gID09PSBgJHtwZXJmb3JtYW5jZS5ub3coKX1gKSB7CiAgICAgIGNvbnN0IG1zZzEgPSAncGVyZm9ybWFuY2Uubm93IGlzIG1vZGlmaWVkIGJ1dCBwZXJmb3JtYW5jZS5ub3coKSBpcyBub3Qgc3RyaWN0bHkgaW5jcmVhc2luZy4nOwogICAgICBjb25zdCBtc2cyID0gJ3BlcmZvcm1hbmNlLm5vdyBjYW5ub3QgYmUgbW9kaWZpZWQgYW5kIHBlcmZvcm1hbmNlLm5vdygpIGlzIG5vdCBzdHJpY3RseSBpbmNyZWFzaW5nLic7CiAgICAgIGxvZ2dlck1zZyA9IHBlcmZvcm1hbmNlLm5vdyAhPT0gcGVyZm9ybWFuY2Uubm93MTYgPyBtc2cxIDogbXNnMjsgLy8gbWlnaHQgbm90IGFibGUgdG8gc2V0IGluIEZpcmVmb3gKICAgIH0KICAgIGxvZ2dlck1zZyAmJiBjb25zb2xlLndhcm4obG9nZ2VyTXNnKTsKICB9KSgpOwoKICBGSVhfcmVtb3ZlQ2hpbGQgJiYgKCgpID0+IHsKICAgIGlmICh0eXBlb2YgTm9kZS5wcm90b3R5cGUucmVtb3ZlQ2hpbGQgPT09ICdmdW5jdGlvbicgJiYgdHlwZW9mIE5vZGUucHJvdG90eXBlLnJlbW92ZUNoaWxkMDYyICE9PSAnZnVuY3Rpb24nKSB7CiAgICAgIE5vZGUucHJvdG90eXBlLnJlbW92ZUNoaWxkMDYyID0gTm9kZS5wcm90b3R5cGUucmVtb3ZlQ2hpbGQ7CiAgICAgIE5vZGUucHJvdG90eXBlLnJlbW92ZUNoaWxkID0gZnVuY3Rpb24gKGNoaWxkKSB7CiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLl9fc2hhZHlfbmF0aXZlX3JlbW92ZUNoaWxkICE9PSAnZnVuY3Rpb24nIHx8ICgoY2hpbGQgaW5zdGFuY2VvZiBOb2RlKSAmJiBjaGlsZC5wYXJlbnROb2RlID09PSB0aGlzKSkgewogICAgICAgICAgdGhpcy5yZW1vdmVDaGlsZDA2MihjaGlsZCk7CiAgICAgICAgfSBlbHNlIGlmICgoY2hpbGQgaW5zdGFuY2VvZiBFbGVtZW50KSAmJiBjaGlsZC5pcyA9PT0gJ3RwLXl0LXBhcGVyLXRvb2x0aXAnKSB7CiAgICAgICAgICAvLyB0b29sdGlwIGJ1ZwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBjb25zb2xlLndhcm4oJ1t5dC1qcy1lbmdpbmUtdGFtZXJdIE5vZGUgaXMgbm90IHJlbW92ZWQgZnJvbSBwYXJlbnQnLCB7IHBhcmVudDogdGhpcywgY2hpbGQ6IGNoaWxkIH0pCiAgICAgICAgfQogICAgICAgIHJldHVybiBjaGlsZDsKICAgICAgfQogICAgfQogIH0pKCk7CgogIC8vIFdFQUtSRUZfU2hhZHlET00KCiAgTU9ESUZZX1NoYWR5RE9NX09CSiAmJiAoKFdlYWtSZWYpID0+IHsKCiAgICBjb25zdCBzZXR1cFBsYWluU2hhZHlET00gPSAoYikgPT4gewogICAgICAoT01JVF9TaGFkeURPTV9zZXR0aW5ncyAmIDEpICYmIChiLmluVXNlID09PSB0cnVlKSAmJiAoYi5pblVzZSA9IGZhbHNlKTsKICAgICAgKE9NSVRfU2hhZHlET01fc2V0dGluZ3MgJiAyKSAmJiAoYi5oYW5kbGVzRHluYW1pY1Njb3BpbmcgPT09IHRydWUpICYmIChiLmhhbmRsZXNEeW5hbWljU2NvcGluZyA9IGZhbHNlKTsKICAgICAgKE9NSVRfU2hhZHlET01fc2V0dGluZ3MgJiA0KSAmJiAoYi5mb3JjZSA9PT0gdHJ1ZSkgJiYgKGIuZm9yY2UgPSBmYWxzZSk7CiAgICAgIGIucGF0Y2hPbkRlbWFuZCA9IHRydWU7CiAgICAgIGIucHJlZmVyUGVyZm9ybWFuY2UgPSB0cnVlOwogICAgICBiLm5vUGF0Y2ggPSB0cnVlOwogICAgfQoKICAgIGNvbnN0IGlzUGxhaW5PYmplY3QgPSAoYiwgbSkgPT4gewogICAgICBpZiAoIWIgfHwgdHlwZW9mIGIgIT09ICdvYmplY3QnKSByZXR1cm4gZmFsc2U7CiAgICAgIGNvbnN0IGUgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9ycyhiKTsKICAgICAgaWYgKGUubGVuZ3RoIDw9IG0pIHJldHVybiBmYWxzZTsKICAgICAgbGV0IHByID0gMDsKICAgICAgZm9yIChjb25zdCBrIGluIGUpIHsKICAgICAgICBjb25zdCBkID0gZVtrXTsKICAgICAgICBpZiAoIWQgfHwgZC5nZXQgfHwgZC5zZXQgfHwgIWQuZW51bWVyYWJsZSB8fCAhZC5jb25maWd1cmFibGUpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAoISgndmFsdWUnIGluIGQpIHx8IHR5cGVvZiBkLnZhbHVlID09PSAnZnVuY3Rpb24nKSByZXR1cm4gZmFsc2U7CiAgICAgICAgcHIrKzsKICAgICAgfQogICAgICByZXR1cm4gcHIgPiBtOwogICAgfQoKICAgIGxldCBiOwoKICAgIGxldCBseiA9IDA7CgogICAgY29uc3Qgc2RwID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih3aW5kb3csICdTaGFkeURPTScpOwogICAgaWYgKHNkcCAmJiBzZHAuY29uZmlndXJhYmxlICYmIHNkcC52YWx1ZSAmJiBzZHAuZW51bWVyYWJsZSAmJiBzZHAud3JpdGFibGUpIHsKCiAgICAgIC8vIEJyYXZlIC0gU2hhZHlET00gZXhpc3RzIGJlZm9yZSB1c2Vyc2NyaXB0aW5nCiAgICAgIGIgPSBzZHAudmFsdWU7CgogICAgICBpZiAoYiAmJiB0eXBlb2YgYiA9PT0gJ29iamVjdCcgJiYgaXNQbGFpbk9iamVjdChiLCAwKSkgewogICAgICAgIE9NSVRfU2hhZHlET01fRVhQRVJJTUVOVEFMICYmIHNldHVwUGxhaW5TaGFkeURPTShiKTsKICAgICAgICBseiA9IDE7CiAgICAgIH0KCiAgICB9CgoKICAgIGlmIChzZHAgJiYgc2RwLmNvbmZpZ3VyYWJsZSAmJiBzZHAudmFsdWUgJiYgc2RwLmVudW1lcmFibGUgJiYgc2RwLndyaXRhYmxlICYmICFzZHAuZ2V0ICYmICFzZHAuc2V0KSB7CiAgICB9IGVsc2UgaWYgKCFzZHApIHsKICAgIH0gZWxzZSB7CiAgICAgIGNvbnNvbGUubG9nKDM3MTksICdbeXQtanMtZW5naW5lLXRhbWVyXSBGSVg6OlNoYWR5RE9NIGlzIG5vdCBhcHBsaWVkIFsgUHJvcGVydHlEZXNjcmlwdG9yIGlzc3VlIF0nLCBzZHApOwogICAgICByZXR1cm47CiAgICB9CgogICAgY29uc3Qgc2hhZHlET01Ob2RlV1JNID0gbmV3IFdlYWtNYXAoKTsKCiAgICBjb25zb2xlLmxvZygzNzE5LCAnW3l0LWpzLWVuZ2luZS10YW1lcl0gRklYOjpTaGFkeURPTSA8PCAwMSA+PicsIGIpOwoKICAgIGNvbnN0IHdlYWtXcmFwcGVyTm9kZUhhbmRsZXJGbiA9ICgpID0+ICh7CiAgICAgIGdldCgpIHsKICAgICAgICBsZXQgdyA9IHNoYWR5RE9NTm9kZVdSTS5nZXQodGhpcyk7CiAgICAgICAgaWYgKHR5cGVvZiB3ID09PSAnb2JqZWN0JykgdyA9IGtSZWYodykgfHwgKHNoYWR5RE9NTm9kZVdSTS5kZWxldGUodGhpcyksIHVuZGVmaW5lZCk7CiAgICAgICAgcmV0dXJuIHc7CiAgICAgIH0sCiAgICAgIHNldChudikgewogICAgICAgIHNoYWR5RE9NTm9kZVdSTS5zZXQodGhpcywgbVdlYWtSZWYobnYpKTsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSwKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICB9KTsKCiAgICBmdW5jdGlvbiB3ZWFrV3JhcHBlcihfU2hhZHlET00pIHsKICAgICAgY29uc3QgU2hhZHlET00gPSBfU2hhZHlET007CiAgICAgIGlmIChXRUFLUkVGX1NoYWR5RE9NICYmIGx6IDwgMyAmJiB0eXBlb2YgV2Vha1JlZiA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgU2hhZHlET00uV3JhcHBlciA9PT0gJ2Z1bmN0aW9uJyAmJiBTaGFkeURPTS5XcmFwcGVyLmxlbmd0aCA9PT0gMSAmJiB0eXBlb2YgKFNoYWR5RE9NLldyYXBwZXIucHJvdG90eXBlIHx8IDApID09PSAnb2JqZWN0JykgewogICAgICAgIGxldCBudWxsRWxlbWVudCA9IHsgbm9kZTogbnVsbCB9OwogICAgICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZihudWxsRWxlbWVudCwgRWxlbWVudC5wcm90b3R5cGUpOwogICAgICAgIGxldCBwID0gbmV3IFNoYWR5RE9NLldyYXBwZXIobnVsbEVsZW1lbnQpOwogICAgICAgIGxldCBkID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihwLCAnbm9kZScpOwogICAgICAgIGlmIChkLmNvbmZpZ3VyYWJsZSAmJiBkLmVudW1lcmFibGUgJiYgIWQuZ2V0ICYmICFkLnNldCAmJiBkLndyaXRhYmxlICYmIGQudmFsdWUgPT09IG51bGxFbGVtZW50ICYmICFPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKFNoYWR5RE9NLldyYXBwZXIucHJvdG90eXBlLCAnbm9kZScpKSB7CiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoU2hhZHlET00uV3JhcHBlci5wcm90b3R5cGUsICdub2RlJywgd2Vha1dyYXBwZXJOb2RlSGFuZGxlckZuKCkpOwogICAgICAgICAgY29uc29sZS5sb2coJ1t5dC1qcy1lbmdpbmUtdGFtZXJdIEZJWDo6U2hhZHlET00gPDwgV0VBS1JFRl9TaGFkeURPTSA+PicpCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgbGV0IHByZXZpb3VzV3JhcFN0b3JlID0gbnVsbDsKCiAgICBjb25zdCBzdGFuZGFyZFdyYXAgPSBmdW5jdGlvbiAoYSkgewogICAgICBpZiAoYSBpbnN0YW5jZW9mIFNoYWRvd1Jvb3QgfHwgYSBpbnN0YW5jZW9mIFNoYWR5RE9NLldyYXBwZXIpIHJldHVybiBhOwogICAgICBpZiAocHJldmlvdXNXcmFwU3RvcmUpIHsKICAgICAgICBjb25zdCBzID0ga1JlZihwcmV2aW91c1dyYXBTdG9yZS5nZXQoYSkpOyAvLyBrUmVmIGZvciBwbGF5IHNhZmUgb25seQogICAgICAgIGlmIChzKSB7CiAgICAgICAgICBwcmV2aW91c1dyYXBTdG9yZS5kZWxldGUoYSk7CiAgICAgICAgICBzaGFkeURPTU5vZGVXUk0uc2V0KGEsIG1XZWFrUmVmKHMpKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgbGV0IHUgPSBrUmVmKHNoYWR5RE9NTm9kZVdSTS5nZXQoYSkpOwogICAgICBpZiAoIXUpIHsKICAgICAgICB1ID0gbmV3IFNoYWR5RE9NLldyYXBwZXIoYSk7CiAgICAgICAgc2hhZHlET01Ob2RlV1JNLnNldChhLCBtV2Vha1JlZih1KSk7CiAgICAgIH0KICAgICAgcmV0dXJuIHU7CiAgICB9CgoKICAgIGZ1bmN0aW9uIHNldHVwV3JhcEZ1bmMoX1NoYWR5RE9NKSB7CiAgICAgIGNvbnN0IFNoYWR5RE9NID0gX1NoYWR5RE9NOwoKCiAgICAgIGNvbnN0IHdtUEQgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKFdlYWtNYXAucHJvdG90eXBlLCAnZ2V0Jyk7CiAgICAgIGlmICghKHdtUEQgJiYgd21QRC53cml0YWJsZSAmJiAhd21QRC5lbnVtZXJhYmxlICYmIHdtUEQuY29uZmlndXJhYmxlICYmIHdtUEQudmFsdWUgJiYgIXdtUEQuZ2V0ICYmICF3bVBELnNldCkpIHsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgbGV0IG1tID0gbmV3IFNldCgpOwogICAgICBjb25zdCBwZ2V0ID0gd21QRC52YWx1ZTsKICAgICAgV2Vha01hcC5wcm90b3R5cGUuZ2V0ID0gZnVuY3Rpb24gKGEpIHsKICAgICAgICBtbS5hZGQodGhpcyk7CiAgICAgICAgcmV0dXJuIGE7CiAgICAgIH0KICAgICAgdHJ5IHsKICAgICAgICBsZXQgbnVsbEVsZW1lbnQgPSB7IG5vZGU6IG51bGwgfTsKICAgICAgICBPYmplY3Quc2V0UHJvdG90eXBlT2YobnVsbEVsZW1lbnQsIEVsZW1lbnQucHJvdG90eXBlKTsKICAgICAgICBTaGFkeURPTS53cmFwSWZOZWVkZWQobnVsbEVsZW1lbnQpCiAgICAgICAgU2hhZHlET00ud3JhcChudWxsRWxlbWVudCkKICAgICAgfSBjYXRjaCAoZSkgeyB9CiAgICAgIFdlYWtNYXAucHJvdG90eXBlLmdldCA9IHBnZXQ7CiAgICAgIGlmIChtbS5zaXplICE9PSAxKSB7CiAgICAgICAgbW0uY2xlYXIoKTsKICAgICAgICByZXR1cm47CiAgICAgIH0KICAgICAgY29uc3QgcCA9IG1tLnZhbHVlcygpLm5leHQoKS52YWx1ZTsKICAgICAgaWYgKCEocCBpbnN0YW5jZW9mIFdlYWtNYXApKSByZXR1cm47CiAgICAgIC8vIHAuY2xlYXIoKTsKICAgICAgLy8gcC5nZXQgPSBmdW5jdGlvbiAoYSkgeyByZXR1cm4gYSB9CiAgICAgIC8vIHAuc2V0ID0gZnVuY3Rpb24gKGEsIGIpIHsgcmV0dXJuIHRoaXMgfQogICAgICAvLyBjb25zb2xlLmxvZygxODgsIHdpbmRvdy5uMm4gPSBtbSwgd2luZG93Lm4ycCA9IHApCgogICAgICAvLyBjb25zb2xlLmxvZygzNDkyOSxwLnNpemUpCiAgICAgIHByZXZpb3VzV3JhcFN0b3JlID0gcDsKCiAgICAgIGlmICh0eXBlb2YgU2hhZHlET00ud3JhcCA9PT0gJ2Z1bmN0aW9uJyAmJiBTaGFkeURPTS53cmFwLmxlbmd0aCA9PT0gMSkgewogICAgICAgIFNoYWR5RE9NLndyYXAgPSBmdW5jdGlvbiAoYSkgeyAwICYmIGNvbnNvbGUubG9nKDM3MTksICdbeXQtanMtZW5naW5lLXRhbWVyXSAoT01JVF9TaGFkeURPTSkgZnVuY3Rpb24gY2FsbCAtIHdyYXAnKTsgcmV0dXJuIHN0YW5kYXJkV3JhcChhKSB9CiAgICAgIH0KICAgICAgaWYgKHR5cGVvZiBTaGFkeURPTS53cmFwSWZOZWVkZWQgPT09ICdmdW5jdGlvbicgJiYgU2hhZHlET00ud3JhcElmTmVlZGVkLmxlbmd0aCA9PT0gMSkgewogICAgICAgIFNoYWR5RE9NLndyYXBJZk5lZWRlZCA9IGZ1bmN0aW9uIChhKSB7IGNvbnNvbGUubG9nKDM3MTksICdbeXQtanMtZW5naW5lLXRhbWVyXSAoT01JVF9TaGFkeURPTSkgZnVuY3Rpb24gY2FsbCAtIHdyYXBJZk5lZWRlZCcpOyByZXR1cm4gc3RhbmRhcmRXcmFwKGEpIH0KICAgICAgfQoKICAgIH0KCiAgICBmdW5jdGlvbiBzZXR1cExaMyhudikgewoKICAgICAgY29uc3QgU2hhZHlET00gPSBudjsKCiAgICAgIGNvbnN0IFNoYWR5RE9NU2V0dGluZ3MgPSBTaGFkeURPTS5zZXR0aW5nczsKICAgICAgaWYgKCEoU2hhZHlET01TZXR0aW5ncy5pblVzZSA9PT0gdHJ1ZSAmJiBTaGFkeURPTS5pblVzZSA9PT0gdHJ1ZSAmJiAoU2hhZHlET01TZXR0aW5ncy5oYW5kbGVzRHluYW1pY1Njb3BpbmcgfHwgU2hhZHlET00uaGFuZGxlc0R5bmFtaWNTY29waW5nKSA9PT0gdHJ1ZSkpIHsKICAgICAgICBjb25zb2xlLmxvZygzNzE5LCAnW3l0LWpzLWVuZ2luZS10YW1lcl0gT01JVF9TaGFkeURPTSBpcyBub3QgYXBwbGllZCBbMDJdJywgd2luZG93LlNoYWR5RE9NKTsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHdlYWtXcmFwcGVyKFNoYWR5RE9NKTsKCiAgICAgIGlmIChPTUlUX1NoYWR5RE9NX0VYUEVSSU1FTlRBTCAmJiBseiA8IDMpIHsKCiAgICAgICAgc2V0dXBQbGFpblNoYWR5RE9NKFNoYWR5RE9NU2V0dGluZ3MpOwogICAgICAgIHNldHVwUGxhaW5TaGFkeURPTShTaGFkeURPTSk7CgogICAgICAgIFNoYWR5RE9NLmlzU2hhZHlSb290ID0gZnVuY3Rpb24gKCkgeyBjb25zb2xlLmxvZygzNzE5LCAnW3l0LWpzLWVuZ2luZS10YW1lcl0gKE9NSVRfU2hhZHlET00pIGZ1bmN0aW9uIGNhbGwgLSBpc1NoYWR5Um9vdCcpOyByZXR1cm4gZmFsc2U7IH0KCiAgICAgICAgc2V0dXBXcmFwRnVuYyhTaGFkeURPTSk7CiAgICAgICAgU2hhZHlET00ucGF0Y2hFbGVtZW50UHJvdG8gPSBmdW5jdGlvbiAoKSB7IGNvbnNvbGUubG9nKDM3MTksICdbeXQtanMtZW5naW5lLXRhbWVyXSAoT01JVF9TaGFkeURPTSkgZnVuY3Rpb24gY2FsbCAtIHBhdGNoRWxlbWVudFByb3RvJykgfQogICAgICAgIFNoYWR5RE9NLnBhdGNoID0gZnVuY3Rpb24gKCkgeyBjb25zb2xlLmxvZygzNzE5LCAnW3l0LWpzLWVuZ2luZS10YW1lcl0gKE9NSVRfU2hhZHlET00pIGZ1bmN0aW9uIGNhbGwgLSBwYXRjaCcpIH0KCiAgICAgICAgLy8gVG8gYmUgY29uZmlybWVkCiAgICAgICAgaWYgKE9NSVRfU2hhZHlET01fRVhQRVJJTUVOVEFMICYgMikgewogICAgICAgICAgU2hhZHlET00uY29tcG9zZWRQYXRoID0gZnVuY3Rpb24gKGUpIHsKICAgICAgICAgICAgY29uc3QgdCA9IChlIHx8IDApLnRhcmdldCB8fCBudWxsOwogICAgICAgICAgICBpZiAoISh0IGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpKSB7CiAgICAgICAgICAgICAgY29uc29sZS5sb2coMzcxOSwgJ1t5dC1qcy1lbmdpbmUtdGFtZXJdIChPTUlUX1NoYWR5RE9NJjIpIGNvbXBvc2VkUGF0aCcsIHQpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHQgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCA/IFt0XSA6IFtdOwogICAgICAgICAgfTsKICAgICAgICB9CgogICAgICB9CgogICAgfQoKCiAgICBmdW5jdGlvbiBzZXR1cExaNihudikgewoKICAgICAgY29uc3QgU2hhZHlET00gPSBudjsKCiAgICAgIGNvbnN0IFNoYWR5RE9NU2V0dGluZ3MgPSBTaGFkeURPTS5zZXR0aW5nczsKCiAgICAgIGlmICghKFNoYWR5RE9NU2V0dGluZ3MuaW5Vc2UgPT09IHRydWUgJiYgU2hhZHlET00uaW5Vc2UgPT09IHRydWUgJiYgKFNoYWR5RE9NU2V0dGluZ3MuaGFuZGxlc0R5bmFtaWNTY29waW5nIHx8IFNoYWR5RE9NLmhhbmRsZXNEeW5hbWljU2NvcGluZykgPT09IHRydWUpKSB7CiAgICAgICAgY29uc29sZS5sb2coMzcxOSwgJ1t5dC1qcy1lbmdpbmUtdGFtZXJdIE9NSVRfU2hhZHlET00gaXMgbm90IGFwcGxpZWQgWzAyXScsIHdpbmRvdy5TaGFkeURPTSk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CgogICAgICB3ZWFrV3JhcHBlcihTaGFkeURPTSk7CgogICAgICBpZiAoT01JVF9TaGFkeURPTV9FWFBFUklNRU5UQUwgJiYgbHogPCAzKSB7CgogICAgICAgIHNldHVwUGxhaW5TaGFkeURPTShTaGFkeURPTVNldHRpbmdzKTsKICAgICAgICBzZXR1cFBsYWluU2hhZHlET00oU2hhZHlET00pOwoKICAgICAgICBzZXR1cFdyYXBGdW5jKFNoYWR5RE9NKTsKCiAgICAgIH0KCiAgICB9CgogICAgaWYgKGIgJiYgdHlwZW9mIGIuV3JhcHBlciA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgYi5zZXR0aW5ncyA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIGIud3JhcCA9PT0gJ2Z1bmN0aW9uJykgewoKICAgICAgY29uc3QgbnYgPSBiOwoKICAgICAgaWYgKHNldHVwTFo2KG52KSA9PT0gZmFsc2UpIHJldHVybjsKCiAgICAgIGx6ID0gNjsKCiAgICAgIGNvbnNvbGUubG9nKDM3MTksICdbeXQtanMtZW5naW5lLXRhbWVyXSBGSVg6OlNoYWR5RE9NIDw8IDAyYiA+PicsIG52KQoKICAgICAgcmV0dXJuOwogICAgfQoKICAgIGRlbGV0ZSB3aW5kb3cuU2hhZHlET007CgogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHdpbmRvdywgJ1NoYWR5RE9NJywgewogICAgICBnZXQoKSB7CiAgICAgICAgcmV0dXJuIGI7CiAgICAgIH0sCiAgICAgIHNldChudikgewogICAgICAgIGxldCByZXQgPSAwOwogICAgICAgIHRyeSB7CiAgICAgICAgICBkbyB7CiAgICAgICAgICAgIGlmICghbnYgfHwgIW52LnNldHRpbmdzKSB7CiAgICAgICAgICAgICAgaWYgKGx6IDwgMSAmJiBudiAmJiB0eXBlb2YgbnYgPT09ICdvYmplY3QnICYmIGlzUGxhaW5PYmplY3QobnYsIDApKSB7CiAgICAgICAgICAgICAgICBPTUlUX1NoYWR5RE9NX0VYUEVSSU1FTlRBTCAmJiBzZXR1cFBsYWluU2hhZHlET00obnYpOwogICAgICAgICAgICAgICAgbHogPSAxOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKDM3MTksICdbeXQtanMtZW5naW5lLXRhbWVyXSBGSVg6OlNoYWR5RE9NIGlzIG5vdCBhcHBsaWVkIFtudjpudWxsXScsIG52KTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgY29uc3Qgc2RwID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcih0aGlzIHx8IHt9LCAnU2hhZHlET00nKTsKICAgICAgICAgICAgaWYgKCEoc2RwICYmIHNkcC5jb25maWd1cmFibGUgJiYgc2RwLmdldCAmJiBzZHAuc2V0KSkgewogICAgICAgICAgICAgIGNvbnNvbGUubG9nKDM3MTksICdbeXQtanMtZW5naW5lLXRhbWVyXSBPTUlUX1NoYWR5RE9NIGlzIG5vdCBhcHBsaWVkIFsgaW5jb3JyZWN0IFByb3BlcnR5RGVzY3JpcHRvciBdJywgbnYpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoc2V0dXBMWjMobnYpID09PSBmYWxzZSkgYnJlYWs7CgogICAgICAgICAgICBseiA9IDM7CgogICAgICAgICAgICBjb25zb2xlLmxvZygzNzE5LCAnW3l0LWpzLWVuZ2luZS10YW1lcl0gRklYOjpTaGFkeURPTSA8PCAwMmEgPj4nLCBudikKCiAgICAgICAgICAgIHJldCA9IDE7CgogICAgICAgICAgfSB3aGlsZSAoMCk7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgY29uc29sZS5sb2coJ1t5dC1qcy1lbmdpbmUtdGFtZXJdIEZJWDo6U2hhZHlET00gPDwgRVJST1IgPj4nLCBlKQogICAgICAgIH0KCiAgICAgICAgaWYgKCFyZXQpIGIgPSBudjsKICAgICAgICBlbHNlIHsKICAgICAgICAgIGRlbGV0ZSB0aGlzLlNoYWR5RE9NOwogICAgICAgICAgdGhpcy5TaGFkeURPTSA9IG52OwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfSwKICAgICAgZW51bWVyYWJsZTogZmFsc2UsCiAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgfSk7CgogIH0pKHR5cGVvZiBXZWFrUmVmICE9PSAndW5kZWZpbmVkJyA/IFdlYWtSZWYgOiBmdW5jdGlvbiAoKSB7IH0pOwoKICBpZiAoRU5BQkxFX0FTWU5DX0RJU1BBVENIRVZFTlQgJiYgbmV4dEJyb3dzZXJUaWNrKSB7CiAgICBjb25zdCBmaWx0ZXIgPSBuZXcgU2V0KFsKICAgICAgJ3l0LWFjdGlvbicsCiAgICAgIC8vICdpZnJhbWUtc3JjLXJlcGxhY2VkJywKICAgICAgJ3Nob3duLWl0ZW1zLWNoYW5nZWQnLAogICAgICAnY2FuLXNob3ctbW9yZS1jaGFuZ2VkJywgJ2NvbGxhcHNlZC1jaGFuZ2VkJywKCiAgICAgICd5dC1uYXZpZ2F0ZScsICd5dC1uYXZpZ2F0ZS1zdGFydCcsICd5dC1uYXZpZ2F0ZS1jYWNoZScsCiAgICAgICd5dC1wbGF5ZXItdXBkYXRlZCcsICd5dC1wYWdlLWRhdGEtZmV0Y2hlZCcsICd5dC1wYWdlLXR5cGUtY2hhbmdlZCcsICd5dC1wYWdlLWRhdGEtdXBkYXRlZCcsCiAgICAgICd5dC1uYXZpZ2F0ZS1maW5pc2gnLAoKICAgICAgLy8gJ2RhdGEtY2hhbmdlZCcsJ3l0LXdhdGNoLWNvbW1lbnRzLXJlYWR5JwogICAgXSkKICAgIEV2ZW50VGFyZ2V0LnByb3RvdHlwZS5kaXNwYXRjaEV2ZW50OTM4ID0gRXZlbnRUYXJnZXQucHJvdG90eXBlLmRpc3BhdGNoRXZlbnQ7CiAgICBFdmVudFRhcmdldC5wcm90b3R5cGUuZGlzcGF0Y2hFdmVudCA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICBjb25zdCB0eXBlID0gKGV2ZW50IHx8IDApLnR5cGU7CiAgICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gJ3N0cmluZycgJiYgZXZlbnQuaXNUcnVzdGVkID09PSBmYWxzZSAmJiAoZXZlbnQgaW5zdGFuY2VvZiBDdXN0b21FdmVudCkgJiYgZXZlbnQuY2FuY2VsYWJsZSA9PT0gZmFsc2UpIHsKICAgICAgICBpZiAoIWZpbHRlci5oYXModHlwZSkgJiYgIXR5cGUuZW5kc1dpdGgoJy1jaGFuZ2VkJykpIHsKICAgICAgICAgIGlmICh0aGlzIGluc3RhbmNlb2YgTm9kZSB8fCB0aGlzIGluc3RhbmNlb2YgV2luZG93KSB7CiAgICAgICAgICAgIG5leHRCcm93c2VyVGljaygoKSA9PiB0aGlzLmRpc3BhdGNoRXZlbnQ5MzgoZXZlbnQpKTsKICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmRpc3BhdGNoRXZlbnQ5MzgoZXZlbnQpOwogICAgfQogIH0KCiAgLy8gYXZvaWQgUkVHRVhQIHRlc3RQYXR0ZXJuIGV4ZWN1dGlvbiBpbiBCcmF2ZSdzIHNjcmlwdGxldCBmb3IgcGVyZm9ybWFuY2UgYm9vc3QKICBTQ1JJUFRMRVRfUkVNT1ZFX1BSVU5FX3Byb3BOZWVkbGVzICYmICgoKSA9PiB7CiAgICAvLyBjb25zdCB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3Q7CiAgICBjb25zdCBwZE9yaSA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoTWFwLnByb3RvdHlwZSwgJ3NpemUnKTsKICAgIGlmICghcGRPcmkgfHwgcGRPcmkuY29uZmlndXJhYmxlICE9PSB0cnVlKSByZXR1cm47CiAgICBsZXQgcHJvcE5lZWRsZXMgPSBudWxsOwogICAgY29uc3QgcGROZXcgPSB7CiAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgZW51bWVyYWJsZTogdHJ1ZSwKICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7CiAgICAgICAgcHJvcE5lZWRsZXMgPSB0aGlzOwogICAgICAgIGlmIChERUJVR19yZW1vdmVQcnVuZSkgZGVidWdnZXI7IC8vIHRvIGxvY2F0ZSBCcmF2ZSBzY3JpcHRsZXRzCiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCk7CiAgICAgIH0KICAgIH0KICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShNYXAucHJvdG90eXBlLCAnc2l6ZScsIHBkTmV3KTsKICAgIHRyeSB7CiAgICAgIFhNTEh0dHBSZXF1ZXN0LnByb3RvdHlwZS5vcGVuLmNhbGwoMCk7CiAgICAgIC8vIHhoci5vcGVuLmNhbGwobnVsbCkKICAgIH0gY2F0Y2ggKGUpIHsgfQogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KE1hcC5wcm90b3R5cGUsICdzaXplJywgcGRPcmkpOwogICAgaWYgKCFwcm9wTmVlZGxlcykgcmV0dXJuOwogICAgY29uc3QgZW50cmllcyA9IFsuLi5wcm9wTmVlZGxlcy5lbnRyaWVzKCldOwogICAgcHJvcE5lZWRsZXMuY2xlYXIoKTsKICAgIGNvbnNvbGUubG9nKCdbeXQtanMtZW5naW5lLXRhbWVyXSBwcm9wTmVlZGxlcyBpcyBjbGVhcmVkIGZyb20gc2NyaXB0bGV0JywgZW50cmllcywgcHJvcE5lZWRsZXMpOwogIH0pKCk7CgogIGlmIChGSVhfWEhSX1JFUVVFU1RJTkcpIHsKCiAgICBjb25zdCBVUkwgPSB3aW5kb3cuVVJMIHx8IG5ldyBGdW5jdGlvbigncmV0dXJuIFVSTCcpKCk7CiAgICBjb25zdCBjcmVhdGVPYmplY3RVUkwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMLmJpbmQoVVJMKTsKCiAgICBYTUxIdHRwUmVxdWVzdCA9ICgoKSA9PiB7CiAgICAgIGNvbnN0IFhNTEh0dHBSZXF1ZXN0XyA9IFhNTEh0dHBSZXF1ZXN0OwogICAgICBpZiAoJ19feG1NYzhfXycgaW4gWE1MSHR0cFJlcXVlc3RfLnByb3RvdHlwZSkgcmV0dXJuIFhNTEh0dHBSZXF1ZXN0XzsKICAgICAgY29uc3QgdXJsMCA9IGNyZWF0ZU9iamVjdFVSTChuZXcgQmxvYihbXSwgeyB0eXBlOiAndGV4dC9wbGFpbicgfSkpOwogICAgICBjb25zdCBjID0gY2xhc3MgWE1MSHR0cFJlcXVlc3QgZXh0ZW5kcyBYTUxIdHRwUmVxdWVzdF8gewogICAgICAgIGNvbnN0cnVjdG9yKC4uLmFyZ3MpIHsKICAgICAgICAgIHN1cGVyKC4uLmFyZ3MpOwogICAgICAgIH0KICAgICAgICBvcGVuKG1ldGhvZCwgdXJsLCAuLi5hcmdzKSB7CiAgICAgICAgICBsZXQgc2tpcCA9IGZhbHNlOwogICAgICAgICAgaWYgKCF1cmwgfHwgdHlwZW9mIHVybCAhPT0gJ3N0cmluZycpIHNraXAgPSB0cnVlOwogICAgICAgICAgZWxzZSBpZiAodHlwZW9mIHVybCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgbGV0IHR1cmwgPSB1cmxbMF0gPT09ICcvJyA/IGAueW91dHViZS5jb20ke3VybH1gIDogYCR7dXJsfWA7CiAgICAgICAgICAgIGlmICh0dXJsLmluY2x1ZGVzKCdnb29nbGVhZHMnKSB8fCB0dXJsLmluY2x1ZGVzKCdkb3VibGVjbGljay5uZXQnKSkgewogICAgICAgICAgICAgIHNraXAgPSB0cnVlOwogICAgICAgICAgICB9IGVsc2UgaWYgKHR1cmwuaW5jbHVkZXMoJy55b3V0dWJlLmNvbS9wYWdlYWQvJykpIHsKICAgICAgICAgICAgICBza2lwID0gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0dXJsLmluY2x1ZGVzKCcueW91dHViZS5jb20vcHRyYWNraW5nJykpIHsKICAgICAgICAgICAgICBza2lwID0gdHJ1ZTsKICAgICAgICAgICAgfSBlbHNlIGlmICh0dXJsLmluY2x1ZGVzKCcueW91dHViZS5jb20veW91dHViZWkvdjEvbG9nX2V2ZW50PycpKSB7CiAgICAgICAgICAgICAgc2tpcCA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHVybC5pbmNsdWRlcygnLnlvdXR1YmUuY29tL2FwaS9zdGF0cy8nKSkgeyAvLyAvYXBpL3N0YXRzLwogICAgICAgICAgICAgIGlmICh0dXJsLmluY2x1ZGVzKCcueW91dHViZS5jb20vYXBpL3N0YXRzL3FvZT8nKSkgewogICAgICAgICAgICAgICAgc2tpcCA9IHRydWU7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0dXJsLmluY2x1ZGVzKCcueW91dHViZS5jb20vYXBpL3N0YXRzL2Fkcz8nKSkgewogICAgICAgICAgICAgICAgc2tpcCA9IHRydWU7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIC8vIHNraXAgPSB0cnVlOyAvLyBmb3IgdXNlciBhY3Rpdml0eSBsb2dnaW5nIGUuZy4gd2F0Y2hlZCB2aWRlb3MKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHVybC5pbmNsdWRlcygncGxheS5nb29nbGUuY29tL2xvZycpKSB7CiAgICAgICAgICAgICAgc2tpcCA9IHRydWU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodHVybC5pbmNsdWRlcygnLnlvdXR1YmUuY29tLy8/JykpIHsgLy8gLy8/Y3BuPQogICAgICAgICAgICAgIHNraXAgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoIXNraXApIHsKICAgICAgICAgICAgdGhpcy5fX3htTWM4X18gPSAxOwogICAgICAgICAgICByZXR1cm4gc3VwZXIub3BlbihtZXRob2QsIHVybCwgLi4uYXJncyk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLl9feG1NYzhfXyA9IDI7CiAgICAgICAgICAgIHJldHVybiBzdXBlci5vcGVuKCdHRVQnLCB1cmwwKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgc2VuZCguLi5hcmdzKSB7CiAgICAgICAgICBpZiAodGhpcy5fX3htTWM4X18gPT09IDEpIHsKICAgICAgICAgICAgcmV0dXJuIHN1cGVyLnNlbmQoLi4uYXJncyk7CiAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuX194bU1jOF9fID09PSAyKSB7CiAgICAgICAgICAgIHJldHVybiBzdXBlci5zZW5kKCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zb2xlLmxvZygnW3l0LWpzLWVuZ2luZS10YW1lcl0nLCAneGhyIHdhcm5pbmcnKTsKICAgICAgICAgICAgcmV0dXJuIHN1cGVyLnNlbmQoLi4uYXJncyk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIGMucHJvdG90eXBlLl9feG1NYzhfXyA9IDA7CiAgICAgIHByb3RvdHlwZUluaGVyaXQoYy5wcm90b3R5cGUsIFhNTEh0dHBSZXF1ZXN0Xy5wcm90b3R5cGUpOwogICAgICByZXR1cm4gYzsKICAgIH0pKCk7CiAgfQoKICAvLyBBbHRlcm5hdGl2ZSBIQUNLIC0+IFRhYnZpZXcgWW91dHViZQogIGlmIChESVNBQkxFX0NPT0xET1dOX1NDUk9MTElORyAmJiB0eXBlb2YgRXZlbnRUYXJnZXQucHJvdG90eXBlLmFkZEV2ZW50TGlzdGVuZXI1MjE3OCAhPT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgRXZlbnRUYXJnZXQucHJvdG90eXBlLmFkZEV2ZW50TGlzdGVuZXIgPT09ICdmdW5jdGlvbicpIHsKCiAgICAvLyAtLS0tIDw8IHRoaXMub3ZlcnNjcm9sbENvbmZpZyBIQUNLID4+ICAtLS0tLQoKICAgIC8vIDIwMjQuMDQuMTkgLSBQbGF5bGlzdCBpbiBTaW5nbGUgQ29sdW1uIE1vZGUgY2Fubm90IGJlIHNjcm9sbGVkIGNvcnJlY3RseS4KCiAgICAvKgoKICAgICAgO2Z1bmN0aW9uIGdaYihhLCBiKSB7CiAgICAgICAgICBiID0gdm9pZCAwID09PSBiID8gITAgOiBiOwogICAgICAgICAgYS5hZGRFdmVudExpc3RlbmVyKCJ3aGVlbCIsIGhaYik7CiAgICAgICAgICBhLm92ZXJzY3JvbGxDb25maWcgPSB7CiAgICAgICAgICAgICAgY29vbGRvd246IGIKICAgICAgICAgIH0KICAgICAgfQogICAgICBmdW5jdGlvbiBpWmIoYSkgewogICAgICAgICAgYS5vdmVyc2Nyb2xsQ29uZmlnID0gdm9pZCAwOwogICAgICAgICAgYS5yZW1vdmVFdmVudExpc3RlbmVyKCJ3aGVlbCIsIGhaYikKICAgICAgfQogICAgICBmdW5jdGlvbiBoWmIoYSkgewogICAgICAgICAgdmFyIGIgPSBhLmRlbHRhWQogICAgICAgICAgICAsIGMgPSBhLnRhcmdldAogICAgICAgICAgICAsIGQgPSBudWxsOwogICAgICAgICAgaWYgKHdpbmRvdy5Qb2x5bWVyICYmIHdpbmRvdy5Qb2x5bWVyLkVsZW1lbnQpIHsKICAgICAgICAgICAgICBpZiAoYyA9IGEucGF0aCB8fCBhLmNvbXBvc2VkUGF0aCAmJiBhLmNvbXBvc2VkUGF0aCgpKSB7CiAgICAgICAgICAgICAgICAgIGMgPSBnKGMpOwogICAgICAgICAgICAgICAgICBmb3IgKHZhciBlID0gYy5uZXh0KCk7ICFlLmRvbmUgJiYgKGUgPSBlLnZhbHVlLAogICAgICAgICAgICAgICAgICAhalpiKGUsIGIpKTsgZSA9IGMubmV4dCgpKQogICAgICAgICAgICAgICAgICAgICAgaWYgKGUub3ZlcnNjcm9sbENvbmZpZykgewogICAgICAgICAgICAgICAgICAgICAgICAgIGQgPSBlOwogICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlCiAgICAgICAgICAgICAgZm9yICg7IGMgJiYgIWpaYihjLCBiKTsgKSB7CiAgICAgICAgICAgICAgICAgIGlmIChjLm92ZXJzY3JvbGxDb25maWcpIHsKICAgICAgICAgICAgICAgICAgICAgIGQgPSBjOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBjID0gYy5wYXJlbnRFbGVtZW50CiAgICAgICAgICAgICAgfQogICAgICAgICAgZCAmJiAoYiA9IGQub3ZlcnNjcm9sbENvbmZpZywKICAgICAgICAgIGIuY29vbGRvd24gPyAoZCA9IGEuZGVsdGFZLAogICAgICAgICAgYyA9IGIubGFzdERlbHRhWSB8fCAwLAogICAgICAgICAgYi5sYXN0RGVsdGFZID0gZCwKICAgICAgICAgIGUgPSBiLmxhc3RTdG9wcGVkIHx8IDAsCiAgICAgICAgICBjICYmIGUgJiYgMCA8IGMgPT0gMCA8IGQgPyBNYXRoLmFicyhjKSA+PSBNYXRoLmFicyhkKSA/IChkID0gZSArIDEyMDAsCiAgICAgICAgICBjID0gITEpIDogKGQgPSBlICsgNjAwLAogICAgICAgICAgYyA9ICEwKSA6IChkID0gRGF0ZS5ub3coKSArIDYwMCwKICAgICAgICAgIGMgPSAhMCksCiAgICAgICAgICBkID4gRGF0ZS5ub3coKSAmJiAoYS5wcmV2ZW50RGVmYXVsdCgpLAogICAgICAgICAgYyAmJiAoYi5sYXN0U3RvcHBlZCA9IERhdGUubm93KCkpKSkgOiBhLnByZXZlbnREZWZhdWx0KCkpCiAgICAgIH0KICAgICovCgogICAgbGV0IHdoZWVsSGFuZGxlciA9IGZ1bmN0aW9uIChhKSB7CiAgICAgIGlmICh3aW5kb3cuUG9seW1lciAmJiB3aW5kb3cuUG9seW1lci5FbGVtZW50KSB7CiAgICAgICAgbGV0IGM7CiAgICAgICAgaWYgKGMgPSBhLnBhdGggfHwgYS5jb21wb3NlZFBhdGggJiYgYS5jb21wb3NlZFBhdGgoKSkgewogICAgICAgICAgZm9yIChjb25zdCBlIG9mIGMpIHsKICAgICAgICAgICAgY29uc3QgY250ID0gaW5zcChlKTsKICAgICAgICAgICAgaWYgKGUub3ZlcnNjcm9sbENvbmZpZykgZS5vdmVyc2Nyb2xsQ29uZmlnID0gdm9pZCAwOwogICAgICAgICAgICBpZiAoY250Lm92ZXJzY3JvbGxDb25maWcpIGNudC5vdmVyc2Nyb2xsQ29uZmlnID0gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICBsZXQgZSA9IGEudGFyZ2V0OwogICAgICAgIGZvciAoOyBlIGluc3RhbmNlb2YgRWxlbWVudDsgZSA9IGUucGFyZW50RWxlbWVudCkgewogICAgICAgICAgY29uc3QgY250ID0gaW5zcChlKTsKICAgICAgICAgIGlmIChlLm92ZXJzY3JvbGxDb25maWcpIGUub3ZlcnNjcm9sbENvbmZpZyA9IHZvaWQgMDsKICAgICAgICAgIGlmIChjbnQub3ZlcnNjcm9sbENvbmZpZykgY250Lm92ZXJzY3JvbGxDb25maWcgPSB2b2lkIDA7CiAgICAgICAgfQogICAgICB9CiAgICB9OwoKICAgIGxldCBjaGVja1doZWVsTGlzdGVuZXJPYmpzID0gbnVsbDsKCiAgICBsZXQgZ2V0T2Jqc0ZuID0gKCkgPT4gewogICAgICBsZXQgZXV5VmFsID0gMDsKICAgICAgY29uc3QgZXVrRWxtID0ge307CiAgICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZihldWtFbG0sIEhUTUxFbGVtZW50LnByb3RvdHlwZSk7CiAgICAgIGNvbnN0IGV1ek9iaiA9IG5ldyBQcm94eShldWtFbG0sIHsKICAgICAgICBnZXQodGFyZ2V0LCBwcm9wKSB7CiAgICAgICAgICB0aHJvdyBgRXJyb3JGMzEuZ2V0KCR7cHJvcH0pYAogICAgICAgIH0sCiAgICAgICAgc2V0KHRhcmdldCwgcHJvcCwgdmFsdWUpIHsKICAgICAgICAgIHRocm93IGBFcnJvckYzMy5zZXQoJHtwcm9wfSwgJHt2YWx1ZX0pYAogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGNvbnN0IGV1eEVsbSA9IG5ldyBQcm94eShldWtFbG0sIHsKICAgICAgICBnZXQodGFyZ2V0LCBwcm9wKSB7CiAgICAgICAgICBpZiAocHJvcCA9PT0gJ3Njcm9sbFRvcCcpIHsKICAgICAgICAgICAgZXV5VmFsID0gZXV5VmFsIHwgODsKICAgICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocHJvcCA9PT0gJ292ZXJzY3JvbGxDb25maWcnKSB7CiAgICAgICAgICAgIGV1eVZhbCA9IGV1eVZhbCB8IDE2OwogICAgICAgICAgICByZXR1cm4gdm9pZCAwOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHByb3AgPT09ICdzY3JvbGxIZWlnaHQnIHx8IHByb3AgPT09ICdjbGllbnRIZWlnaHQnIHx8IHByb3AgPT09ICdvZmZzZXRIZWlnaHQnKSB7CiAgICAgICAgICAgIHJldHVybiA2NDA7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocHJvcCA9PT0gJ3Njcm9sbExlZnQnKSB7CiAgICAgICAgICAgIGV1eVZhbCA9IGV1eVZhbCB8IDg7CiAgICAgICAgICAgIHJldHVybiAwOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHByb3AgPT09ICdzY3JvbGxXaWR0aCcgfHwgcHJvcCA9PT0gJ2NsaWVudFdpZHRoJyB8fCBwcm9wID09PSAnb2Zmc2V0V2lkdGgnKSB7CiAgICAgICAgICAgIHJldHVybiA4MDA7CiAgICAgICAgICB9CiAgICAgICAgICB0aHJvdyBgRXJyb3JGNDUuZ2V0KCR7cHJvcH0pYAogICAgICAgIH0sCiAgICAgICAgc2V0KHRhcmdldCwgcHJvcCwgdmFsdWUpIHsKICAgICAgICAgIHRocm93IGBFcnJvckY0Ny5zZXQoJHtwcm9wfSwgJHt2YWx1ZX0pYAogICAgICAgIH0KICAgICAgfSk7CiAgICAgIGNvbnN0IGV1a0V2dCA9IHt9OwogICAgICBPYmplY3Quc2V0UHJvdG90eXBlT2YoZXVrRXZ0LCBXaGVlbEV2ZW50LnByb3RvdHlwZSk7CiAgICAgIGNvbnN0IGV1eUV2dCA9IG5ldyBQcm94eShldWtFdnQsIHsKICAgICAgICBnZXQodGFyZ2V0LCBwcm9wKSB7CiAgICAgICAgICBpZiAocHJvcCA9PT0gJ2RlbHRhWScgfHwgcHJvcCA9PT0gJ2RlbHRhWCcpIHsKICAgICAgICAgICAgZXV5VmFsID0gZXV5VmFsIHwgMTsKICAgICAgICAgICAgcmV0dXJuIC05OTk7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAocHJvcCA9PT0gJ3RhcmdldCcpIHsKICAgICAgICAgICAgZXV5VmFsID0gZXV5VmFsIHwgMjsKICAgICAgICAgICAgcmV0dXJuIGV1eEVsbQogICAgICAgICAgfQogICAgICAgICAgaWYgKHByb3AgPT09ICdwYXRoJyB8fCBwcm9wID09PSAnY29tcG9zZWRQYXRoJykgewogICAgICAgICAgICBldXlWYWwgPSBldXlWYWwgfCAyOwogICAgICAgICAgICByZXR1cm4gW2V1eEVsbV0KICAgICAgICAgIH0KICAgICAgICAgIHRocm93IGBFcnJvckY1MS5nZXQoJHtwcm9wfSlgCiAgICAgICAgfSwKICAgICAgICBzZXQodGFyZ2V0LCBwcm9wLCB2YWx1ZSkgewogICAgICAgICAgdGhyb3cgYEVycm9yRjUzLnNldCgke3Byb3B9LCAke3ZhbHVlfSlgCiAgICAgICAgfQogICAgICB9KTsKICAgICAgY29uc3Qgc2V0VmFsID0gKHYpID0+IHsKICAgICAgICBldXlWYWwgPSB2OwogICAgICB9CiAgICAgIGNvbnN0IGdldFZhbCA9ICgpID0+IHsKICAgICAgICByZXR1cm4gZXV5VmFsOwogICAgICB9CiAgICAgIHJldHVybiB7IGV1ek9iaiwgZXV5RXZ0LCBzZXRWYWwsIGdldFZhbCB9OwogICAgfQoKICAgIGxldCBjaGVja1doZWVsTGlzdGVuZXIgPSAoY2FsbGJhY2spID0+IHsKCiAgICAgIGxldCBjYWxsYmFja0lkZW50aWZpZXIgPSAnJzsKCiAgICAgIGxldCByZXMgPSBudWxsOwogICAgICB0cnkgewogICAgICAgIGNvbnN0IHsgZXV6T2JqLCBldXlFdnQsIGdldFZhbCwgc2V0VmFsIH0gPSBjaGVja1doZWVsTGlzdGVuZXJPYmpzIHx8IChjaGVja1doZWVsTGlzdGVuZXJPYmpzID0gZ2V0T2Jqc0ZuKCkpOwogICAgICAgIHNldFZhbCgwKTsKICAgICAgICBpZiAoY2FsbGJhY2suY2FsbChldXpPYmosIGV1eUV2dCkgIT09IHZvaWQgMCkgdGhyb3cgJ0Vycm9yRjk5JzsKICAgICAgICB0aHJvdyBgUkVTVUxUJHtnZXRWYWwoKX1gOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgcmVzID0gZTsKICAgICAgfQoKICAgICAgcmVzID0gYCR7cmVzfWAgfHwgYCR7bnVsbH1gOwogICAgICBpZiAocmVzLmxlbmd0aCA+IDIwKSByZXMgPSBgJHtyZXMuc3Vic3RyaW5nKDAsIDIwKX0uLi5gOwoKICAgICAgY2FsbGJhY2tJZGVudGlmaWVyID0gcmVzOwogICAgICBpZiAoY2FsbGJhY2tJZGVudGlmaWVyID09PSAnUkVTVUxUMjcnKSAwOwogICAgICBlbHNlIGlmIChjYWxsYmFja0lkZW50aWZpZXIgPT09ICdSRVNVTFQwJykgewogICAgICAgIC8vIGEuaXNTZWFyY2ggJiYgIWEuZGlzYWJsZVdoZWVsU2Nyb2xsICYmIEIoImRlc2t0b3BfZW5hYmxlX2RtcGFuZWxfd2hlZWxfc2Nyb2xsIikKICAgICAgfSBlbHNlIGlmIChjYWxsYmFja0lkZW50aWZpZXIuc3RhcnRzV2l0aCgnUkVTVUxUJykpIHsKICAgICAgICBjb25zb2xlLmxvZygnd2hlZWwgZXZlbnRMaXN0ZW5lciAtIFJFU1VMVCcsIGNhbGxiYWNrSWRlbnRpZmllciwgY2FsbGJhY2spCiAgICAgIH0KICAgICAgcmV0dXJuIGNhbGxiYWNrSWRlbnRpZmllcjsKCiAgICB9OwoKICAgIGxldCBjYWxsYmFja0ZvdW5kID0gZmFsc2U7CiAgICBFdmVudFRhcmdldC5wcm90b3R5cGUuYWRkRXZlbnRMaXN0ZW5lcjUyMTc4ID0gRXZlbnRUYXJnZXQucHJvdG90eXBlLmFkZEV2ZW50TGlzdGVuZXI7CiAgICBFdmVudFRhcmdldC5wcm90b3R5cGUuYWRkRXZlbnRMaXN0ZW5lciA9IGZ1bmN0aW9uICh0eXBlLCBjYWxsYmFjaywgb3B0aW9uID0gdm9pZCAwKSB7CiAgICAgIC8vIE0teW91dHViZS1qcy1lbmdpbmUtdGFtZXIuNTIxNzgKICAgICAgaWYgKHR5cGUgPT09ICd3aGVlbCcgJiYgIW9wdGlvbiAmJiB0eXBlb2YgY2FsbGJhY2sgPT09ICdmdW5jdGlvbicgJiYgY2FsbGJhY2subGVuZ3RoID09PSAxKSB7CiAgICAgICAgLy8gKCggbWF0Y2ggd2l0aCBzaWduYXR1cmUgYGEuYWRkRXZlbnRMaXN0ZW5lcigid2hlZWwiLCBoWmIpO2AgKSkgW3N1YmplY3QgdG8gZnVydGhlciByZXZpZXddCiAgICAgICAgY29uc3QgY2FsbGJhY2tJZGVudGlmaWVyID0gY2FsbGJhY2sueWF1am1vbXMgfHwgKGNhbGxiYWNrRm91bmQgPyAnSUdOT1JFJyA6IChjYWxsYmFjay55YXVqbW9tcyA9IGNoZWNrV2hlZWxMaXN0ZW5lcihjYWxsYmFjaykpKTsKICAgICAgICAvLyBSRVNVTFRYWCAvIEVycm9yRlhYIC8gT3RoZXIuLi4KICAgICAgICBpZiAoY2FsbGJhY2tJZGVudGlmaWVyID09PSAnUkVTVUxUMjcnKSB7CiAgICAgICAgICB0aGlzLm92ZXJzY3JvbGxDb25maWdEaXNhYmxlID0gdHJ1ZTsKICAgICAgICAgIGlmICghY2FsbGJhY2tGb3VuZCkgewogICAgICAgICAgICBjYWxsYmFja0ZvdW5kID0gdHJ1ZTsgLy8gc3VwcG9zZSBvbmx5IG9uZSBmdW5jdGlvbiBpcyBhc3NpZ25lZCB0byBvdmVyc2Nyb2xsQ29uZmlnIGNvb2xkb3duIFtubyBmdW5jdGlvbiBiaW5kaW5nXQogICAgICAgICAgICBnZXRPYmpzRm4gPSBjaGVja1doZWVsTGlzdGVuZXIgPSBudWxsOwogICAgICAgICAgICBjaGVja1doZWVsTGlzdGVuZXJPYmpzID0gbnVsbDsKICAgICAgICAgICAgd2hlZWxIYW5kbGVyID0gbnVsbDsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB2b2lkIDA7CiAgICAgICAgfSBlbHNlIGlmICghY2FsbGJhY2tGb3VuZCAmJiAhdGhpcy5vdmVyc2Nyb2xsQ29uZmlnRGlzYWJsZSkgewogICAgICAgICAgdGhpcy5vdmVyc2Nyb2xsQ29uZmlnRGlzYWJsZSA9IHRydWU7CiAgICAgICAgICB0aGlzLmFkZEV2ZW50TGlzdGVuZXI1MjE3OCgnd2hlZWwnLCB3aGVlbEhhbmRsZXIsIHsgcGFzc2l2ZTogZmFsc2UgfSk7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmFkZEV2ZW50TGlzdGVuZXI1MjE3OCh0eXBlLCBjYWxsYmFjaywgb3B0aW9uKTsKICAgIH07CgogICAgLy8gLS0tLSA8PCB0aGlzLm92ZXJzY3JvbGxDb25maWcgSEFDSyA+PiAgLS0tLS0KCiAgfQoKICBjb25zdCB7IHBhZ2VNZWRpYVdhdGNoZXIsIHNob3J0Y3V0S2V5c0ZpeGVyLCBrZXlib2FyZENvbnRyb2xsZXIgfSA9ICgoKSA9PiB7CgogICAgbGV0IHBfYV9vYmpXUiA9IG51bGw7CiAgICBsZXQgaXNTcGFjZUtleUltbWVkaWF0ZSA9IGZhbHNlOyAvLyBmb3IgQURWQU5DRURfRklYX1NIT1JUQ1VUS0VZUwogICAgbGV0IHl0UGFnZVJlYWR5ID0gMDsKCiAgICBsZXQgaXNTcGVlZE1hc3RTcGFjZWJhckNvbnRyb2xFbmFibGVkID0gZmFsc2U7IC8vIHlvdXR1YmUgZXhwZXJpbWVudGFsIGZlYXR1cmUgLy8gY2FuIGJlIGZvcmNlZCBieSBDSEFOR0VfU1BFRURNQVNURVJfU1BBQ0VCQVJfQ09OVFJPTAogICAgbGV0IGlzR2xvYmFsU3BhY2VDb250cm9sID0gdHJ1ZTsKICAgIGxldCBtZWRpYVBsYXllckVsZW1lbnRXUiA9IG51bGw7CiAgICBsZXQgZm9jdXNlZEVsZW1lbnRBdFNlbGVjdGlvbiA9IG51bGw7CgogICAgLy8gbGV0IHdhbnRfY29udHJvbF92aWRlbyA9IGZhbHNlOwoKICAgIGxldCBzcGFjZUJhckNvbnRyb2xfa2V5RyA9ICcnOwoKICAgIGxldCBsYXN0VXNlckFjdGlvbiA9IDA7CgogICAgY29uc3Qgd21LZXlDb250cm9sUGhhc2UgPSBuZXcgV2Vha01hcCgpOwoKICAgIGxldCBjdXJyZW50U2VsZWN0aW9uVGV4dCA9IG51bGw7CgogICAgY29uc3QgZ2V0Q3VycmVudFNlbGVjdGlvblRleHQgPSAoKSA9PiB7CiAgICAgIGlmIChjdXJyZW50U2VsZWN0aW9uVGV4dCAhPT0gbnVsbCkgcmV0dXJuIGN1cnJlbnRTZWxlY3Rpb25UZXh0CiAgICAgIHJldHVybiAoY3VycmVudFNlbGVjdGlvblRleHQgPSBnZXRTZWxlY3Rpb24oKSArICIiKQogICAgfQoKICAgIGNvbnN0IHBhZ2VNZWRpYVdhdGNoZXIgPSAoKSA9PiB7CgogICAgICAvLyBDQU5fVFVORV9WT0xVTU5fQUZURVJfUkVTVU1FX09SX1BBVVNFICYmIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3doZWVsJywgKCkgPT4gewogICAgICAvLyAgIHdhbnRfY29udHJvbF92aWRlbyA9IGZhbHNlOwogICAgICAvLyB9LCB7IGNhcHR1cmU6IHRydWUsIHBhc3NpdmU6IHRydWUgfSk7CgogICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd5dC1uYXZpZ2F0ZScsICgpID0+IHsKICAgICAgICB5dFBhZ2VSZWFkeSA9IDA7CiAgICAgIH0pOwogICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd5dC1uYXZpZ2F0ZS1zdGFydCcsICgpID0+IHsKICAgICAgICB5dFBhZ2VSZWFkeSA9IDA7CiAgICAgIH0pOwogICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd5dC1uYXZpZ2F0ZS1jYWNoZScsICgpID0+IHsKICAgICAgICB5dFBhZ2VSZWFkeSA9IDA7CiAgICAgIH0pOwoKICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigneXQtbmF2aWdhdGUtZmluaXNoJywgKCkgPT4gewogICAgICAgIHl0UGFnZVJlYWR5ID0gMTsKICAgICAgfSk7CgogICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdkdXJhdGlvbmNoYW5nZScsICgpID0+IHsKICAgICAgICBmb3IgKGNvbnN0IGVsbSBvZiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcjbW92aWVfcGxheWVyIHZpZGVvW3NyY10sICNtb3ZpZV9wbGF5ZXIgYXVkaW9bc3JjXScpKSB7CiAgICAgICAgICBpZiAoZWxtLmR1cmF0aW9uID4gMC4wMSkgewogICAgICAgICAgICBpZiAoZWxtLmNsb3Nlc3QoJ1toaWRkZW5dJykpIGNvbnRpbnVlOwogICAgICAgICAgICBtZWRpYVBsYXllckVsZW1lbnRXUiA9IG1XZWFrUmVmKGVsbSk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0sIHsgY2FwdHVyZTogdHJ1ZSwgcGFzc2l2ZTogdHJ1ZSB9KTsKCiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3NlbGVjdGlvbmNoYW5nZScsIChldnQpID0+IHsKICAgICAgICBpZiAoIWV2dCB8fCAhZXZ0LmlzVHJ1c3RlZCB8fCAhKGV2dCBpbnN0YW5jZW9mIEV2ZW50KSkgcmV0dXJuOwogICAgICAgIGN1cnJlbnRTZWxlY3Rpb25UZXh0ID0gbnVsbDsKICAgICAgICBpZiAoIShldnQudGFyZ2V0IGluc3RhbmNlb2YgTm9kZSkpIHJldHVybjsKICAgICAgICBmb2N1c2VkRWxlbWVudEF0U2VsZWN0aW9uID0gZXZ0LnRhcmdldDsKICAgICAgfSwgeyBjYXB0dXJlOiB0cnVlLCBwYXNzaXZlOiB0cnVlIH0pCgogICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdwb2ludGVyZG93bicsIChldnQpID0+IHsKICAgICAgICBpZiAoZXZ0LmlzVHJ1c3RlZCAmJiBldnQgaW5zdGFuY2VvZiBFdmVudCkgbGFzdFVzZXJBY3Rpb24gPSBEYXRlLm5vdygpOwogICAgICB9LCB7IGNhcHR1cmU6IHRydWUsIHBhc3NpdmU6IHRydWUgfSk7CgoKICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigncG9pbnRlcnVwJywgKGV2dCkgPT4gewogICAgICAgIGlmIChldnQuaXNUcnVzdGVkICYmIGV2dCBpbnN0YW5jZW9mIEV2ZW50KSBsYXN0VXNlckFjdGlvbiA9IERhdGUubm93KCk7CiAgICAgIH0sIHsgY2FwdHVyZTogdHJ1ZSwgcGFzc2l2ZTogdHJ1ZSB9KTsKCgogICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgKGV2dCkgPT4gewogICAgICAgIGlmIChldnQuaXNUcnVzdGVkICYmIGV2dCBpbnN0YW5jZW9mIEV2ZW50KSBsYXN0VXNlckFjdGlvbiA9IERhdGUubm93KCk7CiAgICAgIH0sIHsgY2FwdHVyZTogdHJ1ZSwgcGFzc2l2ZTogdHJ1ZSB9KTsKCiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleXVwJywgKGV2dCkgPT4gewogICAgICAgIGlmIChldnQuaXNUcnVzdGVkICYmIGV2dCBpbnN0YW5jZW9mIEV2ZW50KSBsYXN0VXNlckFjdGlvbiA9IERhdGUubm93KCk7CiAgICAgIH0sIHsgY2FwdHVyZTogdHJ1ZSwgcGFzc2l2ZTogdHJ1ZSB9KTsKCiAgICB9OwoKCiAgICBjb25zdCBjaGVja0tleUIgPSAocF9hX29iaikgPT4gewoKICAgICAgY29uc3QgYm9vbExpc3QgPSBuZXcgU2V0KCk7CiAgICAgIGNvbnN0IHBfYV9vYmpfYXBpID0gcF9hX29iai5hcGk7CgogICAgICBjb25zdCBuaWxGdW5jMCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gdm9pZCAwCiAgICAgIH07CiAgICAgIGNvbnN0IG10ID0gbmV3IFByb3h5KHt9LCB7CiAgICAgICAgZ2V0KHRhcmdldCwgcHJvcCkgewogICAgICAgICAgaWYgKHByb3AgPT09ICdnZXQnKSByZXR1cm4gbmlsRnVuYzA7CiAgICAgICAgICByZXR1cm4gbXQ7CiAgICAgICAgfQogICAgICB9KTsKICAgICAgY29uc3QgbmlsRnVuYyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICByZXR1cm4gbXQKICAgICAgfTsKICAgICAgY29uc3QgbXcgPSBuZXcgUHJveHkoe30sIHsKICAgICAgICBnZXQodGFyZ2V0LCBwcm9wKSB7CiAgICAgICAgICBpZiAocHJvcCBpbiBwX2Ffb2JqX2FwaSkgewogICAgICAgICAgICBpZiAodHlwZW9mIHBfYV9vYmpfYXBpLmNvbnN0cnVjdG9yLnByb3RvdHlwZVtwcm9wXSA9PT0gJ2Z1bmN0aW9uJykgcmV0dXJuIG5pbEZ1bmM7CiAgICAgICAgICAgIGxldCBxID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihwX2Ffb2JqX2FwaSwgcHJvcCk7CiAgICAgICAgICAgIGlmIChxICYmIHEudmFsdWUpIHsKICAgICAgICAgICAgICBpZiAoIXEud3JpdGFibGUpIHJldHVybiBxLnZhbHVlOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgcS52YWx1ZSA9PT0gJ3N0cmluZycpIHJldHVybiAnJzsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHEudmFsdWUgPT09ICdudW1iZXInKSByZXR1cm4gMDsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHEudmFsdWUgPT09ICdib29sZWFuJykgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICAgIGlmIChxLnZhbHVlICYmIHR5cGVvZiBxLnZhbHVlID09PSAnb2JqZWN0JykgcmV0dXJuIHt9OwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgIH0sCiAgICAgICAgc2V0KHRhcmdldCwgcHJvcCkgewogICAgICAgICAgdGhyb3cgJ213U2V0JzsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgY29uc3QgbXEgPSBuZXcgUHJveHkoe30sIHsKICAgICAgICBnZXQodGFyZ2V0LCBwcm9wKSB7CiAgICAgICAgICBpZiAocHJvcCA9PT0gJ2FwaScpIHJldHVybiBtdzsKICAgICAgICAgIGlmIChwcm9wIGluIHBfYV9vYmopIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBwX2Ffb2JqLmNvbnN0cnVjdG9yLnByb3RvdHlwZVtwcm9wXSA9PT0gJ2Z1bmN0aW9uJykgcmV0dXJuIG5pbEZ1bmM7CiAgICAgICAgICAgIGxldCBxID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihwX2Ffb2JqLCBwcm9wKTsKICAgICAgICAgICAgaWYgKHEgJiYgcS52YWx1ZSkgewogICAgICAgICAgICAgIGlmICghcS53cml0YWJsZSkgcmV0dXJuIHEudmFsdWU7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBxLnZhbHVlID09PSAnc3RyaW5nJykgcmV0dXJuICcnOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgcS52YWx1ZSA9PT0gJ251bWJlcicpIHJldHVybiAwOwogICAgICAgICAgICAgIGlmICh0eXBlb2YgcS52YWx1ZSA9PT0gJ2Jvb2xlYW4nKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgICAgaWYgKHEudmFsdWUgJiYgdHlwZW9mIHEudmFsdWUgPT09ICdvYmplY3QnKSByZXR1cm4ge307CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgfSwKICAgICAgICBzZXQodGFyZ2V0LCBwcm9wLCB2YWwpIHsKICAgICAgICAgIGlmICh0eXBlb2YgdmFsID09PSAnYm9vbGVhbicpIGJvb2xMaXN0LmFkZChwcm9wKQogICAgICAgICAgdGhyb3cgYG1xU2V0KCR7cHJvcH0sJHt2YWx9KWA7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIGxldCByZXMgPSAnJwogICAgICB0cnkgewogICAgICAgIHJlcyA9IGBSRVNVTFQ6OiR7cF9hX29iai5oYW5kbGVHbG9iYWxLZXlVcC5jYWxsKG1xLCA5LCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgIlRhYiIsICJUYWIiKX1gOwogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgcmVzID0gYEVSUk9SOjoke2V9YDsKICAgICAgfQoKICAgICAgaWYgKGJvb2xMaXN0LnNpemUgPT09IDEpIHsKICAgICAgICBjb25zdCB2YWx1ZSA9IGJvb2xMaXN0LnZhbHVlcygpLm5leHQoKS52YWx1ZTsKICAgICAgICBpZiAocmVzID09PSBgRVJST1I6Om1xU2V0KCR7dmFsdWV9LCR7dHJ1ZX0pYCkgewogICAgICAgICAgcF9hX29iai5fX3VaV2FEX18gPSB2YWx1ZTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGNvbnNvbGUubG9nKCdbeXQtanMtZW5naW5lLXRhbWVyXSBnbG9iYWwgc2hvcnRjdXQgY29udHJvbCcsIHsgJ19fdVpXYURfXyc6IHBfYV9vYmouX191WldhRF9fIH0pOwoKICAgIH0KCgogICAgbGV0IHBtX3BfYSA9IG51bGw7CgogICAgY29uc3QgcF9hX2luaXQgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGNvbnN0IHIgPSB0aGlzLmluaXQ5MSgpOwogICAgICBjb25zdCBrZXlCdyA9IHRoaXMuX19jUHpmb19fIHx8ICdfX05JTF9fJzsKICAgICAgY29uc3QgcF9hX29iaiA9IHRoaXNba2V5QnddOwogICAgICBpZiAoIXBfYV9vYmopIHJldHVybjsKICAgICAgdHJ5IHsKICAgICAgICBjaGVja0tleUIocF9hX29iaik7CiAgICAgIH0gY2F0Y2ggKGUpIHsgfQogICAgICBwX2Ffb2JqV1IgPSBtV2Vha1JlZihwX2Ffb2JqKTsKICAgICAgaWYgKEZJWF9TSE9SVENVVEtFWVMgPiAwKSB7CiAgICAgICAgaWYgKHBfYV9vYmogJiYgIXBfYV9vYmouaFZodGcpIHsKICAgICAgICAgIHBfYV9vYmouaFZodGcgPSAxOwoKICAgICAgICAgIHBfYV9vYmouaGFuZGxlR2xvYmFsS2V5VXA5MSA9IHBfYV9vYmouaGFuZGxlR2xvYmFsS2V5VXA7CiAgICAgICAgICBwX2Ffb2JqLmhhbmRsZUdsb2JhbEtleVVwID0gcF9hX3h0LmhhbmRsZUdsb2JhbEtleVVwOwogICAgICAgICAgcF9hX29iai5oYW5kbGVHbG9iYWxLZXlEb3duOTEgPSBwX2Ffb2JqLmhhbmRsZUdsb2JhbEtleURvd247CiAgICAgICAgICBwX2Ffb2JqLmhhbmRsZUdsb2JhbEtleURvd24gPSBwX2FfeHQuaGFuZGxlR2xvYmFsS2V5RG93bjsKICAgICAgICAgIHBfYV9vYmouX19oYW5kbGVHbG9iYWxLZXlCZWZvcmVfXyA9IHBfYV94dC5fX2hhbmRsZUdsb2JhbEtleUJlZm9yZV9fOwogICAgICAgICAgcF9hX29iai5fX2hhbmRsZUdsb2JhbEtleUFmdGVyX18gPSBwX2FfeHQuX19oYW5kbGVHbG9iYWxLZXlBZnRlcl9fOwoKICAgICAgICB9CiAgICAgICAgLy8gaWYgKENBTl9UVU5FX1ZPTFVNTl9BRlRFUl9SRVNVTUVfT1JfUEFVU0UgJiYgcF9hX29iaiAmJiBwX2Ffb2JqLmFwaSAmJiAhcF9hX29iai5hcGkuaFZodGcpIHsKICAgICAgICAvLyAgIGNvbnN0IGFwaSA9IHBfYV9vYmouYXBpCiAgICAgICAgLy8gICBhcGkuaFZodGcgPSAxOwogICAgICAgIC8vICAgYXBpLnBsYXlWaWRlbzkxID0gYXBpLnBsYXlWaWRlbzsKICAgICAgICAvLyAgIGFwaS5wbGF5VmlkZW8gPSBwX2FfanQucGxheVZpZGVvOwogICAgICAgIC8vICAgYXBpLnBhdXNlVmlkZW85MSA9IGFwaS5wYXVzZVZpZGVvOwogICAgICAgIC8vICAgYXBpLnBhdXNlVmlkZW8gPSBwX2FfanQucGF1c2VWaWRlbzsKICAgICAgICAvLyB9CiAgICAgIH0KICAgICAgaWYgKHBtX3BfYSkgewogICAgICAgIHBtX3BfYS5yZXNvbHZlKCk7CiAgICAgICAgcG1fcF9hID0gbnVsbDsKICAgICAgfQogICAgICByZXR1cm4gcjsKICAgIH07CgogICAgY29uc3QgcF9hX3h0ID0gewoKICAgICAgX19oYW5kbGVHbG9iYWxLZXlCZWZvcmVfXyhhLCBiLCBjLCBkLCBlLCBmLCBoLCBhY3RpdmVFbGVtZW50KSB7CgogICAgICAgIGlmIChGSVhfU0hPUlRDVVRLRVlTID09PSAyKSB7CgogICAgICAgICAgLy8gaWYgKGZsYWdTcGVlZE1hc3RlciAhPT0gZmFsc2UgJiYgIWdldEdsb2JhbFNwYWNlYmFyQ29udHJvbEZsYWcoKSkgcmV0dXJuIGZhbHNlOwoKICAgICAgICAgIGlmIChhY3RpdmVFbGVtZW50KSB7CgogICAgICAgICAgICBjb25zdCBjb250cm9sUGhhc2VDYWNoZSA9IHdtS2V5Q29udHJvbFBoYXNlLmdldChhY3RpdmVFbGVtZW50KTsKCiAgICAgICAgICAgIGlmIChjb250cm9sUGhhc2VDYWNoZSA9PT0gNiAmJiBnZXRDdXJyZW50U2VsZWN0aW9uVGV4dCgpICE9PSAiIikgdm9pZCAwOwogICAgICAgICAgICBlbHNlIGlmIChjb250cm9sUGhhc2VDYWNoZSA9PT0gMSB8fCBjb250cm9sUGhhc2VDYWNoZSA9PT0gMiB8fCBjb250cm9sUGhhc2VDYWNoZSA9PT0gNSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBlbHNlIGlmICgoY29udHJvbFBoYXNlQ2FjaGUgIT09IDYgfHwgZm9jdXNlZEVsZW1lbnRBdFNlbGVjdGlvbiA9PT0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudCkgJiYgZ2V0Q3VycmVudFNlbGVjdGlvblRleHQoKSAhPT0gIiIpIHJldHVybiBmYWxzZTsKCiAgICAgICAgICB9CgogICAgICAgICAgY29uc3QgaXNTcGFjZUJhciA9IGEgPT09IDMyICYmIGIgPT09IGZhbHNlICYmIGMgPT09IGZhbHNlICYmIGQgPT09IGZhbHNlICYmIGUgPT09IGZhbHNlICYmIGYgPT09ICcgJyAmJiBoID09PSAnU3BhY2UnOwogICAgICAgICAgY29uc3QgaXNEZWxheWVkU3BhY2VCYXIgPSBGSVhfU0hPUlRDVVRLRVlTID09PSAyICYmIGlzU3BhY2VCYXIgJiYgIWlzU3BhY2VLZXlJbW1lZGlhdGUgJiYgKGlzU3BlZWRNYXN0U3BhY2ViYXJDb250cm9sRW5hYmxlZCA9IGdldFNwZWVkTWFzdGVyQ29udHJvbEZsYWcoKSk7CiAgICAgICAgICAvLyBjb25zb2xlLmxvZyg1ODIsIGlzRGVsYXllZFNwYWNlQmFyKQogICAgICAgICAgaWYgKGlzRGVsYXllZFNwYWNlQmFyKSByZXR1cm4gdm9pZCAwOyAvLyBhY2NlcHQgZGVsYXkgc3BhY2ViYXIgdW5kZXIgaXNTcGVlZE1hc3RTcGFjZWJhckNvbnRyb2xFbmFibGVkIChubyByZWplY3Rpb24pCgogICAgICAgICAgaWYgKGFjdGl2ZUVsZW1lbnQgJiYgKGggPT09ICdTcGFjZScgfHwgaCA9PT0gJ0VudGVyJykpIHsKICAgICAgICAgICAgY29uc3QgY29udHJvbFBoYXNlID0gd21LZXlDb250cm9sUGhhc2UuZ2V0KGFjdGl2ZUVsZW1lbnQpOwogICAgICAgICAgICBpZiAoY29udHJvbFBoYXNlID09PSA0IHx8IGNvbnRyb2xQaGFzZSA9PT0gNSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgaWYgKGZvY3VzZWRFbGVtZW50QXRTZWxlY3Rpb24gPT09IGFjdGl2ZUVsZW1lbnQgJiYgZ2V0Q3VycmVudFNlbGVjdGlvblRleHQoKSAhPT0gIiIpIHJldHVybiBmYWxzZTsKICAgICAgICAgIC8vIGlmICghaXNTcGVlZE1hc3RTcGFjZWJhckNvbnRyb2xFbmFibGVkICYmIGEgPT09IDMyICYmIGIgPT09IGZhbHNlICYmIGMgPT09IGZhbHNlICYmIGQgPT09IGZhbHNlICYmIGUgPT09IGZhbHNlICYmIGYgPT09ICcgJyAmJiBoID09PSAnU3BhY2UnKSB7CiAgICAgICAgICAvLyAgIGlmICghaXNTcGFjZUtleUltbWVkaWF0ZSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgLy8gfQogICAgICAgIH0KCiAgICAgIH0sCgogICAgICBfX2hhbmRsZUdsb2JhbEtleUFmdGVyX18oYSwgYiwgYywgZCwgZSwgZiwgaCwgYWN0aXZlRWxlbWVudCwgcmV0KSB7CgogICAgICAgIGlmIChGSVhfU0hPUlRDVVRLRVlTID09PSAyICYmIHJldCAmJiBhID49IDMyICYmIHl0UGFnZVJlYWR5ID09PSAxICYmIERhdGUubm93KCkgLSBsYXN0VXNlckFjdGlvbiA8IDQwICYmIGFjdGl2ZUVsZW1lbnQgPT09IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQpIHsKCiAgICAgICAgICBjb25zdCBpc1NwYWNlQmFyID0gYSA9PT0gMzIgJiYgYiA9PT0gZmFsc2UgJiYgYyA9PT0gZmFsc2UgJiYgZCA9PT0gZmFsc2UgJiYgZSA9PT0gZmFsc2UgJiYgZiA9PT0gJyAnICYmIGggPT09ICdTcGFjZSc7CiAgICAgICAgICBjb25zdCBpc0RlbGF5ZWRTcGFjZUJhciA9IEZJWF9TSE9SVENVVEtFWVMgPT09IDIgJiYgaXNTcGFjZUJhciAmJiAhaXNTcGFjZUtleUltbWVkaWF0ZSAmJiAoaXNTcGVlZE1hc3RTcGFjZWJhckNvbnRyb2xFbmFibGVkID0gZ2V0U3BlZWRNYXN0ZXJDb250cm9sRmxhZygpKTsKICAgICAgICAgIC8vIGNvbnNvbGUubG9nKDU4MywgaXNEZWxheWVkU3BhY2VCYXIpCiAgICAgICAgICBpZiAoaXNEZWxheWVkU3BhY2VCYXIpIHJldHVybiB2b2lkIDA7IC8vIGFjY2VwdCBkZWxheSBzcGFjZWJhciB1bmRlciBpc1NwZWVkTWFzdFNwYWNlYmFyQ29udHJvbEVuYWJsZWQgKG5vIHJlamVjdGlvbikKCiAgICAgICAgICBjb25zdCBtZWRpYVBsYXllckVsZW1lbnQgPSBrUmVmKG1lZGlhUGxheWVyRWxlbWVudFdSKTsKCiAgICAgICAgICBsZXQgbWVkaWFXb3JraW5nID0gZmFsc2U7CiAgICAgICAgICBpZiAobWVkaWFQbGF5ZXJFbGVtZW50ICYmIChtZWRpYVBsYXllckVsZW1lbnQucmVhZHlTdGF0ZSA9PT0gNCB8fCBtZWRpYVBsYXllckVsZW1lbnQucmVhZHlTdGF0ZSA9PT0gMSkgJiYgbWVkaWFQbGF5ZXJFbGVtZW50Lm5ldHdvcmtTdGF0ZSA9PT0gMiAmJiBtZWRpYVBsYXllckVsZW1lbnQuZHVyYXRpb24gPiAwLjAxKSB7CiAgICAgICAgICAgIG1lZGlhV29ya2luZyA9IHRydWU7CiAgICAgICAgICB9IGVsc2UgaWYgKG1lZGlhUGxheWVyRWxlbWVudCAmJiAhbWVkaWFQbGF5ZXJFbGVtZW50LnBhdXNlZCAmJiAhbWVkaWFQbGF5ZXJFbGVtZW50Lm11dGVkICYmIG1lZGlhUGxheWVyRWxlbWVudC5kdXJhdGlvbiA+IDAuMDEpIHsKICAgICAgICAgICAgbWVkaWFXb3JraW5nID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICAgIC8vIGNvbnNvbGUubG9nKDE4MiwgbWVkaWFXb3JraW5nLCBtZWRpYVBsYXllckVsZW1lbnQucmVhZHlTdGF0ZSAsIG1lZGlhUGxheWVyRWxlbWVudC5uZXR3b3JrU3RhdGUpCiAgICAgICAgICBtZWRpYVdvcmtpbmcgJiYgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiB7CiAgICAgICAgICAgIGlmIChhY3RpdmVFbGVtZW50ID09PSBkb2N1bWVudC5hY3RpdmVFbGVtZW50KSB7CiAgICAgICAgICAgICAgcmV0dXJuIGFjdGl2ZUVsZW1lbnQuYmx1cigpCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlCiAgICAgICAgICAgIH0KICAgICAgICAgIH0pLnRoZW4oKHIpID0+IHsKICAgICAgICAgICAgciAhPT0gZmFsc2UgJiYgbWVkaWFQbGF5ZXJFbGVtZW50LmZvY3VzKCk7CiAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgIH0sCgoKICAgICAgaGFuZGxlR2xvYmFsS2V5VXAoYSwgYiwgYywgZCwgZSwgZiwgaCkgewoKICAgICAgICBpZiAoQllfUEFTU19LRVlCT0FSRF9DT05UUk9MKSByZXR1cm4gdGhpcy5oYW5kbGVHbG9iYWxLZXlVcDkxKGEsIGIsIGMsIGQsIGUsIGYsIGgpOwoKICAgICAgICBjb25zdCBhY3RpdmVFbGVtZW50ID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDsKCiAgICAgICAgY29uc3QgYWxsb3cgPSB0eXBlb2YgdGhpcy5fX2hhbmRsZUdsb2JhbEtleUJlZm9yZV9fID09PSAnZnVuY3Rpb24nID8gdGhpcy5fX2hhbmRsZUdsb2JhbEtleUJlZm9yZV9fKGEsIGIsIGMsIGQsIGUsIGYsIGgsIGFjdGl2ZUVsZW1lbnQpIDogdm9pZCAwOwogICAgICAgIGlmIChhbGxvdyA9PT0gZmFsc2UpIHJldHVybiBmYWxzZTsKCiAgICAgICAgY29uc3QgcmV0ID0gdGhpcy5oYW5kbGVHbG9iYWxLZXlVcDkxKGEsIGIsIGMsIGQsIGUsIGYsIGgpOwogICAgICAgIC8vIGNvbnNvbGUubG9nKCdoYW5kbGVHbG9iYWxLZXlVcCcscmV0LCBhLCBiLCBjLCBkLCBlLCBmLCBoKTsKCiAgICAgICAgdHlwZW9mIHRoaXMuX19oYW5kbGVHbG9iYWxLZXlBZnRlcl9fID09PSAnZnVuY3Rpb24nICYmIHRoaXMuX19oYW5kbGVHbG9iYWxLZXlBZnRlcl9fKGEsIGIsIGMsIGQsIGUsIGYsIGgsIGFjdGl2ZUVsZW1lbnQsIHJldCk7CgogICAgICAgIHJldHVybiByZXQ7CiAgICAgIH0sCiAgICAgIGhhbmRsZUdsb2JhbEtleURvd24oYSwgYiwgYywgZCwgZSwgZiwgaCwgbCkgewoKCiAgICAgICAgaWYgKEJZX1BBU1NfS0VZQk9BUkRfQ09OVFJPTCkgcmV0dXJuIHRoaXMuaGFuZGxlR2xvYmFsS2V5RG93bjkxKGEsIGIsIGMsIGQsIGUsIGYsIGgsIGwpOwoKICAgICAgICBjb25zdCBhY3RpdmVFbGVtZW50ID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDsKICAgICAgICAvLyBpZiAoYSA9PT0gMzIgJiYgYiA9PT0gZmFsc2UgJiYgYyA9PT0gZmFsc2UgJiYgZCA9PT0gZmFsc2UgJiYgZSA9PT0gZmFsc2UgJiYgZiA9PT0gJyAnICYmIGggPT09ICdTcGFjZScgJiYgIShpc1NwZWVkTWFzdFNwYWNlYmFyQ29udHJvbEVuYWJsZWQgPSBnZXRTcGVlZE1hc3RlckNvbnRyb2xGbGFnKCkpKSB7CiAgICAgICAgLy8gICByZXR1cm4gdGhpcy5oYW5kbGVHbG9iYWxLZXlEb3duOTEoYSwgYiwgYywgZCwgZSwgZiwgaCwgbCk7CiAgICAgICAgLy8gfQogICAgICAgIGNvbnN0IGFsbG93ID0gdHlwZW9mIHRoaXMuX19oYW5kbGVHbG9iYWxLZXlCZWZvcmVfXyA9PT0gJ2Z1bmN0aW9uJyA/IHRoaXMuX19oYW5kbGVHbG9iYWxLZXlCZWZvcmVfXyhhLCBiLCBjLCBkLCBlLCBmLCBoLCBhY3RpdmVFbGVtZW50KSA6IHZvaWQgMDsKICAgICAgICBpZiAoYWxsb3cgPT09IGZhbHNlKSByZXR1cm4gZmFsc2U7CgogICAgICAgIGNvbnN0IHJldCA9IHRoaXMuaGFuZGxlR2xvYmFsS2V5RG93bjkxKGEsIGIsIGMsIGQsIGUsIGYsIGgsIGwpOwogICAgICAgIC8vIGNvbnNvbGUubG9nKCdoYW5kbGVHbG9iYWxLZXlEb3duJyxyZXQsIGEsIGIsIGMsIGQsIGUsIGYsIGgsbCkKCiAgICAgICAgdHlwZW9mIHRoaXMuX19oYW5kbGVHbG9iYWxLZXlBZnRlcl9fID09PSAnZnVuY3Rpb24nICYmIHRoaXMuX19oYW5kbGVHbG9iYWxLZXlBZnRlcl9fKGEsIGIsIGMsIGQsIGUsIGYsIGgsIGFjdGl2ZUVsZW1lbnQsIHJldCk7CgogICAgICAgIHJldHVybiByZXQ7CiAgICAgIH0KCiAgICB9OwoKICAgIC8vIGNvbnN0IHBfYV9qdCA9IHsgLy8gQVBJCgogICAgLy8gICBwbGF5VmlkZW8oYSkgeyAvLyB3aXRob3V0IHNwaW5uZXIgZWZmZWN0CgogICAgLy8gICAgIGlmIChDQU5fVFVORV9WT0xVTU5fQUZURVJfUkVTVU1FX09SX1BBVVNFKSB7CgogICAgLy8gICAgICAgY29uc3QgbWVkaWFQbGF5ZXJFbGVtZW50ID0ga1JlZihtZWRpYVBsYXllckVsZW1lbnRXUik7CiAgICAvLyAgICAgICBpZiAobWVkaWFQbGF5ZXJFbGVtZW50ICYmICFtZWRpYVBsYXllckVsZW1lbnQucGF1c2VkICYmICFtZWRpYVBsYXllckVsZW1lbnQubXV0ZWQgJiYgbWVkaWFQbGF5ZXJFbGVtZW50LmR1cmF0aW9uID4gMC4wMSkgewogICAgLy8gICAgICAgICB3YW50X2NvbnRyb2xfdmlkZW8gPSB0cnVlOwogICAgLy8gICAgICAgICAvLyBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpPT4gbWVkaWFQbGF5ZXJFbGVtZW50LmZvY3VzKCkgKTsKICAgIC8vICAgICAgIH0KCiAgICAvLyAgICAgfQogICAgLy8gICAgIHJldHVybiB0aGlzLnBsYXlWaWRlbzkxKGEpOwoKICAgIC8vICAgfSwKCiAgICAvLyAgIHBhdXNlVmlkZW8oYSkgeyAvLyB3aXRob3V0IHNwaW5uZXIgZWZmZWN0CgogICAgLy8gICAgIGlmIChDQU5fVFVORV9WT0xVTU5fQUZURVJfUkVTVU1FX09SX1BBVVNFKSB7CgogICAgLy8gICAgICAgY29uc3QgbWVkaWFQbGF5ZXJFbGVtZW50ID0ga1JlZihtZWRpYVBsYXllckVsZW1lbnRXUik7CiAgICAvLyAgICAgICBpZiAobWVkaWFQbGF5ZXJFbGVtZW50ICYmIG1lZGlhUGxheWVyRWxlbWVudC5wYXVzZWQgJiYgIW1lZGlhUGxheWVyRWxlbWVudC5tdXRlZCAmJiBtZWRpYVBsYXllckVsZW1lbnQuZHVyYXRpb24gPiAwLjAxKSB7CiAgICAvLyAgICAgICAgIHdhbnRfY29udHJvbF92aWRlbyA9IHRydWU7CiAgICAvLyAgICAgICAgIC8vIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCk9PiBtZWRpYVBsYXllckVsZW1lbnQuZm9jdXMoKSApOwogICAgLy8gICAgICAgfQoKICAgIC8vICAgICB9CiAgICAvLyAgICAgcmV0dXJuIHRoaXMucGF1c2VWaWRlbzkxKGEpOwoKICAgIC8vICAgfQogICAgLy8gfTsKCiAgICBsZXQgZmxhZ1NwZWVkTWFzdGVyID0gbnVsbDsKICAgIGNvbnN0IGdldFNwZWVkTWFzdGVyQ29udHJvbEZsYWcgPSAoKSA9PiB7CgogICAgICBjb25zdCBjb25maWcgPSAod2luLnl0IHx8IDApLmNvbmZpZ18gfHwgKHdpbi55dGNmZyB8fCAwKS5kYXRhXyB8fCAwOwogICAgICBpc1NwZWVkTWFzdFNwYWNlYmFyQ29udHJvbEVuYWJsZWQgPSBmYWxzZTsKICAgICAgaWYgKGNvbmZpZyAmJiBjb25maWcuRVhQRVJJTUVOVF9GTEFHUyAmJiBjb25maWcuRVhQRVJJTUVOVF9GTEFHUy53ZWJfc3BlZWRtYXN0ZXJfc3BhY2ViYXJfY29udHJvbCkgewogICAgICAgIGlzU3BlZWRNYXN0U3BhY2ViYXJDb250cm9sRW5hYmxlZCA9IHRydWU7CiAgICAgIH0KICAgICAgaWYgKGNvbmZpZyAmJiBjb25maWcuRVhQRVJJTUVOVFNfRk9SQ0VEX0ZMQUdTICYmIGNvbmZpZy5FWFBFUklNRU5UU19GT1JDRURfRkxBR1Mud2ViX3NwZWVkbWFzdGVyX3NwYWNlYmFyX2NvbnRyb2wpIHsKICAgICAgICBpc1NwZWVkTWFzdFNwYWNlYmFyQ29udHJvbEVuYWJsZWQgPSB0cnVlOwogICAgICB9CgogICAgICBpZiAoZmxhZ1NwZWVkTWFzdGVyID09PSBudWxsKSB7CiAgICAgICAgY29uc3QgcCA9ICgoKGNvbmZpZyB8fCAwKS5XRUJfUExBWUVSX0NPTlRFWFRfQ09ORklHUyB8fCAwKS5XRUJfUExBWUVSX0NPTlRFWFRfQ09ORklHX0lEX0tFVkxBUl9XQVRDSCB8fCAwKS5zZXJpYWxpemVkRXhwZXJpbWVudEZsYWdzOwogICAgICAgIGlmICghcCkgewogICAgICAgICAgZmxhZ1NwZWVkTWFzdGVyID0gZmFsc2U7CiAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICBmbGFnU3BlZWRNYXN0ZXIgPSAocC5pbmNsdWRlcygnd2ViX2VuYWJsZV9zcGVlZG1hc3Rlcj10cnVlJykgJiYgcC5pbmNsdWRlcygnd2ViX3NwZWVkbWFzdGVyX3NwYWNlYmFyX2NvbnRyb2w9dHJ1ZScpICYmIHAuaW5jbHVkZXMoJ3dlYl9zcGVlZG1hc3Rlcl91cGRhdGVkX2VkdT10cnVlJykpOwoKICAgICAgICB9CgogICAgICB9CiAgICAgIGlmICghZmxhZ1NwZWVkTWFzdGVyKSBpc1NwZWVkTWFzdFNwYWNlYmFyQ29udHJvbEVuYWJsZWQgPSBmYWxzZTsKCiAgICAgIHJldHVybiBpc1NwZWVkTWFzdFNwYWNlYmFyQ29udHJvbEVuYWJsZWQ7CiAgICB9CgoKICAgIGNvbnN0IGdldEdsb2JhbFNwYWNlYmFyQ29udHJvbEZsYWcgPSAoKSA9PiB7CgogICAgICBjb25zdCBjb25maWcgPSAod2luLnl0IHx8IDApLmNvbmZpZ18gfHwgKHdpbi55dGNmZyB8fCAwKS5kYXRhXyB8fCAwOwogICAgICBpc0dsb2JhbFNwYWNlQ29udHJvbCA9IGZhbHNlOwogICAgICBpZiAoY29uZmlnICYmIGNvbmZpZy5FWFBFUklNRU5UX0ZMQUdTICYmIGNvbmZpZy5FWFBFUklNRU5UX0ZMQUdTLmdsb2JhbF9zcGFjZWJhcl9wYXVzZSkgewogICAgICAgIGlzR2xvYmFsU3BhY2VDb250cm9sID0gdHJ1ZTsKICAgICAgfQogICAgICBpZiAoY29uZmlnICYmIGNvbmZpZy5FWFBFUklNRU5UU19GT1JDRURfRkxBR1MgJiYgY29uZmlnLkVYUEVSSU1FTlRTX0ZPUkNFRF9GTEFHUy5nbG9iYWxfc3BhY2ViYXJfcGF1c2UpIHsKICAgICAgICBpc0dsb2JhbFNwYWNlQ29udHJvbCA9IHRydWU7CiAgICAgIH0KCiAgICAgIHJldHVybiBpc0dsb2JhbFNwYWNlQ29udHJvbDsKICAgIH0KCiAgICBjb25zdCBrZXlib2FyZENvbnRyb2xsZXIgPSBhc3luYyAoX3l0X3BsYXllcikgPT4gewoKICAgICAgY29uc3Qga2V5UVQgPSBnZXRRVChfeXRfcGxheWVyKTsKICAgICAgY29uc3Qga2V5U1YgPSBnZXRTVihfeXRfcGxheWVyKTsKICAgICAgY29uc3Qga2V5RFggPSBnZXREWChfeXRfcGxheWVyKTsKICAgICAgY29uc29sZS5sb2coYFtRVCxTVixEWF1gLCBba2V5UVQsIGtleVNWLCBrZXlEWF0pOwoKICAgICAgaWYgKCFrZXlEWCkgcmV0dXJuOwogICAgICBpZiAoa2V5RFggPT09IGtleVFUIHx8IGtleURYID09PSBrZXlTVikgcmV0dXJuOwoKICAgICAgaWYgKHR5cGVvZiBrZXlEWCAhPT0gJ3N0cmluZycpIHJldHVybjsKCiAgICAgIGxldCBsYXN0QWNjZXNzS2V5ID0gJyc7CiAgICAgIGxldCBsYXN0QWNjZXNzS2V5Q29uZmlybWVkID0gJyc7CiAgICAgIGNvbnN0IG1iID0gbmV3IFByb3h5KHt9LCB7CiAgICAgICAgZ2V0KHRhcmdldCwgcHJvcCkgewogICAgICAgICAgaWYgKHByb3AgPT09ICdoYW5kbGVHbG9iYWxLZXlVcCcpIGxhc3RBY2Nlc3NLZXlDb25maXJtZWQgPSBsYXN0QWNjZXNzS2V5OwogICAgICAgICAgdGhyb3cgJ21iR2V0JwogICAgICAgIH0sCiAgICAgICAgc2V0KHRhcmdldCwgcHJvcCwgdmFsKSB7CiAgICAgICAgICB0aHJvdyAnbWJTZXQnCiAgICAgICAgfQogICAgICB9KTsKICAgICAgY29uc3QgbWEgPSBuZXcgUHJveHkoe30sIHsKICAgICAgICBnZXQodGFyZ2V0LCBwcm9wKSB7CiAgICAgICAgICBsYXN0QWNjZXNzS2V5ID0gcHJvcDsKICAgICAgICAgIHJldHVybiBtYgogICAgICAgIH0sCiAgICAgICAgc2V0KHRhcmdldCwgcHJvcCwgdmFsKSB7CiAgICAgICAgICB0aHJvdyAnbWFTZXQnCiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIGxldCBrZXlCdyA9ICcnOwogICAgICB0cnkgewogICAgICAgIF95dF9wbGF5ZXJba2V5RFhdLnByb3RvdHlwZS5oYW5kbGVHbG9iYWxLZXlVcC5jYWxsKG1hKTsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGlmIChlID09PSAnbWJHZXQnICYmIHR5cGVvZiBsYXN0QWNjZXNzS2V5Q29uZmlybWVkID09PSAnc3RyaW5nJyAmJiBsYXN0QWNjZXNzS2V5Q29uZmlybWVkLmxlbmd0aCA+IDApIHsKICAgICAgICAgIGtleUJ3ID0gbGFzdEFjY2Vzc0tleUNvbmZpcm1lZDsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGlmICgha2V5QncpIHJldHVybjsKCiAgICAgIGlmICh0eXBlb2YgX3l0X3BsYXllcltrZXlEWF0ucHJvdG90eXBlLmluaXQgIT09ICdmdW5jdGlvbicgfHwgX3l0X3BsYXllcltrZXlEWF0ucHJvdG90eXBlLmluaXQubGVuZ3RoICE9PSAwKSByZXR1cm47CgogICAgICBwbV9wX2EgPSBuZXcgUHJvbWlzZUV4dGVybmFsKCk7CgogICAgICBfeXRfcGxheWVyW2tleURYXS5wcm90b3R5cGUuX19jUHpmb19fID0ga2V5Qnc7CgogICAgICBfeXRfcGxheWVyW2tleURYXS5wcm90b3R5cGUuaW5pdDkxID0gX3l0X3BsYXllcltrZXlEWF0ucHJvdG90eXBlLmluaXQ7CgogICAgICBfeXRfcGxheWVyW2tleURYXS5wcm90b3R5cGUuaW5pdCA9IHBfYV9pbml0OwoKICAgICAgYXdhaXQgcG1fcF9hLnRoZW4oKTsKICAgICAgY29uc3QgcF9hX29iaiA9IGtSZWYocF9hX29ialdSKTsKCiAgICAgIGNvbnN0IGlzU3BlZWRNYXN0U3BhY2ViYXJDb250cm9sRW5hYmxlZEEgPSBnZXRTcGVlZE1hc3RlckNvbnRyb2xGbGFnKCk7CgoKICAgICAgaWYgKENIQU5HRV9TUEVFRE1BU1RFUl9TUEFDRUJBUl9DT05UUk9MID4gMCkgewoKICAgICAgICBpc1NwZWVkTWFzdFNwYWNlYmFyQ29udHJvbEVuYWJsZWQgPSBDSEFOR0VfU1BFRURNQVNURVJfU1BBQ0VCQVJfQ09OVFJPTCA9PSAxOwoKICAgICAgICBpZiAoIWlzU3BlZWRNYXN0U3BhY2ViYXJDb250cm9sRW5hYmxlZCkgewoKICAgICAgICAgIGlmIChjb25maWcgJiYgY29uZmlnLkVYUEVSSU1FTlRfRkxBR1MpIHsKICAgICAgICAgICAgY29uZmlnLkVYUEVSSU1FTlRfRkxBR1Mud2ViX3NwZWVkbWFzdGVyX3NwYWNlYmFyX2NvbnRyb2wgPSBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChjb25maWcgJiYgY29uZmlnLkVYUEVSSU1FTlRTX0ZPUkNFRF9GTEFHUykgewogICAgICAgICAgICBjb25maWcuRVhQRVJJTUVOVFNfRk9SQ0VEX0ZMQUdTLndlYl9zcGVlZG1hc3Rlcl9zcGFjZWJhcl9jb250cm9sID0gZmFsc2U7CiAgICAgICAgICB9CgogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgaWYgKGNvbmZpZyAmJiBjb25maWcuRVhQRVJJTUVOVF9GTEFHUykgewogICAgICAgICAgICBjb25maWcuRVhQRVJJTUVOVF9GTEFHUy53ZWJfc3BlZWRtYXN0ZXJfc3BhY2ViYXJfY29udHJvbCA9IHRydWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAoY29uZmlnICYmIGNvbmZpZy5FWFBFUklNRU5UU19GT1JDRURfRkxBR1MpIHsKICAgICAgICAgICAgY29uZmlnLkVYUEVSSU1FTlRTX0ZPUkNFRF9GTEFHUy53ZWJfc3BlZWRtYXN0ZXJfc3BhY2ViYXJfY29udHJvbCA9IHRydWU7CiAgICAgICAgICB9CgogICAgICAgIH0KCiAgICAgIH0KCiAgICAgIGNvbnN0IGlzU3BlZWRNYXN0U3BhY2ViYXJDb250cm9sRW5hYmxlZEIgPSBnZXRTcGVlZE1hc3RlckNvbnRyb2xGbGFnKCk7CgoKCgogICAgICBjb25zb2xlLmxvZygnW3l0LWpzLWVuZ2luZS10YW1lcl0gc3BlZWRtYXN0ZXIgYnkgc3BhY2UgKHl0IHNldHRpbmcpJywgaXNTcGVlZE1hc3RTcGFjZWJhckNvbnRyb2xFbmFibGVkQSwgaXNTcGVlZE1hc3RTcGFjZWJhckNvbnRyb2xFbmFibGVkQik7CgogICAgICAvLyBjb25zb2xlLmxvZyhwX2Ffb2JqLmhhbmRsZUdsb2JhbEtleVVwKQogICAgICBjb25zb2xlLmxvZygnW3l0LWpzLWVuZ2luZS10YW1lcl0gcF9hJywgcF9hX29iaikKCiAgICAgIC8vIGNvbnNvbGUubG9nKHBfYV9vYmouYXBpKQoKCiAgICAgIC8vIFFUIC0+IERYKFNWKSAtPiBwX2EKCgogICAgICAvKgogICAgICAgKgogICAgICAgKgogICAgICAgIGcuay5oYW5kbGVHbG9iYWxLZXlVcCA9IGZ1bmN0aW9uKGEsIGIsIGMsIGQsIGUsIGYsIGgpIHsKICAgICAgICAgICAgYiA9IHZvaWQgMCA9PT0gYiA/ICExIDogYjsKICAgICAgICAgICAgYyA9IHZvaWQgMCA9PT0gYyA/ICExIDogYzsKICAgICAgICAgICAgZCA9IHZvaWQgMCA9PT0gZCA/ICExIDogZDsKICAgICAgICAgICAgZSA9IHZvaWQgMCA9PT0gZSA/ICExIDogZTsKICAgICAgICAgICAgdmFyIGwgPSBnLlBUKHRoaXMpOwogICAgICAgICAgICBsICYmIGwuaGFuZGxlR2xvYmFsS2V5VXAoYSwgYiwgYywgZCwgZSwgZiwgaCkKICAgICAgICB9CgogICAgICAqLwoKICAgICAgLyoKICAgICAgICoKICAgICAgICoKICAgICAgICoKICAgICAgICBnLmsuaGFuZGxlR2xvYmFsS2V5VXAgPSBmdW5jdGlvbihhLCBiLCBjLCBkLCBlLCBmLCBoKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLkJ3ID8gdGhpcy5Cdy5oYW5kbGVHbG9iYWxLZXlVcChhLCBiLCBjLCBkLCBlLCBmLCBoKSA6ICExCiAgICAgICAgfQoKICAgICAgKi8KCgogICAgICAvLyBpZigha2V5RFgpIHJldHVybjsKCiAgICAgIC8vIGNvbnNvbGUubG9nKDQ5OTksIGtleURYKQoKICAgIH07CgoKICAgIGNvbnN0IHl0UmVzdW1lRm4gPSBmdW5jdGlvbiAoKSB7IC8vIEFEVkFOQ0VEX0ZJWF9TSE9SVENVVEtFWVMKCiAgICAgIGNvbnN0IHBfYV9vYmogPSBrUmVmKHBfYV9vYmpXUik7CiAgICAgIC8vIGNvbnN0IGFwaSA9IHBfYV9vYmouYXBpOwoKCiAgICAgIC8vIGNvbnNvbGUubG9nKDU0MCk7CgogICAgICBsZXQgYm9vbExpc3QgPSBudWxsOwogICAgICBsZXQgcmV0OwogICAgICBpc1NwYWNlS2V5SW1tZWRpYXRlID0gdHJ1ZTsKICAgICAgdHJ5IHsKCiAgICAgICAgcmV0ID0gMDsKICAgICAgICByZXQgPSByZXQgfCAocF9hX29iai5oYW5kbGVHbG9iYWxLZXlEb3duKDMyLCBmYWxzZSwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgJyAnLCAnU3BhY2UnLCBmYWxzZSkgPyAxIDogMCk7CiAgICAgICAgbGV0IHBfYV9vYmpUOwogICAgICAgIGlmICghc3BhY2VCYXJDb250cm9sX2tleUcpIHsgLy8ganVzdCBpbiBjYXNlCiAgICAgICAgICBib29sTGlzdCA9IG5ldyBTZXQoKTsKICAgICAgICAgIHBfYV9vYmpUID0gbmV3IFByb3h5KHBfYV9vYmosIHsKICAgICAgICAgICAgZ2V0KHRhcmdldCwgcHJvcCwgaGFuZGxlcikgewogICAgICAgICAgICAgIGNvbnN0IHZhbCA9IHRhcmdldFtwcm9wXTsKICAgICAgICAgICAgICBpZiAodHlwZW9mIHZhbCAhPT0gJ2Jvb2xlYW4nKSByZXR1cm4gdmFsOwogICAgICAgICAgICAgIGJvb2xMaXN0LmFkZChwcm9wKTsKICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyg1NTUsIHByb3AsIHZhbCk7CiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwcm9wID09PSAnc3RyaW5nJyAmJiBwcm9wLmxlbmd0aCA8PSAzICYmIHZhbCA9PT0gdHJ1ZSAmJiBib29sTGlzdC5sZW5ndGggPT09IDEpIHsKICAgICAgICAgICAgICAgIHNwYWNlQmFyQ29udHJvbF9rZXlHID0gcHJvcDsKICAgICAgICAgICAgICAgIHBfYV9vYmouX191WldhRF9fID0gc3BhY2VCYXJDb250cm9sX2tleUc7CiAgICAgICAgICAgICAgICB2YWwgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CgoKICAgICAgICB9IGVsc2UgaWYgKHBfYV9vYmpbc3BhY2VCYXJDb250cm9sX2tleUddID09PSB0cnVlKSB7CiAgICAgICAgICBwX2Ffb2JqW3NwYWNlQmFyQ29udHJvbF9rZXlHXSA9IGZhbHNlOwogICAgICAgICAgcF9hX29ialQgPSBwX2Ffb2JqOwogICAgICAgICAgLy8gY29uc29sZS5sb2cocF9hX29iaiwgc3BhY2VCYXJDb250cm9sX2tleUcsIHBfYV9vYmpbc3BhY2VCYXJDb250cm9sX2tleUddICkKICAgICAgICB9IGVsc2UgewoKICAgICAgICAgIHBfYV9vYmpUID0gcF9hX29iajsKICAgICAgICB9CgogICAgICAgIHJldCA9IHJldCB8IChwX2Ffb2JqVC5oYW5kbGVHbG9iYWxLZXlVcCgzMiwgZmFsc2UsIGZhbHNlLCBmYWxzZSwgZmFsc2UsICcgJywgJ1NwYWNlJykgPyAyIDogMCk7CgoKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGNvbnNvbGUubG9nKGUpCiAgICAgIH0KICAgICAgaXNTcGFjZUtleUltbWVkaWF0ZSA9IGZhbHNlOwoKICAgICAgaWYgKGJvb2xMaXN0ICYmIGJvb2xMaXN0LnNpemUgPT09IDEpIHsKICAgICAgICBjb25zdCB2YWx1ZSA9IGJvb2xMaXN0LnZhbHVlcygpLm5leHQoKS52YWx1ZTsKICAgICAgICBzcGFjZUJhckNvbnRyb2xfa2V5RyA9IHZhbHVlOwogICAgICAgIHBfYV9vYmouX191WldhRF9fID0gc3BhY2VCYXJDb250cm9sX2tleUc7CgogICAgICB9CgogICAgICBpZiAoc3BhY2VCYXJDb250cm9sX2tleUcgJiYgcF9hX29ialtzcGFjZUJhckNvbnRyb2xfa2V5R10gPT09IHRydWUpIHBfYV9vYmpbc3BhY2VCYXJDb250cm9sX2tleUddID0gZmFsc2U7CgogICAgICByZXR1cm4gcmV0OwogICAgfQoKICAgIGNvbnN0IHNob3J0Y3V0S2V5c0ZpeGVyID0gKCkgPT4gewoKICAgICAgbGV0IHBhdXNlUHJvbWlzZUNvbnRyb2xKID0gMDsKCgogICAgICBjb25zdCBvYnRhaW5DdXJyZW50Q29udHJvbFBoYXNlID0gKGV2dCwgbWVkaWFQbGF5ZXJFbGVtZW50KSA9PiB7CgogICAgICAgIGxldCBjb250cm9sUGhhc2UgPSAwOwogICAgICAgIGNvbnN0IGFFbG0gPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50OwoKICAgICAgICBpZiAoYUVsbSkgewoKICAgICAgICAgIGNvbnN0IGNvbnRyb2xQaGFzZUNhY2hlID0gd21LZXlDb250cm9sUGhhc2UuZ2V0KGFFbG0pOwoKICAgICAgICAgIGlmICh0eXBlb2YgY29udHJvbFBoYXNlQ2FjaGUgPT09ICdudW1iZXInKSB7CgogICAgICAgICAgICBjb250cm9sUGhhc2UgPSBjb250cm9sUGhhc2VDYWNoZTsKICAgICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgICBpZiAoYUVsbSBpbnN0YW5jZW9mIEhUTUxJbnB1dEVsZW1lbnQpIGNvbnRyb2xQaGFzZSA9IDE7CiAgICAgICAgICAgIGVsc2UgaWYgKGFFbG0gaW5zdGFuY2VvZiBIVE1MVGV4dEFyZWFFbGVtZW50KSBjb250cm9sUGhhc2UgPSAxOwogICAgICAgICAgICBlbHNlIGlmIChhRWxtIGluc3RhbmNlb2YgSFRNTEJ1dHRvbkVsZW1lbnQpIGNvbnRyb2xQaGFzZSA9IDI7CiAgICAgICAgICAgIGVsc2UgaWYgKGFFbG0gaW5zdGFuY2VvZiBIVE1MSUZyYW1lRWxlbWVudCkgY29udHJvbFBoYXNlID0gMjsKICAgICAgICAgICAgZWxzZSBpZiAoYUVsbSBpbnN0YW5jZW9mIEhUTUxJbWFnZUVsZW1lbnQpIGNvbnRyb2xQaGFzZSA9IDI7CiAgICAgICAgICAgIGVsc2UgaWYgKGFFbG0gaW5zdGFuY2VvZiBIVE1MRW1iZWRFbGVtZW50KSBjb250cm9sUGhhc2UgPSAyOwogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICBpZiAoYUVsbSBpbnN0YW5jZW9mIEhUTUxFbGVtZW50ICYmIGFFbG0uY2xvc2VzdCgnW3JvbGVdJykpIGNvbnRyb2xQaGFzZSA9IDU7CiAgICAgICAgICAgICAgaWYgKGFFbG0gaW5zdGFuY2VvZiBIVE1MRGl2RWxlbWVudCkgY29udHJvbFBoYXNlID0gMjsKICAgICAgICAgICAgICBlbHNlIGlmIChhRWxtIGluc3RhbmNlb2YgSFRNTEFuY2hvckVsZW1lbnQpIGNvbnRyb2xQaGFzZSA9IDI7CiAgICAgICAgICAgICAgZWxzZSBpZiAoIShhRWxtIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpICYmIChhRWxtIGluc3RhbmNlb2YgRWxlbWVudCkpIGNvbnRyb2xQaGFzZSA9IDI7IC8vIHN2ZwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoKGNvbnRyb2xQaGFzZSA9PT0gMiB8fCBjb250cm9sUGhhc2UgPT09IDUpICYmIChhRWxtIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpICYmIGFFbG0uY29udGFpbnMobWVkaWFQbGF5ZXJFbGVtZW50KSkgewogICAgICAgICAgICAgIGNvbnRyb2xQaGFzZSA9IDA7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmICgoY29udHJvbFBoYXNlID09PSAyIHx8IGNvbnRyb2xQaGFzZSA9PT0gNSkgJiYgZXZ0ICYmIGV2dC50YXJnZXQgJiYgZXZ0LnRhcmdldCA9PT0gYUVsbSkgewogICAgICAgICAgICAgIGlmIChhRWxtLmNsb3Nlc3QoJ1tjb250ZW50ZWRpdGFibGVdLCBpbnB1dCwgdGV4dGFyZWEnKSkgewogICAgICAgICAgICAgICAgY29udHJvbFBoYXNlID0gNTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKGFFbG0uY2xvc2VzdCgnYnV0dG9uJykpIHsKICAgICAgICAgICAgICAgIGNvbnRyb2xQaGFzZSA9IDQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoYUVsbS5jbG9zZXN0KCcjbW92aWVfcGxheWVyJykpIGNvbnRyb2xQaGFzZSA9IDY7CgogICAgICAgICAgICB3bUtleUNvbnRyb2xQaGFzZS5zZXQoYUVsbSwgY29udHJvbFBoYXNlKTsKCiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gY29udHJvbFBoYXNlOwoKICAgICAgfQoKICAgICAgY29uc3QgaXNTdGF0ZUNvbnRyb2xsYWJsZSA9IChhcGkpID0+IHsKICAgICAgICBsZXQgYXBwU3RhdGUgPSBudWxsOwogICAgICAgIGxldCBwbGF5ZXJTdGF0ZSA9IG51bGw7CiAgICAgICAgbGV0IGFkU3RhdGUgPSBudWxsOwogICAgICAgIHRyeSB7CiAgICAgICAgICBhcHBTdGF0ZSA9IGFwaS5nZXRBcHBTdGF0ZSgpOwogICAgICAgICAgcGxheWVyU3RhdGUgPSBhcGkuZ2V0UGxheWVyU3RhdGUoKTsKICAgICAgICAgIGFkU3RhdGUgPSBhcGkuZ2V0QWRTdGF0ZSgpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsgfQogICAgICAgIC8vIGlnbm9yZSBwbGF5ZXJTdGF0ZSAtMQogICAgICAgIHJldHVybiBhcHBTdGF0ZSA9PT0gNSAmJiBhZFN0YXRlID09PSAtMSAmJiAocGxheWVyU3RhdGUgPT09IDEgfHwgcGxheWVyU3RhdGUgPT09IDIgfHwgcGxheWVyU3RhdGUgPT09IDMpOwogICAgICB9OwoKCiAgICAgIGNvbnN0IGtleUV2ZW50TGlzdGVuZXIgPSAoZXZ0KSA9PiB7CiAgICAgICAgaWYgKEJZX1BBU1NfS0VZQk9BUkRfQ09OVFJPTCkgcmV0dXJuOwoKICAgICAgICBpZiAoZXZ0LmlzVHJ1c3RlZCAmJiBldnQgaW5zdGFuY2VvZiBFdmVudCkgbGFzdFVzZXJBY3Rpb24gPSBEYXRlLm5vdygpOwogICAgICAgIGlmIChpc1NwYWNlS2V5SW1tZWRpYXRlIHx8ICFldnQuaXNUcnVzdGVkIHx8ICEoZXZ0IGluc3RhbmNlb2YgS2V5Ym9hcmRFdmVudCkpIHJldHVybjsKICAgICAgICBpZiAoIXl0UGFnZVJlYWR5KSByZXR1cm47CgogICAgICAgIGlmIChldnQuZGVmYXVsdFByZXZlbnRlZCA9PT0gdHJ1ZSkgcmV0dXJuOwoKICAgICAgICBjb25zdCBwX2Ffb2JqID0ga1JlZihwX2Ffb2JqV1IpOwoKICAgICAgICBpZiAoIXBfYV9vYmopIHJldHVybjsKCgogICAgICAgIGNvbnN0IG1lZGlhUGxheWVyRWxlbWVudCA9IGtSZWYobWVkaWFQbGF5ZXJFbGVtZW50V1IpOwogICAgICAgIGlmICghbWVkaWFQbGF5ZXJFbGVtZW50KSByZXR1cm47CgogICAgICAgIC8vIGxldCBmb2N1c0JvZHlJZlN1Y2Nlc3MgPSBmYWxzZTsKCiAgICAgICAgY29uc3QgY29udHJvbFBoYXNlID0gb2J0YWluQ3VycmVudENvbnRyb2xQaGFzZShldnQsIG1lZGlhUGxheWVyRWxlbWVudCk7CgogICAgICAgIGlmIChjb250cm9sUGhhc2UgPT09IDYgJiYgZ2V0Q3VycmVudFNlbGVjdGlvblRleHQoKSAhPT0gIiIpIHZvaWQgMDsKICAgICAgICBlbHNlIGlmIChjb250cm9sUGhhc2UgPT09IDEgfHwgY29udHJvbFBoYXNlID09PSAyIHx8IGNvbnRyb2xQaGFzZSA9PT0gNSkgcmV0dXJuOwogICAgICAgIGVsc2UgaWYgKChjb250cm9sUGhhc2UgIT09IDYgfHwgZm9jdXNlZEVsZW1lbnRBdFNlbGVjdGlvbiA9PT0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudCkgJiYgZ2V0Q3VycmVudFNlbGVjdGlvblRleHQoKSAhPT0gIiIpIHJldHVybjsKCgogICAgICAgIGlmIChldnQuY29kZSA9PT0gJ1NwYWNlJyAmJiAhZ2V0R2xvYmFsU3BhY2ViYXJDb250cm9sRmxhZygpKSByZXR1cm47CgogICAgICAgIC8vIGNvbnNvbGUubG9nKGAke2V2dC50eXBlfTo6Y29udHJvbFBoYXNlYCxjb250cm9sUGhhc2UpCgogICAgICAgIC8vIGlmIChjb250cm9sUGhhc2UgPT0gNCkgewogICAgICAgIC8vICAgZm9jdXNCb2R5SWZTdWNjZXNzID0gdHJ1ZTsKICAgICAgICAvLyB9CgogICAgICAgIHNwYWNlQmFyQ29udHJvbF9rZXlHID0gc3BhY2VCYXJDb250cm9sX2tleUcgfHwgcF9hX29iai5fX3VaV2FEX18gfHwgJycKICAgICAgICBpZiAoc3BhY2VCYXJDb250cm9sX2tleUcgJiYgcF9hX29ialtzcGFjZUJhckNvbnRyb2xfa2V5R10gPT09IHRydWUpIHBfYV9vYmpbc3BhY2VCYXJDb250cm9sX2tleUddID0gZmFsc2U7CgogICAgICAgIGlmIChGSVhfU0hPUlRDVVRLRVlTIDwgMikgcmV0dXJuOwogICAgICAgIGlmICghKCFldnQuc2hpZnRLZXkgJiYgIWV2dC5jdHJsS2V5ICYmICFldnQuYWx0S2V5ICYmICFldnQubWV0YUtleSkpIHJldHVybjsgLy8gaWdub3JlIGlmIG1vZGlmaWVyIGtleSBpcyBwcmVzc2VkIC0+IGxldCBvdGhlciBldmVudCBsaXN0ZW5lciB0byBoYW5kbGUgZmlyc3QKCiAgICAgICAgbGV0IHJyOwogICAgICAgIGNvbnN0IGlzU3BhY2VCYXIgPSBldnQuY29kZSA9PT0gJ1NwYWNlJyAmJiAhZXZ0LnNoaWZ0S2V5ICYmICFldnQuY3RybEtleSAmJiAhZXZ0LmFsdEtleSAmJiAhZXZ0Lm1ldGFLZXk7CgoKCiAgICAgICAgbGV0IHVzZUltcHJvdmVkUGF1c2VSZXN1bWUgPSBmYWxzZTsKCiAgICAgICAgaWYgKFVTRV9JTVBST1ZFRF9QQVVTRVJFU1VNRV9VTkRFUl9OT19TUEVFRE1BU1RFUiAmJiBpc1NwYWNlQmFyICYmICEoaXNTcGVlZE1hc3RTcGFjZWJhckNvbnRyb2xFbmFibGVkID0gZ2V0U3BlZWRNYXN0ZXJDb250cm9sRmxhZygpKSkgewoKICAgICAgICAgIGNvbnN0IGFwaSA9IHBfYV9vYmouYXBpOwogICAgICAgICAgY29uc3Qgc3RhdGVDb250cm9sbGFibGUgPSBpc1N0YXRlQ29udHJvbGxhYmxlKGFwaSk7CiAgICAgICAgICAvLyBjb25zb2xlLmxvZygyMTIyLCBhcHBTdGF0ZSwgcGxheWVyU3RhdGUsIGFkU3RhdGUpCgogICAgICAgICAgaWYgKHN0YXRlQ29udHJvbGxhYmxlICYmIGlzV2F0Y2hQYWdlVVJMKCkgJiYgbWVkaWFQbGF5ZXJFbGVtZW50LmR1cmF0aW9uID4gMC4wMSAmJiAobWVkaWFQbGF5ZXJFbGVtZW50LnJlYWR5U3RhdGUgPT09IDQgfHwgbWVkaWFQbGF5ZXJFbGVtZW50LnJlYWR5U3RhdGUgPT09IDEpICYmIG1lZGlhUGxheWVyRWxlbWVudC5uZXR3b3JrU3RhdGUgPT09IDIpIHsKCiAgICAgICAgICAgIHVzZUltcHJvdmVkUGF1c2VSZXN1bWUgPSB0cnVlOwoKICAgICAgICAgIH0KCgogICAgICAgIH0KCgogICAgICAgIC8vIGZvcmNlIGZsYWc6IENIQU5HRV9TUEVFRE1BU1RFUl9TUEFDRUJBUl9DT05UUk9MCiAgICAgICAgaWYgKGV2dC50eXBlID09PSAna2V5ZG93bicpIHsKCiAgICAgICAgICBpZiAodXNlSW1wcm92ZWRQYXVzZVJlc3VtZSkgewoKICAgICAgICAgICAgY29uc3QgaXNQYXVzZWQgPSBtZWRpYVBsYXllckVsZW1lbnQucGF1c2VkOwoKICAgICAgICAgICAgY29uc3QgY2ogPSArK3BhdXNlUHJvbWlzZUNvbnRyb2xKOwogICAgICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IHsKCiAgICAgICAgICAgICAgaWYgKGNqICE9PSBwYXVzZVByb21pc2VDb250cm9sSikgcmV0dXJuOwoKICAgICAgICAgICAgICBpZiAobWVkaWFQbGF5ZXJFbGVtZW50LnBhdXNlZCAhPT0gaXNQYXVzZWQpIHJldHVybjsKCiAgICAgICAgICAgICAgY29uc3QgcmV0ID0geXRSZXN1bWVGbigpOwogICAgICAgICAgICAgIGlmICghcmV0KSB7IC8vIGZhbGxiYWNrCiAgICAgICAgICAgICAgICBpc1BhdXNlZCA/IGFwaS5wbGF5VmlkZW8oKSA6IGFwaS5wYXVzZVZpZGVvKCk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAvKgogICAgICAgICAgICAgICAgICBsZXQgYSA9IHZvaWQgMDsKICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1JiJywgYXBpLlJiKCkpCiAgICAgICAgICAgICAgICAgIGEgPSAhd2luZG93Ll95dF9wbGF5ZXIubkwoYXBpLlJiKCkpOwogICAgICAgICAgICAgICAgICBwX2Ffb2JqLldkLmtHKGEpCiAgICAgICAgICAgICAgICAgICAgICBhID8gYXBpLnBsYXlWaWRlbygpIDogYXBpLnBhdXNlVmlkZW8oKTsKCiAgICAgICAgICAgICAgKi8KCgogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcnIgPSB0cnVlOwogICAgICAgICAgfSBlbHNlIHsKCiAgICAgICAgICAgIGlzU3BhY2VLZXlJbW1lZGlhdGUgPSB0cnVlOwogICAgICAgICAgICByciA9IHBfYV9vYmouaGFuZGxlR2xvYmFsS2V5RG93bihldnQua2V5Q29kZSwgZXZ0LnNoaWZ0S2V5LCBldnQuY3RybEtleSwgZXZ0LmFsdEtleSwgZXZ0Lm1ldGFLZXksIGV2dC5rZXksIGV2dC5jb2RlLCBldnQucmVwZWF0KTsKICAgICAgICAgICAgaXNTcGFjZUtleUltbWVkaWF0ZSA9IGZhbHNlOwogICAgICAgICAgICBpZiAoc3BhY2VCYXJDb250cm9sX2tleUcgJiYgcF9hX29ialtzcGFjZUJhckNvbnRyb2xfa2V5R10gPT09IHRydWUpIHBfYV9vYmpbc3BhY2VCYXJDb250cm9sX2tleUddID0gZmFsc2U7CgogICAgICAgICAgfQoKCiAgICAgICAgfSBlbHNlIGlmIChldnQudHlwZSA9PT0gJ2tleXVwJykgewoKICAgICAgICAgIGlmIChpc1NwYWNlQmFyICYmIHVzZUltcHJvdmVkUGF1c2VSZXN1bWUgJiYgIShpc1NwZWVkTWFzdFNwYWNlYmFyQ29udHJvbEVuYWJsZWQgPSBnZXRTcGVlZE1hc3RlckNvbnRyb2xGbGFnKCkpKSB7CgogICAgICAgICAgICByciA9IHRydWU7CiAgICAgICAgICB9IGVsc2UgewoKICAgICAgICAgICAgaXNTcGFjZUtleUltbWVkaWF0ZSA9IHRydWU7CiAgICAgICAgICAgIHJyID0gcF9hX29iai5oYW5kbGVHbG9iYWxLZXlVcChldnQua2V5Q29kZSwgZXZ0LnNoaWZ0S2V5LCBldnQuY3RybEtleSwgZXZ0LmFsdEtleSwgZXZ0Lm1ldGFLZXksIGV2dC5rZXksIGV2dC5jb2RlKTsKICAgICAgICAgICAgaXNTcGFjZUtleUltbWVkaWF0ZSA9IGZhbHNlOwogICAgICAgICAgICBpZiAoc3BhY2VCYXJDb250cm9sX2tleUcgJiYgcF9hX29ialtzcGFjZUJhckNvbnRyb2xfa2V5R10gPT09IHRydWUpIHBfYV9vYmpbc3BhY2VCYXJDb250cm9sX2tleUddID0gZmFsc2U7CgogICAgICAgICAgfQoKCiAgICAgICAgICAvKgoKICAgICAgICAgICAgICBpZiAoZCkKICAgICAgICAgICAgICAgICAgc3dpdGNoIChjKSB7CiAgICAgICAgICAgICAgICAgIGNhc2UgMzI6CiAgICAgICAgICAgICAgICAgIGNhc2UgMTM6CiAgICAgICAgICAgICAgICAgICAgICBpZiAoIkJVVFRPTiIgPT09IGQudGFnTmFtZSB8fCAiQSIgPT09IGQudGFnTmFtZSB8fCAiSU5QVVQiID09PSBkLnRhZ05hbWUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgYiA9ICEwLAogICAgICAgICAgICAgICAgICAgICAgICAgIGUgPSAhMTsKICAgICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgbSA9IGQuZ2V0QXR0cmlidXRlKCJyb2xlIik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgIW0gfHwgIm9wdGlvbiIgIT09IG0gJiYgImJ1dHRvbiIgIT09IG0gJiYgMCAhPT0gbS5pbmRleE9mKCJtZW51aXRlbSIpIHx8IChiID0gITAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgZC5jbGljaygpLAogICAgICAgICAgICAgICAgICAgICAgICAgIGYgPSAhMCkKICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIDM3OgogICAgICAgICAgICAgICAgICBjYXNlIDM5OgogICAgICAgICAgICAgICAgICBjYXNlIDM2OgogICAgICAgICAgICAgICAgICBjYXNlIDM1OgogICAgICAgICAgICAgICAgICAgICAgYiA9ICJzbGlkZXIiID09PSBkLmdldEF0dHJpYnV0ZSgicm9sZSIpOwogICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgIGNhc2UgMzg6CiAgICAgICAgICAgICAgICAgIGNhc2UgNDA6CiAgICAgICAgICAgICAgICAgICAgICBtID0gZC5nZXRBdHRyaWJ1dGUoInJvbGUiKSwKICAgICAgICAgICAgICAgICAgICAgIGQgPSAzOCA9PT0gYyA/IGQucHJldmlvdXNTaWJsaW5nIDogZC5uZXh0U2libGluZywKICAgICAgICAgICAgICAgICAgICAgICJzbGlkZXIiID09PSBtID8gYiA9ICEwIDogZSAmJiAoIm9wdGlvbiIgPT09IG0gPyAoZCAmJiAib3B0aW9uIiA9PT0gZC5nZXRBdHRyaWJ1dGUoInJvbGUiKSAmJiBkLmZvY3VzKCksCiAgICAgICAgICAgICAgICAgICAgICBmID0gYiA9ICEwKSA6IG0gJiYgMCA9PT0gbS5pbmRleE9mKCJtZW51aXRlbSIpICYmIChkICYmIGQuaGFzQXR0cmlidXRlKCJyb2xlIikgJiYgMCA9PT0gZC5nZXRBdHRyaWJ1dGUoInJvbGUiKS5pbmRleE9mKCJtZW51aXRlbSIpICYmIGQuZm9jdXMoKSwKICAgICAgICAgICAgICAgICAgICAgIGYgPSBiID0gITApKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGUgJiYgIWYpCiAgICAgICAgICAgICAgICAgIHN3aXRjaCAoYykgewogICAgICAgICAgICAgICAgICBjYXNlIDM4OgogICAgICAgICAgICAgICAgICAgICAgZiA9IE1hdGgubWluKHRoaXMuYXBpLmdldFZvbHVtZSgpICsgNSwgMTAwKTsKICAgICAgICAgICAgICAgICAgICAgIFhWKHRoaXMuV2QsIGYsICExKTsKICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXBpLnNldFZvbHVtZShmKTsKICAgICAgICAgICAgICAgICAgICAgIGggPSBmID0gITA7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSA0MDoKICAgICAgICAgICAgICAgICAgICAgIGYgPSBNYXRoLm1heCh0aGlzLmFwaS5nZXRWb2x1bWUoKSAtIDUsIDApOwogICAgICAgICAgICAgICAgICAgICAgWFYodGhpcy5XZCwgZiwgITApOwogICAgICAgICAgICAgICAgICAgICAgdGhpcy5hcGkuc2V0Vm9sdW1lKGYpOwogICAgICAgICAgICAgICAgICAgICAgaCA9IGYgPSAhMDsKICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICBjYXNlIDM2OgogICAgICAgICAgICAgICAgICAgICAgdGhpcy5hcGkuWWgoKSAmJiAodGhpcy5hcGkuc3RhcnRTZWVrQ3NpQWN0aW9uKCksCiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmFwaS5zZWVrVG8oMCwgdm9pZCAwLCB2b2lkIDAsIHZvaWQgMCwgNzkpLAogICAgICAgICAgICAgICAgICAgICAgaCA9IGYgPSAhMCk7CiAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgY2FzZSAzNToKICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXBpLlloKCkgJiYgKHRoaXMuYXBpLnN0YXJ0U2Vla0NzaUFjdGlvbigpLAogICAgICAgICAgICAgICAgICAgICAgdGhpcy5hcGkuc2Vla1RvKEluZmluaXR5LCB2b2lkIDAsIHZvaWQgMCwgdm9pZCAwLCA4MCksCiAgICAgICAgICAgICAgICAgICAgICBoID0gZiA9ICEwKQogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAqLwoKICAgICAgICB9CgoKICAgICAgICBpZiAocnIpIHsKCiAgICAgICAgICAvLyBmb2N1c0JvZHlJZlN1Y2Nlc3MgJiYgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiB7CiAgICAgICAgICAvLyAgIGFjdGl2ZUVsZW1lbnQgPT09IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgJiYgYWN0aXZlRWxlbWVudC5ibHVyKCk7CiAgICAgICAgICAvLyB9KTsKCiAgICAgICAgICBldnQucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgIGV2dC5zdG9wSW1tZWRpYXRlUHJvcGFnYXRpb24oKTsKICAgICAgICAgIGV2dC5zdG9wUHJvcGFnYXRpb24oKTsKCiAgICAgICAgfQoKICAgICAgfTsKCiAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCBrZXlFdmVudExpc3RlbmVyLCB7IGNhcHR1cmU6IHRydWUgfSk7CgoKICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigna2V5dXAnLCBrZXlFdmVudExpc3RlbmVyLCB7IGNhcHR1cmU6IHRydWUgfSk7CgogICAgfQoKICAgIHJldHVybiB7IHBhZ2VNZWRpYVdhdGNoZXIsIHNob3J0Y3V0S2V5c0ZpeGVyLCBrZXlib2FyZENvbnRyb2xsZXIgfTsKCiAgfSkoKTsKCgogIHBhZ2VNZWRpYVdhdGNoZXIoKTsKICBGSVhfU0hPUlRDVVRLRVlTID4gMCAmJiBzaG9ydGN1dEtleXNGaXhlcigpOwoKCiAgY29uc3QgY2hlY2tfZm9yX3NldF9rZXlfb3JkZXIgPSAoKCkgPT4gewoKICAgIGxldCBteVNldCA9IG5ldyBTZXQoKTsKCiAgICBteVNldC5hZGQoInZhbHVlMSIpOwogICAgbXlTZXQuYWRkKCJ2YWx1ZTIiKTsKICAgIG15U2V0LmFkZCgidmFsdWUzIik7CgogICAgLy8gRnVuY3Rpb24gdG8gY29udmVydCBTZXQgdmFsdWVzIHRvIGFuIGFycmF5CiAgICBmdW5jdGlvbiBnZXRTZXRWYWx1ZXMoc2V0KSB7CiAgICAgIHJldHVybiBBcnJheS5mcm9tKHNldC52YWx1ZXMoKSk7CiAgICB9CgogICAgLy8gRnVuY3Rpb24gdG8gdGVzdCBpZiB0aGUgU2V0IG1haW50YWlucyBpbnNlcnRpb24gb3JkZXIKICAgIGZ1bmN0aW9uIHRlc3RTZXRPcmRlcihzZXQsIGV4cGVjdGVkT3JkZXIpIHsKICAgICAgbGV0IHZhbHVlcyA9IGdldFNldFZhbHVlcyhzZXQpOwogICAgICByZXR1cm4gZXhwZWN0ZWRPcmRlci5qb2luKCcsJykgPT09IHZhbHVlcy5qb2luKCcsJyk7CiAgICB9CgogICAgLy8gVGVzdCAxOiBJbml0aWFsIG9yZGVyCiAgICBpZiAobXlTZXQudmFsdWVzKCkubmV4dCgpLnZhbHVlICE9PSAidmFsdWUxIikgcmV0dXJuIGZhbHNlOwogICAgaWYgKCF0ZXN0U2V0T3JkZXIobXlTZXQsIFsidmFsdWUxIiwgInZhbHVlMiIsICJ2YWx1ZTMiXSkpIHJldHVybiBmYWxzZTsKCiAgICAvLyBUZXN0IDI6IEFmdGVyIGRlbGV0aW5nIGFuIGVsZW1lbnQKICAgIG15U2V0LmRlbGV0ZSgidmFsdWUyIik7CiAgICBpZiAobXlTZXQudmFsdWVzKCkubmV4dCgpLnZhbHVlICE9PSAidmFsdWUxIikgcmV0dXJuIGZhbHNlOwogICAgaWYgKCF0ZXN0U2V0T3JkZXIobXlTZXQsIFsidmFsdWUxIiwgInZhbHVlMyJdKSkgcmV0dXJuIGZhbHNlOwoKICAgIC8vIFRlc3QgMzogQWZ0ZXIgcmUtYWRkaW5nIGEgZGVsZXRlZCBlbGVtZW50CiAgICBteVNldC5hZGQoInZhbHVlMiIpOwogICAgaWYgKG15U2V0LnZhbHVlcygpLm5leHQoKS52YWx1ZSAhPT0gInZhbHVlMSIpIHJldHVybiBmYWxzZTsKICAgIGlmICghdGVzdFNldE9yZGVyKG15U2V0LCBbInZhbHVlMSIsICJ2YWx1ZTMiLCAidmFsdWUyIl0pKSByZXR1cm4gZmFsc2U7CgogICAgLy8gVGVzdCA0OiBBZnRlciBhZGRpbmcgYSBuZXcgZWxlbWVudAogICAgbXlTZXQuYWRkKCJ2YWx1ZTQiKTsKICAgIGlmIChteVNldC52YWx1ZXMoKS5uZXh0KCkudmFsdWUgIT09ICJ2YWx1ZTEiKSByZXR1cm4gZmFsc2U7CiAgICBpZiAoIXRlc3RTZXRPcmRlcihteVNldCwgWyJ2YWx1ZTEiLCAidmFsdWUzIiwgInZhbHVlMiIsICJ2YWx1ZTQiXSkpIHJldHVybiBmYWxzZTsKCiAgICAvLyBUZXN0IDU6IERlbGV0ZStBZGQKICAgIG15U2V0LmRlbGV0ZSgidmFsdWUxIik7CiAgICBteVNldC5kZWxldGUoInZhbHVlMyIpOwogICAgbXlTZXQuYWRkKCJ2YWx1ZTMiKTsKICAgIG15U2V0LmFkZCgidmFsdWUxIik7CiAgICBpZiAobXlTZXQudmFsdWVzKCkubmV4dCgpLnZhbHVlICE9PSAidmFsdWUyIikgcmV0dXJuIGZhbHNlOwogICAgaWYgKCF0ZXN0U2V0T3JkZXIobXlTZXQsIFsidmFsdWUyIiwgInZhbHVlNCIsICJ2YWx1ZTMiLCAidmFsdWUxIl0pKSByZXR1cm4gZmFsc2U7CgogICAgcmV0dXJuIHRydWU7CiAgfSkoKTsKCgogIC8vIGNvbnN0IHFtNDcgPSBTeW1ib2woKTsKICBjb25zdCBxbTU3ID0gU3ltYm9sKCk7CiAgY29uc3QgcW01MyA9IFN5bWJvbCgpOwogIGNvbnN0IHFuNTMgPSBTeW1ib2woKTsKCgogIGNvbnN0IHVtcDMgPSBuZXcgV2Vha01hcCgpOwoKICBjb25zdCBzdHAgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdub3NjcmlwdCcpOwogIHN0cC5pZCA9ICd3ZWFrcmVmLXBsYWNlaG9sZGVyJwoKCiAgY29uc3QgaGFuZGxlcldGcyA9IHt9OwoKICBjb25zdCBjcmVhdGVIYW5kbGVyV0YgPSAoeiwgdXNlUGxhY2Vob2xkZXIpID0+IHsKCiAgICByZXR1cm4gewogICAgICBnZXQoKSB7CiAgICAgICAgY29uc3QgZWxtID0gdGhpczsKICAgICAgICBjb25zdCB3ciA9IGVsbVt6XTsKICAgICAgICBpZiAoIXdyKSByZXR1cm4gbnVsbDsKICAgICAgICBjb25zdCBtID0ga1JlZih3cik7CiAgICAgICAgaWYgKCFtICYmIHVzZVBsYWNlaG9sZGVyKSB7CiAgICAgICAgICBpZiAodHlwZW9mIHVzZVBsYWNlaG9sZGVyID09PSAnZnVuY3Rpb24nKSB1c2VQbGFjZWhvbGRlcihlbG0pOwogICAgICAgICAgcmV0dXJuIHN0cDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG07CiAgICAgIH0sCiAgICAgIHNldChudikgewogICAgICAgIGNvbnN0IGVsbSA9IHRoaXM7CiAgICAgICAgZWxtW3pdID0gbnYgPyBtV2Vha1JlZihudikgOiBudWxsOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9LAogICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgIGVudW1lcmFibGU6IHRydWUKCiAgICB9CiAgfQoKICBjb25zdCBzZXR1cFdGID0gdHlwZW9mIFdlYWtSZWYgIT09ICd1bmRlZmluZWQnID8gKGVsbSwgcywgdXNlUGxhY2Vob2xkZXIpID0+IHsKICAgIGNvbnN0IHogPSBgJHtzfTcyYDsKICAgIGlmICh6IGluIGVsbSkgcmV0dXJuOwogICAgY29uc3QgcGQgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGVsbSwgcyk7CiAgICBpZiAocGQgJiYgcGQuY29uZmlndXJhYmxlICYmICFwZC5nZXQgJiYgIXBkLnNldCkgewogICAgICBjb25zdCBwID0gcGQudmFsdWU7CiAgICAgIGRlbGV0ZSBlbG1bc107CiAgICAgIGNvbnN0IGhhbmRsZXJXRiA9IGhhbmRsZXJXRnNbc10gfHwgKGhhbmRsZXJXRnNbc10gPSBjcmVhdGVIYW5kbGVyV0YoeiwgdXNlUGxhY2Vob2xkZXIpKTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGVsbSwgcywgaGFuZGxlcldGKTsKICAgICAgZWxtW3NdID0gcDsKICAgICAgZWxtID0gbnVsbDsKICAgIH0KICB9IDogbnVsbDsKCiAgY29uc3QgbXhNYXBQRCA9IG5ldyBXZWFrTWFwKCk7CgogIGNvbnN0IGlkZW50aWZpZXJXRCA9IFN5bWJvbCgpOwogIGNvbnN0IGhhbmRsZXJXRCA9IHsKICAgIGdldChvYmosIHByb3ApIHsKICAgICAgaWYgKHByb3AgPT09IGlkZW50aWZpZXJXRCkgcmV0dXJuIHRydWU7CiAgICAgIGNvbnN0IHZhbCA9IG9ialtwcm9wXTsKICAgICAgaWYgKHR5cGVvZiAodmFsIHx8IDApLmRlcmVmID09PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgcmV0dXJuIHZhbC5kZXJlZigpOwogICAgICB9CiAgICAgIHJldHVybiB2YWw7CiAgICB9LAogICAgc2V0KG9iaiwgcHJvcCwgdmFsKSB7CiAgICAgIGlmICh2YWwgaW5zdGFuY2VvZiBOb2RlKSB7CiAgICAgICAgb2JqW3Byb3BdID0gbVdlYWtSZWYodmFsKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBvYmpbcHJvcF0gPSB2YWw7CiAgICAgIH0KICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgfTsKCiAgY29uc3Qgc2V0dXBXRCA9IFdFQUtfUkVGX1BST1hZX0RPTExBUiAmJiB0eXBlb2YgV2Vha1JlZiAhPT0gJ3VuZGVmaW5lZCcgPyBmdW5jdGlvbiAoZGgpIHsKCiAgICBjb25zdCAkID0gZGggPyBkaC4kIDogMDsKCiAgICBpZiAodHlwZW9mICgkIHx8IDApID09PSAnb2JqZWN0JyAmJiAkW2lkZW50aWZpZXJXRF0gIT09IHRydWUpIHsKCiAgICAgIGZvciAoY29uc3QgW2ssIHZdIG9mIE9iamVjdC5lbnRyaWVzKCQpKSB7CiAgICAgICAgaWYgKHYgaW5zdGFuY2VvZiBOb2RlKSB7CiAgICAgICAgICAkW2tdID0gbVdlYWtSZWYodik7CiAgICAgICAgfQogICAgICB9CgogICAgICBsZXQga1BEID0gbXhNYXBQRC5nZXQoJCk7CiAgICAgIGlmICgha1BEKSB7CiAgICAgICAga1BEID0gbmV3IFByb3h5KCQsIGhhbmRsZXJXRCk7CiAgICAgICAgbXhNYXBQRC5zZXQoJCwga1BEKTsKICAgICAgfQogICAgICBkZWxldGUgZGguJDsKICAgICAgZGguJCA9IGtQRDsKCiAgICB9CgogIH0gOiBudWxsOwoKCiAgY29uc3QgY29uZmlndXJlVmlzaWJpbGl0eU9ic2VydmVyVF8gPSBmdW5jdGlvbiAoKSB7CiAgICBjb25zdCBob3N0RWxlbWVudCA9IHRoaXMuaG9zdEVsZW1lbnQ7CiAgICBpZiAoIShob3N0RWxlbWVudCBpbnN0YW5jZW9mIE5vZGUpIHx8IGhvc3RFbGVtZW50Lm5vZGVOYW1lID09PSAnTk9TQ1JJUFQnKSB7CiAgICAgIHRoaXMudW5vYnNlcnZlXygpOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRoaXMuY29uZmlndXJlVmlzaWJpbGl0eU9ic2VydmVyMjdfKCk7CiAgICB9CiAgfTsKICBjb25zdCBnZXRQYXJlbnRSZW5kZXJlclQgPSBmdW5jdGlvbiAoKSB7CiAgICBjb25zdCBob3N0RWxlbWVudCA9IHRoaXMuaG9zdEVsZW1lbnQ7CiAgICBpZiAoIShob3N0RWxlbWVudCBpbnN0YW5jZW9mIE5vZGUpIHx8IGhvc3RFbGVtZW50Lm5vZGVOYW1lID09PSAnTk9TQ1JJUFQnKSB7CiAgICAgIHJldHVybiBudWxsOwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIHRoaXMuZ2V0UGFyZW50UmVuZGVyZXIyNygpOwogICAgfQogIH0KCiAgY29uc3QgYXR0YWNoZWRUID0gZnVuY3Rpb24gKCkgewogICAgY29uc3QgaG9zdEVsZW1lbnQgPSB0aGlzLmhvc3RFbGVtZW50OwogICAgaWYgKCEoaG9zdEVsZW1lbnQgaW5zdGFuY2VvZiBOb2RlKSB8fCBob3N0RWxlbWVudC5ub2RlTmFtZSA9PT0gJ05PU0NSSVBUJykgewogICAgICBpZiAodGhpcy5pc0F0dGFjaGVkID09PSB0cnVlKSB0aGlzLmlzQXR0YWNoZWQgPSBmYWxzZTsKICAgICAgcmV0dXJuIHZvaWQgMDsKICAgIH0gZWxzZSB7CiAgICAgIHJldHVybiB0aGlzLmF0dGFjaGVkMjcoKTsKICAgIH0KICB9CgogIGNvbnN0IGhvc3RFbGVtZW50Q2xlYW5VcCA9IChkaCkgPT4gewogICAgaWYgKHR5cGVvZiBkaC5kaXNwb3NlID09PSAnZnVuY3Rpb24nKSB7CiAgICAgIHRyeSB7CiAgICAgICAgaWYgKGRoLnZpc2liaWxpdHlNb25pdG9yIHx8IGRoLnZpc2liaWxpdHlPYnNlcnZlcikgewogICAgICAgICAgZGguZGlzcG9zZSgpOwogICAgICAgICAgZGgudmlzaWJpbGl0eU1vbml0b3IgPSBudWxsOwogICAgICAgICAgZGgudmlzaWJpbGl0eU9ic2VydmVyID0gbnVsbDsKICAgICAgICB9CiAgICAgIH0gY2F0Y2ggKGUpIHsgfQogICAgfQogICAgaWYgKHR5cGVvZiBkaC5kZXRhY2hlZCA9PT0gJ2Z1bmN0aW9uJykgewogICAgICB0cnkgewogICAgICAgIGlmIChkaC52aXNpYmlsaXR5T2JzZXJ2ZXJGb3JDaGlsZF8gfHwgZGgubG9jYWxWaXNpYmlsaXR5T2JzZXJ2ZXJfKSB7CiAgICAgICAgICBkaC5kZXRhY2hlZCgpOwogICAgICAgICAgZGgudmlzaWJpbGl0eU9ic2VydmVyRm9yQ2hpbGRfID0gbnVsbDsKICAgICAgICAgIGRoLmxvY2FsVmlzaWJpbGl0eU9ic2VydmVyXyA9IG51bGw7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChlKSB7IH0KICAgIH0KICB9OwoKICBjb25zdCBzZXR1cERhdGFIb3N0XyA9IChlaCkgPT4gewogICAgaWYgKHR5cGVvZiBlaC5jb25maWd1cmVWaXNpYmlsaXR5T2JzZXJ2ZXJfID09PSAnZnVuY3Rpb24nICYmICFlaC5jb25maWd1cmVWaXNpYmlsaXR5T2JzZXJ2ZXIyN18pIHsKICAgICAgZWguY29uZmlndXJlVmlzaWJpbGl0eU9ic2VydmVyMjdfID0gZWguY29uZmlndXJlVmlzaWJpbGl0eU9ic2VydmVyXzsKICAgICAgZWguY29uZmlndXJlVmlzaWJpbGl0eU9ic2VydmVyXyA9IGNvbmZpZ3VyZVZpc2liaWxpdHlPYnNlcnZlclRfOwogICAgfQogICAgaWYgKHR5cGVvZiBlaC5nZXRQYXJlbnRSZW5kZXJlciA9PT0gJ2Z1bmN0aW9uJyAmJiAhZWguZ2V0UGFyZW50UmVuZGVyZXIyNykgewogICAgICBlaC5nZXRQYXJlbnRSZW5kZXJlcjI3ID0gZWguZ2V0UGFyZW50UmVuZGVyZXI7CiAgICAgIGVoLmdldFBhcmVudFJlbmRlcmVyID0gZ2V0UGFyZW50UmVuZGVyZXJUOwogICAgfQogICAgaWYgKHR5cGVvZiBlaC5hdHRhY2hlZCA9PT0gJ2Z1bmN0aW9uJyAmJiAhZWguYXR0YWNoZWQyNykgewogICAgICBlaC5hdHRhY2hlZDI3ID0gZWguYXR0YWNoZWQ7CiAgICAgIGVoLmF0dGFjaGVkID0gYXR0YWNoZWRUOwogICAgfQogIH0KCiAgY29uc3Qgc2V0dXBEYXRhSG9zdCA9IFdFQUtfUkVGX0JJTkRJTkcgJiYgc2V0dXBXRiAmJiBzZXR1cFdEID8gZnVuY3Rpb24gKGRoLCBvcHQpIHsKCiAgICBpZiAodHlwZW9mIChkaCB8fCAwKSA9PT0gJ29iamVjdCcpIHsKCiAgICAgIGNvbnN0IGVoID0gKGRoLmNvbnN0cnVjdG9yIHx8IDApLnByb3RvdHlwZSB8fCBkaDsKCiAgICAgIHNldHVwRGF0YUhvc3RfKGVoKTsKICAgICAgc2V0dXBEYXRhSG9zdF8oZGgpOwoKICAgICAgZGgubTgyMiA9IChkaC5tODIyIHx8IDApICsgMTsKCiAgICAgIHNldHVwV0YoZGgsICdob3N0RWxlbWVudCcsIGhvc3RFbGVtZW50Q2xlYW5VcCk7CiAgICAgIHNldHVwV0YoZGgsICdwYXJlbnRDb21wb25lbnQnKTsKICAgICAgc2V0dXBXRihkaCwgJ2xvY2FsVmlzaWJpbGl0eU9ic2VydmVyXycpOwogICAgICBzZXR1cFdGKGRoLCAnY2FjaGVkUHJvdmlkZXJOb2RlXycpOwoKCiAgICAgIHNldHVwV0YoZGgsICdfX3RlbXBsYXRlJyk7CiAgICAgIHNldHVwV0YoZGgsICdfX3RlbXBsYXRpemVPd25lcicpOwogICAgICBzZXR1cFdGKGRoLCAnX190ZW1wbGF0ZUluZm8nKTsKCiAgICAgIC8vIHNldHVwRDEoZGgsICdyb290JywgMSk7CgogICAgICBsZXQgZWxlbWVudHNfOwogICAgICBpZiAoISgnZWxlbWVudHNfNzInIGluIGRoKSAmJiAoZWxlbWVudHNfID0gZGguZWxlbWVudHNfKSAmJiB0eXBlb2YgZWxlbWVudHNfID09PSAnb2JqZWN0JyAmJiBPYmplY3Qua2V5cyhlbGVtZW50c18pLmxlbmd0aCA+IDApIHNldHVwV0YoZGgsICdlbGVtZW50c18nKTsKCiAgICAgIHNldHVwV0QoZGgpOwogICAgfQoKCgoKICB9IDogbnVsbDsKCiAgUFJPUF9PdmVyUmVJbmNsdXNpb25fQVZPSUQgJiYgKCgpID0+IHsKCgogICAgaWYgKHR5cGVvZiBIVE1MRWxlbWVudC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk3MiA9PT0gJ2Z1bmN0aW9uJyB8fCB0eXBlb2YgSFRNTEVsZW1lbnQucHJvdG90eXBlLmhhc093blByb3BlcnR5ICE9PSAnZnVuY3Rpb24nKSByZXR1cm47CiAgICBjb25zdCBmID0gSFRNTEVsZW1lbnQucHJvdG90eXBlLmhhc093blByb3BlcnR5NzIgPSBIVE1MRWxlbWVudC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHk7CiAgICBsZXQgYnlQYXNzVmFsID0gbnVsbDsKICAgIGxldCBieVBhc3NDb3VudCA9IDA7CiAgICBsZXQgbW13ID0gbmV3IFNldCgpCiAgICBIVE1MRWxlbWVudC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkgPSBmdW5jdGlvbiAocHJvcCkgewogICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCAhPT0gMSkgcmV0dXJuIGYuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKICAgICAgaWYgKGJ5UGFzc1ZhbCAhPT0gbnVsbCAmJiB0eXBlb2YgcHJvcCA9PT0gJ3N0cmluZycpIHsKCgogICAgICAgIGlmIChQUk9QX092ZXJSZUluY2x1c2lvbl9MSVNULmhhcyhwcm9wKSkgewoKICAgICAgICAgIGJ5UGFzc0NvdW50Kys7CiAgICAgICAgICByZXR1cm4gYnlQYXNzVmFsOwogICAgICAgIH0KCiAgICAgICAgLy8gaWYoYnlQYXNzVmFsID09PSB0cnVlICYmICF0aGlzLmhhc093blByb3BlcnR5NzIocHJvcCkpewoKICAgICAgICAvLyAgIE9iamVjdC5kZQoKICAgICAgICAvLyB9CgogICAgICAgIFBST1BfT3ZlclJlSW5jbHVzaW9uX0RFQlVHTE9HICYmIG1tdy5hZGQocHJvcCk7CgoKICAgICAgfQogICAgICByZXR1cm4gdGhpcy5oYXNPd25Qcm9wZXJ0eTcyKHByb3ApOwogICAgfQoKCiAgICAvKgoKCiAgICAgICAgICAgIHoucHJvdG90eXBlLmZvcndhcmREeW5hbWljUHJvcHMgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgIHZhciBCID0gbSh0aGlzLmluc3QpOwogICAgICAgICAgICAgICAgQiA9IGgoQik7CiAgICAgICAgICAgICAgICBmb3IgKHZhciBGID0gQi5uZXh0KCk7ICFGLmRvbmU7IEYgPSBCLm5leHQoKSkgewogICAgICAgICAgICAgICAgICAgIHZhciBIID0gaChGLnZhbHVlKTsKICAgICAgICAgICAgICAgICAgICBGID0gSC5uZXh0KCkudmFsdWU7CiAgICAgICAgICAgICAgICAgICAgSCA9IEgubmV4dCgpLnZhbHVlOwogICAgICAgICAgICAgICAgICAgIG15KHRoaXMsIEYsIEgpOwogICAgICAgICAgICAgICAgICAgIHIoYikgJiYgIWx5KEYpICYmIFd1YSh0aGlzLmluc3QsIEYpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICovCgoKCiAgICBsZXQgYnlQYXNzWmVyb1Nob3dlZCA9IGZhbHNlOwogICAgY29uc3QgZm9yd2FyZER5bmFtaWNQcm9wc0dlbmVyYWwgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGJ5UGFzc1ZhbCA9IHRydWU7CiAgICAgIGJ5UGFzc0NvdW50ID0gMDsKICAgICAgUFJPUF9PdmVyUmVJbmNsdXNpb25fREVCVUdMT0cgJiYgbW13LmNsZWFyKCk7CiAgICAgIGNvbnN0IHJldCA9IHRoaXMuZm9yd2FyZER5bmFtaWNQcm9wczcyKCk7CiAgICAgIGJ5UGFzc1ZhbCA9IG51bGw7CiAgICAgIGlmIChieVBhc3NDb3VudCA9PT0gMCAmJiAhYnlQYXNzWmVyb1Nob3dlZCkgewogICAgICAgIGJ5UGFzc1plcm9TaG93ZWQgPSB0cnVlOwogICAgICAgIGNvbnNvbGUubG9nKCdbeXQtanMtZW5naW5lLXRhbWVyXSBieVBhc3NDb3VudCA9IDAgaW4gZm9yd2FyZER5bmFtaWNQcm9wcycpCiAgICAgIH0KICAgICAgYnlQYXNzQ291bnQgPSAwOwogICAgICBpZiAoUFJPUF9PdmVyUmVJbmNsdXNpb25fREVCVUdMT0cgJiYgbW13LnNpemUgPiAwKSBjb25zb2xlLmxvZygzOTksICdbeXQtanMtZW5naW5lLXRhbWVyXScsIFsuLi5tbXddKQogICAgICBQUk9QX092ZXJSZUluY2x1c2lvbl9ERUJVR0xPRyAmJiBtbXcuY2xlYXIoKTsKICAgICAgcmV0dXJuIHJldDsKICAgIH07CgogICAgY29uc3QgcHJvcENoZWNrID0gKHByb3RvKSA9PiB7CiAgICAgIGlmICh0eXBlb2YgKHByb3RvIHx8IDApID09ICdvYmplY3QnICYmIHR5cGVvZiBwcm90by5mb3J3YXJkRHluYW1pY1Byb3BzID09PSAnZnVuY3Rpb24nICYmIHR5cGVvZiBwcm90by5mb3J3YXJkRHluYW1pY1Byb3BzNzIgIT09ICdmdW5jdGlvbicpIHsKICAgICAgICBwcm90by5mb3J3YXJkRHluYW1pY1Byb3BzNzIgPSBwcm90by5mb3J3YXJkRHluYW1pY1Byb3BzOwogICAgICAgIGlmIChwcm90by5mb3J3YXJkRHluYW1pY1Byb3BzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgcHJvdG8uZm9yd2FyZER5bmFtaWNQcm9wcyA9IGZvcndhcmREeW5hbWljUHJvcHNHZW5lcmFsOwogICAgICAgIH0KICAgICAgfQogICAgfTsKCiAgICBjb25zdCB2YWxNYXAgPSBuZXcgV2Vha01hcCgpOwogICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KEhUTUxFbGVtZW50LnByb3RvdHlwZSwgJ2RpZEZvcndhcmREeW5hbWljUHJvcHMnLCB7CiAgICAgIGdldCgpIHsKICAgICAgICBwcm9wQ2hlY2sodGhpcy5jb25zdHJ1Y3Rvci5wcm90b3R5cGUpOwogICAgICAgIHJldHVybiB2YWxNYXAuZ2V0KHRoaXMpOwogICAgICB9LAogICAgICBzZXQobnYpIHsKICAgICAgICBwcm9wQ2hlY2sodGhpcy5jb25zdHJ1Y3Rvci5wcm90b3R5cGUpOwogICAgICAgIHZhbE1hcC5zZXQodGhpcywgbnYpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9LAogICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgY29uZmlndXJhYmxlOiB0cnVlCgogICAgfSk7CgogICAgcHJvbWlzZUZvckN1c3RvbVl0RWxlbWVudHNSZWFkeS50aGVuKCgpID0+IHsKICAgICAgaWYgKHR5cGVvZiBjdXN0b21FbGVtZW50cyAhPT0gJ29iamVjdCcgfHwgdHlwZW9mIGN1c3RvbUVsZW1lbnRzLmRlZmluZTcyID09PSAnZnVuY3Rpb24nIHx8IHR5cGVvZiBjdXN0b21FbGVtZW50cy5kZWZpbmUgIT09ICdmdW5jdGlvbicpIHJldHVybjsKICAgICAgaWYgKGN1c3RvbUVsZW1lbnRzLmRlZmluZS5sZW5ndGggIT09IDIpIHJldHVybjsKICAgICAgY3VzdG9tRWxlbWVudHMuZGVmaW5lNzIgPSBjdXN0b21FbGVtZW50cy5kZWZpbmU7CiAgICAgIGN1c3RvbUVsZW1lbnRzLmRlZmluZSA9IGZ1bmN0aW9uIChiLCB3KSB7CiAgICAgICAgcHJvcENoZWNrKHcucHJvdG90eXBlKTsKICAgICAgICBjb25zdCByZXQgPSB0aGlzLmRlZmluZTcyKGIsIHcpOwogICAgICAgIHJldHVybiByZXQ7CiAgICAgIH0KICAgIH0pOwoKICB9KSgpOwoKCiAgbGV0IGRlbGF5MzAwID0gbnVsbDsKCiAgaWYgKFVOTE9BRF9ERVRBQ0hFRF9QT0xZTUVSIHx8IFdFQUtfUkVGX0JJTkRJTkcpIHsKICAgIGRlbGF5MzAwID0gbmV3IFByb21pc2VFeHRlcm5hbCgpOwogICAgc2V0SW50ZXJ2YWwoKCkgPT4gewogICAgICBkZWxheTMwMC5yZXNvbHZlKCk7CiAgICAgIGRlbGF5MzAwID0gbmV3IFByb21pc2VFeHRlcm5hbCgpOwogICAgfSwgMzAwKTsKICB9CgogIGNvbnN0IGFEZWxheSA9IGFzeW5jIGZ1bmN0aW9uICgpIHsKICAgIGF3YWl0IGRlbGF5MzAwLnRoZW4oKTsKICAgIGF3YWl0IGRlbGF5MzAwLnRoZW4oKTsKICB9CgogIGNvbnN0IGNvbnZlcnRpb25GdW5jTWFwID0gbmV3IFdlYWtNYXAoKTsKICBsZXQgdmFsX2tldmxhcl9zaG91bGRfbWFpbnRhaW5fc3RhYmxlX2xpc3QgPSBudWxsOwoKICBjb25zdCBjcmVhdGVTdGFtcERvbUFycmF5Rm5fID0gKGZuKSA9PiB7CiAgICBpZiAodmFsX2tldmxhcl9zaG91bGRfbWFpbnRhaW5fc3RhYmxlX2xpc3QgPT09IG51bGwpIHsKICAgICAgY29uc3QgY29uZmlnXyA9ICgod2luZG93Lnl0IHx8IDApLmNvbmZpZ18gfHwgMCk7CiAgICAgIHZhbF9rZXZsYXJfc2hvdWxkX21haW50YWluX3N0YWJsZV9saXN0ID0gKChjb25maWdfIHx8IDApLkVYUEVSSU1FTlRfRkxBR1MgfHwgMCkua2V2bGFyX3Nob3VsZF9tYWludGFpbl9zdGFibGVfbGlzdCA9PT0gdHJ1ZQogICAgfQogICAgY29uc3QgZ24gPSBmdW5jdGlvbiAoYSwgYiwgYywgZCwgZSwgaCkgewogICAgICBjb25zdCBpc05vbkVtcHR5QXJyYXkgPSAoYSB8fCAwKS5sZW5ndGggPj0gMQogICAgICBpZiAoIWlzTm9uRW1wdHlBcnJheSkgewogICAgICAgIHJldHVybiBmbi5jYWxsKHRoaXMsIHVuZGVmaW5lZCwgYiwgdW5kZWZpbmVkLCBkKTsKICAgICAgfSBlbHNlIGlmIChoID09PSB1bmRlZmluZWQgJiYgdHlwZW9mIGIgPT09ICdzdHJpbmcnICYmIGMgJiYgdHlwZW9mIGMgPT09ICdvYmplY3QnICYmIHRoaXMuaXMgJiYgdmFsX2tldmxhcl9zaG91bGRfbWFpbnRhaW5fc3RhYmxlX2xpc3QpIHsKICAgICAgICBpZiAoYy5jbGllbnRTaWRlVG9nZ2xlTWVudUl0ZW1SZW5kZXJlcikgewogICAgICAgICAgaCA9IGZhbHNlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBoID0gdHJ1ZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgcmV0dXJuIGZuLmNhbGwodGhpcywgYSwgYiwgYywgZCwgZSwgaCkKICAgIH0KICAgIGduLm9yaWdpbmFsRm4gPSBmbjsKICAgIGNvbnZlcnRpb25GdW5jTWFwLnNldChmbiwgZ24pOwogICAgcmV0dXJuIGduOwogIH0KCiAgY29uc3QgZml4U3RhbXBEb21BcnJheVN0YWJsZUxpc3QgPSAoaCkgPT4gewogICAgaWYgKCFoLnN0YW1wRG9tQXJyYXlfKSByZXR1cm47CiAgICBjb25zdCBwcm90byA9IGguX19wcm90b19fOwogICAgY29uc3QgZiA9IHByb3RvLnN0YW1wRG9tQXJyYXlfOwogICAgaWYgKCFwcm90by5zdGFtcERvbUFycmF5RjAwMV8gJiYgdHlwZW9mIGYgPT09ICdmdW5jdGlvbicgJiYgZi5sZW5ndGggPT09IDYpIHsKICAgICAgcHJvdG8uc3RhbXBEb21BcnJheUYwMDFfID0gMTsKICAgICAgcHJvdG8uc3RhbXBEb21BcnJheV8gPSBjb252ZXJ0aW9uRnVuY01hcC5nZXQoZikgfHwgY3JlYXRlU3RhbXBEb21BcnJheUZuXyhmKTsKICAgIH0KICB9CgogIGNvbnN0IHdlYWtlblN0YW1wUmVmZXJlbmNlcyA9ICgoKSA9PiB7CgogICAgY29uc3QgREVCVUdfU1RBTVAgPSBmYWxzZTsKCiAgICBjb25zdCBzMSA9IFN5bWJvbCgpOwogICAgY29uc3QgaGFuZGxlcjEgPSB7CiAgICAgIGdldCh0YXJnZXQsIHByb3AsIHJlY2VpdmVyKSB7CiAgICAgICAgaWYgKHByb3AgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICByZXR1cm4ga1JlZih0YXJnZXRbczFdKTsgLy8gYXZvaWQgbWVtb3J5IGxlYWthZ2UKICAgICAgICB9CiAgICAgICAgaWYgKHByb3AgPT09ICdfX3Byb3h5MzEyX18nKSByZXR1cm4gMTsKICAgICAgICByZXR1cm4gdGFyZ2V0W3Byb3BdOwogICAgICB9CiAgICB9OwogICAgY29uc3QgaGFuZGxlcjIgPSB7CiAgICAgIGdldCh0YXJnZXQsIHByb3AsIHJlY2VpdmVyKSB7CiAgICAgICAgaWYgKHByb3AgPT09ICdpbmRleFNwbGljZXMnKSB7CiAgICAgICAgICByZXR1cm4ga1JlZih0YXJnZXRbczFdKTsgLy8gYXZvaWQgbWVtb3J5IGxlYWthZ2UKICAgICAgICB9CiAgICAgICAgaWYgKHByb3AgPT09ICdfX3Byb3h5MzEyX18nKSByZXR1cm4gMTsKICAgICAgICByZXR1cm4gdGFyZ2V0W3Byb3BdOwogICAgICB9CiAgICB9CiAgICByZXR1cm4gKGgpID0+IHsKCiAgICAgIGlmIChoLnJlbmRlcmVyU3RhbXBlckFwcGx5Q2hhbmdlUmVjb3JkXyB8fCBoLnN0YW1wRG9tQXJyYXlTcGxpY2VzXykgewogICAgICAgIGNvbnN0IHByb3RvID0gaC5fX3Byb3RvX187CiAgICAgICAgaWYgKCFwcm90by55enhlciAmJiAocHJvdG8ucmVuZGVyZXJTdGFtcGVyQXBwbHlDaGFuZ2VSZWNvcmRfIHx8IHByb3RvLnN0YW1wRG9tQXJyYXlTcGxpY2VzXykpIHsKICAgICAgICAgIHByb3RvLnl6eGVyID0gMTsKCiAgICAgICAgICBjb25zdCBsaXN0ID0gWwogICAgICAgICAgICAvLyAicmVuZGVyZXJTdGFtcGVyT2JzZXJ2ZXJfIiwgLy8gMyAgPT0+IHJlbmRlcmVyU3RhbXBlckFwcGx5Q2hhbmdlUmVjb3JkXwogICAgICAgICAgICAicmVuZGVyZXJTdGFtcGVyQXBwbHlDaGFuZ2VSZWNvcmRfIiwgLy8gMwogICAgICAgICAgICAiZm9yd2FyZFJlbmRlcmVyU3RhbXBlckNoYW5nZXNfIiwgLy8gMwogICAgICAgICAgICAic3RhbXBEb21BcnJheVNwbGljZXNfIiwgLy8gMwogICAgICAgICAgICAic3RhbXBEb21BcnJheV8iLCAvLyA2CiAgICAgICAgICAgICJkZWZlclJlbmRlclN0YW1wZXJCaW5kaW5nXyIsIC8vIDMKICAgICAgICAgIF07CiAgICAgICAgICBmb3IgKGNvbnN0IGtleSBvZiBsaXN0KSB7CiAgICAgICAgICAgIGNvbnN0IHBleSA9IGAke2tleX0kd3EwaXdfYDsKICAgICAgICAgICAgY29uc3QgdktleSA9IHByb3RvW2tleV07CiAgICAgICAgICAgIGlmICh0eXBlb2YgdktleSAhPT0gJ2Z1bmN0aW9uJykgY29udGludWU7CiAgICAgICAgICAgIGlmIChwcm90b1twZXldIHx8IHZLZXkubGVuZ3RoID09PSAwKSBjb250aW51ZTsKCiAgICAgICAgICAgIGlmIChrZXkgPT09ICdzdGFtcERvbUFycmF5U3BsaWNlc18nICYmIHZLZXkubGVuZ3RoID09PSAzKSB7CiAgICAgICAgICAgICAgcHJvdG9bcGV5XSA9IHZLZXk7CiAgICAgICAgICAgICAgcHJvdG9ba2V5XSA9IGZ1bmN0aW9uIChhLCBiLCBjKSB7CgogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBhID09PSAnc3RyaW5nJyAmJiB0eXBlb2YgYiA9PT0gJ3N0cmluZycgJiYgdHlwZW9mIGMgPT09ICdvYmplY3QnICYmIGMgJiYgYy5pbmRleFNwbGljZXMgJiYgYy5pbmRleFNwbGljZXMubGVuZ3RoID49IDEgJiYgIWMuaW5kZXhTcGxpY2VzLnJ6Z2pyKSB7CgogICAgICAgICAgICAgICAgICBjLmluZGV4U3BsaWNlcyA9IGMuaW5kZXhTcGxpY2VzLm1hcChlID0+IHsKICAgICAgICAgICAgICAgICAgICBpZiAoZS5fX3Byb3h5MzEyX18pIHJldHVybiBlOwogICAgICAgICAgICAgICAgICAgIGVbczFdID0gbVdlYWtSZWYoZS5vYmplY3QpOwogICAgICAgICAgICAgICAgICAgIGUub2JqZWN0ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFByb3h5KGUsIGhhbmRsZXIxKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIGMuaW5kZXhTcGxpY2VzLnJ6Z2pyID0gMTsKCiAgICAgICAgICAgICAgICAgIGNbczFdID0gbVdlYWtSZWYoYy5pbmRleFNwbGljZXMpOwogICAgICAgICAgICAgICAgICBjLmluZGV4U3BsaWNlcyA9IG51bGw7CiAgICAgICAgICAgICAgICAgIGMgPSBuZXcgUHJveHkoYywgaGFuZGxlcjIpCiAgICAgICAgICAgICAgICAgIGFyZ3VtZW50c1syXSA9IGM7CgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coa2V5LCBhcmd1bWVudHMubGVuZ3RoLCBbLi4uYXJndW1lbnRzXSk7CiAgICAgICAgICAgICAgICByZXR1cm4gcHJvdG9bcGV5XS5jYWxsKHRoaXMsIGEsIGIsIGMpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSAncmVuZGVyZXJTdGFtcGVyQXBwbHlDaGFuZ2VSZWNvcmRfJyAmJiB2S2V5Lmxlbmd0aCA9PT0gMykgewoKICAgICAgICAgICAgICAvLyBOaWwKCiAgICAgICAgICAgIH0gZWxzZSBpZiAoREVCVUdfU1RBTVApIHsKCiAgICAgICAgICAgICAgY29uc29sZS5sb2cocHJvdG8uaXNSZW5kZXJlcl8sICdtc18nICsga2V5LCB2S2V5Lmxlbmd0aCwgaC5pcykKICAgICAgICAgICAgICBwcm90b1twZXldID0gdktleTsKICAgICAgICAgICAgICBwcm90b1trZXldID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgaWYgKGtleSA9PT0gJ3JlbmRlcmVyU3RhbXBlckFwcGx5Q2hhbmdlUmVjb3JkXycgJiYgdHlwZW9mIGFyZ3VtZW50c1szXSA9PT0gJ29iamVjdCcpIHsKICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coa2V5LCBhcmd1bWVudHMubGVuZ3RoLCB7IHZhbHVlOiBhcmd1bWVudHNbM10udmFsdWUsIGJhc2U6IGFyZ3VtZW50c1szXS5iYXNlLCB9KQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc29sZS5sb2coa2V5LCBhcmd1bWVudHMubGVuZ3RoLCBbLi4uYXJndW1lbnRzXSk7CiAgICAgICAgICAgICAgICByZXR1cm4gcHJvdG9bcGV5XS5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0KCiAgICAgICAgICB9CgoKICAgICAgICAgIC8vIGNvbnN0IG0gPSAoT2JqZWN0Lm1rc3MgPSBPYmplY3QubWtzcyB8fCBuZXcgU2V0KCkpOwogICAgICAgICAgLy8gT2JqZWN0LmtleXMoaC5fX3Byb3RvX18pLmZpbHRlcihlID0+IGUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnc3RhbXAnKSAmJiB0eXBlb2YgaFtlXSA9PT0gJ2Z1bmN0aW9uJykuZm9yRWFjaChlID0+IG0uYWRkKGUpKQogICAgICAgICAgLy8gY29uc29sZS5sb2coWy4uLm1dKQogICAgICAgIH0KICAgICAgfQoKICAgIH0KICB9KSgpOwoKICBjb25zdCBzZXR1cERpc2NyZXRlVGFza3MgPSAoaCwgcmIpID0+IHsKCiAgICBpZiAocmIpIHsKICAgICAgaWYgKGgua3kzNikgcmV0dXJuOwogICAgfQoKCiAgICBpZiAodHlwZW9mIGgub25ZdFJlbmRlcmVyc3RhbXBlckZpbmlzaGVkID09PSAnZnVuY3Rpb24nICYmICEoaC5vbll0UmVuZGVyZXJzdGFtcGVyRmluaXNoZWQua20zNCkpIHsKICAgICAgY29uc3QgZiA9IGgub25ZdFJlbmRlcmVyc3RhbXBlckZpbmlzaGVkOwogICAgICBjb25zdCBnID0gdW1wMy5nZXQoZikgfHwgZnVuY3Rpb24gKCkgewogICAgICAgIGlmICh0aGlzLnVwZGF0ZUNoaWxkVmlzaWJpbGl0eVByb3BlcnRpZXMgJiYgIXRoaXMubWFya0RpcnR5KSB7CiAgICAgICAgICByZXR1cm4gZi5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgIH0KICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGYuYXBwbHkodGhpcywgYXJndW1lbnRzKSkuY2F0Y2goY29uc29sZS5sb2cpOwogICAgICB9CiAgICAgIHVtcDMuc2V0KGYsIGcpOwogICAgICBnLmttMzQgPSAxOwogICAgICBoLm9uWXRSZW5kZXJlcnN0YW1wZXJGaW5pc2hlZCA9IGc7CgogICAgfQoKICAgIGlmICh0eXBlb2YgaC5vbll0VXBkYXRlRGVzY3JpcHRpb25BY3Rpb24gPT09ICdmdW5jdGlvbicgJiYgIShoLm9uWXRVcGRhdGVEZXNjcmlwdGlvbkFjdGlvbi5rbTM0KSkgewogICAgICBjb25zdCBmID0gaC5vbll0VXBkYXRlRGVzY3JpcHRpb25BY3Rpb247CiAgICAgIGNvbnN0IGcgPSB1bXAzLmdldChmKSB8fCBmdW5jdGlvbiAoYSkgewogICAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gZi5hcHBseSh0aGlzLCBhcmd1bWVudHMpKS5jYXRjaChjb25zb2xlLmxvZyk7CiAgICAgIH0KICAgICAgdW1wMy5zZXQoZiwgZyk7CiAgICAgIGcua20zNCA9IDE7CiAgICAgIGgub25ZdFVwZGF0ZURlc2NyaXB0aW9uQWN0aW9uID0gZzsKCiAgICB9CgogICAgaWYgKHR5cGVvZiBoLmhhbmRsZVVwZGF0ZURlc2NyaXB0aW9uQWN0aW9uID09PSAnZnVuY3Rpb24nICYmICEoaC5oYW5kbGVVcGRhdGVEZXNjcmlwdGlvbkFjdGlvbi5rbTM0KSkgewogICAgICBjb25zdCBmID0gaC5oYW5kbGVVcGRhdGVEZXNjcmlwdGlvbkFjdGlvbjsKICAgICAgY29uc3QgZyA9IHVtcDMuZ2V0KGYpIHx8IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBmLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpLmNhdGNoKGNvbnNvbGUubG9nKTsKICAgICAgfQogICAgICB1bXAzLnNldChmLCBnKTsKICAgICAgZy5rbTM0ID0gMTsKICAgICAgaC5oYW5kbGVVcGRhdGVEZXNjcmlwdGlvbkFjdGlvbiA9IGc7CgogICAgfQoKICAgIGlmICh0eXBlb2YgaC5oYW5kbGVVcGRhdGVMaXZlQ2hhdFBvbGxBY3Rpb24gPT09ICdmdW5jdGlvbicgJiYgIShoLmhhbmRsZVVwZGF0ZUxpdmVDaGF0UG9sbEFjdGlvbi5rbTM0KSkgewogICAgICBjb25zdCBmID0gaC5oYW5kbGVVcGRhdGVMaXZlQ2hhdFBvbGxBY3Rpb247CiAgICAgIGNvbnN0IGcgPSB1bXAzLmdldChmKSB8fCBmdW5jdGlvbiAoYSkgewogICAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gZi5hcHBseSh0aGlzLCBhcmd1bWVudHMpKS5jYXRjaChjb25zb2xlLmxvZyk7CiAgICAgIH0KICAgICAgdW1wMy5zZXQoZiwgZyk7CiAgICAgIGcua20zNCA9IDE7CiAgICAgIGguaGFuZGxlVXBkYXRlTGl2ZUNoYXRQb2xsQWN0aW9uID0gZzsKCiAgICB9CgogICAgaWYgKHR5cGVvZiBoLm9uVGV4dENoYW5nZWQgPT09ICdmdW5jdGlvbicgJiYgIShoLm9uVGV4dENoYW5nZWQua20zNCkpIHsKICAgICAgY29uc3QgZiA9IGgub25UZXh0Q2hhbmdlZDsKICAgICAgY29uc3QgZyA9IHVtcDMuZ2V0KGYpIHx8IGZ1bmN0aW9uICgpIHsKICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGYuYXBwbHkodGhpcywgYXJndW1lbnRzKSkuY2F0Y2goY29uc29sZS5sb2cpOwogICAgICB9CiAgICAgIHVtcDMuc2V0KGYsIGcpOwogICAgICBnLmttMzQgPSAxOwogICAgICBoLm9uVGV4dENoYW5nZWQgPSBnOwoKICAgIH0KCiAgICBpZiAodHlwZW9mIGgub25WaWRlb0RhdGFDaGFuZ2UgPT09ICdmdW5jdGlvbicgJiYgIShoLm9uVmlkZW9EYXRhQ2hhbmdlLmttMzQpKSB7CiAgICAgIGNvbnN0IGYgPSBoLm9uVmlkZW9EYXRhQ2hhbmdlOwogICAgICBjb25zdCBnID0gdW1wMy5nZXQoZikgfHwgZnVuY3Rpb24gKGEpIHsKICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGYuYXBwbHkodGhpcywgYXJndW1lbnRzKSkuY2F0Y2goY29uc29sZS5sb2cpOwogICAgICB9CiAgICAgIHVtcDMuc2V0KGYsIGcpOwogICAgICBnLmttMzQgPSAxOwogICAgICBoLm9uVmlkZW9EYXRhQ2hhbmdlID0gZzsKCiAgICB9CgogICAgaWYgKHR5cGVvZiBoLm9uVmlkZW9EYXRhQ2hhbmdlXyA9PT0gJ2Z1bmN0aW9uJyAmJiAhKGgub25WaWRlb0RhdGFDaGFuZ2VfLmttMzQpKSB7CiAgICAgIGNvbnN0IGYgPSBoLm9uVmlkZW9EYXRhQ2hhbmdlXzsKICAgICAgY29uc3QgZyA9IHVtcDMuZ2V0KGYpIHx8IGZ1bmN0aW9uICgpIHsKICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGYuYXBwbHkodGhpcywgYXJndW1lbnRzKSkuY2F0Y2goY29uc29sZS5sb2cpOwogICAgICB9CiAgICAgIHVtcDMuc2V0KGYsIGcpOwogICAgICBnLmttMzQgPSAxOwogICAgICBoLm9uVmlkZW9EYXRhQ2hhbmdlXyA9IGc7CgogICAgfQoKICAgIC8qCiAgICAvLyBhZmZlY3QgY2hhdCBtZXNzYWdlIGljb24gdG9vbHRpcHMKICAgIGlmICh0eXBlb2YgaC5hZGRUb29sdGlwcyA9PT0gJ2Z1bmN0aW9uJyAmJiAhKGguYWRkVG9vbHRpcHMua20zNCkpIHsKCiAgICAgIGNvbnN0IGYgPSBoLmFkZFRvb2x0aXBzOwogICAgICBjb25zdCBnID0gdW1wMy5nZXQoZikgfHwgZnVuY3Rpb24gKCkgewogICAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gZi5hcHBseSh0aGlzLCBhcmd1bWVudHMpKS5jYXRjaChjb25zb2xlLmxvZyk7CiAgICAgIH0KICAgICAgdW1wMy5zZXQoZiwgZyk7CiAgICAgIGcua20zNCA9IDE7CiAgICAgIGguYWRkVG9vbHRpcHMgPSBnOwoKICAgIH0KICAgICovCiAgICAvKgogICAgICAgIGlmICh0eXBlb2YgaC5vbk1vdXNlT3Zlcl8gPT09ICdmdW5jdGlvbicgJiYgIShoLm9uTW91c2VPdmVyXy5rbTM0KSAmJiB0eXBlb2YgaC5jcmVhdGVUb29sdGlwSWZSZXF1aXJlZF8gPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coMjEyLCBoLmlzKTsKICAgICAgICAgICAgY29uc3QgZiA9IGgub25Nb3VzZU92ZXJfOwogICAgICAgICAgY29uc3QgZyA9IHVtcDMuZ2V0KGYpIHx8IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgICAgaWYgKCF0aGlzLl9fbUVaX18pIHsKCgogICAgICAgICAgICAgICAgICBjb25zdCB3ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudDsKICAgICAgICAgICAgICAgICAgbGV0IEVVID0gbnVsbDsKICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICAgIGxldCByID0gdy5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAgICAgICAgICAgRVUgPSByOwogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIGxldCBkb25lID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBvbHltZXJDb250cm9sbGVyLmNyZWF0ZVRvb2x0aXBJZlJlcXVpcmVkXygpOwogICAgICAgICAgICAgICAgICAgICAgZG9uZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgaWYgKCFkb25lKSB7CiAgICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlVG9vbHRpcElmUmVxdWlyZWRfKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgZG9uZSA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CgogICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICB0aGlzLl9fbUVaX18gPSBFVTsKICAgICAgICAgICAgICAgICAgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCA9IHc7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmKHRoaXMuX19tRVpfXyl7CiAgICAgICAgICAgICAgICB0aGlzLl9fbUVaX18ucmVtb3ZlKCk7CiAgICAgICAgICAgICAgICAvLyB0aGlzLl9fbUVaX18uZm9yID0gbnVsbDsKICAgICAgICAgICAgICAgIFsuLi50aGlzLl9fbUVaX18ucXVlcnlTZWxlY3RvckFsbCgnLmhpZGRlbicpXS5mb3JFYWNoKGU9PmUuY2xhc3NMaXN0LnJlbW92ZSgnaGlkZGVuJykpCiAgICAgICAgICAgICAgfQogICAgICAgICAgICBjb25zb2xlLmxvZygyMTIsdGhpcywgdGhpcy5pcywgdGhpcy5fX21FWl9fKQogICAgICAgICAgICByZXR1cm4gZi5hcHBseSh0aGlzLCBhcmd1bWVudHMpCiAgICAgICAgICB9CiAgICAgICAgICB1bXAzLnNldChmLCBnKTsKICAgICAgICAgIGcua20zNCA9IDE7CiAgICAgICAgICBoLm9uTW91c2VPdmVyXyA9IGc7CgogICAgICAgIH0KICAgICAgICAqLwoKCiAgICBpZiAodHlwZW9mIGguYWRkVG9vbHRpcHNfID09PSAnZnVuY3Rpb24nICYmICEoaC5hZGRUb29sdGlwc18ua20zNCkpIHsKCiAgICAgIGNvbnN0IGYgPSBoLmFkZFRvb2x0aXBzXzsKICAgICAgY29uc3QgZyA9IHVtcDMuZ2V0KGYpIHx8IGZ1bmN0aW9uICgpIHsKICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGYuYXBwbHkodGhpcywgYXJndW1lbnRzKSkuY2F0Y2goY29uc29sZS5sb2cpOwogICAgICB9CiAgICAgIHVtcDMuc2V0KGYsIGcpOwogICAgICBnLmttMzQgPSAxOwogICAgICBoLmFkZFRvb2x0aXBzXyA9IGc7CgogICAgfQoKICAgIGlmICh0eXBlb2YgaC51cGRhdGVSZW5kZXJlZEVsZW1lbnRzID09PSAnZnVuY3Rpb24nICYmICEoaC51cGRhdGVSZW5kZXJlZEVsZW1lbnRzLmttMzQpKSB7CgogICAgICBjb25zdCBmID0gaC51cGRhdGVSZW5kZXJlZEVsZW1lbnRzOwogICAgICBjb25zdCBnID0gdW1wMy5nZXQoZikgfHwgZnVuY3Rpb24gKCkgewogICAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gZi5hcHBseSh0aGlzLCBhcmd1bWVudHMpKS5jYXRjaChjb25zb2xlLmxvZyk7CiAgICAgIH0KICAgICAgdW1wMy5zZXQoZiwgZyk7CiAgICAgIGcua20zNCA9IDE7CiAgICAgIGgudXBkYXRlUmVuZGVyZWRFbGVtZW50cyA9IGc7CgogICAgfQoKICAgIGlmICgoV0VBS19SRUZfQklORElOR19DT05UUk9MICYgMikgJiYgdHlwZW9mIGgubG9hZFBhZ2VfID09PSAnZnVuY3Rpb24nICYmICEoaC5sb2FkUGFnZV8ua20zNCkpIHsKICAgICAgY29uc3QgZiA9IGgubG9hZFBhZ2VfOwogICAgICBjb25zdCBnID0gdW1wMy5nZXQoZikgfHwgZnVuY3Rpb24gKGEpIHsKICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGYuYXBwbHkodGhpcywgYXJndW1lbnRzKSkuY2F0Y2goY29uc29sZS5sb2cpOwogICAgICB9CiAgICAgIHVtcDMuc2V0KGYsIGcpOwogICAgICBnLmttMzQgPSAxOwogICAgICBoLmxvYWRQYWdlXyA9IGc7CgogICAgfQogICAgLy8gdXBkYXRlUGFnZURhdGFfIDogcG9zc2libGUgY29uZmxpY3Qgd2l0aCBPbWl0IFNoYWR5RE9NCiAgICBpZiAoKFdFQUtfUkVGX0JJTkRJTkdfQ09OVFJPTCAmIDIpICYmIHR5cGVvZiBoLnVwZGF0ZVBhZ2VEYXRhXyA9PT0gJ2Z1bmN0aW9uJyAmJiAhKGgudXBkYXRlUGFnZURhdGFfLmttMzQpKSB7CiAgICAgIGNvbnN0IGYgPSBoLnVwZGF0ZVBhZ2VEYXRhXzsKICAgICAgY29uc3QgZyA9IHVtcDMuZ2V0KGYpIHx8IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBmLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpLmNhdGNoKGNvbnNvbGUubG9nKTsKICAgICAgfQogICAgICB1bXAzLnNldChmLCBnKTsKICAgICAgZy5rbTM0ID0gMTsKICAgICAgaC51cGRhdGVQYWdlRGF0YV8gPSBnOwoKICAgIH0KCgogICAgaWYgKChXRUFLX1JFRl9CSU5ESU5HX0NPTlRST0wgJiAxKSAmJiB0eXBlb2YgaC5vbkZvY3VzXyA9PT0gJ2Z1bmN0aW9uJyAmJiAhKGgub25Gb2N1c18ua20zNCkpIHsKCiAgICAgIGNvbnN0IGYgPSBoLm9uRm9jdXNfOwogICAgICBjb25zdCBnID0gdW1wMy5nZXQoZikgfHwgZnVuY3Rpb24gKCkgewogICAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gZi5hcHBseSh0aGlzLCBhcmd1bWVudHMpKS5jYXRjaChjb25zb2xlLmxvZyk7CiAgICAgIH0KICAgICAgdW1wMy5zZXQoZiwgZyk7CiAgICAgIGcua20zNCA9IDE7CiAgICAgIGgub25Gb2N1c18gPSBnOwoKICAgIH0KCiAgICBpZiAoKFdFQUtfUkVGX0JJTkRJTkdfQ09OVFJPTCAmIDEpICYmIHR5cGVvZiBoLm9uQmx1cl8gPT09ICdmdW5jdGlvbicgJiYgIShoLm9uQmx1cl8ua20zNCkpIHsKCiAgICAgIGNvbnN0IGYgPSBoLm9uQmx1cl87CiAgICAgIGNvbnN0IGcgPSB1bXAzLmdldChmKSB8fCBmdW5jdGlvbiAoKSB7CiAgICAgICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBmLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpLmNhdGNoKGNvbnNvbGUubG9nKTsKICAgICAgfQogICAgICB1bXAzLnNldChmLCBnKTsKICAgICAgZy5rbTM0ID0gMTsKICAgICAgaC5vbkJsdXJfID0gZzsKCiAgICB9CgoKICAgIGlmICgoV0VBS19SRUZfQklORElOR19DT05UUk9MICYgMSkgJiYgdHlwZW9mIGguYnV0dG9uQ2xhc3NDaGFuZ2VkXyA9PT0gJ2Z1bmN0aW9uJyAmJiAhKGguYnV0dG9uQ2xhc3NDaGFuZ2VkXy5rbTM0KSkgewoKICAgICAgY29uc3QgZiA9IGguYnV0dG9uQ2xhc3NDaGFuZ2VkXzsKICAgICAgY29uc3QgZyA9IHVtcDMuZ2V0KGYpIHx8IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBmLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpLmNhdGNoKGNvbnNvbGUubG9nKTsKICAgICAgfQogICAgICB1bXAzLnNldChmLCBnKTsKICAgICAgZy5rbTM0ID0gMTsKICAgICAgaC5idXR0b25DbGFzc0NoYW5nZWRfID0gZzsKCiAgICB9CgogICAgaWYgKChXRUFLX1JFRl9CSU5ESU5HX0NPTlRST0wgJiAxKSAmJiB0eXBlb2YgaC5idXR0b25JY29uQ2hhbmdlZF8gPT09ICdmdW5jdGlvbicgJiYgIShoLmJ1dHRvbkljb25DaGFuZ2VkXy5rbTM0KSkgewoKICAgICAgY29uc3QgZiA9IGguYnV0dG9uSWNvbkNoYW5nZWRfOwogICAgICBjb25zdCBnID0gdW1wMy5nZXQoZikgfHwgZnVuY3Rpb24gKGEpIHsKICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGYuYXBwbHkodGhpcywgYXJndW1lbnRzKSkuY2F0Y2goY29uc29sZS5sb2cpOwogICAgICB9CiAgICAgIHVtcDMuc2V0KGYsIGcpOwogICAgICBnLmttMzQgPSAxOwogICAgICBoLmJ1dHRvbkljb25DaGFuZ2VkXyA9IGc7CgogICAgfQoKICAgIGlmICgoV0VBS19SRUZfQklORElOR19DT05UUk9MICYgMSkgJiYgdHlwZW9mIGguZGF0YUNoYW5nZWRJbkJlaGF2aW9yXyA9PT0gJ2Z1bmN0aW9uJyAmJiAhKGguZGF0YUNoYW5nZWRJbkJlaGF2aW9yXy5rbTM0KSkgewoKICAgICAgY29uc3QgZiA9IGguZGF0YUNoYW5nZWRJbkJlaGF2aW9yXzsKICAgICAgY29uc3QgZyA9IHVtcDMuZ2V0KGYpIHx8IGZ1bmN0aW9uICgpIHsKICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGYuYXBwbHkodGhpcywgYXJndW1lbnRzKSkuY2F0Y2goY29uc29sZS5sb2cpOwogICAgICB9CiAgICAgIHVtcDMuc2V0KGYsIGcpOwogICAgICBnLmttMzQgPSAxOwogICAgICBoLmRhdGFDaGFuZ2VkSW5CZWhhdmlvcl8gPSBnOwoKICAgIH0KCiAgICBpZiAoKFdFQUtfUkVGX0JJTkRJTkdfQ09OVFJPTCAmIDEpICYmIHR5cGVvZiBoLmNvbnRpbnVhdGlvbnNDaGFuZ2VkXyA9PT0gJ2Z1bmN0aW9uJyAmJiAhKGguY29udGludWF0aW9uc0NoYW5nZWRfLmttMzQpKSB7CgogICAgICBjb25zdCBmID0gaC5jb250aW51YXRpb25zQ2hhbmdlZF87CiAgICAgIGNvbnN0IGcgPSB1bXAzLmdldChmKSB8fCBmdW5jdGlvbiAoKSB7CiAgICAgICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBmLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpLmNhdGNoKGNvbnNvbGUubG9nKTsKICAgICAgfQogICAgICB1bXAzLnNldChmLCBnKTsKICAgICAgZy5rbTM0ID0gMTsKICAgICAgaC5jb250aW51YXRpb25zQ2hhbmdlZF8gPSBnOwoKICAgIH0KCgogICAgaWYgKChXRUFLX1JFRl9CSU5ESU5HX0NPTlRST0wgJiAxKSAmJiB0eXBlb2YgaC5mb3JjZUNoYXRQb2xsXyA9PT0gJ2Z1bmN0aW9uJyAmJiAhKGguZm9yY2VDaGF0UG9sbF8ua20zNCkpIHsKCiAgICAgIGNvbnN0IGYgPSBoLmZvcmNlQ2hhdFBvbGxfOwogICAgICBjb25zdCBnID0gdW1wMy5nZXQoZikgfHwgZnVuY3Rpb24gKGEpIHsKICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGYuYXBwbHkodGhpcywgYXJndW1lbnRzKSkuY2F0Y2goY29uc29sZS5sb2cpOwogICAgICB9CiAgICAgIHVtcDMuc2V0KGYsIGcpOwogICAgICBnLmttMzQgPSAxOwogICAgICBoLmZvcmNlQ2hhdFBvbGxfID0gZzsKCiAgICB9CgogICAgaWYgKChXRUFLX1JFRl9CSU5ESU5HX0NPTlRST0wgJiAxKSAmJiB0eXBlb2YgaC5vbkVuZHBvaW50Q2xpY2tfID09PSAnZnVuY3Rpb24nICYmICEoaC5vbkVuZHBvaW50Q2xpY2tfLmttMzQpKSB7CgogICAgICBjb25zdCBmID0gaC5vbkVuZHBvaW50Q2xpY2tfOwogICAgICBjb25zdCBnID0gdW1wMy5nZXQoZikgfHwgZnVuY3Rpb24gKGEpIHsKICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGYuYXBwbHkodGhpcywgYXJndW1lbnRzKSkuY2F0Y2goY29uc29sZS5sb2cpOwogICAgICB9CiAgICAgIHVtcDMuc2V0KGYsIGcpOwogICAgICBnLmttMzQgPSAxOwogICAgICBoLm9uRW5kcG9pbnRDbGlja18gPSBnOwoKICAgIH0KCiAgICBpZiAoKFdFQUtfUkVGX0JJTkRJTkdfQ09OVFJPTCAmIDEpICYmIHR5cGVvZiBoLm9uRW5kcG9pbnRUYXBfID09PSAnZnVuY3Rpb24nICYmICEoaC5vbkVuZHBvaW50VGFwXy5rbTM0KSkgewoKICAgICAgY29uc3QgZiA9IGgub25FbmRwb2ludFRhcF87CiAgICAgIGNvbnN0IGcgPSB1bXAzLmdldChmKSB8fCBmdW5jdGlvbiAoYSkgewogICAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gZi5hcHBseSh0aGlzLCBhcmd1bWVudHMpKS5jYXRjaChjb25zb2xlLmxvZyk7CiAgICAgIH0KICAgICAgdW1wMy5zZXQoZiwgZyk7CiAgICAgIGcua20zNCA9IDE7CiAgICAgIGgub25FbmRwb2ludFRhcF8gPSBnOwoKICAgIH0KCiAgICBpZiAoKFdFQUtfUkVGX0JJTkRJTkdfQ09OVFJPTCAmIDEpICYmIHR5cGVvZiBoLmhhbmRsZUNsaWNrXyA9PT0gJ2Z1bmN0aW9uJyAmJiAhKGguaGFuZGxlQ2xpY2tfLmttMzQpKSB7CgogICAgICBjb25zdCBmID0gaC5oYW5kbGVDbGlja187CiAgICAgIGNvbnN0IGcgPSB1bXAzLmdldChmKSB8fCBmdW5jdGlvbiAoYSwgYikgewogICAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gZi5hcHBseSh0aGlzLCBhcmd1bWVudHMpKS5jYXRjaChjb25zb2xlLmxvZyk7CiAgICAgIH0KICAgICAgdW1wMy5zZXQoZiwgZyk7CiAgICAgIGcua20zNCA9IDE7CiAgICAgIGguaGFuZGxlQ2xpY2tfID0gZzsKCiAgICB9CgogICAgaWYgKChXRUFLX1JFRl9CSU5ESU5HX0NPTlRST0wgJiAxKSAmJiB0eXBlb2YgaC5vblJlYWR5U3RhdGVDaGFuZ2VfID09PSAnZnVuY3Rpb24nICYmICEoaC5vblJlYWR5U3RhdGVDaGFuZ2VfLmttMzQpKSB7CgogICAgICBjb25zdCBmID0gaC5vblJlYWR5U3RhdGVDaGFuZ2VfOwogICAgICBjb25zdCBnID0gdW1wMy5nZXQoZikgfHwgZnVuY3Rpb24gKCkgewogICAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gZi5hcHBseSh0aGlzLCBhcmd1bWVudHMpKS5jYXRjaChjb25zb2xlLmxvZyk7CiAgICAgIH0KICAgICAgdW1wMy5zZXQoZiwgZyk7CiAgICAgIGcua20zNCA9IDE7CiAgICAgIGgub25SZWFkeVN0YXRlQ2hhbmdlXyA9IGc7CgogICAgfQoKICAgIGlmICgoV0VBS19SRUZfQklORElOR19DT05UUk9MICYgMSkgJiYgdHlwZW9mIGgub25SZWFkeVN0YXRlQ2hhbmdlRW50cnlQb2ludF8gPT09ICdmdW5jdGlvbicgJiYgIShoLm9uUmVhZHlTdGF0ZUNoYW5nZUVudHJ5UG9pbnRfLmttMzQpKSB7CgogICAgICBjb25zdCBmID0gaC5vblJlYWR5U3RhdGVDaGFuZ2VFbnRyeVBvaW50XzsKICAgICAgY29uc3QgZyA9IHVtcDMuZ2V0KGYpIHx8IGZ1bmN0aW9uICgpIHsKICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGYuYXBwbHkodGhpcywgYXJndW1lbnRzKSkuY2F0Y2goY29uc29sZS5sb2cpOwogICAgICB9CiAgICAgIHVtcDMuc2V0KGYsIGcpOwogICAgICBnLmttMzQgPSAxOwogICAgICBoLm9uUmVhZHlTdGF0ZUNoYW5nZUVudHJ5UG9pbnRfID0gZzsKCiAgICB9CgogICAgaWYgKChXRUFLX1JFRl9CSU5ESU5HX0NPTlRST0wgJiAxKSAmJiB0eXBlb2YgaC5yZWFkeVN0YXRlQ2hhbmdlSGFuZGxlcl8gPT09ICdmdW5jdGlvbicgJiYgIShoLnJlYWR5U3RhdGVDaGFuZ2VIYW5kbGVyXy5rbTM0KSkgewoKICAgICAgY29uc3QgZiA9IGgucmVhZHlTdGF0ZUNoYW5nZUhhbmRsZXJfOwogICAgICBjb25zdCBnID0gdW1wMy5nZXQoZikgfHwgZnVuY3Rpb24gKGEpIHsKICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGYuYXBwbHkodGhpcywgYXJndW1lbnRzKSkuY2F0Y2goY29uc29sZS5sb2cpOwogICAgICB9CiAgICAgIHVtcDMuc2V0KGYsIGcpOwogICAgICBnLmttMzQgPSAxOwogICAgICBoLnJlYWR5U3RhdGVDaGFuZ2VIYW5kbGVyXyA9IGc7CgogICAgfQoKICAgIGlmICh0eXBlb2YgaC54bWxIdHRwSGFuZGxlcl8gPT09ICdmdW5jdGlvbicgJiYgIShoLnhtbEh0dHBIYW5kbGVyXy5rbTM0KSkgewoKICAgICAgY29uc3QgZiA9IGgueG1sSHR0cEhhbmRsZXJfOwogICAgICBjb25zdCBnID0gdW1wMy5nZXQoZikgfHwgZnVuY3Rpb24gKGEpIHsKICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGYuYXBwbHkodGhpcywgYXJndW1lbnRzKSkuY2F0Y2goY29uc29sZS5sb2cpOwogICAgICB9CiAgICAgIHVtcDMuc2V0KGYsIGcpOwogICAgICBnLmttMzQgPSAxOwogICAgICBoLnhtbEh0dHBIYW5kbGVyXyA9IGc7CgogICAgfQoKICAgIGlmICgoV0VBS19SRUZfQklORElOR19DT05UUk9MICYgMSkgJiYgdHlwZW9mIGguZXhlY3V0ZUNhbGxiYWNrc18gPT09ICdmdW5jdGlvbicgJiYgIShoLmV4ZWN1dGVDYWxsYmFja3NfLmttMzQpKSB7CgogICAgICBjb25zdCBmID0gaC5leGVjdXRlQ2FsbGJhY2tzXzsgLy8gb3ZlcmxvYWRlZAogICAgICBjb25zdCBnID0gdW1wMy5nZXQoZikgfHwgZnVuY3Rpb24gKGEpIHsKICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGYuYXBwbHkodGhpcywgYXJndW1lbnRzKSkuY2F0Y2goY29uc29sZS5sb2cpOwogICAgICB9CiAgICAgIHVtcDMuc2V0KGYsIGcpOwogICAgICBnLmttMzQgPSAxOwogICAgICBoLmV4ZWN1dGVDYWxsYmFja3NfID0gZzsKCiAgICB9CgogICAgaWYgKChXRUFLX1JFRl9CSU5ESU5HX0NPTlRST0wgJiAxKSAmJiB0eXBlb2YgaC5oYW5kbGVJbnZhbGlkYXRpb25EYXRhXyA9PT0gJ2Z1bmN0aW9uJyAmJiAhKGguaGFuZGxlSW52YWxpZGF0aW9uRGF0YV8ua20zNCkpIHsKCiAgICAgIGNvbnN0IGYgPSBoLmhhbmRsZUludmFsaWRhdGlvbkRhdGFfOwogICAgICBjb25zdCBnID0gdW1wMy5nZXQoZikgfHwgZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGYuYXBwbHkodGhpcywgYXJndW1lbnRzKSkuY2F0Y2goY29uc29sZS5sb2cpOwogICAgICB9CiAgICAgIHVtcDMuc2V0KGYsIGcpOwogICAgICBnLmttMzQgPSAxOwogICAgICBoLmhhbmRsZUludmFsaWRhdGlvbkRhdGFfID0gZzsKCiAgICB9CgogICAgaWYgKHR5cGVvZiBoLm9uSW5wdXRfID09PSAnZnVuY3Rpb24nICYmICEoaC5vbklucHV0Xy5rbTM0KSkgewoKICAgICAgY29uc3QgZiA9IGgub25JbnB1dF87CiAgICAgIGNvbnN0IGcgPSB1bXAzLmdldChmKSB8fCBmdW5jdGlvbiAoKSB7CiAgICAgICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBmLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpLmNhdGNoKGNvbnNvbGUubG9nKTsKICAgICAgfQogICAgICB1bXAzLnNldChmLCBnKTsKICAgICAgZy5rbTM0ID0gMTsKICAgICAgaC5vbklucHV0XyA9IGc7CgogICAgfQogICAgaWYgKHR5cGVvZiBoLnRyaWdnZXJfID09PSAnZnVuY3Rpb24nICYmICEoaC50cmlnZ2VyXy5rbTM0KSkgewoKICAgICAgY29uc3QgZiA9IGgudHJpZ2dlcl87CiAgICAgIGNvbnN0IGcgPSB1bXAzLmdldChmKSB8fCBmdW5jdGlvbiAoYSkgewogICAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gZi5hcHBseSh0aGlzLCBhcmd1bWVudHMpKS5jYXRjaChjb25zb2xlLmxvZyk7CiAgICAgIH0KICAgICAgdW1wMy5zZXQoZiwgZyk7CiAgICAgIGcua20zNCA9IDE7CiAgICAgIGgudHJpZ2dlcl8gPSBnOwoKICAgIH0KCiAgICBpZiAodHlwZW9mIGgucmVxdWVzdERhdGFfID09PSAnZnVuY3Rpb24nICYmICEoaC5yZXF1ZXN0RGF0YV8ua20zNCkpIHsKCiAgICAgIGNvbnN0IGYgPSBoLnJlcXVlc3REYXRhXzsKICAgICAgY29uc3QgZyA9IHVtcDMuZ2V0KGYpIHx8IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBmLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpLmNhdGNoKGNvbnNvbGUubG9nKTsKICAgICAgfQogICAgICB1bXAzLnNldChmLCBnKTsKICAgICAgZy5rbTM0ID0gMTsKICAgICAgaC5yZXF1ZXN0RGF0YV8gPSBnOwoKICAgIH0KCiAgICBpZiAodHlwZW9mIGgub25Mb2FkUmVsb2FkQ29udGludWF0aW9uXyA9PT0gJ2Z1bmN0aW9uJyAmJiAhKGgub25Mb2FkUmVsb2FkQ29udGludWF0aW9uXy5rbTM0KSkgewoKICAgICAgY29uc3QgZiA9IGgub25Mb2FkUmVsb2FkQ29udGludWF0aW9uXzsKICAgICAgY29uc3QgZyA9IHVtcDMuZ2V0KGYpIHx8IGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBmLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpLmNhdGNoKGNvbnNvbGUubG9nKTsKICAgICAgfQogICAgICB1bXAzLnNldChmLCBnKTsKICAgICAgZy5rbTM0ID0gMTsKICAgICAgaC5vbkxvYWRSZWxvYWRDb250aW51YXRpb25fID0gZzsKCiAgICB9CgogICAgaWYgKHR5cGVvZiBoLm9uTG9hZEluY3JlbWVudGFsQ29udGludWF0aW9uXyA9PT0gJ2Z1bmN0aW9uJyAmJiAhKGgub25Mb2FkSW5jcmVtZW50YWxDb250aW51YXRpb25fLmttMzQpKSB7CgogICAgICBjb25zdCBmID0gaC5vbkxvYWRJbmNyZW1lbnRhbENvbnRpbnVhdGlvbl87CiAgICAgIGNvbnN0IGcgPSB1bXAzLmdldChmKSB8fCBmdW5jdGlvbiAoYSwgYikgewogICAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gZi5hcHBseSh0aGlzLCBhcmd1bWVudHMpKS5jYXRjaChjb25zb2xlLmxvZyk7CiAgICAgIH0KICAgICAgdW1wMy5zZXQoZiwgZyk7CiAgICAgIGcua20zNCA9IDE7CiAgICAgIGgub25Mb2FkSW5jcmVtZW50YWxDb250aW51YXRpb25fID0gZzsKCiAgICB9CgogICAgaWYgKHR5cGVvZiBoLm9uTG9hZFNlZWtDb250aW51YXRpb25fID09PSAnZnVuY3Rpb24nICYmICEoaC5vbkxvYWRTZWVrQ29udGludWF0aW9uXy5rbTM0KSkgewoKICAgICAgY29uc3QgZiA9IGgub25Mb2FkU2Vla0NvbnRpbnVhdGlvbl87CiAgICAgIGNvbnN0IGcgPSB1bXAzLmdldChmKSB8fCBmdW5jdGlvbiAoYSwgYikgewogICAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gZi5hcHBseSh0aGlzLCBhcmd1bWVudHMpKS5jYXRjaChjb25zb2xlLmxvZyk7CiAgICAgIH0KICAgICAgdW1wMy5zZXQoZiwgZyk7CiAgICAgIGcua20zNCA9IDE7CiAgICAgIGgub25Mb2FkU2Vla0NvbnRpbnVhdGlvbl8gPSBnOwoKICAgIH0KICAgIGlmICh0eXBlb2YgaC5vbkxvYWRSZXBsYXlDb250aW51YXRpb25fID09PSAnZnVuY3Rpb24nICYmICEoaC5vbkxvYWRSZXBsYXlDb250aW51YXRpb25fLmttMzQpKSB7CgogICAgICBjb25zdCBmID0gaC5vbkxvYWRSZXBsYXlDb250aW51YXRpb25fOwogICAgICBjb25zdCBnID0gdW1wMy5nZXQoZikgfHwgZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGYuYXBwbHkodGhpcywgYXJndW1lbnRzKSkuY2F0Y2goY29uc29sZS5sb2cpOwogICAgICB9CiAgICAgIHVtcDMuc2V0KGYsIGcpOwogICAgICBnLmttMzQgPSAxOwogICAgICBoLm9uTG9hZFJlcGxheUNvbnRpbnVhdGlvbl8gPSBnOwoKICAgIH0KICAgIGlmICgoV0VBS19SRUZfQklORElOR19DT05UUk9MICYgMSkgJiYgdHlwZW9mIGgub25OYXZpZ2F0ZV8gPT09ICdmdW5jdGlvbicgJiYgIShoLm9uTmF2aWdhdGVfLmttMzQpKSB7CgogICAgICBjb25zdCBmID0gaC5vbk5hdmlnYXRlXzsKICAgICAgY29uc3QgZyA9IHVtcDMuZ2V0KGYpIHx8IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBmLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpLmNhdGNoKGNvbnNvbGUubG9nKTsKICAgICAgfQogICAgICB1bXAzLnNldChmLCBnKTsKICAgICAgZy5rbTM0ID0gMTsKICAgICAgaC5vbk5hdmlnYXRlXyA9IGc7CgogICAgfQoKICAgIGlmICgoV0VBS19SRUZfQklORElOR19DT05UUk9MICYgMSkgJiYgdHlwZW9mIGgueXRSZW5kZXJlckJlaGF2aW9yRGF0YU9ic2VydmVyXyA9PT0gJ2Z1bmN0aW9uJyAmJiAhKGgueXRSZW5kZXJlckJlaGF2aW9yRGF0YU9ic2VydmVyXy5rbTM0KSkgewoKICAgICAgY29uc3QgZiA9IGgueXRSZW5kZXJlckJlaGF2aW9yRGF0YU9ic2VydmVyXzsKICAgICAgY29uc3QgZyA9IHVtcDMuZ2V0KGYpIHx8IGZ1bmN0aW9uICgpIHsKICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGYuYXBwbHkodGhpcywgYXJndW1lbnRzKSkuY2F0Y2goY29uc29sZS5sb2cpOwogICAgICB9CiAgICAgIHVtcDMuc2V0KGYsIGcpOwogICAgICBnLmttMzQgPSAxOwogICAgICBoLnl0UmVuZGVyZXJCZWhhdmlvckRhdGFPYnNlcnZlcl8gPSBnOwoKICAgIH0KCiAgICBpZiAoKFdFQUtfUkVGX0JJTkRJTkdfQ09OVFJPTCAmIDEpICYmIHR5cGVvZiBoLnl0UmVuZGVyZXJCZWhhdmlvclRhcmdldElkT2JzZXJ2ZXJfID09PSAnZnVuY3Rpb24nICYmICEoaC55dFJlbmRlcmVyQmVoYXZpb3JUYXJnZXRJZE9ic2VydmVyXy5rbTM0KSkgewoKICAgICAgY29uc3QgZiA9IGgueXRSZW5kZXJlckJlaGF2aW9yVGFyZ2V0SWRPYnNlcnZlcl87CiAgICAgIGNvbnN0IGcgPSB1bXAzLmdldChmKSB8fCBmdW5jdGlvbiAoKSB7CiAgICAgICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBmLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpLmNhdGNoKGNvbnNvbGUubG9nKTsKICAgICAgfQogICAgICB1bXAzLnNldChmLCBnKTsKICAgICAgZy5rbTM0ID0gMTsKICAgICAgaC55dFJlbmRlcmVyQmVoYXZpb3JUYXJnZXRJZE9ic2VydmVyXyA9IGc7CgogICAgfQoKICAgIGlmICgoV0VBS19SRUZfQklORElOR19DT05UUk9MICYgMSkgJiYgdHlwZW9mIGgudW5yZWdpc3RlclJlbmRlcmVyXyA9PT0gJ2Z1bmN0aW9uJyAmJiAhKGgudW5yZWdpc3RlclJlbmRlcmVyXy5rbTM0KSkgewoKICAgICAgY29uc3QgZiA9IGgudW5yZWdpc3RlclJlbmRlcmVyXzsKICAgICAgY29uc3QgZyA9IHVtcDMuZ2V0KGYpIHx8IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBmLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpLmNhdGNoKGNvbnNvbGUubG9nKTsKICAgICAgfQogICAgICB1bXAzLnNldChmLCBnKTsKICAgICAgZy5rbTM0ID0gMTsKICAgICAgaC51bnJlZ2lzdGVyUmVuZGVyZXJfID0gZzsKCiAgICB9CgogICAgaWYgKChXRUFLX1JFRl9CSU5ESU5HX0NPTlRST0wgJiAxKSAmJiB0eXBlb2YgaC50ZXh0Q2hhbmdlZF8gPT09ICdmdW5jdGlvbicgJiYgIShoLnRleHRDaGFuZ2VkXy5rbTM0KSkgewoKICAgICAgY29uc3QgZiA9IGgudGV4dENoYW5nZWRfOwogICAgICBjb25zdCBnID0gdW1wMy5nZXQoZikgfHwgZnVuY3Rpb24gKGEpIHsKICAgICAgICBpZiAodm9pZCAwICE9PSB0aGlzLmlzQXR0YWNoZWQpIHsKICAgICAgICAgIGNvbnN0IGhvc3RFbGVtZW50ID0gdGhpcy5ob3N0RWxlbWVudDsKICAgICAgICAgIGlmICghKGhvc3RFbGVtZW50IGluc3RhbmNlb2YgTm9kZSkgfHwgaG9zdEVsZW1lbnQubm9kZU5hbWUgPT09ICdOT1NDUklQVCcpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGYuYXBwbHkodGhpcywgYXJndW1lbnRzKSkuY2F0Y2goY29uc29sZS5sb2cpOwogICAgICB9CiAgICAgIHVtcDMuc2V0KGYsIGcpOwogICAgICBnLmttMzQgPSAxOwogICAgICBoLnRleHRDaGFuZ2VkXyA9IGc7CgogICAgfQoKCgogICAgLyoqCiAgICAgKgogICAgICogTmVnbGVjdCBmb2xsb3dpbmcKICAgICAqCiAgICAgKiBoLm9uWXRBY3Rpb25fCiAgICAgKiBoLnN0YXJ0TG9hZGluZ1dhdGNoIFsgYnVnZ3kgZm9yIHl0LXBsYXllci11cGRhdGVkIF0KICAgICAqIGguZGVmZXJSZW5kZXJTdGFtcGVyQmluZGluZ18KICAgICAqCiAgICAgKiBoLnN0YW1wRG9tQXJyYXlfCiAgICAgKiBoLnN0YW1wRG9tQXJyYXlTcGxpY2VzXwogICAgICoKICAgICAqLwoKCiAgICAvLyBSUC5wcm90b3R5cGUuc2VhcmNoQ2hhbmdlZF8gPSBSUC5wcm90b3R5cGUuc2VhcmNoQ2hhbmdlZF87CiAgICAvLyBSUC5wcm90b3R5cGUuc2tpblRvbmVDaGFuZ2VkXyA9IFJQLnByb3RvdHlwZS5za2luVG9uZUNoYW5nZWRfOwogICAgLy8gUlAucHJvdG90eXBlLm9uRW1vamlIb3Zlcl8gPSBSUC5wcm90b3R5cGUub25FbW9qaUhvdmVyXzsKICAgIC8vIFJQLnByb3RvdHlwZS5vblNlbGVjdENhdGVnb3J5XyA9IFJQLnByb3RvdHlwZS5vblNlbGVjdENhdGVnb3J5XzsKICAgIC8vIFJQLnByb3RvdHlwZS5vblNob3dFbW9qaVZhcmlhbnRTZWxlY3RvciA9IFJQLnByb3RvdHlwZS5vblNob3dFbW9qaVZhcmlhbnRTZWxlY3RvcjsKICAgIC8vIFJQLnByb3RvdHlwZS51cGRhdGVDYXRlZ29yaWVzQW5kUGxhY2Vob2xkZXJfID0gUlAucHJvdG90eXBlLnVwZGF0ZUNhdGVnb3JpZXNBbmRQbGFjZWhvbGRlcl87CgogICAgaWYgKHR5cGVvZiBoLnNlYXJjaENoYW5nZWRfID09PSAnZnVuY3Rpb24nICYmICEoaC5zZWFyY2hDaGFuZ2VkXy5rbTM0KSkgewoKICAgICAgY29uc3QgZiA9IGguc2VhcmNoQ2hhbmdlZF87CiAgICAgIGNvbnN0IGcgPSB1bXAzLmdldChmKSB8fCBmdW5jdGlvbiAoKSB7CiAgICAgICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBmLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpLmNhdGNoKGNvbnNvbGUubG9nKTsKICAgICAgfQogICAgICB1bXAzLnNldChmLCBnKTsKICAgICAgZy5rbTM0ID0gMTsKICAgICAgaC5zZWFyY2hDaGFuZ2VkXyA9IGc7CgogICAgfQoKICAgIGlmICh0eXBlb2YgaC5za2luVG9uZUNoYW5nZWRfID09PSAnZnVuY3Rpb24nICYmICEoaC5za2luVG9uZUNoYW5nZWRfLmttMzQpKSB7CgogICAgICBjb25zdCBmID0gaC5za2luVG9uZUNoYW5nZWRfOwogICAgICBjb25zdCBnID0gdW1wMy5nZXQoZikgfHwgZnVuY3Rpb24gKGEpIHsKICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGYuYXBwbHkodGhpcywgYXJndW1lbnRzKSkuY2F0Y2goY29uc29sZS5sb2cpOwogICAgICB9CiAgICAgIHVtcDMuc2V0KGYsIGcpOwogICAgICBnLmttMzQgPSAxOwogICAgICBoLnNraW5Ub25lQ2hhbmdlZF8gPSBnOwoKICAgIH0KCiAgICBpZiAodHlwZW9mIGgub25FbW9qaUhvdmVyXyA9PT0gJ2Z1bmN0aW9uJyAmJiAhKGgub25FbW9qaUhvdmVyXy5rbTM0KSkgewoKICAgICAgY29uc3QgZiA9IGgub25FbW9qaUhvdmVyXzsKICAgICAgY29uc3QgZyA9IHVtcDMuZ2V0KGYpIHx8IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBmLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpLmNhdGNoKGNvbnNvbGUubG9nKTsKICAgICAgfQogICAgICB1bXAzLnNldChmLCBnKTsKICAgICAgZy5rbTM0ID0gMTsKICAgICAgaC5vbkVtb2ppSG92ZXJfID0gZzsKCiAgICB9CgogICAgaWYgKHR5cGVvZiBoLm9uU2VsZWN0Q2F0ZWdvcnlfID09PSAnZnVuY3Rpb24nICYmICEoaC5vblNlbGVjdENhdGVnb3J5Xy5rbTM0KSkgewoKICAgICAgY29uc3QgZiA9IGgub25TZWxlY3RDYXRlZ29yeV87CiAgICAgIGNvbnN0IGcgPSB1bXAzLmdldChmKSB8fCBmdW5jdGlvbiAoYSkgewogICAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gZi5hcHBseSh0aGlzLCBhcmd1bWVudHMpKS5jYXRjaChjb25zb2xlLmxvZyk7CiAgICAgIH0KICAgICAgdW1wMy5zZXQoZiwgZyk7CiAgICAgIGcua20zNCA9IDE7CiAgICAgIGgub25TZWxlY3RDYXRlZ29yeV8gPSBnOwoKICAgIH0KCiAgICBpZiAodHlwZW9mIGgub25TaG93RW1vamlWYXJpYW50U2VsZWN0b3IgPT09ICdmdW5jdGlvbicgJiYgIShoLm9uU2hvd0Vtb2ppVmFyaWFudFNlbGVjdG9yLmttMzQpKSB7CgogICAgICBjb25zdCBmID0gaC5vblNob3dFbW9qaVZhcmlhbnRTZWxlY3RvcjsKICAgICAgY29uc3QgZyA9IHVtcDMuZ2V0KGYpIHx8IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBmLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpLmNhdGNoKGNvbnNvbGUubG9nKTsKICAgICAgfQogICAgICB1bXAzLnNldChmLCBnKTsKICAgICAgZy5rbTM0ID0gMTsKICAgICAgaC5vblNob3dFbW9qaVZhcmlhbnRTZWxlY3RvciA9IGc7CgogICAgfQoKICAgIGlmICh0eXBlb2YgaC51cGRhdGVDYXRlZ29yaWVzQW5kUGxhY2Vob2xkZXJfID09PSAnZnVuY3Rpb24nICYmICEoaC51cGRhdGVDYXRlZ29yaWVzQW5kUGxhY2Vob2xkZXJfLmttMzQpKSB7CgogICAgICBjb25zdCBmID0gaC51cGRhdGVDYXRlZ29yaWVzQW5kUGxhY2Vob2xkZXJfOwogICAgICBjb25zdCBnID0gdW1wMy5nZXQoZikgfHwgZnVuY3Rpb24gKCkgewogICAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gZi5hcHBseSh0aGlzLCBhcmd1bWVudHMpKS5jYXRjaChjb25zb2xlLmxvZyk7CiAgICAgIH0KICAgICAgdW1wMy5zZXQoZiwgZyk7CiAgICAgIGcua20zNCA9IDE7CiAgICAgIGgudXBkYXRlQ2F0ZWdvcmllc0FuZFBsYWNlaG9sZGVyXyA9IGc7CgogICAgfQoKICAgIGlmICh0eXBlb2YgaC53YXRjaFBhZ2VBY3RpdmVDaGFuZ2VkXyA9PT0gJ2Z1bmN0aW9uJyAmJiAhKGgud2F0Y2hQYWdlQWN0aXZlQ2hhbmdlZF8ua20zNCkpIHsKCiAgICAgIGNvbnN0IGYgPSBoLndhdGNoUGFnZUFjdGl2ZUNoYW5nZWRfOwogICAgICBjb25zdCBnID0gdW1wMy5nZXQoZikgfHwgZnVuY3Rpb24gKCkgewogICAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gZi5hcHBseSh0aGlzLCBhcmd1bWVudHMpKS5jYXRjaChjb25zb2xlLmxvZyk7CiAgICAgIH0KICAgICAgdW1wMy5zZXQoZiwgZyk7CiAgICAgIGcua20zNCA9IDE7CiAgICAgIGgud2F0Y2hQYWdlQWN0aXZlQ2hhbmdlZF8gPSBnOwoKICAgIH0KCiAgICBpZiAodHlwZW9mIGguYWN0aXZhdGVfID09PSAnZnVuY3Rpb24nICYmICEoaC5hY3RpdmF0ZV8ua20zNCkpIHsKCiAgICAgIGNvbnN0IGYgPSBoLmFjdGl2YXRlXzsKICAgICAgY29uc3QgZyA9IHVtcDMuZ2V0KGYpIHx8IGZ1bmN0aW9uICgpIHsKICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGYuYXBwbHkodGhpcywgYXJndW1lbnRzKSkuY2F0Y2goY29uc29sZS5sb2cpOwogICAgICB9CiAgICAgIHVtcDMuc2V0KGYsIGcpOwogICAgICBnLmttMzQgPSAxOwogICAgICBoLmFjdGl2YXRlXyA9IGc7CgogICAgfQogICAgaWYgKHR5cGVvZiBoLm9uWXRQbGF5bGlzdERhdGFVcGRhdGVkXyA9PT0gJ2Z1bmN0aW9uJyAmJiAhKGgub25ZdFBsYXlsaXN0RGF0YVVwZGF0ZWRfLmttMzQpKSB7CgogICAgICBjb25zdCBmID0gaC5vbll0UGxheWxpc3REYXRhVXBkYXRlZF87CiAgICAgIGNvbnN0IGcgPSB1bXAzLmdldChmKSB8fCBmdW5jdGlvbiAoKSB7CiAgICAgICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBmLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpLmNhdGNoKGNvbnNvbGUubG9nKTsKICAgICAgfQogICAgICB1bXAzLnNldChmLCBnKTsKICAgICAgZy5rbTM0ID0gMTsKICAgICAgaC5vbll0UGxheWxpc3REYXRhVXBkYXRlZF8gPSBnOwoKICAgIH0KCiAgICBGSVhfc3RhbXBEb21BcnJheV9zdGFibGVMaXN0ICYmIGZpeFN0YW1wRG9tQXJyYXlTdGFibGVMaXN0KGgpOwogICAgY29uc3QgRU5BQkxFX3dlYWtlblN0YW1wUmVmZXJlbmNlc1EgPSBFTkFCTEVfd2Vha2VuU3RhbXBSZWZlcmVuY2VzICYmIHR5cGVvZiBEb2N1bWVudFRpbWVsaW5lICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YgV2Vha1JlZiAhPT0gJ3VuZGVmaW5lZCc7CiAgICBFTkFCTEVfd2Vha2VuU3RhbXBSZWZlcmVuY2VzUSAmJiB3ZWFrZW5TdGFtcFJlZmVyZW5jZXMoaCk7CgoKICAgIC8qKgogICAgICoKICAgICAqIE5lZ2xlY3QgZm9sbG93aW5nCiAgICAgKgogICAgICogaC5yZW5kZXJlclN0YW1wZXJPYnNlcnZlcl8KICAgICAqIGgucmVuZGVyZXJTdGFtcGVyQXBwbHlDaGFuZ2VSZWNvcmRfCiAgICAgKiBoLmZsdXNoUmVuZGVyU3RhbXBlckNvbXBvbmVudEJpbmRpbmdzXwogICAgICogaC5mb3J3YXJkUmVuZGVyZXJTdGFtcGVyQ2hhbmdlc18KICAgICAqCiAgICAgKi8KCiAgICBpZiAodHlwZW9mIGgudHJ5UmVuZGVyQ2h1bmtfID09PSAnZnVuY3Rpb24nICYmICEoaC50cnlSZW5kZXJDaHVua18ua20zNCkpIHsKCiAgICAgIGNvbnN0IGYgPSBoLnRyeVJlbmRlckNodW5rXzsKICAgICAgY29uc3QgZyA9IHVtcDMuZ2V0KGYpIHx8IGZ1bmN0aW9uICgpIHsKICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGYuYXBwbHkodGhpcywgYXJndW1lbnRzKSkuY2F0Y2goY29uc29sZS5sb2cpOwogICAgICB9CiAgICAgIHVtcDMuc2V0KGYsIGcpOwogICAgICBnLmttMzQgPSAxOwogICAgICBoLnRyeVJlbmRlckNodW5rXyA9IGc7CgogICAgfQoKCiAgICBpZiAodHlwZW9mIGgucmVuZGVyQ2h1bmtfID09PSAnZnVuY3Rpb24nICYmICEoaC5yZW5kZXJDaHVua18ua20zNCkpIHsKCiAgICAgIGNvbnN0IGYgPSBoLnJlbmRlckNodW5rXzsKICAgICAgY29uc3QgZyA9IHVtcDMuZ2V0KGYpIHx8IGZ1bmN0aW9uICgpIHsKICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGYuYXBwbHkodGhpcywgYXJndW1lbnRzKSkuY2F0Y2goY29uc29sZS5sb2cpOwogICAgICB9CiAgICAgIHVtcDMuc2V0KGYsIGcpOwogICAgICBnLmttMzQgPSAxOwogICAgICBoLnJlbmRlckNodW5rXyA9IGc7CgogICAgfQoKICAgIGlmICh0eXBlb2YgaC5kZWVwTGF6eUxpc3RPYnNlcnZlcl8gPT09ICdmdW5jdGlvbicgJiYgIShoLmRlZXBMYXp5TGlzdE9ic2VydmVyXy5rbTM0KSkgewoKICAgICAgY29uc3QgZiA9IGguZGVlcExhenlMaXN0T2JzZXJ2ZXJfOwogICAgICBjb25zdCBnID0gdW1wMy5nZXQoZikgfHwgZnVuY3Rpb24gKCkgewogICAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gZi5hcHBseSh0aGlzLCBhcmd1bWVudHMpKS5jYXRjaChjb25zb2xlLmxvZyk7CiAgICAgIH0KICAgICAgdW1wMy5zZXQoZiwgZyk7CiAgICAgIGcua20zNCA9IDE7CiAgICAgIGguZGVlcExhenlMaXN0T2JzZXJ2ZXJfID0gZzsKCiAgICB9CgogICAgaWYgKHR5cGVvZiBoLm9uSXRlbXNVcGRhdGVkXyA9PT0gJ2Z1bmN0aW9uJyAmJiAhKGgub25JdGVtc1VwZGF0ZWRfLmttMzQpKSB7CgogICAgICBjb25zdCBmID0gaC5vbkl0ZW1zVXBkYXRlZF87CiAgICAgIGNvbnN0IGcgPSB1bXAzLmdldChmKSB8fCBmdW5jdGlvbiAoKSB7CiAgICAgICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBmLmFwcGx5KHRoaXMsIGFyZ3VtZW50cykpLmNhdGNoKGNvbnNvbGUubG9nKTsKICAgICAgfQogICAgICB1bXAzLnNldChmLCBnKTsKICAgICAgZy5rbTM0ID0gMTsKICAgICAgaC5vbkl0ZW1zVXBkYXRlZF8gPSBnOwoKICAgIH0KCiAgICBpZiAodHlwZW9mIGgucmVxdWVzdFJlbmRlckNodW5rXyA9PT0gJ2Z1bmN0aW9uJyAmJiAhKGgucmVxdWVzdFJlbmRlckNodW5rXy5rbTM0KSkgewoKICAgICAgY29uc3QgZiA9IGgucmVxdWVzdFJlbmRlckNodW5rXzsKICAgICAgY29uc3QgZyA9IHVtcDMuZ2V0KGYpIHx8IGZ1bmN0aW9uICgpIHsKICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IGYuYXBwbHkodGhpcywgYXJndW1lbnRzKSkuY2F0Y2goY29uc29sZS5sb2cpOwogICAgICB9CiAgICAgIHVtcDMuc2V0KGYsIGcpOwogICAgICBnLmttMzQgPSAxOwogICAgICBoLnJlcXVlc3RSZW5kZXJDaHVua18gPSBnOwoKICAgIH0KCiAgICAvKioKICAgICAqCiAgICAgKiBOZWdsZWN0IGZvbGxvd2luZwogICAgICoKICAgICAqIGguZGF0YUNoYW5nZWRfIFsgYnVnZ3kgZm9yIHBhZ2Ugc3d0aWNoaW5nIF0KICAgICAqCiAgICAgKiBoLnVwZGF0ZUNoYW5nZVJlY29yZF8gWyBzZWUgaHR0cHM6Ly9naXRodWIuY29tL2N5ZnVuZzEwMzEvdXNlcnNjcmlwdC1zdXBwb3J0cy9pc3N1ZXMvMjAgXQogICAgICoKICAgICAqIGguY2FuY2VsUGVuZGluZ1Rhc2tzXwogICAgICogaC5maWxsUmFuZ2VfCiAgICAgKiBoLmFkZFRleHROb2Rlc18KICAgICAqIGgudXBkYXRlVGV4dF8KICAgICAqIGguc3RhbXBUeXBlQ2hhbmdlZF8KICAgICAqCiAgICAgKi8KCgogIH0KCiAgY29uc3Qga2V5U3RDb25uZWN0ZWRDYWxsYmFjayA9IFN5bWJvbCgpOyAvLyBhdm9pZCBjb3B5aW5nIHRoZSB2YWx1ZQoKICAvLyBjb25zdCBrZXlTdERpc2Nvbm5lY3RlZENhbGxiYWNrID0gU3ltYm9sKCk7IC8vIGF2b2lkIGNvcHlpbmcgdGhlIHZhbHVlCiAgY29uc3QgY21mID0gbmV3IFdlYWtNYXAoKTsKICBjb25zdCBkbWYgPSBuZXcgV2Vha01hcCgpOwoKICBjb25zdCBndkdlbmVyYXRvciA9IChudikgPT4gewogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgY29uc3QgY250ID0gaW5zcCh0aGlzKTsKICAgICAgY29uc3QgaG9zdEVsZW1lbnQgPSBjbnQuaG9zdEVsZW1lbnQgfHwgMDsKICAgICAgY29uc3QgZG9sbGFyID0gaG9zdEVsZW1lbnQgPyAodGhpcy4kIHx8IGluZHIodGhpcykpIDogMDsKICAgICAgbGV0IHAgPSAoaG9zdEVsZW1lbnQgaW5zdGFuY2VvZiBIVE1MRWxlbWVudCkgJiYgKGRvbGxhciB8fCAhdGhpcy5pcyk7CiAgICAgIGlmIChwICYmICghZG9sbGFyICYmICF0aGlzLmlzKSkgewogICAgICAgIGNvbnN0IG5vZGVOYW1lID0gaG9zdEVsZW1lbnQubm9kZU5hbWU7CiAgICAgICAgaWYgKHR5cGVvZiBub2RlTmFtZSAhPT0gJ3N0cmluZycpIHsKICAgICAgICAgIC8vIGp1c3QgaW4gY2FzZQogICAgICAgIH0gZWxzZSBpZiAobm9kZU5hbWUuc3RhcnRzV2l0aCgiRE9NLSIpKSB7CiAgICAgICAgICAvLyBkb20taWYsIGRvbS1yZXBlYXQsIGV0YwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAvLyB5dCBlbGVtZW50IC0gbmV3IG1vZGVsLCB5dC14eHh4LCBhbml4eHh4eHgKICAgICAgICAgIHAgPSBmYWxzZTsKICAgICAgICB9CiAgICAgIH0KICAgICAgaWYgKHApIHsKICAgICAgICBpZiAodHlwZW9mIGNudC5tYXJrRGlydHkgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgIC8vIHRoZSB5dCBlbGVtZW50IG1pZ2h0IGNhbGwgbWFya0RpcnR5IChvY2Nhc2lvbmFsbHkpCiAgICAgICAgICBwID0gZmFsc2U7CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzID09PSAneXRkLWVuZ2FnZW1lbnQtcGFuZWwtc2VjdGlvbi1saXN0LXJlbmRlcmVyJykgewogICAgICAgICAgLy8gc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9jeWZ1bmcxMDMxL3VzZXJzY3JpcHQtc3VwcG9ydHMvaXNzdWVzLzIwCiAgICAgICAgICBwID0gZmFsc2U7CiAgICAgICAgfQogICAgICB9CiAgICAgIGlmIChwKSB7CgogICAgICAgIC8vIDw8IGRvbS1yZXBlYXQgJiBkb20taWYgPj4KCiAgICAgICAgLy8gc2VxdWVuY2Ugb24gdGhlIHNhbWUgaW5zdGFuY2UKICAgICAgICB0aGlzW3FtNTddID0gKHRoaXNbcW01N10gfHwgUHJvbWlzZS5yZXNvbHZlKCkpLnRoZW4oKCkgPT4gbnYuYXBwbHkodGhpcywgYXJndW1lbnRzKSkuY2F0Y2goY29uc29sZS5sb2cpOwogICAgICB9IGVsc2UgewogICAgICAgIG52LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KICAgIH07CiAgfQoKICAvLyBjb25zdCBhc3NpZ25lZEhvbGRlcldTID0gbmV3IFdlYWtTZXQoKTsKCiAgY29uc3Qgc2V0dXBXZWFrUmVmID0gKGgpID0+IHsKCgoKICAgIC8qCiAgICBpZih0eXBlb2YgaC5pcyA9PT0gJ3N0cmluZycpewoKICAgICAgY29uc3QgaG9sZGVyID0gaC5ob3N0RWxlbWVudCB8fCBoOwogICAgICBpZiAoaG9sZGVyIGluc3RhbmNlb2YgTm9kZSkgewogICAgICAgIGlmICghYXNzaWduZWRIb2xkZXJXUy5oYXMoaG9sZGVyKSkgewogICAgICAgICAgYXNzaWduZWRIb2xkZXJXUy5hZGQoaG9sZGVyKTsKICAgICAgICAgIGgua3o2MiA9IDA7CiAgICAgICAgfQogICAgICB9CgogICAgfQoKICAgICovCgogICAgLy8gaWYoaC5pcyA9PT0gJ3l0ZC1tZXRhZGF0YS1yb3ctY29udGFpbmVyLXJlbmRlcmVyJyl7CgogICAgLy8gICBpZighaC5tazIxNDUpIGgubWsyMTQ1ID0gY3J5cHRvLnJhbmRvbVVVSUQoKTsKCiAgICAvLyAgIGxldCB3dyA9ICcnOwogICAgLy8gICBjb25zdCBob2xkZXIgPSBoLmhvc3RFbGVtZW50IHx8IGg7CiAgICAvLyAgIGlmKGhvbGRlciAmJiBob2xkZXIuc2V0QXR0cmlidXRlKXsKICAgIC8vICAgICBob2xkZXIuc2V0QXR0cmlidXRlKCdzd3cnLChob2xkZXIuZ2V0QXR0cmlidXRlKCdzd3cnICkgfHwgJycgKSsiKiIgKQoKICAgIC8vICAgICB3dyA9IGhvbGRlci5nZXRBdHRyaWJ1dGUoJ3N3dycpCiAgICAvLyAgIH0KICAgIC8vICAgY29uc29sZS5sb2coMjkyOSwgIGBhLiR7J2hvc3RFbGVtZW50JyBpbiBofTtiLiR7J2hvc3RFbGVtZW50NzInIGluIGh9YCwgaC5tazIxNDUsICBoLmlzICx3dywgaCwgYGt6NjI9JHtoLmt6NjJ9YCAsICEhKHNldHVwV0QgJiYgc2V0dXBXRiAmJiBzZXR1cERhdGFIb3N0ICYmIChoLmlzIHx8IGguX19kYXRhSG9zdCkpICkKCiAgICAvLyB9CgogICAgaWYgKHNldHVwRGF0YUhvc3QgIT09IG51bGwgJiYgKCdob3N0RWxlbWVudCcgaW4gaCkgJiYgISgnaG9zdEVsZW1lbnQ3MicgaW4gaCkpIHsKCiAgICAgIGxldCBza2lwID0gZmFsc2U7CiAgICAgIC8vIGlmIChoLmlzICYmIHR5cGVvZiBoLmlzID09PSAnc3RyaW5nJyAmJiBoLmlzLmxlbmd0aCA+IDE1ICYmIGguaXMubGVuZ3RoIDwgMzApIHsKICAgICAgLy8gICBpZiAoaC5pcy5pbmNsdWRlcygneXQtJykgJiYgIWguJCAmJiBoLmlzLmxlbmd0aCAhPT0gMjAgJiYgaC5pcy5sZW5ndGggIT09IDIxICYmIGguaXMubGVuZ3RoICE9PSAyMikgewogICAgICAvLyAgICAgc2tpcCA9IHRydWU7CiAgICAgIC8vICAgICAvLyByZXR1cm47CiAgICAgIC8vICAgfQogICAgICAvLyB9CgogICAgICBoLmt6NjIgPSAoaC5rejYyIHx8IDApICsgMTsKCiAgICAgIC8vCgogICAgICBzZXR1cFdEKGgpOwogICAgICBjb25zdCBob3N0RWxlbWVudCA9IGguaG9zdEVsZW1lbnQ7CgogICAgICBmb3IgKGNvbnN0IHMgb2YgWydfX2RhdGFIb3N0JywgJ19fQ0Vfc2hhZG93Um9vdCcsICdfX3RlbXBsYXRlJywgJ19fdGVtcGxhdGl6ZU93bmVyJ10pIHsKICAgICAgICBzZXR1cFdGKGgsIHMpOwogICAgICAgIHNldHVwV0YoaG9zdEVsZW1lbnQsIHMpOwogICAgICB9CgogICAgICBzZXR1cERhdGFIb3N0KGguX19kYXRhSG9zdCwgc2tpcCk7CiAgICAgIHNldHVwRGF0YUhvc3QoaG9zdEVsZW1lbnQuX19kYXRhSG9zdCwgc2tpcCk7CgogICAgICBob3N0RWxlbWVudCAmJiBhRGVsYXkoKS50aGVuKCgpID0+IHsKICAgICAgICBzZXR1cFdGKGhvc3RFbGVtZW50LCAnX19DRV9zaGFkb3dSb290Jyk7CiAgICAgIH0pOwoKICAgICAgaWYgKCFoLm04MjIpIHNldHVwRGF0YUhvc3QoaCkKCiAgICB9CgogIH0KCgogIGxldCBuYXRpdmVIVE1MRWxlbWVudCA9IHdpbmRvdy5IVE1MRWxlbWVudDsKCiAgdHJ5IHsKCiAgICBjb25zdCBxID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGVtcGxhdGUnKTsKICAgIHEuaW5uZXJIVE1MID0gJzx5dHotbnVsbDM2MT48L3l0ei1udWxsMzYxPic7CiAgICBuYXRpdmVIVE1MRWxlbWVudCA9IHEuY29udGVudC5maXJzdENoaWxkLmNvbnN0cnVjdG9yCgogIH0gY2F0Y2ggKGUpIHsgfQoKICBpZiAoIW5hdGl2ZUhUTUxFbGVtZW50LnByb3RvdHlwZS5jb25uZWN0ZWRDYWxsYmFjaykgewogICAgbmF0aXZlSFRNTEVsZW1lbnQucHJvdG90eXBlLmNvbm5lY3RlZENhbGxiYWNrNzkgPSBuYXRpdmVIVE1MRWxlbWVudC5wcm90b3R5cGUuY29ubmVjdGVkQ2FsbGJhY2s7CiAgICBuYXRpdmVIVE1MRWxlbWVudC5wcm90b3R5cGUuY29ubmVjdGVkQ2FsbGJhY2sgPSBmdW5jdGlvbiAoKSB7CiAgICAgIGxldCByOwogICAgICBpZiAodGhpcy5jb25uZWN0ZWRDYWxsYmFjazc5KSByID0gdGhpcy5jb25uZWN0ZWRDYWxsYmFjazc5LmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CgogICAgICBpZiAoV0VBS19SRUZfQklORElORyAmJiAodGhpcyBpbnN0YW5jZW9mIE5vZGUpICYmICh0aGlzLmlzIHx8IHRoaXMuX19kYXRhSG9zdCkpIHsKCiAgICAgICAgc2V0dXBXZWFrUmVmKGluc3AodGhpcykpCiAgICAgICAgLy8gc2V0dXBXZWFrUmVmKHRoaXMuX19kYXRhSG9zdCkKICAgICAgfQogICAgICByZXR1cm4gcjsKICAgIH0KICB9CgogIFNDUklQVExFVF9OT0ZJWF9zZXRUaW1lb3V0ICYmIEZJWF9WSURFT19CTE9DS0lORyAmJiB0eXBlb2YgQWJvcnRTaWduYWwgIT09ICd1bmRlZmluZWQnICYmICgoKSA9PiB7CiAgICAvLyByZXNvbHZlKDEpIGlzIGFscmVhZHkgZG9uZSBieSBKUyBUYW1lciAoRklYX1ZJREVPX0JMT0NLSU5HKQogICAgLy8gYHNldFRpbWVvdXQocmVzb2x2ZSgxKSwgNTAwMClgIGlzIHJlbW92ZWQgaW4gMjAyNC4wNS4xMiBZVCBDb2RlCgogICAgY29uc3QgZGVsYXkgPSA1MDAwOwogICAgbGV0IHJlTmVlZGxlID0gbnVsbDsKICAgIGxldCB0ZXN0OwogICAgdHJ5IHsKICAgICAgdGVzdCA9IFJlZ0V4cC5wcm90b3R5cGUudGVzdDsKICAgICAgUmVnRXhwLnByb3RvdHlwZS50ZXN0ID0gZnVuY3Rpb24gKCkgeyByZU5lZWRsZSA9IHRoaXM7IHRocm93ICcnIH0KICAgICAgc2V0VGltZW91dChTeW1ib2woKSwgZGVsYXkpOwogICAgfSBjYXRjaCAoZSkgeyB9CiAgICBpZiAodGVzdCkgUmVnRXhwLnByb3RvdHlwZS50ZXN0ID0gdGVzdDsKICAgIGlmIChyZU5lZWRsZSkgewogICAgICByZU5lZWRsZS50ZXN0ID0gKCkgPT4gZmFsc2U7CiAgICAgIC8vIHJlTmVlZGxlLnRlc3Q4NDg9IHJlTmVlZGxlLnRlc3Q7CiAgICAgIC8vIHJlTmVlZGxlLnRlc3QgPSBmdW5jdGlvbigpewogICAgICAvLyAgIGNvbnN0IHIgPSB0aGlzLnRlc3Q4NDgoLi4uYXJndW1lbnRzKTsKICAgICAgLy8gICBjb25zb2xlLmxvZygndGVzdGVkJywgcikKICAgICAgLy8gICByZXR1cm4gcjsKICAgICAgLy8gfQogICAgICBjb25zb2xlLmxvZygnW3l0LWpzLWVuZ2luZS10YW1lcl0gRGlzYWJsZWQgU2NyaXB0bGV0IHNldFRpbWVvdXQnLCByZU5lZWRsZSk7CiAgICB9CgogIH0pKCk7CgogIEVOQUJMRV9kaXNjcmV0ZVRhc2tpbmcgJiYgT2JqZWN0LmRlZmluZVByb3BlcnR5KE9iamVjdC5wcm90b3R5cGUsICdjb25uZWN0ZWRDYWxsYmFjaycsIHsKICAgIGdldCgpIHsKICAgICAgY29uc3QgZiA9IHRoaXNba2V5U3RDb25uZWN0ZWRDYWxsYmFja107CiAgICAgIGlmICh0aGlzLmlzKSB7CiAgICAgICAgc2V0dXBEaXNjcmV0ZVRhc2tzKHRoaXMsIHRydWUpOwogICAgICAgIGlmIChmKSB0aGlzLmt5MzYgPSAxOwogICAgICB9CiAgICAgIGlmIChXRUFLX1JFRl9CSU5ESU5HICYmICh0aGlzLmlzIHx8IHRoaXMgaW5zdGFuY2VvZiBOb2RlKSkgewogICAgICAgIHNldHVwV2Vha1JlZih0aGlzKQogICAgICB9CiAgICAgIHJldHVybiBmOwogICAgfSwKICAgIHNldChudikgewogICAgICBsZXQgZ3Y7CiAgICAgIGlmICh0eXBlb2YgbnYgPT09ICdmdW5jdGlvbicpIHsKCiAgICAgICAgZ3YgPSBjbWYuZ2V0KG52KSB8fCBndkdlbmVyYXRvcihudik7CiAgICAgICAgaWYgKGd2ICE9PSBudikgewogICAgICAgICAgY21mLnNldChudiwgZ3YpOwogICAgICAgICAgY21mLnNldChndiwgZ3YpOwogICAgICAgICAgZG1mLnNldChndiwgbnYpOwogICAgICAgIH0KCiAgICAgIH0gZWxzZSB7CiAgICAgICAgZ3YgPSBudjsKICAgICAgfQogICAgICB0aGlzW2tleVN0Q29ubmVjdGVkQ2FsbGJhY2tdID0gZ3Y7IC8vIHByb3RvIG9yIG9iamVjdAogICAgICBpZiAodGhpcy5pcykgewogICAgICAgIHNldHVwRGlzY3JldGVUYXNrcyh0aGlzKTsKICAgICAgfQogICAgICBpZiAoV0VBS19SRUZfQklORElORyAmJiAodGhpcy5pcyB8fCB0aGlzIGluc3RhbmNlb2YgTm9kZSkpIHsKICAgICAgICBzZXR1cFdlYWtSZWYodGhpcykKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0sCiAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQoKICB9KTsKCiAgY29uc3QgcExvYWQgPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHsKICAgIGlmIChkb2N1bWVudC5yZWFkeVN0YXRlICE9PSAnbG9hZGluZycpIHsKICAgICAgcmVzb2x2ZSgpOwogICAgfSBlbHNlIHsKICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoIkRPTUNvbnRlbnRMb2FkZWQiLCByZXNvbHZlLCBmYWxzZSk7CiAgICB9CiAgfSk7CgogIGlmIChGSVhfZml4X3JlcXVlc3RJZGxlQ2FsbGJhY2tfdGltaW5nICYmICF3aW5kb3cucmVxdWVzdElkbGVDYWxsYmFjazQ3MSAmJiB0eXBlb2Ygd2luZG93LnJlcXVlc3RJZGxlQ2FsbGJhY2sgPT09ICdmdW5jdGlvbicpIHsKICAgIHdpbmRvdy5yZXF1ZXN0SWRsZUNhbGxiYWNrNDcxID0gd2luZG93LnJlcXVlc3RJZGxlQ2FsbGJhY2s7CiAgICB3aW5kb3cucmVxdWVzdElkbGVDYWxsYmFjayA9IGZ1bmN0aW9uIChmLCAuLi5hcmdzKSB7CiAgICAgIHJldHVybiAodGhpcyB8fCB3aW5kb3cpLnJlcXVlc3RJZGxlQ2FsbGJhY2s0NzEoYXN5bmMgZnVuY3Rpb24gKCkgewogICAgICAgIGF3YWl0IHBMb2FkLnRoZW4oKTsKICAgICAgICBmLmNhbGwodGhpcywgLi4uYXJndW1lbnRzKQogICAgICB9LCAuLi5hcmdzKTsKICAgIH0KICB9CgogIHBMb2FkLnRoZW4oKCkgPT4gewoKICAgIGxldCBub25jZSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ3N0eWxlW25vbmNlXScpOwogICAgbm9uY2UgPSBub25jZSA/IG5vbmNlLmdldEF0dHJpYnV0ZSgnbm9uY2UnKSA6IG51bGw7CiAgICBjb25zdCBzdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7CiAgICBpZiAodHlwZW9mIG5vbmNlID09PSAnc3RyaW5nJykgc3Quc2V0QXR0cmlidXRlKCdub25jZScsIG5vbmNlKTsKICAgIHN0LnRleHRDb250ZW50ID0gIm5vbmUtZWxlbWVudC1rNDd7b3JkZXI6MH0iOwogICAgc3QuYWRkRXZlbnRMaXN0ZW5lcignbG9hZCcsICgpID0+IHsKICAgICAgcGYzMS5yZXNvbHZlKCk7CiAgICAgIHA1OSA9IDE7CiAgICB9LCBmYWxzZSk7CiAgICAoZG9jdW1lbnQuYm9keSB8fCBkb2N1bWVudC5oZWFkIHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCkuYXBwZW5kQ2hpbGQoc3QpOwoKICB9KTsKCiAgY29uc3QgcHJlcGFyZUxvZ3MgPSBbXTsKCiAgY29uc3Qgc2tpcEFkc0RldGVjdGlvbiA9IG5ldyBTZXQoWycvcm9ib3RzLnR4dCcsICcvbGl2ZV9jaGF0JywgJy9saXZlX2NoYXRfcmVwbGF5J10pOwoKICBsZXQgd2luRXJyb3IwMCA9IHdpbmRvdy5vbmVycm9yOwoKICBsZXQgZml4X2Vycm9yX21hbnlfc3RhY2tfc3RhdGUgPSAhRklYX2Vycm9yX21hbnlfc3RhY2sgPyAwIDogc2tpcEFkc0RldGVjdGlvbi5oYXMobG9jYXRpb24ucGF0aG5hbWUpID8gMiA6IDE7CgogIGlmICghSlNPTiB8fCAhKCdwYXJzZScgaW4gSlNPTikpIGZpeF9lcnJvcl9tYW55X3N0YWNrX3N0YXRlID0gMDsKCiAgOyBGSVhfSWZyYW1lX05VTExfU1JDICYmIHR5cGVvZiBrYWdpID09PSAndW5kZWZpbmVkJyAmJiAoKCkgPT4gewoKICAgIGNvbnN0IGVtcHR5QmxvYlVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwobmV3IEJsb2IoW10sIHsgdHlwZTogJ3RleHQvaHRtbCcgfSkpOwogICAgY29uc3QgbGNPcHQgPSB7IHNlbnNpdGl2aXR5OiAnYmFzZScgfTsKICAgIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQyNCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQ7CiAgICBkb2N1bWVudC5jcmVhdGVFbGVtZW50ID0gZnVuY3Rpb24gKHQpIHsKICAgICAgaWYgKHR5cGVvZiB0ID09PSAnc3RyaW5nJyAmJiB0Lmxlbmd0aCA9PT0gNikgewogICAgICAgIGlmICh0LmxvY2FsZUNvbXBhcmUoJ2lmcmFtZScsIHVuZGVmaW5lZCwgbGNPcHQpID09PSAwKSB7CiAgICAgICAgICBjb25zdCBwID0gdGhpcy5jcmVhdGVFbGVtZW50MjQodCk7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zdCBzdGFjayA9IG5ldyBFcnJvcigpLnN0YWNrOwogICAgICAgICAgICBjb25zdCBpc1NlYXJjaGJveCA9IHN0YWNrLmluY2x1ZGVzKCdpbml0aWFsaXplU2VhcmNoYm94Jyk7IC8vIHNlZSBodHRwczovL2dyZWFzeWZvcmsub3JnL3NjcmlwdHMvNDczOTcyLXlvdXR1YmUtanMtZW5naW5lLXRhbWVyL2Rpc2N1c3Npb25zLzIxNzA4NAogICAgICAgICAgICBpZiAoIWlzU2VhcmNoYm94KSB7CiAgICAgICAgICAgICAgcC5zcmMgPSBlbXB0eUJsb2JVcmw7IC8vIGF2b2lkIGlmcmFtZSBpcyBhcHBlbmRlZCB0byBET00gd2l0aG91dCBhbnkgdXJsCiAgICAgICAgICAgIH0KICAgICAgICAgIH0gY2F0Y2ggKGUpIHsgfQogICAgICAgICAgcmV0dXJuIHA7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiB0aGlzLmNyZWF0ZUVsZW1lbnQyNC5hcHBseSh0aGlzLCBhcmd1bWVudHMpOwogICAgfTsKCiAgfSkoKTsKCiAgOyBmaXhfZXJyb3JfbWFueV9zdGFja19zdGF0ZSA9PT0gMSAmJiAoKCkgPT4gewoKCiAgICBsZXQgcDEgPSB3aW5FcnJvcjAwOwoKICAgIGxldCBzdGFja05lZWRsZURldGFpbHMgPSBudWxsOwoKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShPYmplY3QucHJvdG90eXBlLCAnbWF0Y2hBbGwnLCB7CiAgICAgIGdldCgpIHsKICAgICAgICBzdGFja05lZWRsZURldGFpbHMgPSB0aGlzOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9LAogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICBjb25maWd1cmFibGU6IHRydWUKICAgIH0pOwoKICAgIHRyeSB7CiAgICAgIEpTT04ucGFyc2UoInt9Iik7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGNvbnNvbGUud2FybihlKQogICAgICBmaXhfZXJyb3JfbWFueV9zdGFja19zdGF0ZSA9IDA7CiAgICB9CgogICAgZGVsZXRlIE9iamVjdC5wcm90b3R5cGVbJ21hdGNoQWxsJ107CgogICAgbGV0IHAyID0gd2luZG93Lm9uZXJyb3I7CgogICAgd2luZG93Lm9uZXJyb3IgPSBwMTsKCiAgICBpZiAoZml4X2Vycm9yX21hbnlfc3RhY2tfc3RhdGUgPT09IDApIHJldHVybjsKCiAgICBpZiAoc3RhY2tOZWVkbGVEZXRhaWxzKSB7CiAgICAgIEpTT04ucGFyc2Uuc3RhY2tOZWVkbGVEZXRhaWxzID0gc3RhY2tOZWVkbGVEZXRhaWxzOwogICAgICBzdGFja05lZWRsZURldGFpbHMubWF0Y2hBbGwgPSB0cnVlOwogICAgfQoKICAgIGlmIChwMSA9PT0gcDIpIHJldHVybiAoZml4X2Vycm9yX21hbnlfc3RhY2tfc3RhdGUgPSAwKTsKCiAgICAvLyBwMSE9PXAyCiAgICBmaXhfZXJyb3JfbWFueV9zdGFja19zdGF0ZSA9ICFzdGFja05lZWRsZURldGFpbHMgPyA0IDogMzsKCiAgfSkoKTsKCiAgOyBmaXhfZXJyb3JfbWFueV9zdGFja19zdGF0ZSA9PT0gMiAmJiAoKCkgPT4gewoKCiAgICBsZXQgcDEgPSB3aW5FcnJvcjAwOwoKICAgIGxldCBvYmplY3RQcnVuZSA9IG51bGw7CiAgICBsZXQgc3RhY2tOZWVkbGVEZXRhaWxzID0gbnVsbDsKCiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoRnVuY3Rpb24ucHJvdG90eXBlLCAnZmluZE93bmVyJywgewogICAgICBnZXQoKSB7CiAgICAgICAgb2JqZWN0UHJ1bmUgPSB0aGlzOwogICAgICAgIHJldHVybiB0aGlzLl9maW5kT3duZXI7CiAgICAgIH0sCiAgICAgIHNldChudikgewogICAgICAgIHRoaXMuX2ZpbmRPd25lciA9IG52OwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9LAogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICBjb25maWd1cmFibGU6IHRydWUKICAgIH0pOwoKICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShPYmplY3QucHJvdG90eXBlLCAnbWF0Y2hBbGwnLCB7CiAgICAgIGdldCgpIHsKICAgICAgICBzdGFja05lZWRsZURldGFpbHMgPSB0aGlzOwogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9LAogICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICBjb25maWd1cmFibGU6IHRydWUKICAgIH0pOwoKICAgIHRyeSB7CiAgICAgIEpTT04ucGFyc2UoInt9Iik7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGNvbnNvbGUud2FybihlKQogICAgICBmaXhfZXJyb3JfbWFueV9zdGFja19zdGF0ZSA9IDA7CiAgICB9CgogICAgZGVsZXRlIEZ1bmN0aW9uLnByb3RvdHlwZVsnZmluZE93bmVyJ107CiAgICBkZWxldGUgT2JqZWN0LnByb3RvdHlwZVsnbWF0Y2hBbGwnXTsKCiAgICBsZXQgcDIgPSB3aW5kb3cub25lcnJvcjsKCiAgICBpZiAocDEgIT09IHAyKSByZXR1cm4gKGZpeF9lcnJvcl9tYW55X3N0YWNrX3N0YXRlID0gNCk7IC8vIHAxICE9IHAyCgogICAgaWYgKGZpeF9lcnJvcl9tYW55X3N0YWNrX3N0YXRlID09IDApIHJldHVybjsKCiAgICAvLyB0aGUgZm9sbG93aW5nIHdpbGwgb25seSBleGVjdXRlIHdoZW4gQnJhdmUncyBzY3JpcHRsZXRzLmpzIGlzIGV4ZWN1dGVkLgoKICAgIHByZXBhcmVMb2dzLnB1c2goImZpeF9lcnJvcl9tYW55X3N0YWNrX3N0YXRlIE5CIikKCiAgICBpZiAoc3RhY2tOZWVkbGVEZXRhaWxzKSB7CiAgICAgIHN0YWNrTmVlZGxlRGV0YWlscy5wYXR0ZXJuID0gbnVsbDsKICAgICAgc3RhY2tOZWVkbGVEZXRhaWxzLnJlID0gbnVsbDsKICAgICAgc3RhY2tOZWVkbGVEZXRhaWxzLmV4cGVjdCA9IG51bGw7CiAgICAgIHN0YWNrTmVlZGxlRGV0YWlscy5tYXRjaEFsbCA9IHRydWU7CiAgICB9CgogICAgaWYgKG9iamVjdFBydW5lKSB7CiAgICAgIG9iamVjdFBydW5lLmZpbmRPd25lciA9IG9iamVjdFBydW5lLm11c3RQcm9jZXNzID0gb2JqZWN0UHJ1bmUubG9nSnNvbiA9ICgpID0+IHsgfQogICAgICBkZWxldGUgb2JqZWN0UHJ1bmUuX2ZpbmRPd25lcjsKICAgIH0KCiAgICBmaXhfZXJyb3JfbWFueV9zdGFja19zdGF0ZSA9IDM7CiAgICBKU09OLnBhcnNlLnN0YWNrTmVlZGxlRGV0YWlscyA9IHN0YWNrTmVlZGxlRGV0YWlsczsKICAgIEpTT04ucGFyc2Uub2JqZWN0UHJ1bmUgPSBvYmplY3RQcnVuZTsKCiAgfSkoKTsKCiAgOyBmaXhfZXJyb3JfbWFueV9zdGFja19zdGF0ZSA9PT0gMyAmJiAoKCkgPT4gewoKCiAgICBsZXQgcDEgPSB3aW5FcnJvcjAwOwoKICAgIHRyeSB7CiAgICAgIEpTT04ucGFyc2UoInt9Iik7CiAgICB9IGNhdGNoIChlKSB7CiAgICAgIGNvbnNvbGUud2FybihlKQogICAgICBmaXhfZXJyb3JfbWFueV9zdGFja19zdGF0ZSA9IDA7CiAgICB9CgogICAgbGV0IHAyID0gd2luZG93Lm9uZXJyb3I7CgogICAgaWYgKHAxID09PSBwMikgcmV0dXJuOwoKICAgIHdpbmRvdy5vbmVycm9yID0gcDE7CgogICAgaWYgKGZpeF9lcnJvcl9tYW55X3N0YWNrX3N0YXRlID09PSAwKSByZXR1cm47CgogICAgZml4X2Vycm9yX21hbnlfc3RhY2tfc3RhdGUgPSA0OyAvLyBwMSAhPSBwMgoKCiAgfSkoKTsKCiAgZml4X2Vycm9yX21hbnlfc3RhY2tfc3RhdGUgPT09IDQgJiYgKCgpID0+IHsKCiAgICAvLyB0aGUgZm9sbG93aW5nIHdpbGwgb25seSBleGVjdXRlIHdoZW4gQnJhdmUncyBzY3JpcHRsZXRzLmpzIGlzIGV4ZWN1dGVkLgoKICAgIHByZXBhcmVMb2dzLnB1c2goImZpeF9lcnJvcl9tYW55X3N0YWNrX3N0YXRlIEFCIikKCiAgICBKU09OLnBhcnNlUHJveHkgPSBKU09OLnBhcnNlOwoKICAgIEpTT04ucGFyc2UgPSAoKHBhcnNlKSA9PiB7CgogICAgICBwYXJzZSA9IHBhcnNlLmJpbmQoSlNPTik7IC8vIGdldCBhIG5ldyBpbnN0YW5jZSBvZiB0aGUgY3VycmVudCBKU09OLnBhcnNlCiAgICAgIHJldHVybiBmdW5jdGlvbiAodGV4dCwgcmV2aXZlcikgewogICAgICAgIGNvbnN0IG9uZXJyb3IgPSB3aW5kb3cub25lcnJvcjsKICAgICAgICB3aW5kb3cub25lcnJvciA9IG51bGw7CiAgICAgICAgbGV0IHI7CiAgICAgICAgdHJ5IHsKICAgICAgICAgIHIgPSBwYXJzZSguLi5hcmd1bWVudHMpOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgIHIgPSBlOwogICAgICAgIH0KICAgICAgICB3aW5kb3cub25lcnJvciA9IG9uZXJyb3I7CiAgICAgICAgaWYgKHIgaW5zdGFuY2VvZiBFcnJvcikgewogICAgICAgICAgdGhyb3cgcjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHI7CiAgICAgIH0KCiAgICB9KShKU09OLnBhcnNlKTsKCgogIH0pKCk7CgoKICAvLyA8PCBpZiBGSVhfeXRfcGxheWVyID4+CgogIC8vIGNyZWRpdCB0byBAbm9wZWxlc3MgKGh0dHBzOi8vZ3JlYXN5Zm9yay5vcmcvc2NyaXB0cy80NzE0ODkteW91dHViZS1wbGF5ZXItcGVyZi8pCiAgY29uc3QgUEVSRl80NzE0ODlfID0gdHJ1ZTsKICAvLyBQRVJGXzQ3MTQ4OV8gaXMgbm90IGV4YWN0bHkgdGhlIHNhbWUgdG8gWW91dHViZSBQbGF5ZXIgcGVyZiB2MC43CiAgLy8gVGhpcyBzY3JpcHQgdXNlcyBhIG11Y2ggZ2VudGxlIHdheSB0byB0YW1lciB0aGUgSlMgZW5naW5lIGluc3RlYWQuCgogIC8vIDw8IGVuZCA+PgoKICBjb25zdCBzdGVwcGluZ1NjYWxlTiA9IDIwMDsgLy8gdHJhbnNmb3JtOiBzY2FsZVgoay9OKTsgMDxrPE4KCgoKICBjb25zdCBuaWxGbiA9ICgpID0+IHsgfTsKCiAgbGV0IGlzTWFpbldpbmRvdyA9IGZhbHNlOwogIHRyeSB7CiAgICBpc01haW5XaW5kb3cgPSB3aW5kb3cuZG9jdW1lbnQgPT09IHdpbmRvdy50b3AuZG9jdW1lbnQKICB9IGNhdGNoIChlKSB7IH0KCiAgbGV0IE5PX1BSRUxPQURfR0VORVJBVEVfMjA0X0JZUEFTUyA9IE5PX1BSRUxPQURfR0VORVJBVEVfMjA0ID8gZmFsc2UgOiB0cnVlOwogIGxldCBoZWFkTGlua0NvbGxlY3Rpb24gPSBudWxsOwoKCiAgLy8gY29uc3QgYXNzZXJ0b3IgPSAoZikgPT4gZigpIHx8IGNvbnNvbGUuYXNzZXJ0KGZhbHNlLCBmICsgIiIpOwoKICBjb25zdCBmbkludGVncml0eSA9IChmLCBkKSA9PiB7CiAgICBpZiAoIWYgfHwgdHlwZW9mIGYgIT09ICdmdW5jdGlvbicpIHsKICAgICAgY29uc29sZS53YXJuKCdmIGlzIG5vdCBhIGZ1bmN0aW9uJywgZik7CiAgICAgIHJldHVybjsKICAgIH0KICAgIGxldCBwID0gZiArICIiLCBzID0gMCwgaiA9IC0xLCB3ID0gMDsKICAgIGZvciAobGV0IGkgPSAwLCBsID0gcC5sZW5ndGg7IGkgPCBsOyBpKyspIHsKICAgICAgY29uc3QgdCA9IHBbaV07CiAgICAgIGlmICgoKHQgPj0gJ2EnICYmIHQgPD0gJ3onKSB8fCAodCA+PSAnQScgJiYgdCA8PSAnWicpKSkgewogICAgICAgIGlmIChqIDwgaSAtIDEpIHcrKzsKICAgICAgICBqID0gaTsKICAgICAgfSBlbHNlIHsKICAgICAgICBzKys7CiAgICAgIH0KICAgIH0KICAgIGxldCBpdHogPSBgJHtmLmxlbmd0aH0uJHtzfS4ke3d9YDsKICAgIGlmICghZCkgewogICAgICByZXR1cm4gaXR6OwogICAgfSBlbHNlIHsKICAgICAgcmV0dXJuIGl0eiA9PT0gZDsKICAgIH0KICB9OwoKICBjb25zdCBnZXRacU91ID0gKF95dF9wbGF5ZXIpID0+IHsKCiAgICBjb25zdCB3ID0gJ1pxT3UnOwoKICAgIGxldCBhcnIgPSBbXTsKCiAgICBmb3IgKGNvbnN0IFtrLCB2XSBvZiBPYmplY3QuZW50cmllcyhfeXRfcGxheWVyKSkgewoKICAgICAgY29uc3QgcCA9IHR5cGVvZiB2ID09PSAnZnVuY3Rpb24nID8gdi5wcm90b3R5cGUgOiAwOwogICAgICBpZiAocAogICAgICAgICYmIHR5cGVvZiBwLnN0YXJ0ID09PSAnZnVuY3Rpb24nICYmIHAuc3RhcnQubGVuZ3RoID09PSAwIC8vIE91CiAgICAgICAgJiYgdHlwZW9mIHAuaXNBY3RpdmUgPT09ICdmdW5jdGlvbicgJiYgcC5pc0FjdGl2ZS5sZW5ndGggPT09IDAKICAgICAgICAmJiB0eXBlb2YgcC5zdG9wID09PSAnZnVuY3Rpb24nICYmIHAuc3RvcC5sZW5ndGggPT09IDAKICAgICAgICAmJiAhcC5pc0NvbXBsZXRlICYmICFwLmdldFN0YXR1cyAmJiAhcC5nZXRSZXNwb25zZUhlYWRlciAmJiAhcC5nZXRMYXN0RXJyb3IKICAgICAgICAmJiAhcC5zZW5kICYmICFwLmFib3J0CiAgICAgICAgJiYgIXAuc2FtcGxlICYmICFwLmluaXRpYWxpemUgJiYgIXAuZmFpbCAmJiAhcC5nZXROYW1lCiAgICAgICAgLy8gJiYgIXAuZGlzcG9zZSAmJiAhcC5pc0Rpc3Bvc2VkCgogICAgICApIHsKICAgICAgICBhcnIgPSBhZGRQcm90b1RvQXJyKF95dF9wbGF5ZXIsIGssIGFycikgfHwgYXJyOwoKCiAgICAgIH0KCiAgICB9CgogICAgaWYgKGFyci5sZW5ndGggPT09IDApIHsKCiAgICAgIGNvbnNvbGUud2FybihgS2V5IGRvZXMgbm90IGV4aXN0LiBbJHt3fV1gKTsKICAgIH0gZWxzZSB7CgogICAgICBjb25zb2xlLmxvZyhgWyR7d31dYCwgYXJyKTsKICAgICAgcmV0dXJuIGFyclswXTsKICAgIH0KCiAgfQoKICBjb25zdCBnZXRacVF1ID0gKF95dF9wbGF5ZXIpID0+IHsKCiAgICBjb25zdCB3ID0gJ1pxUXUnOwoKICAgIGxldCBhcnIgPSBbXTsKCgogICAgZm9yIChjb25zdCBbaywgdl0gb2YgT2JqZWN0LmVudHJpZXMoX3l0X3BsYXllcikpIHsKCiAgICAgIGNvbnN0IHAgPSB0eXBlb2YgdiA9PT0gJ2Z1bmN0aW9uJyA/IHYucHJvdG90eXBlIDogMDsKICAgICAgaWYgKHAKICAgICAgICAmJiB0eXBlb2YgcC5zdGFydCA9PT0gJ2Z1bmN0aW9uJyAmJiBwLnN0YXJ0Lmxlbmd0aCA9PT0gMSAvLyBRdQogICAgICAgICYmIHR5cGVvZiBwLmlzQWN0aXZlID09PSAnZnVuY3Rpb24nICYmIHAuaXNBY3RpdmUubGVuZ3RoID09PSAwCiAgICAgICAgJiYgdHlwZW9mIHAuc3RvcCA9PT0gJ2Z1bmN0aW9uJyAmJiBwLnN0b3AubGVuZ3RoID09PSAwCiAgICAgICAgJiYgIXAuaXNDb21wbGV0ZSAmJiAhcC5nZXRTdGF0dXMgJiYgIXAuZ2V0UmVzcG9uc2VIZWFkZXIgJiYgIXAuZ2V0TGFzdEVycm9yCiAgICAgICAgJiYgIXAuc2VuZCAmJiAhcC5hYm9ydAogICAgICAgICYmICFwLnNhbXBsZSAmJiAhcC5pbml0aWFsaXplICYmICFwLmZhaWwgJiYgIXAuZ2V0TmFtZQogICAgICAgIC8vICYmICFwLmRpc3Bvc2UgJiYgIXAuaXNEaXNwb3NlZAoKICAgICAgKSB7CiAgICAgICAgYXJyID0gYWRkUHJvdG9Ub0FycihfeXRfcGxheWVyLCBrLCBhcnIpIHx8IGFycjsKCgogICAgICB9CgogICAgfQoKICAgIGlmIChhcnIubGVuZ3RoID09PSAwKSB7CgogICAgICBjb25zb2xlLndhcm4oYEtleSBkb2VzIG5vdCBleGlzdC4gWyR7d31dYCk7CiAgICB9IGVsc2UgewoKICAgICAgY29uc29sZS5sb2coYFske3d9XWAsIGFycik7CiAgICAgIHJldHVybiBhcnJbMF07CiAgICB9CgogIH0KCgogIGNvbnN0IGdldFZHID0gKF95dF9wbGF5ZXIpID0+IHsKICAgIGNvbnN0IHcgPSAnVkcnOwoKICAgIGxldCBhcnIgPSBbXTsKCiAgICBmb3IgKGNvbnN0IFtrLCB2XSBvZiBPYmplY3QuZW50cmllcyhfeXRfcGxheWVyKSkgewoKICAgICAgY29uc3QgcCA9IHR5cGVvZiB2ID09PSAnZnVuY3Rpb24nID8gdi5wcm90b3R5cGUgOiAwOwogICAgICBpZiAocAogICAgICAgICYmIHR5cGVvZiBwLnNob3cgPT09ICdmdW5jdGlvbicgJiYgcC5zaG93Lmxlbmd0aCA9PT0gMQogICAgICAgICYmIHR5cGVvZiBwLmhpZGUgPT09ICdmdW5jdGlvbicgJiYgcC5oaWRlLmxlbmd0aCA9PT0gMAogICAgICAgICYmIHR5cGVvZiBwLnN0b3AgPT09ICdmdW5jdGlvbicgJiYgcC5zdG9wLmxlbmd0aCA9PT0gMCkgewoKICAgICAgICBhcnIgPSBhZGRQcm90b1RvQXJyKF95dF9wbGF5ZXIsIGssIGFycikgfHwgYXJyOwoKICAgICAgfQoKICAgIH0KCgogICAgaWYgKGFyci5sZW5ndGggPT09IDApIHsKCiAgICAgIGNvbnNvbGUud2FybihgS2V5IGRvZXMgbm90IGV4aXN0LiBbJHt3fV1gKTsKICAgIH0gZWxzZSB7CgogICAgICBjb25zb2xlLmxvZyhgWyR7d31dYCwgYXJyKTsKICAgICAgcmV0dXJuIGFyclswXTsKICAgIH0KCgoKICB9CgoKICBjb25zdCBnZXR6byA9IChfeXRfcGxheWVyKSA9PiB7CiAgICBjb25zdCB3ID0gJ3pvJzsKCiAgICBsZXQgYXJyID0gW107CgogICAgZm9yIChjb25zdCBbaywgdl0gb2YgT2JqZWN0LmVudHJpZXMoX3l0X3BsYXllcikpIHsKCiAgICAgIGlmICgKICAgICAgICB0eXBlb2YgdiA9PT0gJ2Z1bmN0aW9uJyAmJiB2Lmxlbmd0aCA9PT0gMyAmJiBrLmxlbmd0aCA8IDMKICAgICAgICAmJiAodiArICIiKS5pbmNsdWRlcygiYS5zdHlsZVtiXT1jIikKICAgICAgKSB7CgogICAgICAgIGFyci5wdXNoKGspOwoKICAgICAgfQoKICAgIH0KCgogICAgaWYgKGFyci5sZW5ndGggPT09IDApIHsKCiAgICAgIGNvbnNvbGUud2FybihgS2V5IGRvZXMgbm90IGV4aXN0LiBbJHt3fV1gKTsKICAgIH0gZWxzZSB7CgogICAgICBjb25zb2xlLmxvZyhgWyR7d31dYCwgYXJyKTsKICAgICAgcmV0dXJuIGFyclswXTsKICAgIH0KCiAgfQoKICBjb25zdCBhZGRQcm90b1RvQXJyID0gKHBhcmVudCwga2V5LCBhcnIpID0+IHsKCgogICAgbGV0IGlzQ2hpbGRQcm90byA9IGZhbHNlOwogICAgZm9yIChjb25zdCBzciBvZiBhcnIpIHsKICAgICAgaWYgKHBhcmVudFtrZXldLnByb3RvdHlwZSBpbnN0YW5jZW9mIHBhcmVudFtzcl0pIHsKICAgICAgICBpc0NoaWxkUHJvdG8gPSB0cnVlOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CgogICAgaWYgKGlzQ2hpbGRQcm90bykgcmV0dXJuOwoKICAgIGFyciA9IGFyci5maWx0ZXIoc3IgPT4gewogICAgICBpZiAocGFyZW50W3NyXS5wcm90b3R5cGUgaW5zdGFuY2VvZiBwYXJlbnRba2V5XSkgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgfQogICAgICByZXR1cm4gdHJ1ZTsKICAgIH0pOwoKICAgIGFyci5wdXNoKGtleSk7CgogICAgcmV0dXJuIGFycjsKCgogIH0KCiAgY29uc3QgZ2V0dUcgPSAoX3l0X3BsYXllcikgPT4gewoKICAgIGNvbnN0IHcgPSAndUcnOwoKICAgIGxldCBhcnIgPSBbXTsKCiAgICBmb3IgKGNvbnN0IFtrLCB2XSBvZiBPYmplY3QuZW50cmllcyhfeXRfcGxheWVyKSkgewoKCiAgICAgIGNvbnN0IHAgPSB0eXBlb2YgdiA9PT0gJ2Z1bmN0aW9uJyA/IHYucHJvdG90eXBlIDogMDsKCiAgICAgIGlmIChwCiAgICAgICAgJiYgdHlwZW9mIHAuY3JlYXRlRWxlbWVudCA9PT0gJ2Z1bmN0aW9uJyAmJiBwLmNyZWF0ZUVsZW1lbnQubGVuZ3RoID09PSAyCiAgICAgICAgJiYgdHlwZW9mIHAuZGV0YWNoID09PSAnZnVuY3Rpb24nICYmIHAuZGV0YWNoLmxlbmd0aCA9PT0gMAogICAgICAgICYmIHR5cGVvZiBwLnVwZGF0ZSA9PT0gJ2Z1bmN0aW9uJyAmJiBwLnVwZGF0ZS5sZW5ndGggPT09IDEKICAgICAgICAmJiB0eXBlb2YgcC51cGRhdGVWYWx1ZSA9PT0gJ2Z1bmN0aW9uJyAmJiBwLnVwZGF0ZVZhbHVlLmxlbmd0aCA9PT0gMgogICAgICApIHsKCiAgICAgICAgYXJyID0gYWRkUHJvdG9Ub0FycihfeXRfcGxheWVyLCBrLCBhcnIpIHx8IGFycjsKCiAgICAgIH0KCiAgICB9CgoKCgoKICAgIGlmIChhcnIubGVuZ3RoID09PSAwKSB7CgogICAgICBjb25zb2xlLndhcm4oYEtleSBkb2VzIG5vdCBleGlzdC4gWyR7d31dYCk7CiAgICB9IGVsc2UgewoKICAgICAgY29uc29sZS5sb2coYFske3d9XWAsIGFycik7CiAgICAgIHJldHVybiBhcnJbMF07CiAgICB9CgogIH0KCgogIGNvbnN0IGdldFFUID0gKF95dF9wbGF5ZXIpID0+IHsKICAgIGNvbnN0IHcgPSAnUVQnOwoKICAgIGxldCBhcnIgPSBbXTsKICAgIGxldCBicnIgPSBuZXcgTWFwKCk7CgogICAgZm9yIChjb25zdCBbaywgdl0gb2YgT2JqZWN0LmVudHJpZXMoX3l0X3BsYXllcikpIHsKCiAgICAgIGNvbnN0IHAgPSB0eXBlb2YgdiA9PT0gJ2Z1bmN0aW9uJyA/IHYucHJvdG90eXBlIDogMDsKICAgICAgaWYgKHApIHsKICAgICAgICBsZXQgcSA9IDA7CiAgICAgICAgaWYgKHR5cGVvZiBwLmhhbmRsZUdsb2JhbEtleVVwID09PSAnZnVuY3Rpb24nICYmIHAuaGFuZGxlR2xvYmFsS2V5VXAubGVuZ3RoID09PSA3KSBxICs9IDQwMDsKICAgICAgICBlbHNlIGlmICh0eXBlb2YgcC5oYW5kbGVHbG9iYWxLZXlVcCA9PT0gJ2Z1bmN0aW9uJyAmJiBwLmhhbmRsZUdsb2JhbEtleVVwLmxlbmd0aCA9PT0gOCkgcSArPSAzMDA7CiAgICAgICAgZWxzZSBpZiAodHlwZW9mIHAuaGFuZGxlR2xvYmFsS2V5VXAgPT09ICdmdW5jdGlvbicpIHEgKz0gMjAwOwoKICAgICAgICBpZiAodHlwZW9mIHAuaGFuZGxlR2xvYmFsS2V5VXAgPT09ICdmdW5jdGlvbicgJiYgcC5oYW5kbGVHbG9iYWxLZXlVcC5sZW5ndGggPT09IDApIHEgLT0gNjAwOyAvLyBhdm9pZCBTVgoKICAgICAgICBpZiAocSA8IDIwMCkgY29udGludWU7IC8vIHAuaGFuZGxlR2xvYmFsS2V5VXAgbXVzdCBiZSBhdmFpbGFibGUKCiAgICAgICAgaWYgKHR5cGVvZiBwLmhhbmRsZUdsb2JhbEtleURvd24gPT09ICdmdW5jdGlvbicgJiYgcC5oYW5kbGVHbG9iYWxLZXlEb3duLmxlbmd0aCA9PT0gOCkgcSArPSA4MDsKICAgICAgICBpZiAodHlwZW9mIHAuaGFuZGxlR2xvYmFsS2V5RG93biA9PT0gJ2Z1bmN0aW9uJyAmJiBwLmhhbmRsZUdsb2JhbEtleURvd24ubGVuZ3RoID09PSA3KSBxICs9IDMwOwogICAgICAgIGlmICh0eXBlb2YgcC5zdGVwID09PSAnZnVuY3Rpb24nICYmIHAuc3RlcC5sZW5ndGggPT09IDEpIHEgKz0gMTA7CiAgICAgICAgaWYgKHR5cGVvZiBwLnN0ZXAgPT09ICdmdW5jdGlvbicgJiYgcC5zdGVwLmxlbmd0aCAhPT0gMSkgcSArPSA1OwoKCiAgICAgICAgLy8gZGlmZmVyZW50aWF0ZSBRVCBhbmQgRFgKCiAgICAgICAgcSArPSAyODA7CiAgICAgICAgaWYgKHR5cGVvZiBwLmN1ZVZpZGVvQnlQbGF5ZXJWYXJzID09PSAnZnVuY3Rpb24nKSBxICs9IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLmxvYWRWaWRlb0J5UGxheWVyVmFycyA9PT0gJ2Z1bmN0aW9uJykgcSArPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC5wcmVsb2FkVmlkZW9CeVBsYXllclZhcnMgPT09ICdmdW5jdGlvbicpIHEgKz0gNDsKICAgICAgICBpZiAodHlwZW9mIHAuc2Vla0J5ID09PSAnZnVuY3Rpb24nKSBxICs9IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLnNlZWtUbyA9PT0gJ2Z1bmN0aW9uJykgcSArPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC5nZXRTdG9yeWJvYXJkRm9ybWF0ID09PSAnZnVuY3Rpb24nKSBxICs9IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLmdldER1cmF0aW9uID09PSAnZnVuY3Rpb24nKSBxICs9IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLmxvYWRNb2R1bGUgPT09ICdmdW5jdGlvbicpIHEgKz0gNDsKICAgICAgICBpZiAodHlwZW9mIHAudW5sb2FkTW9kdWxlID09PSAnZnVuY3Rpb24nKSBxICs9IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLmdldE9wdGlvbiA9PT0gJ2Z1bmN0aW9uJykgcSArPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC5nZXRPcHRpb25zID09PSAnZnVuY3Rpb24nKSBxICs9IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLnNldE9wdGlvbiA9PT0gJ2Z1bmN0aW9uJykgcSArPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC5hZGRDdWVSYW5nZSA9PT0gJ2Z1bmN0aW9uJykgcSArPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC5nZXREZWJ1Z1RleHQgPT09ICdmdW5jdGlvbicpIHEgKz0gNDsKICAgICAgICBpZiAodHlwZW9mIHAuZ2V0Q3VycmVudEJyb2FkY2FzdElkID09PSAnZnVuY3Rpb24nKSBxICs9IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLnNldFNpemVTdHlsZSA9PT0gJ2Z1bmN0aW9uJykgcSArPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC5zaG93Q29udHJvbHMgPT09ICdmdW5jdGlvbicpIHEgKz0gNDsKICAgICAgICBpZiAodHlwZW9mIHAuaGlkZUNvbnRyb2xzID09PSAnZnVuY3Rpb24nKSBxICs9IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLmdldFZpZGVvQ29udGVudFJlY3QgPT09ICdmdW5jdGlvbicpIHEgKz0gNDsKICAgICAgICBpZiAodHlwZW9mIHAudG9nZ2xlRnVsbHNjcmVlbiA9PT0gJ2Z1bmN0aW9uJykgcSArPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC5pc0Z1bGxzY3JlZW4gPT09ICdmdW5jdGlvbicpIHEgKz0gNDsKICAgICAgICBpZiAodHlwZW9mIHAuY2FuY2VsUGxheWJhY2sgPT09ICdmdW5jdGlvbicpIHEgKz0gNDsKICAgICAgICBpZiAodHlwZW9mIHAuZ2V0UHJvZ3Jlc3NTdGF0ZSA9PT0gJ2Z1bmN0aW9uJykgcSArPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC5pc0lubGluZSA9PT0gJ2Z1bmN0aW9uJykgcSArPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC5zZXRJbmxpbmUgPT09ICdmdW5jdGlvbicpIHEgKz0gNDsKICAgICAgICBpZiAodHlwZW9mIHAudG9nZ2xlU3VidGl0bGVzID09PSAnZnVuY3Rpb24nKSBxICs9IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLmdldFBsYXllclNpemUgPT09ICdmdW5jdGlvbicpIHEgKz0gNDsKICAgICAgICBpZiAodHlwZW9mIHAud2FrZVVwQ29udHJvbHMgPT09ICdmdW5jdGlvbicpIHEgKz0gNDsKICAgICAgICBpZiAodHlwZW9mIHAuc2V0Q2VudGVyQ3JvcCA9PT0gJ2Z1bmN0aW9uJykgcSArPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC5nZXRMb29wVmlkZW8gPT09ICdmdW5jdGlvbicpIHEgKz0gNDsKICAgICAgICBpZiAodHlwZW9mIHAuc2V0TG9vcFZpZGVvID09PSAnZnVuY3Rpb24nKSBxICs9IDQ7CgoKICAgICAgICBpZiAocSA+IDApIGFyciA9IGFkZFByb3RvVG9BcnIoX3l0X3BsYXllciwgaywgYXJyKSB8fCBhcnI7CgogICAgICAgIGlmIChxID4gMCkgYnJyLnNldChrLCBxKTsKCiAgICAgIH0KCiAgICB9CgogICAgaWYgKGFyci5sZW5ndGggPT09IDApIHsKCiAgICAgIGNvbnNvbGUud2FybihgS2V5IGRvZXMgbm90IGV4aXN0LiBbJHt3fV1gKTsKICAgIH0gZWxzZSB7CgogICAgICBhcnIgPSBhcnIubWFwKGtleSA9PiBba2V5LCAoYnJyLmdldChrZXkpIHx8IDApXSk7CgogICAgICBpZiAoYXJyLmxlbmd0aCA+IDEpIGFyci5zb3J0KChhLCBiKSA9PiBiWzFdIC0gYVsxXSk7CgogICAgICBpZiAoYXJyLmxlbmd0aCA+IDIpIGNvbnNvbGUubG9nKGBbJHt3fV1gLCBhcnIpOwogICAgICByZXR1cm4gYXJyWzBdWzBdOwogICAgfQoKCgogIH0KCgoKICBjb25zdCBnZXRTViA9IChfeXRfcGxheWVyKSA9PiB7CiAgICBjb25zdCB3ID0gJ1NWJzsKCiAgICBsZXQgYXJyID0gW107CiAgICBsZXQgYnJyID0gbmV3IE1hcCgpOwoKICAgIGZvciAoY29uc3QgW2ssIHZdIG9mIE9iamVjdC5lbnRyaWVzKF95dF9wbGF5ZXIpKSB7CgogICAgICBjb25zdCBwID0gdHlwZW9mIHYgPT09ICdmdW5jdGlvbicgPyB2LnByb3RvdHlwZSA6IDA7CiAgICAgIGlmIChwKSB7CiAgICAgICAgbGV0IHEgPSAwOwogICAgICAgIGlmICh0eXBlb2YgcC5oYW5kbGVHbG9iYWxLZXlVcCA9PT0gJ2Z1bmN0aW9uJyAmJiBwLmhhbmRsZUdsb2JhbEtleVVwLmxlbmd0aCA9PT0gNykgcSArPSA0MDA7CiAgICAgICAgZWxzZSBpZiAodHlwZW9mIHAuaGFuZGxlR2xvYmFsS2V5VXAgPT09ICdmdW5jdGlvbicgJiYgcC5oYW5kbGVHbG9iYWxLZXlVcC5sZW5ndGggPT09IDgpIHEgKz0gMzAwOwogICAgICAgIGVsc2UgaWYgKHR5cGVvZiBwLmhhbmRsZUdsb2JhbEtleVVwID09PSAnZnVuY3Rpb24nKSBxICs9IDIwMDsKCiAgICAgICAgaWYgKHR5cGVvZiBwLmhhbmRsZUdsb2JhbEtleVVwID09PSAnZnVuY3Rpb24nICYmIHAuaGFuZGxlR2xvYmFsS2V5VXAubGVuZ3RoID09PSAwKSBxICs9IDYwMDsgLy8gU1YKCiAgICAgICAgaWYgKHEgPCAyMDApIGNvbnRpbnVlOyAvLyBwLmhhbmRsZUdsb2JhbEtleVVwIG11c3QgYmUgYXZhaWxhYmxlCgogICAgICAgIGlmICh0eXBlb2YgcC5oYW5kbGVHbG9iYWxLZXlEb3duID09PSAnZnVuY3Rpb24nICYmIHAuaGFuZGxlR2xvYmFsS2V5RG93bi5sZW5ndGggPT09IDgpIHEgKz0gODA7CiAgICAgICAgaWYgKHR5cGVvZiBwLmhhbmRsZUdsb2JhbEtleURvd24gPT09ICdmdW5jdGlvbicgJiYgcC5oYW5kbGVHbG9iYWxLZXlEb3duLmxlbmd0aCA9PT0gNykgcSArPSAzMDsKICAgICAgICBpZiAodHlwZW9mIHAuc3RlcCA9PT0gJ2Z1bmN0aW9uJyAmJiBwLnN0ZXAubGVuZ3RoID09PSAxKSBxICs9IDEwOwogICAgICAgIGlmICh0eXBlb2YgcC5zdGVwID09PSAnZnVuY3Rpb24nICYmIHAuc3RlcC5sZW5ndGggIT09IDEpIHEgKz0gNTsKCgogICAgICAgIC8vIGRpZmZlcmVudGlhdGUgUVQgYW5kIERYCgoKICAgICAgICBxICs9IDI4MDsKCiAgICAgICAgaWYgKHR5cGVvZiBwLmN1ZVZpZGVvQnlQbGF5ZXJWYXJzID09PSAnZnVuY3Rpb24nKSBxIC09IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLmxvYWRWaWRlb0J5UGxheWVyVmFycyA9PT0gJ2Z1bmN0aW9uJykgcSAtPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC5wcmVsb2FkVmlkZW9CeVBsYXllclZhcnMgPT09ICdmdW5jdGlvbicpIHEgLT0gNDsKICAgICAgICBpZiAodHlwZW9mIHAuc2Vla0J5ID09PSAnZnVuY3Rpb24nKSBxIC09IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLnNlZWtUbyA9PT0gJ2Z1bmN0aW9uJykgcSAtPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC5nZXRTdG9yeWJvYXJkRm9ybWF0ID09PSAnZnVuY3Rpb24nKSBxIC09IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLmdldER1cmF0aW9uID09PSAnZnVuY3Rpb24nKSBxIC09IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLmxvYWRNb2R1bGUgPT09ICdmdW5jdGlvbicpIHEgLT0gNDsKICAgICAgICBpZiAodHlwZW9mIHAudW5sb2FkTW9kdWxlID09PSAnZnVuY3Rpb24nKSBxIC09IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLmdldE9wdGlvbiA9PT0gJ2Z1bmN0aW9uJykgcSAtPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC5nZXRPcHRpb25zID09PSAnZnVuY3Rpb24nKSBxIC09IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLnNldE9wdGlvbiA9PT0gJ2Z1bmN0aW9uJykgcSAtPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC5hZGRDdWVSYW5nZSA9PT0gJ2Z1bmN0aW9uJykgcSAtPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC5nZXREZWJ1Z1RleHQgPT09ICdmdW5jdGlvbicpIHEgLT0gNDsKICAgICAgICBpZiAodHlwZW9mIHAuZ2V0Q3VycmVudEJyb2FkY2FzdElkID09PSAnZnVuY3Rpb24nKSBxIC09IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLnNldFNpemVTdHlsZSA9PT0gJ2Z1bmN0aW9uJykgcSAtPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC5zaG93Q29udHJvbHMgPT09ICdmdW5jdGlvbicpIHEgLT0gNDsKICAgICAgICBpZiAodHlwZW9mIHAuaGlkZUNvbnRyb2xzID09PSAnZnVuY3Rpb24nKSBxIC09IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLmdldFZpZGVvQ29udGVudFJlY3QgPT09ICdmdW5jdGlvbicpIHEgLT0gNDsKICAgICAgICBpZiAodHlwZW9mIHAudG9nZ2xlRnVsbHNjcmVlbiA9PT0gJ2Z1bmN0aW9uJykgcSAtPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC5pc0Z1bGxzY3JlZW4gPT09ICdmdW5jdGlvbicpIHEgLT0gNDsKICAgICAgICBpZiAodHlwZW9mIHAuY2FuY2VsUGxheWJhY2sgPT09ICdmdW5jdGlvbicpIHEgLT0gNDsKICAgICAgICBpZiAodHlwZW9mIHAuZ2V0UHJvZ3Jlc3NTdGF0ZSA9PT0gJ2Z1bmN0aW9uJykgcSAtPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC5pc0lubGluZSA9PT0gJ2Z1bmN0aW9uJykgcSAtPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC5zZXRJbmxpbmUgPT09ICdmdW5jdGlvbicpIHEgLT0gNDsKICAgICAgICBpZiAodHlwZW9mIHAudG9nZ2xlU3VidGl0bGVzID09PSAnZnVuY3Rpb24nKSBxIC09IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLmdldFBsYXllclNpemUgPT09ICdmdW5jdGlvbicpIHEgLT0gNDsKICAgICAgICBpZiAodHlwZW9mIHAud2FrZVVwQ29udHJvbHMgPT09ICdmdW5jdGlvbicpIHEgLT0gNDsKICAgICAgICBpZiAodHlwZW9mIHAuc2V0Q2VudGVyQ3JvcCA9PT0gJ2Z1bmN0aW9uJykgcSAtPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC5nZXRMb29wVmlkZW8gPT09ICdmdW5jdGlvbicpIHEgLT0gNDsKICAgICAgICBpZiAodHlwZW9mIHAuc2V0TG9vcFZpZGVvID09PSAnZnVuY3Rpb24nKSBxIC09IDQ7CgoKICAgICAgICBpZiAocSA+IDApIGFyciA9IGFkZFByb3RvVG9BcnIoX3l0X3BsYXllciwgaywgYXJyKSB8fCBhcnI7CgogICAgICAgIGlmIChxID4gMCkgYnJyLnNldChrLCBxKTsKCiAgICAgIH0KCiAgICB9CgogICAgaWYgKGFyci5sZW5ndGggPT09IDApIHsKCiAgICAgIGNvbnNvbGUud2FybihgS2V5IGRvZXMgbm90IGV4aXN0LiBbJHt3fV1gKTsKICAgIH0gZWxzZSB7CgogICAgICBhcnIgPSBhcnIubWFwKGtleSA9PiBba2V5LCAoYnJyLmdldChrZXkpIHx8IDApXSk7CgogICAgICBpZiAoYXJyLmxlbmd0aCA+IDEpIGFyci5zb3J0KChhLCBiKSA9PiBiWzFdIC0gYVsxXSk7CgogICAgICBpZiAoYXJyLmxlbmd0aCA+IDIpIGNvbnNvbGUubG9nKGBbJHt3fV1gLCBhcnIpOwogICAgICByZXR1cm4gYXJyWzBdWzBdOwogICAgfQoKCgogIH0KCgoKCiAgY29uc3QgZ2V0RFggPSAoX3l0X3BsYXllcikgPT4gewogICAgY29uc3QgdyA9ICdEWCc7CgogICAgbGV0IGFyciA9IFtdOwogICAgbGV0IGJyciA9IG5ldyBNYXAoKTsKCiAgICBmb3IgKGNvbnN0IFtrLCB2XSBvZiBPYmplY3QuZW50cmllcyhfeXRfcGxheWVyKSkgewoKICAgICAgY29uc3QgcCA9IHR5cGVvZiB2ID09PSAnZnVuY3Rpb24nID8gdi5wcm90b3R5cGUgOiAwOwogICAgICBpZiAocCkgewogICAgICAgIGxldCBxID0gMDsKICAgICAgICBpZiAodHlwZW9mIHAuaGFuZGxlR2xvYmFsS2V5VXAgPT09ICdmdW5jdGlvbicgJiYgcC5oYW5kbGVHbG9iYWxLZXlVcC5sZW5ndGggPT09IDcpIHEgKz0gNDAwOwogICAgICAgIGVsc2UgaWYgKHR5cGVvZiBwLmhhbmRsZUdsb2JhbEtleVVwID09PSAnZnVuY3Rpb24nICYmIHAuaGFuZGxlR2xvYmFsS2V5VXAubGVuZ3RoID09PSA4KSBxICs9IDMwMDsKICAgICAgICBlbHNlIGlmICh0eXBlb2YgcC5oYW5kbGVHbG9iYWxLZXlVcCA9PT0gJ2Z1bmN0aW9uJykgcSArPSAyMDA7CgogICAgICAgIGlmICh0eXBlb2YgcC5oYW5kbGVHbG9iYWxLZXlVcCA9PT0gJ2Z1bmN0aW9uJyAmJiBwLmhhbmRsZUdsb2JhbEtleVVwLmxlbmd0aCA9PT0gMCkgcSAtPSA2MDA7IC8vIGF2b2lkIFNWCgoKICAgICAgICBpZiAoISh0eXBlb2YgcC5pbml0ID09PSAnZnVuY3Rpb24nICYmIHAuaW5pdC5sZW5ndGggPT09IDApKSBxIC09IDMwMDsgLy8gaW5pdCBpcyByZXF1aXJlZAoKICAgICAgICBpZiAocSA8IDIwMCkgY29udGludWU7IC8vIHAuaGFuZGxlR2xvYmFsS2V5VXAgbXVzdCBiZSBhdmFpbGFibGUKCiAgICAgICAgaWYgKHR5cGVvZiBwLmhhbmRsZUdsb2JhbEtleURvd24gPT09ICdmdW5jdGlvbicgJiYgcC5oYW5kbGVHbG9iYWxLZXlEb3duLmxlbmd0aCA9PT0gOCkgcSArPSA4MDsKICAgICAgICBpZiAodHlwZW9mIHAuaGFuZGxlR2xvYmFsS2V5RG93biA9PT0gJ2Z1bmN0aW9uJyAmJiBwLmhhbmRsZUdsb2JhbEtleURvd24ubGVuZ3RoID09PSA3KSBxICs9IDMwOwogICAgICAgIGlmICh0eXBlb2YgcC5zdGVwID09PSAnZnVuY3Rpb24nICYmIHAuc3RlcC5sZW5ndGggPT09IDEpIHEgKz0gMTA7CiAgICAgICAgaWYgKHR5cGVvZiBwLnN0ZXAgPT09ICdmdW5jdGlvbicgJiYgcC5zdGVwLmxlbmd0aCAhPT0gMSkgcSArPSA1OwoKCiAgICAgICAgLy8gZGlmZmVyZW50aWF0ZSBRVCBhbmQgRFgKCgogICAgICAgIHEgKz0gMjgwOwoKICAgICAgICBpZiAodHlwZW9mIHAuY3VlVmlkZW9CeVBsYXllclZhcnMgPT09ICdmdW5jdGlvbicpIHEgLT0gNDsKICAgICAgICBpZiAodHlwZW9mIHAubG9hZFZpZGVvQnlQbGF5ZXJWYXJzID09PSAnZnVuY3Rpb24nKSBxIC09IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLnByZWxvYWRWaWRlb0J5UGxheWVyVmFycyA9PT0gJ2Z1bmN0aW9uJykgcSAtPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC5zZWVrQnkgPT09ICdmdW5jdGlvbicpIHEgLT0gNDsKICAgICAgICBpZiAodHlwZW9mIHAuc2Vla1RvID09PSAnZnVuY3Rpb24nKSBxIC09IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLmdldFN0b3J5Ym9hcmRGb3JtYXQgPT09ICdmdW5jdGlvbicpIHEgLT0gNDsKICAgICAgICBpZiAodHlwZW9mIHAuZ2V0RHVyYXRpb24gPT09ICdmdW5jdGlvbicpIHEgLT0gNDsKICAgICAgICBpZiAodHlwZW9mIHAubG9hZE1vZHVsZSA9PT0gJ2Z1bmN0aW9uJykgcSAtPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC51bmxvYWRNb2R1bGUgPT09ICdmdW5jdGlvbicpIHEgLT0gNDsKICAgICAgICBpZiAodHlwZW9mIHAuZ2V0T3B0aW9uID09PSAnZnVuY3Rpb24nKSBxIC09IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLmdldE9wdGlvbnMgPT09ICdmdW5jdGlvbicpIHEgLT0gNDsKICAgICAgICBpZiAodHlwZW9mIHAuc2V0T3B0aW9uID09PSAnZnVuY3Rpb24nKSBxIC09IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLmFkZEN1ZVJhbmdlID09PSAnZnVuY3Rpb24nKSBxIC09IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLmdldERlYnVnVGV4dCA9PT0gJ2Z1bmN0aW9uJykgcSAtPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC5nZXRDdXJyZW50QnJvYWRjYXN0SWQgPT09ICdmdW5jdGlvbicpIHEgLT0gNDsKICAgICAgICBpZiAodHlwZW9mIHAuc2V0U2l6ZVN0eWxlID09PSAnZnVuY3Rpb24nKSBxIC09IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLnNob3dDb250cm9scyA9PT0gJ2Z1bmN0aW9uJykgcSAtPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC5oaWRlQ29udHJvbHMgPT09ICdmdW5jdGlvbicpIHEgLT0gNDsKICAgICAgICBpZiAodHlwZW9mIHAuZ2V0VmlkZW9Db250ZW50UmVjdCA9PT0gJ2Z1bmN0aW9uJykgcSAtPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC50b2dnbGVGdWxsc2NyZWVuID09PSAnZnVuY3Rpb24nKSBxIC09IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLmlzRnVsbHNjcmVlbiA9PT0gJ2Z1bmN0aW9uJykgcSAtPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC5jYW5jZWxQbGF5YmFjayA9PT0gJ2Z1bmN0aW9uJykgcSAtPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC5nZXRQcm9ncmVzc1N0YXRlID09PSAnZnVuY3Rpb24nKSBxIC09IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLmlzSW5saW5lID09PSAnZnVuY3Rpb24nKSBxIC09IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLnNldElubGluZSA9PT0gJ2Z1bmN0aW9uJykgcSAtPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC50b2dnbGVTdWJ0aXRsZXMgPT09ICdmdW5jdGlvbicpIHEgLT0gNDsKICAgICAgICBpZiAodHlwZW9mIHAuZ2V0UGxheWVyU2l6ZSA9PT0gJ2Z1bmN0aW9uJykgcSAtPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC53YWtlVXBDb250cm9scyA9PT0gJ2Z1bmN0aW9uJykgcSAtPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC5zZXRDZW50ZXJDcm9wID09PSAnZnVuY3Rpb24nKSBxIC09IDQ7CiAgICAgICAgaWYgKHR5cGVvZiBwLmdldExvb3BWaWRlbyA9PT0gJ2Z1bmN0aW9uJykgcSAtPSA0OwogICAgICAgIGlmICh0eXBlb2YgcC5zZXRMb29wVmlkZW8gPT09ICdmdW5jdGlvbicpIHEgLT0gNDsKCgogICAgICAgIGlmIChxID4gMCkgYXJyID0gYWRkUHJvdG9Ub0FycihfeXRfcGxheWVyLCBrLCBhcnIpIHx8IGFycjsKCiAgICAgICAgaWYgKHEgPiAwKSBicnIuc2V0KGssIHEpOwoKICAgICAgfQoKICAgIH0KCiAgICBpZiAoYXJyLmxlbmd0aCA9PT0gMCkgewoKICAgICAgY29uc29sZS53YXJuKGBLZXkgZG9lcyBub3QgZXhpc3QuIFske3d9XWApOwogICAgfSBlbHNlIHsKCiAgICAgIGFyciA9IGFyci5tYXAoa2V5ID0+IFtrZXksIChicnIuZ2V0KGtleSkgfHwgMCldKTsKCiAgICAgIGlmIChhcnIubGVuZ3RoID4gMSkgYXJyLnNvcnQoKGEsIGIpID0+IGJbMV0gLSBhWzFdKTsKCiAgICAgIGlmIChhcnIubGVuZ3RoID4gMikgY29uc29sZS5sb2coYFske3d9XWAsIGFycik7CiAgICAgIHJldHVybiBhcnJbMF1bMF07CiAgICB9CgoKCiAgfQoKCgogIGNvbnN0IGlzUHJlcGFyZUNhY2hlZFYgPSAoRklYX2F2b2lkX2luY29ycmVjdF92aWRlb19tZXRhID8gdHJ1ZSA6IGZhbHNlKSAmJiAod2luZG93ID09PSB0b3ApOwoKICBsZXQgcGFnZVNldHVwVmlkZW9JZCA9IG51bGw7IC8vIHNldCBhdCBmaW5pc2g7ICcnIGZvciBpbmRldGVybWluYXRlIHN0YXRlCiAgbGV0IHBhZ2VTZXR1cFN0YXRlID0gMDsKCiAgaXNQcmVwYXJlQ2FjaGVkViAmJiAoKCkgPT4gewoKICAgIHBhZ2VTZXR1cFZpZGVvSWQgPSAnJzsKICAgIGNvbnN0IGNsZWFyQ2FjaGVkViA9ICgpID0+IHsKICAgICAgcGFnZVNldHVwVmlkZW9JZCA9ICcnOwogICAgICBwYWdlU2V0dXBTdGF0ZSA9IDA7CiAgICB9CiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd5dC1uYXZpZ2F0ZS1zdGFydCcsIGNsZWFyQ2FjaGVkViwgZmFsc2UpOyAvLyB1c2VyIGFjdGlvbgogICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigneXQtbmF2aWdhdGUtY2FjaGUnLCBjbGVhckNhY2hlZFYsIGZhbHNlKTsgLy8gcG9wIHN0YXRlCiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd5dC1wYWdlLWRhdGEtZmV0Y2hlZCcsIGNsZWFyQ2FjaGVkViwgZmFsc2UpOyAvLyBzdGlsbCBjb25zaWRlciBpbnZhbGlkIHVudGlsIHVybCBpcyByZWFkeSBpbiB5dC1uYXZpZ2F0ZS1maW5pc2gKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3l0LW5hdmlnYXRlLWZpbmlzaCcsICgpID0+IHsKICAgICAgcGFnZVNldHVwU3RhdGUgPSAxOwogICAgICB0cnkgewogICAgICAgIGNvbnN0IHVybCA9IG5ldyBVUkwobG9jYXRpb24uaHJlZik7CiAgICAgICAgaWYgKCF1cmwgfHwgIWlzV2F0Y2hQYWdlVVJMKHVybCkpIHsKICAgICAgICAgIHBhZ2VTZXR1cFZpZGVvSWQgPSAnJzsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcGFnZVNldHVwVmlkZW9JZCA9IHVybC5zZWFyY2hQYXJhbXMuZ2V0KCd2JykgfHwgJyc7CiAgICAgICAgfQogICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgcGFnZVNldHVwVmlkZW9JZCA9ICcnOwogICAgICB9CiAgICB9LCBmYWxzZSk7CgogIH0pKCk7CgogIGxldCB2aWRlb1BsYXlpbmdZID0gbnVsbDsKCiAgaXNQcmVwYXJlQ2FjaGVkViAmJiAoKCkgPT4gewoKICAgIGxldCBnZXROZXh0ID0gdHJ1ZTsKICAgIGxldCB2aWRlb1BsYXlpbmdYID0gewogICAgICBnZXQgdmlkZW9JZCgpIHsKICAgICAgICBpZiAoZ2V0TmV4dCkgewogICAgICAgICAgZ2V0TmV4dCA9IGZhbHNlOwoKICAgICAgICAgIGxldCBlbGVtZW50cyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ3l0ZC13YXRjaC1mbGV4eVt2aWRlby1pZF0nKTsKICAgICAgICAgIGNvbnN0IGFyciA9IFtdOwogICAgICAgICAgZm9yIChjb25zdCBlbGVtZW50IG9mIGVsZW1lbnRzKSB7CiAgICAgICAgICAgIGlmICghZWxlbWVudC5jbG9zZXN0KCdbaGlkZGVuXScpKSBhcnIucHVzaChlbGVtZW50KTsKICAgICAgICAgIH0KICAgICAgICAgIGlmIChhcnIubGVuZ3RoICE9PSAxKSB0aGlzLl9fdmlkZW9JZF9fID0gJyc7CiAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fX3ZpZGVvSWRfXyA9IGFyclswXS5nZXRBdHRyaWJ1dGUoJ3ZpZGVvLWlkJyk7CiAgICAgICAgICB9CgogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5fX3ZpZGVvSWRfXyB8fCAnJzsKICAgICAgfQogICAgfQoKICAgIHZpZGVvUGxheWluZ1kgPSB2aWRlb1BsYXlpbmdYOwogICAgY29uc3QgaGFuZGxlciA9IChldnQpID0+IHsKICAgICAgY29uc3QgdGFyZ2V0ID0gKGV2dCB8fCAwKS50YXJnZXQ7CiAgICAgIGlmICh0YXJnZXQgaW5zdGFuY2VvZiBIVE1MVmlkZW9FbGVtZW50KSB7CiAgICAgICAgZ2V0TmV4dCA9IHRydWU7CiAgICAgIH0KICAgIH0KICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2xvYWRlZG1ldGFkYXRhJywgaGFuZGxlciwgdHJ1ZSk7CiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdkdXJhdGlvbmNoYW5nZScsIGhhbmRsZXIsIHRydWUpOwoKICB9KSgpOwoKCgogIGNvbnN0IGNsZWFuQ29udGV4dCA9IGFzeW5jICh3aW4pID0+IHsKICAgIGNvbnN0IHdhaXRGbiA9IHJlcXVlc3RBbmltYXRpb25GcmFtZTsgLy8gc2hhbGwgaGF2ZSBiZWVuIGJpbmRlZCB0byB3aW5kb3cKICAgIHRyeSB7CiAgICAgIGxldCBteCA9IDE2OyAvLyBNQVggVFJJQUwKICAgICAgY29uc3QgZnJhbWVJZCA9ICd2YW5pbGxhanMtaWZyYW1lLXYxJzsKICAgICAgLyoqIEB0eXBlIHtIVE1MSUZyYW1lRWxlbWVudCB8IG51bGx9ICovCiAgICAgIGxldCBmcmFtZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKGZyYW1lSWQpOwogICAgICBsZXQgcmVtb3ZlSWZyYW1lRm4gPSBudWxsOwogICAgICBpZiAoIWZyYW1lKSB7CiAgICAgICAgZnJhbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpZnJhbWUnKTsKICAgICAgICBmcmFtZS5pZCA9IGZyYW1lSWQ7CiAgICAgICAgY29uc3QgYmxvYlVSTCA9IHR5cGVvZiB3ZWJraXRDYW5jZWxBbmltYXRpb25GcmFtZSA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2Yga2FnaSA9PT0gJ3VuZGVmaW5lZCcgPyAoZnJhbWUuc3JjID0gVVJMLmNyZWF0ZU9iamVjdFVSTChuZXcgQmxvYihbXSwgeyB0eXBlOiAndGV4dC9odG1sJyB9KSkpIDogbnVsbDsgLy8gYXZvaWQgQnJhdmUgQ3Jhc2gKICAgICAgICBmcmFtZS5zYW5kYm94ID0gJ2FsbG93LXNhbWUtb3JpZ2luJzsgLy8gc2NyaXB0IGNhbm5vdCBiZSBydW4gaW5zaWRlIGlmcmFtZSBidXQgQVBJIGNhbiBiZSBvYnRhaW5lZCBmcm9tIGlmcmFtZQogICAgICAgIGxldCBuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnbm9zY3JpcHQnKTsgLy8gd3JhcCBpbnRvIE5PU0NSUElUIHRvIGF2b2lkIHJlZmxvdyAobGF5b3V0aW5nKQogICAgICAgIG4uYXBwZW5kQ2hpbGQoZnJhbWUpOwogICAgICAgIHdoaWxlICghZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50ICYmIG14LS0gPiAwKSBhd2FpdCBuZXcgUHJvbWlzZSh3YWl0Rm4pOyAvLyByZXF1ZXN0QW5pbWF0aW9uRnJhbWUgaGVyZSBjb3VsZCBnZXQgbW9kaWZpZWQgYnkgWW91VHViZSBlbmdpbmUKICAgICAgICBjb25zdCByb290ID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50OwogICAgICAgIHJvb3QuYXBwZW5kQ2hpbGQobik7IC8vIHRocm93IGVycm9yIGlmIHJvb3QgaXMgbnVsbCBkdWUgdG8gZXhjZWVkaW5nIE1BWCBUUklBTAogICAgICAgIGlmIChibG9iVVJMKSBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IFVSTC5yZXZva2VPYmplY3RVUkwoYmxvYlVSTCkpOwoKICAgICAgICByZW1vdmVJZnJhbWVGbiA9IChzZXRUaW1lb3V0KSA9PiB7CiAgICAgICAgICBjb25zdCByZW1vdmVJZnJhbWVPbkRvY3VtZW50UmVhZHkgPSAoZSkgPT4gewogICAgICAgICAgICBlICYmIHdpbi5yZW1vdmVFdmVudExpc3RlbmVyKCJET01Db250ZW50TG9hZGVkIiwgcmVtb3ZlSWZyYW1lT25Eb2N1bWVudFJlYWR5LCBmYWxzZSk7CiAgICAgICAgICAgIGUgPSBuOwogICAgICAgICAgICBuID0gd2luID0gcmVtb3ZlSWZyYW1lRm4gPSAwOwogICAgICAgICAgICBzZXRUaW1lb3V0ID8gc2V0VGltZW91dCgoKSA9PiBlLnJlbW92ZSgpLCAyMDApIDogZS5yZW1vdmUoKTsKICAgICAgICAgIH0KICAgICAgICAgIGlmICghc2V0VGltZW91dCB8fCBkb2N1bWVudC5yZWFkeVN0YXRlICE9PSAnbG9hZGluZycpIHsKICAgICAgICAgICAgcmVtb3ZlSWZyYW1lT25Eb2N1bWVudFJlYWR5KCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB3aW4uYWRkRXZlbnRMaXN0ZW5lcigiRE9NQ29udGVudExvYWRlZCIsIHJlbW92ZUlmcmFtZU9uRG9jdW1lbnRSZWFkeSwgZmFsc2UpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICB3aGlsZSAoIWZyYW1lLmNvbnRlbnRXaW5kb3cgJiYgbXgtLSA+IDApIGF3YWl0IG5ldyBQcm9taXNlKHdhaXRGbik7CiAgICAgIGNvbnN0IGZjID0gZnJhbWUuY29udGVudFdpbmRvdzsKICAgICAgaWYgKCFmYykgdGhyb3cgIndpbmRvdyBpcyBub3QgZm91bmQuIjsgLy8gdGhyb3cgZXJyb3IgaWYgcm9vdCBpcyBudWxsIGR1ZSB0byBleGNlZWRpbmcgTUFYIFRSSUFMCiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgeyByZXF1ZXN0QW5pbWF0aW9uRnJhbWUsIHNldFRpbWVvdXQsIGNsZWFyVGltZW91dCwgY2FuY2VsQW5pbWF0aW9uRnJhbWUsIHNldEludGVydmFsLCBjbGVhckludGVydmFsLCByZXF1ZXN0SWRsZUNhbGxiYWNrLCBnZXRDb21wdXRlZFN0eWxlIH0gPSBmYzsKICAgICAgICBjb25zdCByZXMgPSB7IHJlcXVlc3RBbmltYXRpb25GcmFtZSwgc2V0VGltZW91dCwgY2xlYXJUaW1lb3V0LCBjYW5jZWxBbmltYXRpb25GcmFtZSwgc2V0SW50ZXJ2YWwsIGNsZWFySW50ZXJ2YWwsIHJlcXVlc3RJZGxlQ2FsbGJhY2ssIGdldENvbXB1dGVkU3R5bGUgfTsKICAgICAgICBmb3IgKGxldCBrIGluIHJlcykgcmVzW2tdID0gcmVzW2tdLmJpbmQod2luKTsgLy8gbmVjZXNzYXJ5CiAgICAgICAgaWYgKHJlbW92ZUlmcmFtZUZuKSBQcm9taXNlLnJlc29sdmUocmVzLnNldFRpbWVvdXQpLnRoZW4ocmVtb3ZlSWZyYW1lRm4pOwogICAgICAgIHJlcy5hbmltYXRlID0gZmMuSFRNTEVsZW1lbnQucHJvdG90eXBlLmFuaW1hdGU7CiAgICAgICAgcmVzLnBlcmZOb3cgPSBmYy5wZXJmb3JtYW5jZS5ub3c7CiAgICAgICAgcmV0dXJuIHJlczsKICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgIGlmIChyZW1vdmVJZnJhbWVGbikgcmVtb3ZlSWZyYW1lRm4oKTsKICAgICAgICByZXR1cm4gbnVsbDsKICAgICAgfQogICAgfSBjYXRjaCAoZSkgewogICAgICBjb25zb2xlLndhcm4oZSk7CiAgICAgIHJldHVybiBudWxsOwogICAgfQogIH07CgogIGNvbnN0IHByb21pc2VGb3JZdEFjdGlvbkNhbGxlZCA9IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gewogICAgaWYgKHR5cGVvZiBBYm9ydFNpZ25hbCAhPT0gJ3VuZGVmaW5lZCcpIHsKICAgICAgbGV0IGhuID0gKCkgPT4gewogICAgICAgIGlmICghaG4pIHJldHVybjsKICAgICAgICBobiA9IG51bGw7CiAgICAgICAgcmVzb2x2ZShkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCd5dGQtYXBwJykpOwogICAgICB9OwogICAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd5dC1hY3Rpb24nLCBobiwgeyBjYXB0dXJlOiB0cnVlLCBwYXNzaXZlOiB0cnVlLCBvbmNlOiB0cnVlIH0pOwogICAgfSBlbHNlIHsKICAgICAgbGV0IGhuID0gKCkgPT4gewogICAgICAgIGlmICghaG4pIHJldHVybjsKICAgICAgICBkb2N1bWVudC5yZW1vdmVFdmVudExpc3RlbmVyKCd5dC1hY3Rpb24nLCBobiwgdHJ1ZSk7CiAgICAgICAgaG4gPSBudWxsOwogICAgICAgIHJlc29sdmUoZG9jdW1lbnQucXVlcnlTZWxlY3RvcigneXRkLWFwcCcpKTsKICAgICAgfTsKICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigneXQtYWN0aW9uJywgaG4sIHRydWUpOwogICAgfQogIH0pOwoKCgogIGNsZWFuQ29udGV4dCh3aW5kb3cpLnRoZW4oX19DT05URVhUX18gPT4gewogICAgaWYgKCFfX0NPTlRFWFRfXykgcmV0dXJuIG51bGw7CgogICAgY29uc3QgeyByZXF1ZXN0QW5pbWF0aW9uRnJhbWUsIHNldFRpbWVvdXQsIGNsZWFyVGltZW91dCwgY2FuY2VsQW5pbWF0aW9uRnJhbWUsIHNldEludGVydmFsLCBjbGVhckludGVydmFsLCBhbmltYXRlLCByZXF1ZXN0SWRsZUNhbGxiYWNrLCBnZXRDb21wdXRlZFN0eWxlLCBwZXJmTm93IH0gPSBfX0NPTlRFWFRfXzsKCgogICAgcGVyZm9ybWFuY2Uubm93MTcgPSBwZXJmTm93LmJpbmQocGVyZm9ybWFuY2UpOwoKCgogICAgX19yZXF1ZXN0QW5pbWF0aW9uRnJhbWVfXyA9IHJlcXVlc3RBbmltYXRpb25GcmFtZTsKCgogICAgY29uc3QgaXNHUFVBY2NlbGVyYXRpb25BdmFpbGFibGUgPSAoKCkgPT4gewogICAgICAvLyBodHRwczovL2dpc3QuZ2l0aHViLmNvbS9jdmFuLzA0MmIyNDQ4ZmNlY2VmYWZiYjZhOTE0Njk0ODRjZGY4CiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgY2FudmFzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnY2FudmFzJyk7CiAgICAgICAgcmV0dXJuICEhKGNhbnZhcy5nZXRDb250ZXh0KCd3ZWJnbCcpIHx8IGNhbnZhcy5nZXRDb250ZXh0KCdleHBlcmltZW50YWwtd2ViZ2wnKSk7CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KICAgIH0pKCk7CgogICAgY29uc3QgZm9yZWdyb3VuZFByb21pc2VGbl9ub0dQVSA9ICgoKSA9PiB7CgogICAgICBpZiAoaXNHUFVBY2NlbGVyYXRpb25BdmFpbGFibGUpIHJldHVybiBudWxsOwoKICAgICAgY29uc3QgcGQgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKERvY3VtZW50LnByb3RvdHlwZSwgJ3Zpc2liaWxpdHlTdGF0ZScpOwogICAgICBpZiAoIXBkIHx8IHR5cGVvZiBwZC5nZXQgIT09ICdmdW5jdGlvbicpIHJldHVybiBudWxsOwogICAgICBjb25zdCBwZEdldCA9IHBkLmdldDsKCiAgICAgIGxldCBwciA9IG51bGw7CgogICAgICBsZXQgaFN0YXRlID0gcGRHZXQuY2FsbChkb2N1bWVudCkgPT09ICdoaWRkZW4nOwogICAgICAvLyBsZXQgY2lkID0gMDsKICAgICAgcHVyZUFkZEV2ZW50TGlzdGVuZXIuY2FsbChkb2N1bWVudCwgJ3Zpc2liaWxpdHljaGFuZ2UnLCAoZXZ0KSA9PiB7CiAgICAgICAgY29uc3QgbmV3SFN0YXRlID0gcGRHZXQuY2FsbChkb2N1bWVudCkgPT09ICdoaWRkZW4nOwogICAgICAgIGlmIChoU3RhdGUgIT09IG5ld0hTdGF0ZSkgewogICAgICAgICAgLy8gaWYgKGNpZCA+IDApIGNpZCA9IGNsZWFySW50ZXJ2YWwoY2lkKTsKICAgICAgICAgIGhTdGF0ZSA9IG5ld0hTdGF0ZTsKICAgICAgICAgIGlmICghaFN0YXRlICYmIHByKSBwciA9IHByLnJlc29sdmUoKTsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgLy8gY2lkID0gc2V0SW50ZXJ2YWwoKCkgPT4gewogICAgICAvLyAgIGNvbnN0IG5ld0hTdGF0ZSA9IGRvY3VtZW50LnZpc2liaWxpdHlTdGF0ZSA9PT0gJ2hpZGRlbic7CiAgICAgIC8vICAgaWYgKGhTdGF0ZSAhPT0gbmV3SFN0YXRlKSB7CiAgICAgIC8vICAgICBoU3RhdGUgPSBuZXdIU3RhdGU7CiAgICAgIC8vICAgICBpZiAoIWhTdGF0ZSAmJiBwcikgcHIgPSBwci5yZXNvbHZlKCk7CiAgICAgIC8vICAgfQogICAgICAvLyB9LCAxMDApOwoKCiAgICAgIHJldHVybiAoKCkgPT4gewogICAgICAgIGlmIChwcikgcmV0dXJuIHByOwogICAgICAgIGNvbnN0IHcgPSAoKCFoU3RhdGUgJiYgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICBpZiAoIWhTdGF0ZSAmJiBwciA9PT0gdykgcHIgPSBwci5yZXNvbHZlKCk7CiAgICAgICAgfSkpLCAocHIgPSBuZXcgUHJvbWlzZUV4dGVybmFsKCkpKTsKICAgICAgICByZXR1cm4gdzsKICAgICAgfSk7CgogICAgfSkoKTsKCgogICAgbGV0IHJhZlByb21pc2UgPSBudWxsOwogICAgY29uc3QgZ2V0UmFmUHJvbWlzZSA9ICgpID0+IHJhZlByb21pc2UgfHwgKHJhZlByb21pc2UgPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHsKICAgICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKGhSZXMgPT4gewogICAgICAgIHJhZlByb21pc2UgPSBudWxsOwogICAgICAgIHJlc29sdmUoaFJlcyk7CiAgICAgIH0pOwogICAgfSkpOwoKICAgIGNvbnN0IGZvcmVncm91bmRQcm9taXNlRm4gPSBmb3JlZ3JvdW5kUHJvbWlzZUZuX25vR1BVIHx8IGdldFJhZlByb21pc2U7CgoKICAgIGNvbnN0IHdtQ29tcHV0ZWRTdHlsZSA9IG5ldyBXZWFrTWFwKCk7CgogICAgaWYgKCF3aW5kb3cuX19uYXRpdmVfX2dldENvbXB1dGVkU3R5bGVfXyAmJiAhd2luZG93Ll9fanN0X19nZXRDb21wdXRlZFN0eWxlX18gJiYgdHlwZW9mIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlID09PSAnZnVuY3Rpb24nICYmIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlLmxlbmd0aCA9PT0gMSkgewogICAgICB3aW5kb3cuX19uYXRpdmVfX2dldENvbXB1dGVkU3R5bGVfXyA9IGdldENvbXB1dGVkU3R5bGU7CiAgICAgIGlmIChFTkFCTEVfQ09NUFVURURTVFlMRV9DQUNIRSkgewogICAgICAgIHdpbmRvdy5fX29yaWdpbmFsX19nZXRDb21wdXRlZFN0eWxlX18gPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZTsKICAgICAgICB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSA9IGZ1bmN0aW9uIChlbGVtKSB7CiAgICAgICAgICBpZiAoIShlbGVtIGluc3RhbmNlb2YgRWxlbWVudCkgfHwgKGFyZ3VtZW50cy5sZW5ndGggPT09IDIgJiYgYXJndW1lbnRzWzFdKSB8fCAoYXJndW1lbnRzLmxlbmd0aCA+IDIpKSB7CiAgICAgICAgICAgIHJldHVybiB3aW5kb3cuX19vcmlnaW5hbF9fZ2V0Q29tcHV0ZWRTdHlsZV9fKC4uLmFyZ3VtZW50cyk7CiAgICAgICAgICB9CiAgICAgICAgICBsZXQgY3MgPSB3bUNvbXB1dGVkU3R5bGUuZ2V0KGVsZW0pOwogICAgICAgICAgaWYgKCFjcykgewogICAgICAgICAgICBjcyA9IHdpbmRvdy5fX25hdGl2ZV9fZ2V0Q29tcHV0ZWRTdHlsZV9fKGVsZW0pOwogICAgICAgICAgICB3bUNvbXB1dGVkU3R5bGUuc2V0KGVsZW0sIGNzKTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBjczsKICAgICAgICB9OwogICAgICB9IGVsc2UgewogICAgICAgIHdpbmRvdy5fX29yaWdpbmFsX19nZXRDb21wdXRlZFN0eWxlX18gPSBudWxsOwogICAgICB9CiAgICAgIHdpbmRvdy5fX2pzdF9fZ2V0Q29tcHV0ZWRTdHlsZV9fID0gd2luZG93LmdldENvbXB1dGVkU3R5bGU7CiAgICB9CgogICAgTk9fU0NIRURVTElOR19EVUVfVE9fQ09NUFVURURTVFlMRSAmJiBwcm9taXNlRm9yWXRBY3Rpb25DYWxsZWQudGhlbigoKSA9PiB7CiAgICAgIGlmICh0eXBlb2Ygd2luZG93Ll9fanN0X19nZXRDb21wdXRlZFN0eWxlX18gPT09ICdmdW5jdGlvbicgJiYgd2luZG93Ll9fanN0X19nZXRDb21wdXRlZFN0eWxlX18ubGVuZ3RoID09PSAxICYmIHdpbmRvdy5fX2pzdF9fZ2V0Q29tcHV0ZWRTdHlsZV9fICE9PSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZSkgewogICAgICAgIHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlID0gd2luZG93Ll9fanN0X19nZXRDb21wdXRlZFN0eWxlX187CiAgICAgIH0KICAgIH0pOwoKICAgIGNvbnN0IGlzVXJsSW5FbWJlZCA9IGxvY2F0aW9uLmhyZWYuaW5jbHVkZXMoJy55b3V0dWJlLmNvbS9lbWJlZC8nKTsKICAgIGNvbnN0IGlzQWJvcnRTaWduYWxTdXBwb3J0ZWQgPSB0eXBlb2YgQWJvcnRTaWduYWwgIT09ICJ1bmRlZmluZWQiOwoKICAgIGNvbnN0IHByb21pc2VGb3JUYW1lclRpbWVvdXQgPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHsKICAgICAgIWlzVXJsSW5FbWJlZCAmJiBpc0Fib3J0U2lnbmFsU3VwcG9ydGVkICYmIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ3l0LWFjdGlvbicsIGZ1bmN0aW9uICgpIHsKICAgICAgICBzZXRUaW1lb3V0KHJlc29sdmUsIDQ4MCk7CiAgICAgIH0sIHsgY2FwdHVyZTogdHJ1ZSwgcGFzc2l2ZTogdHJ1ZSwgb25jZTogdHJ1ZSB9KTsKICAgICAgIWlzVXJsSW5FbWJlZCAmJiBpc0Fib3J0U2lnbmFsU3VwcG9ydGVkICYmIHR5cGVvZiBjdXN0b21FbGVtZW50cyA9PT0gIm9iamVjdCIgJiYgd2hlbkNFRGVmaW5lZCgneXRkLWFwcCcpLnRoZW4oKCkgPT4gewogICAgICAgIHNldFRpbWVvdXQocmVzb2x2ZSwgMTIwMCk7CiAgICAgIH0pOwogICAgICBzZXRUaW1lb3V0KHJlc29sdmUsIDMwMDApOwogICAgfSk7CgogICAgY29uc3QgcHJvbWlzZUZvclBhZ2VJbml0aWVkID0gbmV3IFByb21pc2UocmVzb2x2ZSA9PiB7CiAgICAgICFpc1VybEluRW1iZWQgJiYgaXNBYm9ydFNpZ25hbFN1cHBvcnRlZCAmJiBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCd5dC1hY3Rpb24nLCBmdW5jdGlvbiAoKSB7CiAgICAgICAgc2V0VGltZW91dChyZXNvbHZlLCA0NTApOwogICAgICB9LCB7IGNhcHR1cmU6IHRydWUsIHBhc3NpdmU6IHRydWUsIG9uY2U6IHRydWUgfSk7CiAgICAgICFpc1VybEluRW1iZWQgJiYgaXNBYm9ydFNpZ25hbFN1cHBvcnRlZCAmJiB0eXBlb2YgY3VzdG9tRWxlbWVudHMgPT09ICJvYmplY3QiICYmIHdoZW5DRURlZmluZWQoJ3l0ZC1hcHAnKS50aGVuKCgpID0+IHsKICAgICAgICBzZXRUaW1lb3V0KHJlc29sdmUsIDkwMCk7CiAgICAgIH0pOwogICAgICBzZXRUaW1lb3V0KHJlc29sdmUsIDE4MDApOwogICAgfSk7CgogICAgTk9fUFJFTE9BRF9HRU5FUkFURV8yMDRfQllQQVNTIHx8IHByb21pc2VGb3JQYWdlSW5pdGllZC50aGVuKCgpID0+IHsKICAgICAgTk9fUFJFTE9BRF9HRU5FUkFURV8yMDRfQllQQVNTID0gdHJ1ZTsKICAgICAgaGVhZExpbmtDb2xsZWN0aW9uID0gbnVsbDsKICAgIH0pOwoKCiAgICBOQVRJVkVfQ0FOVkFTX0FOSU1BVElPTiAmJiAoKCkgPT4gewoKICAgICAgb2JzZXJ2YWJsZVByb21pc2UoKCkgPT4gewogICAgICAgIEhUTUxDYW52YXNFbGVtZW50LnByb3RvdHlwZS5hbmltYXRlID0gYW5pbWF0ZTsKICAgICAgfSwgcHJvbWlzZUZvclRhbWVyVGltZW91dCkub2J0YWluKCk7CgogICAgfSkoKTsKCiAgICBGSVhfeXRBY3Rpb25fICYmIChhc3luYyAoKSA9PiB7CgogICAgICBjb25zdCB5dGRBcHAgPSBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHsKCiAgICAgICAgd2hlbkNFRGVmaW5lZCgneXRkLWFwcCcpLnRoZW4oKCkgPT4gewogICAgICAgICAgY29uc3QgeXRkQXBwID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigneXRkLWFwcCcpOwogICAgICAgICAgaWYgKHl0ZEFwcCkgewogICAgICAgICAgICByZXNvbHZlKHl0ZEFwcCk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KICAgICAgICAgIGxldCBtbyA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKCgpID0+IHsKICAgICAgICAgICAgY29uc3QgeXRkQXBwID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigneXRkLWFwcCcpOwogICAgICAgICAgICBpZiAoIXl0ZEFwcCkgcmV0dXJuOwogICAgICAgICAgICBpZiAobW8pIHsKICAgICAgICAgICAgICBtby5kaXNjb25uZWN0KCk7CiAgICAgICAgICAgICAgbW8udGFrZVJlY29yZHMoKTsKICAgICAgICAgICAgICBtbyA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVzb2x2ZSh5dGRBcHApOwogICAgICAgICAgfSk7CiAgICAgICAgICBtby5vYnNlcnZlKGRvY3VtZW50LCB7IHN1YnRyZWU6IHRydWUsIGNoaWxkTGlzdDogdHJ1ZSB9KTsKICAgICAgICB9KTsKCiAgICAgIH0pOwoKICAgICAgaWYgKCF5dGRBcHApIHJldHVybjsKICAgICAgY29uc3QgY1Byb3RvID0gaW5zcCh5dGRBcHApLmNvbnN0cnVjdG9yLnByb3RvdHlwZTsKCiAgICAgIGlmICghY1Byb3RvKSByZXR1cm47CiAgICAgIGxldCBtYmQgPSAwOwoKICAgICAgY29uc3QgZml4ZXIgPSAoX3l0ZEFwcCkgPT4gewogICAgICAgIGNvbnN0IHl0ZEFwcCA9IGluc3AoX3l0ZEFwcCk7CiAgICAgICAgaWYgKHl0ZEFwcCAmJiB0eXBlb2YgeXRkQXBwLm9uWXRBY3Rpb25Cb3VuZExpc3RlbmVyXyA9PT0gJ2Z1bmN0aW9uJyAmJiAheXRkQXBwLm9uWXRBY3Rpb25Cb3VuZExpc3RlbmVyNTdfKSB7CiAgICAgICAgICB5dGRBcHAub25ZdEFjdGlvbkJvdW5kTGlzdGVuZXI1N18gPSB5dGRBcHAub25ZdEFjdGlvbkJvdW5kTGlzdGVuZXJfOwogICAgICAgICAgeXRkQXBwLm9uWXRBY3Rpb25Cb3VuZExpc3RlbmVyXyA9IHl0ZEFwcC5vbll0QWN0aW9uXy5iaW5kKHl0ZEFwcCk7CiAgICAgICAgICBtYmQrKzsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIG9ic2VydmFibGVQcm9taXNlKCgpID0+IHsKCiAgICAgICAgaWYgKHR5cGVvZiBjUHJvdG8uY3JlYXRlZCA9PT0gJ2Z1bmN0aW9uJyAmJiAhY1Byb3RvLmNyZWF0ZWQ1NikgewogICAgICAgICAgY1Byb3RvLmNyZWF0ZWQ1NiA9IGNQcm90by5jcmVhdGVkOwogICAgICAgICAgY1Byb3RvLmNyZWF0ZWQgPSBmdW5jdGlvbiAoLi4uYXJncykgewogICAgICAgICAgICBjb25zdCByID0gdGhpcy5jcmVhdGVkNTYoLi4uYXJncyk7CiAgICAgICAgICAgIGZpeGVyKHRoaXMpOwogICAgICAgICAgICByZXR1cm4gcjsKICAgICAgICAgIH07CiAgICAgICAgICBtYmQrKzsKICAgICAgICB9CgogICAgICAgIGlmICh0eXBlb2YgY1Byb3RvLm9uWXRBY3Rpb25fID09PSAnZnVuY3Rpb24nICYmICFjUHJvdG8ub25ZdEFjdGlvbjU3XykgewogICAgICAgICAgY1Byb3RvLm9uWXRBY3Rpb241N18gPSBjUHJvdG8ub25ZdEFjdGlvbl87CiAgICAgICAgICBjUHJvdG8ub25ZdEFjdGlvbl8gPSBmdW5jdGlvbiAoLi4uYXJncykgewogICAgICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKCgpID0+IHRoaXMub25ZdEFjdGlvbjU3XyguLi5hcmdzKSk7CiAgICAgICAgICB9OwogICAgICAgICAgbWJkKys7CiAgICAgICAgfQoKICAgICAgICBpZiAoeXRkQXBwKSBmaXhlcih5dGRBcHApOwoKICAgICAgICAvKgogICAgICAgIGNvbnN0IGFjdGlvblJvdXRlcl8gPSB5dGRBcHAgPyB5dGRBcHAuYWN0aW9uUm91dGVyXyA6IG51bGw7CiAgICAgICAgaWYgKGFjdGlvblJvdXRlcl8gJiYgdHlwZW9mIGFjdGlvblJvdXRlcl8uaGFuZGxlQWN0aW9uID09PSAnZnVuY3Rpb24nICYmICFhY3Rpb25Sb3V0ZXJfLmhhbmRsZUFjdGlvbjU3KSB7CiAgICAgICAgICBhY3Rpb25Sb3V0ZXJfLmhhbmRsZUFjdGlvbjU3ID0gYWN0aW9uUm91dGVyXy5oYW5kbGVBY3Rpb247CiAgICAgICAgICBhY3Rpb25Sb3V0ZXJfLmhhbmRsZUFjdGlvbiA9IGZ1bmN0aW9uICguLi5hcmdzKSB7CiAgICAgICAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gdGhpcy5oYW5kbGVBY3Rpb241NyguLi5hcmdzKSk7CiAgICAgICAgICB9CiAgICAgICAgICBtYmQrKzsKICAgICAgICB9CiAgICAgICAgKi8KCiAgICAgICAgLy8gaWYobWJkID09PSAzKSByZXR1cm4gMTsKICAgICAgICBpZiAobWJkID49IDMpIHJldHVybiAxOwoKICAgICAgfSwgbmV3IFByb21pc2UociA9PiBzZXRUaW1lb3V0KHIsIDEwMDApKSkub2J0YWluKCk7CgogICAgfSkoKTsKCiAgICBjb25zdCBvYnNlcnZhYmxlUHJvbWlzZSA9IChwcm9jLCB0aW1lb3V0UHJvbWlzZSkgPT4gewogICAgICBsZXQgcHJvbWlzZSA9IG51bGw7CiAgICAgIHJldHVybiB7CiAgICAgICAgb2J0YWluKCkgewogICAgICAgICAgaWYgKCFwcm9taXNlKSB7CiAgICAgICAgICAgIHByb21pc2UgPSBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHsKICAgICAgICAgICAgICBsZXQgbW8gPSBudWxsOwogICAgICAgICAgICAgIGNvbnN0IGYgPSAoKSA9PiB7CiAgICAgICAgICAgICAgICBsZXQgdCA9IHByb2MoKTsKICAgICAgICAgICAgICAgIGlmICh0KSB7CiAgICAgICAgICAgICAgICAgIG1vLmRpc2Nvbm5lY3QoKTsKICAgICAgICAgICAgICAgICAgbW8udGFrZVJlY29yZHMoKTsKICAgICAgICAgICAgICAgICAgbW8gPSBudWxsOwogICAgICAgICAgICAgICAgICByZXNvbHZlKHQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBtbyA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKGYpOwogICAgICAgICAgICAgIG1vLm9ic2VydmUoZG9jdW1lbnQsIHsgc3VidHJlZTogdHJ1ZSwgY2hpbGRMaXN0OiB0cnVlIH0pCiAgICAgICAgICAgICAgZigpOwogICAgICAgICAgICAgIHRpbWVvdXRQcm9taXNlICYmIHRpbWVvdXRQcm9taXNlLnRoZW4oKCkgPT4gewogICAgICAgICAgICAgICAgcmVzb2x2ZShudWxsKQogICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICAgIHJldHVybiBwcm9taXNlCiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgLy8gbGV0IF95dF9wbGF5ZXJfcHJvbWlzZSA9IG51bGw7CiAgICAvKgogICAgY29uc3QgZ2V0WXRQbGF5ZXJQcm9taXNlID0gKCkgPT4gewogICAgICBpZiAoIV95dF9wbGF5ZXJfcHJvbWlzZSkgewogICAgICAgIF95dF9wbGF5ZXJfcHJvbWlzZSA9IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gewogICAgICAgICAgbGV0IGNpZCA9IHNldEludGVydmFsKCgpID0+IHsKICAgICAgICAgICAgbGV0IHQgPSAoKCh3aW5kb3cgfHwgMCkuX3l0X3BsYXllciB8fCAwKSB8fCAwKTsKICAgICAgICAgICAgaWYgKHQpIHsKICAgICAgICAgICAgICBjbGVhckludGVydmFsKGNpZCk7CiAgICAgICAgICAgICAgcmVzb2x2ZSh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSwgMSk7CiAgICAgICAgICBwcm9taXNlRm9yVGFtZXJUaW1lb3V0LnRoZW4oKCkgPT4gewogICAgICAgICAgICByZXNvbHZlKG51bGwpCiAgICAgICAgICB9KTsKICAgICAgICB9KTsKICAgICAgfQogICAgICByZXR1cm4gX3l0X3BsYXllcl9wcm9taXNlOwogICAgfQogICAgKi8KICAgIGNvbnN0IF95dF9wbGF5ZXJfb2JzZXJ2YWJsZSA9IG9ic2VydmFibGVQcm9taXNlKCgpID0+IHsKICAgICAgcmV0dXJuICgoKHdpbmRvdyB8fCAwKS5feXRfcGxheWVyIHx8IDApIHx8IDApOwogICAgfSwgcHJvbWlzZUZvclRhbWVyVGltZW91dCk7CgogICAgY29uc3QgcG9seW1lck9ic2VydmFibGUgPSBvYnNlcnZhYmxlUHJvbWlzZSgoKSA9PiB7CiAgICAgIGNvbnN0IFBvbHltZXIgPSB3aW5kb3cuUG9seW1lcjsKICAgICAgaWYgKHR5cGVvZiBQb2x5bWVyICE9PSAnZnVuY3Rpb24nKSByZXR1cm47CiAgICAgIGlmICghKFBvbHltZXIuQmFzZSB8fCAwKS5jb25uZWN0ZWRDYWxsYmFjayB8fCAhKFBvbHltZXIuQmFzZSB8fCAwKS5kaXNjb25uZWN0ZWRDYWxsYmFjaykgcmV0dXJuOwogICAgICByZXR1cm4gUG9seW1lcjsKICAgIH0sIHByb21pc2VGb3JUYW1lclRpbWVvdXQpOwoKICAgIGNvbnN0IHNjaGVkdWxlckluc3RhbmNlT2JzZXJ2YWJsZSA9IG9ic2VydmFibGVQcm9taXNlKCgpID0+IHsKICAgICAgcmV0dXJuICgoKHdpbmRvdyB8fCAwKS55dGdsb2JhbCB8fCAwKS5zY2hlZHVsZXJJbnN0YW5jZUluc3RhbmNlXyB8fCAwKTsKICAgIH0sIHByb21pc2VGb3JUYW1lclRpbWVvdXQpOwoKICAgIGNvbnN0IHRpbWVsaW5lT2JzZXJ2YWJsZSA9IG9ic2VydmFibGVQcm9taXNlKCgpID0+IHsKICAgICAgbGV0IHQgPSAoKChkb2N1bWVudCB8fCAwKS50aW1lbGluZSB8fCAwKSB8fCAwKTsKICAgICAgaWYgKHQgJiYgdHlwZW9mIHQuX3BsYXkgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICByZXR1cm4gdDsKICAgICAgfQogICAgfSwgcHJvbWlzZUZvclRhbWVyVGltZW91dCk7CiAgICBjb25zdCBhbmltYXRpb25PYnNlcnZhYmxlID0gb2JzZXJ2YWJsZVByb21pc2UoKCkgPT4gewogICAgICBsZXQgdCA9ICgoKHdpbmRvdyB8fCAwKS5BbmltYXRpb24gfHwgMCkgfHwgMCk7CiAgICAgIGlmICh0ICYmIHR5cGVvZiB0ID09PSAnZnVuY3Rpb24nICYmIHQubGVuZ3RoID09PSAyICYmIHR5cGVvZiB0LnByb3RvdHlwZS5fdXBkYXRlUHJvbWlzZXMgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICByZXR1cm4gdDsKICAgICAgfQogICAgfSwgcHJvbWlzZUZvclRhbWVyVGltZW91dCk7CgoKCgogICAgY29uc3QgZ2VuZXJhbEV2dEhhbmRsZXIgPSBhc3luYyAoX2V2S2V5LCBfZnZLZXksIF9kZWJ1ZykgPT4gewoKICAgICAgY29uc3QgZXZLZXkgPSBgJHtfZXZLZXl9YDsKICAgICAgY29uc3QgZnZLZXkgPSBgJHtfZnZLZXl9YDsKICAgICAgY29uc3QgZGVidWcgPSAhIV9kZWJ1ZzsKCiAgICAgIGNvbnN0IF95dF9wbGF5ZXIgPSBhd2FpdCBfeXRfcGxheWVyX29ic2VydmFibGUub2J0YWluKCk7CgoKICAgICAgaWYgKCFfeXRfcGxheWVyIHx8IHR5cGVvZiBfeXRfcGxheWVyICE9PSAnb2JqZWN0JykgcmV0dXJuOwoKCiAgICAgIGNvbnN0IGdldEFyciA9IChfeXRfcGxheWVyKSA9PiB7CgogICAgICAgIGxldCBhcnIgPSBbXTsKCiAgICAgICAgZm9yIChjb25zdCBbaywgdl0gb2YgT2JqZWN0LmVudHJpZXMoX3l0X3BsYXllcikpIHsKCiAgICAgICAgICBjb25zdCBwID0gdHlwZW9mIHYgPT09ICdmdW5jdGlvbicgPyB2LnByb3RvdHlwZSA6IDA7CiAgICAgICAgICBpZiAocAogICAgICAgICAgICAmJiB0eXBlb2YgcFtldktleV0gPT09ICdmdW5jdGlvbicgJiYgcFtldktleV0ubGVuZ3RoID49IDAgJiYgIXBbZnZLZXldCgogICAgICAgICAgKSB7CiAgICAgICAgICAgIGFyciA9IGFkZFByb3RvVG9BcnIoX3l0X3BsYXllciwgaywgYXJyKSB8fCBhcnI7CgogICAgICAgICAgfQoKICAgICAgICB9CgogICAgICAgIGlmIChhcnIubGVuZ3RoID09PSAwKSB7CgogICAgICAgICAgY29uc29sZS53YXJuKGBLZXkgcHJvcCBbJHtldktleX1dIGRvZXMgbm90IGV4aXN0LmApOwogICAgICAgIH0gZWxzZSB7CgogICAgICAgICAgcmV0dXJuIGFycjsKICAgICAgICB9CgogICAgICB9OwoKICAgICAgY29uc3QgYXJyID0gZ2V0QXJyKF95dF9wbGF5ZXIpOwoKCiAgICAgIGlmICghYXJyKSByZXR1cm47CgogICAgICBkZWJ1ZyAmJiBjb25zb2xlLmxvZyhgRklYXyR7ZXZLZXl9YCwgYXJyKTsKCiAgICAgIGNvbnN0IGYgPSBmdW5jdGlvbiAoLi4uYXJncykgewogICAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gdGhpc1tmdktleV0oLi4uYXJncykpOwogICAgICB9OwoKCiAgICAgIGZvciAoY29uc3QgayBvZiBhcnIpIHsKCiAgICAgICAgY29uc3QgZyA9IF95dF9wbGF5ZXI7CiAgICAgICAgY29uc3QgZ2sgPSBnW2tdOwogICAgICAgIGNvbnN0IGdrcCA9IGdrLnByb3RvdHlwZTsKCiAgICAgICAgZGVidWcgJiYgY29uc29sZS5sb2coMjM3LCBrLCBna3ApCgogICAgICAgIGlmICh0eXBlb2YgZ2twW2V2S2V5XSA9PSAnZnVuY3Rpb24nICYmICFna3BbZnZLZXldKSB7CiAgICAgICAgICBna3BbZnZLZXldID0gZ2twW2V2S2V5XTsKICAgICAgICAgIGdrcFtldktleV0gPSBmOwogICAgICAgIH0KICAgICAgfQoKCgoKICAgIH0KCiAgICBGSVhfb25WaWRlb0RhdGFDaGFuZ2UgJiYgZ2VuZXJhbEV2dEhhbmRsZXIoJ29uVmlkZW9EYXRhQ2hhbmdlJywgJ29uVmlkZW9EYXRhQ2hhbmdlNTcnKTsKICAgIC8vIEZJWF9vbkNsaWNrICYmIGdlbmVyYWxFdnRIYW5kbGVyKCdvbkNsaWNrJywgJ29uQ2xpY2s1NycpOwogICAgRklYX29uU3RhdGVDaGFuZ2UgJiYgZ2VuZXJhbEV2dEhhbmRsZXIoJ29uU3RhdGVDaGFuZ2UnLCAnb25TdGF0ZUNoYW5nZTU3Jyk7CiAgICBGSVhfb25Mb29wUmFuZ2VDaGFuZ2UgJiYgZ2VuZXJhbEV2dEhhbmRsZXIoJ29uTG9vcFJhbmdlQ2hhbmdlJywgJ29uTG9vcFJhbmdlQ2hhbmdlNTcnKTsKICAgIGlmIChGSVhfVmlkZW9FVkVOVFNfdjIpIHsKICAgICAgY29uc3QgRklYX1ZpZGVvRVZFTlRTX0RFQlVHID0gMDsKICAgICAgZ2VuZXJhbEV2dEhhbmRsZXIoJ29uVmlkZW9Qcm9ncmVzcycsICdvblZpZGVvUHJvZ3Jlc3M1NycsIEZJWF9WaWRlb0VWRU5UU19ERUJVRyk7IC8vIC0tCiAgICAgIC8vIGdlbmVyYWxFdnRIYW5kbGVyKCdvbkF1dG9wbGF5QmxvY2tlZCcsICdvbkF1dG9wbGF5QmxvY2tlZDU3JywgRklYX1ZpZGVvRVZFTlRTX0RFQlVHKTsKICAgICAgLy8gZ2VuZXJhbEV2dEhhbmRsZXIoJ29uTG9hZFByb2dyZXNzJywgJ29uTG9hZFByb2dyZXNzNTcnLCBGSVhfVmlkZW9FVkVOVFNfREVCVUcpOyAvLyA8PCBDQVVTRSBJU1NVRSA+PgogICAgICBnZW5lcmFsRXZ0SGFuZGxlcignb25GdWxsc2NyZWVuQ2hhbmdlJywgJ29uRnVsbHNjcmVlbkNoYW5nZTU3JywgRklYX1ZpZGVvRVZFTlRTX0RFQlVHKTsgLy8gLS0KICAgICAgLy8gZ2VuZXJhbEV2dEhhbmRsZXIoJ29uTG9hZGVkTWV0YWRhdGEnLCAnb25Mb2FkZWRNZXRhZGF0YTU3JywgRklYX1ZpZGVvRVZFTlRTX0RFQlVHKTsKICAgICAgLy8gZ2VuZXJhbEV2dEhhbmRsZXIoJ29uRHJtT3V0cHV0UmVzdHJpY3RlZCcsICdvbkRybU91dHB1dFJlc3RyaWN0ZWQ1NycsIEZJWF9WaWRlb0VWRU5UU19ERUJVRyk7CiAgICAgIC8vIGdlbmVyYWxFdnRIYW5kbGVyKCdvbkFpclBsYXlBY3RpdmVDaGFuZ2UnLCAnb25BaXJQbGF5QWN0aXZlQ2hhbmdlNTcnLCBGSVhfVmlkZW9FVkVOVFNfREVCVUcpOwogICAgICAvLyBnZW5lcmFsRXZ0SGFuZGxlcignb25BaXJQbGF5QXZhaWxhYmlsaXR5Q2hhbmdlJywgJ29uQWlyUGxheUF2YWlsYWJpbGl0eUNoYW5nZTU3JywgRklYX1ZpZGVvRVZFTlRTX0RFQlVHKTsKICAgICAgLy8gZ2VuZXJhbEV2dEhhbmRsZXIoJ29uQXBpQ2hhbmdlJywgJ29uQXBpQ2hhbmdlNTcnLCBGSVhfVmlkZW9FVkVOVFNfREVCVUcpOwoKICAgIH0KICAgIC8vIG9uTXV0ZWRBdXRvcGxheUNoYW5nZQogICAgLy8gb25Wb2x1bWVDaGFuZ2UKICAgIC8vIG9uUGxheWJhY2tSYXRlQ2hhbmdlCgogICAgLy8gb25BaXJQbGF5QWN0aXZlQ2hhbmdlCiAgICAvLyBvbkFpclBsYXlBdmFpbGFiaWxpdHlDaGFuZ2UKICAgIC8vIG9uQXBpQ2hhbmdlCiAgICAvLyBvbkF1dG9wbGF5QmxvY2tlZAogICAgLy8gb25Ecm1PdXRwdXRSZXN0cmljdGVkCiAgICAvLyBvbkZ1bGxzY3JlZW5DaGFuZ2UKICAgIC8vIG9uTG9hZFByb2dyZXNzCiAgICAvLyBvbkxvYWRlZE1ldGFkYXRhCiAgICAvLyBvblZpZGVvRGF0YUNoYW5nZQogICAgLy8gb25WaWRlb1Byb2dyZXNzCgoKICAgIChFTkFCTEVfZGlzY3JldGVUYXNraW5nIHx8IFVOTE9BRF9ERVRBQ0hFRF9QT0xZTUVSIHx8IEZJWF9Qb2x5bWVyX2RvbSkgJiYgKGFzeW5jICgpID0+IHsKCiAgICAgIGNvbnN0IFBvbHltZXIgPSBhd2FpdCBwb2x5bWVyT2JzZXJ2YWJsZS5vYnRhaW4oKTsKICAgICAgaWYgKCFQb2x5bWVyKSByZXR1cm47CgogICAgICBpZiAoRklYX1BvbHltZXJfZG9tKSB7CgogICAgICAgIGNvbnN0IGNoZWNrUERGdW5jVmFsdWUgPSAocGQpID0+IHsKICAgICAgICAgIHJldHVybiBwZCAmJiBwZC53cml0YWJsZSAmJiBwZC5lbnVtZXJhYmxlICYmIHBkLmNvbmZpZ3VyYWJsZSAmJiB0eXBlb2YgcGQudmFsdWUgPT0gJ2Z1bmN0aW9uJwogICAgICAgIH0KICAgICAgICBjb25zdCBjaGVja1BERnVuY1ZhbHVlMiA9IChwZCkgPT4gewogICAgICAgICAgcmV0dXJuIHBkICYmIHR5cGVvZiBwZC52YWx1ZSA9PSAnZnVuY3Rpb24nCiAgICAgICAgfQoKICAgICAgICBjb25zdCBjaGVja1BERnVuY0dldCA9IChwZCkgPT4gewogICAgICAgICAgcmV0dXJuIHBkICYmIHR5cGVvZiBwZC5nZXQgPT0gJ2Z1bmN0aW9uJwogICAgICAgIH0KCiAgICAgICAgY29uc3QgZG9tWCA9IFBvbHltZXIuZG9tKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ251bGwnKSk7CiAgICAgICAgY29uc3QgZG9tWFAgPSAoKChkb21YIHx8IDApLmNvbnN0cnVjdG9yIHx8IDApLnByb3RvdHlwZSB8fCAwKTsKICAgICAgICBjb25zdCBwZDEgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGRvbVhQLCAnZ2V0T3duZXJSb290Jyk7CiAgICAgICAgY29uc3QgcGQyID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihOb2RlLnByb3RvdHlwZSwgJ3BhcmVudEVsZW1lbnQnKTsKICAgICAgICBjb25zdCBwZDMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGRvbVhQLCAncXVlcnlTZWxlY3RvcicpOyAvLyB1bmRlZmluZWQKICAgICAgICBjb25zdCBwZDQgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKEVsZW1lbnQucHJvdG90eXBlLCAncXVlcnlTZWxlY3RvcicpOwogICAgICAgIGNvbnN0IHBkNGIgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKERvY3VtZW50LnByb3RvdHlwZSwgJ3F1ZXJ5U2VsZWN0b3InKTsKICAgICAgICBjb25zdCBwZDUgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGRvbVhQLCAncXVlcnlTZWxlY3RvckFsbCcpOyAvLyB1bmRlZmluZWQKICAgICAgICBjb25zdCBwZDYgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKEVsZW1lbnQucHJvdG90eXBlLCAncXVlcnlTZWxlY3RvckFsbCcpOwogICAgICAgIGNvbnN0IHBkNmIgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKERvY3VtZW50LnByb3RvdHlwZSwgJ3F1ZXJ5U2VsZWN0b3JBbGwnKTsKCgogICAgICAgIC8vIGdldE93bmVyUm9vdCAtIHRvIGJlIHJldmlld2VkCiAgICAgICAgaWYgKDAgJiYgY2hlY2tQREZ1bmNWYWx1ZShwZDEpICYmIGNoZWNrUERGdW5jR2V0KHBkMikgJiYgIWRvbVhQLmdldE93bmVyUm9vdDE1ICYmIHR5cGVvZiBkb21YUC5nZXRPd25lclJvb3QgPT09ICdmdW5jdGlvbicpIHsKCiAgICAgICAgICBkb21YUC5nZXRPd25lclJvb3QxNSA9IGRvbVhQLmdldE93bmVyUm9vdDsKICAgICAgICAgIGRvbVhQLmdldE93bmVyUm9vdCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5ub2RlOwoKICAgICAgICAgICAgICBpZiAocCBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSB7CiAgICAgICAgICAgICAgICBjb25zdCBwcCA9IHBkMi5nZXQuY2FsbChwKTsKICAgICAgICAgICAgICAgIGlmIChwcCBpbnN0YW5jZW9mIEhUTUxFbGVtZW50ICYmIHBwLmlzQ29ubmVjdGVkID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgIHJldHVybiBwcC5nZXRSb290Tm9kZSgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5nZXRPd25lclJvb3QxNSgpOwogICAgICAgICAgfQoKICAgICAgICAgIFBvbHltZXIuX19maXhlZEdldE93bmVyUm9vdF9fID0gMTsKICAgICAgICB9CgoKCgogICAgICAgIGlmICgoIXBkMyB8fCBjaGVja1BERnVuY1ZhbHVlKHBkMykpICYmIGNoZWNrUERGdW5jVmFsdWUyKHBkNCkgJiYgY2hlY2tQREZ1bmNWYWx1ZTIocGQ0YikgJiYgISgncXVlcnlTZWxlY3RvcjE1JyBpbiBkb21YUCkpIHsKCiAgICAgICAgICBkb21YUC5xdWVyeVNlbGVjdG9yMTUgPSBkb21YUC5xdWVyeVNlbGVjdG9yOwoKICAgICAgICAgIGNvbnN0IHF1ZXJ5U2VsZWN0b3JGbiA9IGZ1bmN0aW9uIChxdWVyeSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIGNvbnN0IHAgPSB0aGlzLm5vZGU7CgogICAgICAgICAgICAgIC8vIGlmIChwIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQgJiYgcC5pc0Nvbm5lY3RlZCA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgIC8vICAgICByZXR1cm4gcGQ0LnZhbHVlLmNhbGwocCwgcXVlcnkpOwogICAgICAgICAgICAgIC8vIH0KCiAgICAgICAgICAgICAgaWYgKHAgaW5zdGFuY2VvZiBEb2N1bWVudCAmJiBwLmlzQ29ubmVjdGVkID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gcGQ0Yi52YWx1ZS5jYWxsKHAsIHF1ZXJ5KTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9IGNhdGNoIChlKSB7IH0KICAgICAgICAgICAgcmV0dXJuIHRoaXMucXVlcnlTZWxlY3RvcjE1KHF1ZXJ5KTsKICAgICAgICAgIH0KCiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoZG9tWFAsICdxdWVyeVNlbGVjdG9yJywgewogICAgICAgICAgICBnZXQoKSB7CiAgICAgICAgICAgICAgcmV0dXJuIHF1ZXJ5U2VsZWN0b3JGbjsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0KG52KSB7CiAgICAgICAgICAgICAgaWYgKG52ID09PSBxdWVyeVNlbGVjdG9yRm4pIHJldHVybiB0cnVlOwogICAgICAgICAgICAgIHRoaXMucXVlcnlTZWxlY3RvcjE1ID0gbnY7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0sCgogICAgICAgICAgICBlbnVtZXJhYmxlOiBmYWxzZSwKICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlCiAgICAgICAgICB9KTsKCiAgICAgICAgICBQb2x5bWVyLl9fZml4ZWRRdWVyeVNlbGVjdG9yX18gPSAxOwogICAgICAgIH0KCiAgICAgICAgaWYgKCghcGQ1IHx8IGNoZWNrUERGdW5jVmFsdWUocGQ1KSkgJiYgY2hlY2tQREZ1bmNWYWx1ZTIocGQ2KSAmJiBjaGVja1BERnVuY1ZhbHVlMihwZDZiKSAmJiAhKCdxdWVyeVNlbGVjdG9yQWxsMTUnIGluIGRvbVhQKSkgewoKICAgICAgICAgIGRvbVhQLnF1ZXJ5U2VsZWN0b3JBbGwxNSA9IGRvbVhQLnF1ZXJ5U2VsZWN0b3JBbGw7CgogICAgICAgICAgY29uc3QgcXVlcnlTZWxlY3RvckFsbEZuID0gZnVuY3Rpb24gKHF1ZXJ5KSB7CgogICAgICAgICAgICB0cnkgewoKICAgICAgICAgICAgICBjb25zdCBwID0gdGhpcy5ub2RlOwoKICAgICAgICAgICAgICAvLyBpZiAocCBpbnN0YW5jZW9mIEhUTUxFbGVtZW50ICYmIHAuaXNDb25uZWN0ZWQgPT09IHRydWUpIHsKICAgICAgICAgICAgICAvLyAgICAgcmV0dXJuIHBkNi52YWx1ZS5jYWxsKHAsIHF1ZXJ5KTsKICAgICAgICAgICAgICAvLyB9CgogICAgICAgICAgICAgIGlmIChwIGluc3RhbmNlb2YgRG9jdW1lbnQgJiYgcC5pc0Nvbm5lY3RlZCA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgcmV0dXJuIHBkNmIudmFsdWUuY2FsbChwLCBxdWVyeSk7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgfSBjYXRjaCAoZSkgewoKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gdGhpcy5xdWVyeVNlbGVjdG9yQWxsMTUocXVlcnkpOwogICAgICAgICAgfQoKICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShkb21YUCwgJ3F1ZXJ5U2VsZWN0b3JBbGwnLCB7CiAgICAgICAgICAgIGdldCgpIHsKICAgICAgICAgICAgICByZXR1cm4gcXVlcnlTZWxlY3RvckFsbEZuOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXQobnYpIHsKICAgICAgICAgICAgICBpZiAobnYgPT09IHF1ZXJ5U2VsZWN0b3JBbGxGbikgcmV0dXJuIHRydWU7CiAgICAgICAgICAgICAgdGhpcy5xdWVyeVNlbGVjdG9yQWxsMTUgPSBudjsKICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICAgICAgfSwKCiAgICAgICAgICAgIGVudW1lcmFibGU6IGZhbHNlLAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICAgIH0pOwoKICAgICAgICAgIFBvbHltZXIuX19maXhlZFF1ZXJ5U2VsZWN0b3JBbGxfXyA9IDE7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAoVU5MT0FEX0RFVEFDSEVEX1BPTFlNRVIgJiYgdHlwZW9mIFBvbHltZXIuQmFzZS5kZXRhY2hlZCA9PT0gJ2Z1bmN0aW9uJyAmJiAhUG9seW1lci5CYXNlLmRldGFjaGVkOTIgJiYgUG9seW1lci5CYXNlLmRldGFjaGVkLmxlbmd0aCA9PT0gMCkgewogICAgICAgIFBvbHltZXIuQmFzZS5kZXRhY2hlZDkyID0gUG9seW1lci5CYXNlLmRldGFjaGVkOwoKICAgICAgICBjb25zdCBkZXRhY2hlZFBsdXMgPSBhc3luYyBmdW5jdGlvbiAoZWxlbSkgewogICAgICAgICAgYXdhaXQgZGVsYXkzMDAudGhlbigpOwogICAgICAgICAgaWYgKGVsZW0uaXNBdHRhY2hlZCAhPT0gZmFsc2UpIHJldHVybjsKICAgICAgICAgIGF3YWl0IGRlbGF5MzAwLnRoZW4oKTsKICAgICAgICAgIGlmIChlbGVtLmlzQXR0YWNoZWQgIT09IGZhbHNlKSByZXR1cm47CgogICAgICAgICAgaWYgKGVsZW0uX19kYXRhQ2xpZW50c1JlYWR5ID09PSB0cnVlKSBlbGVtLl9fZGF0YUNsaWVudHNSZWFkeSA9IGZhbHNlOwogICAgICAgICAgLy8gaWYgKGVsZW0uX19kYXRhRW5hYmxlZCA9PT0gdHJ1ZSkgZWxlbS5fX2RhdGFFbmFibGVkID0gZmFsc2U7CiAgICAgICAgICBpZiAoZWxlbS5fX2RhdGFSZWFkeSA9PT0gdHJ1ZSkgZWxlbS5fX2RhdGFSZWFkeSA9IGZhbHNlOwoKICAgICAgICAgIGVsZW0uX19kYXRhTGlua2VkUGF0aHMgPSBlbGVtLl9fZGF0YVRvTm90aWZ5ID0gZWxlbS5fX2RhdGFQZW5kaW5nQ2xpZW50cyA9IG51bGw7CiAgICAgICAgICBlbGVtLl9fZGF0YUhhc1BhdGhzID0gZmFsc2U7CiAgICAgICAgICAvLyBlbGVtLl9fZGF0YUNvbXBvdW5kU3RvcmFnZSA9IG51bGw7CiAgICAgICAgICBlbGVtLl9fZGF0YUhvc3QgPSBudWxsOwogICAgICAgICAgZWxlbS5fX2RhdGFUZW1wID0gbnVsbDsKICAgICAgICAgIGVsZW0uX19kYXRhQ2xpZW50c0luaXRpYWxpemVkID0gZmFsc2U7CgoKICAgICAgICAgIC8vIGVsZW0uZGF0YSA9IHt9OwogICAgICAgICAgZWxlbS5kYXRhID0gbnVsbDsKICAgICAgICAgIGVsZW0uX19kYXRhUGVuZGluZyA9IG51bGw7CiAgICAgICAgICBlbGVtLl9fZGF0YU9sZCA9IG51bGw7CiAgICAgICAgICBlbGVtLl9fZGF0YUluc3RhbmNlUHJvcHMgPSBudWxsOwoKICAgICAgICAgIGVsZW0uX19kYXRhQ291bnRlciA9IDA7CiAgICAgICAgICBlbGVtLl9fc2VyaWFsaXppbmcgPSBmYWxzZTsKCiAgICAgICAgfQogICAgICAgIFBvbHltZXIuQmFzZS5kZXRhY2hlZCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIFByb21pc2UucmVzb2x2ZSh0aGlzKS50aGVuKGRldGFjaGVkUGx1cyk7CiAgICAgICAgICByZXR1cm4gUG9seW1lci5CYXNlLmRldGFjaGVkOTIoKTsKICAgICAgICB9OwogICAgICB9CgoKICAgICAgaWYgKEVOQUJMRV9kaXNjcmV0ZVRhc2tpbmcpIHsKCiAgICAgICAgUG9seW1lci5CYXNlLl9fY29ubkluaXRfXyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHNldHVwRGlzY3JldGVUYXNrcyh0aGlzKTsKICAgICAgICAgIC8vIGlmIChXRUFLX1JFRl9CSU5ESU5HICYmICh0aGlzLmlzIHx8IHRoaXMgaW5zdGFuY2VvZiBOb2RlKSkgewogICAgICAgICAgLy8gICBzZXR1cFdlYWtSZWYodGhpcykKICAgICAgICAgIC8vIH0KICAgICAgICB9CgoKICAgICAgICAvKiogQHR5cGUge0Z1bmN0aW9ufSAqLwogICAgICAgIGNvbnN0IGNvbm5lY3RlZENhbGxiYWNrSyA9IGZ1bmN0aW9uICguLi5hcmdzKSB7CiAgICAgICAgICAhdGhpcy5taDM1ICYmIHR5cGVvZiB0aGlzLl9fY29ubkluaXRfXyA9PT0gJ2Z1bmN0aW9uJyAmJiB0aGlzLl9fY29ubkluaXRfXygpOwogICAgICAgICAgY29uc3QgciA9IHRoaXNbcW01M10oLi4uYXJncyk7CiAgICAgICAgICAhdGhpcy5taDM1ICYmIHR5cGVvZiB0aGlzLl9fY29ubkluaXRfXyA9PT0gJ2Z1bmN0aW9uJyAmJiB0aGlzLl9fY29ubkluaXRfXygpOwogICAgICAgICAgdGhpcy5taDM1ID0gMTsKICAgICAgICAgIHJldHVybiByOwogICAgICAgIH07CgogICAgICAgIGNvbm5lY3RlZENhbGxiYWNrSy5tMzUzID0gMTsKCgogICAgICAgIGNvbnN0IHF0NTMgPSBQb2x5bWVyLkJhc2UuY29ubmVjdGVkQ2FsbGJhY2s7CiAgICAgICAgUG9seW1lci5CYXNlW3FtNTNdID0gZG1mLmdldChxdDUzKSB8fCBxdDUzOwoKICAgICAgICBQb2x5bWVyLkJhc2UuY29ubmVjdGVkQ2FsbGJhY2sgPSBjb25uZWN0ZWRDYWxsYmFja0s7CgoKICAgICAgICAvKiogQHR5cGUge0Z1bmN0aW9ufSAqLwogICAgICAgIGNvbnN0IGNyZWF0ZWRLID0gZnVuY3Rpb24gKC4uLmFyZ3MpIHsKICAgICAgICAgICF0aGlzLm1oMzYgJiYgdHlwZW9mIHRoaXMuX19jb25uSW5pdF9fID09PSAnZnVuY3Rpb24nICYmIHRoaXMuX19jb25uSW5pdF9fKCk7CiAgICAgICAgICBjb25zdCByID0gdGhpc1txbjUzXSguLi5hcmdzKTsKICAgICAgICAgICF0aGlzLm1oMzYgJiYgdHlwZW9mIHRoaXMuX19jb25uSW5pdF9fID09PSAnZnVuY3Rpb24nICYmIHRoaXMuX19jb25uSW5pdF9fKCk7CiAgICAgICAgICB0aGlzLm1oMzYgPSAxOwogICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgfTsKCgogICAgICAgIGNyZWF0ZWRLLm0zNTMgPSAxOwogICAgICAgIFBvbHltZXIuQmFzZVtxbjUzXSA9IFBvbHltZXIuQmFzZS5jcmVhdGVkOwogICAgICAgIFBvbHltZXIuQmFzZS5jcmVhdGVkID0gY3JlYXRlZEs7CgogICAgICB9CgogICAgfSkoKTsKCgogICAgLyoKCiAgICAgIGUubmF0aXZlQXBwZW5kQ2hpbGQgPSBkLnByb3RvdHlwZS5hcHBlbmRDaGlsZCwKICAgICAgZC5wcm90b3R5cGUuYXBwZW5kQ2hpbGQgPSBmdW5jdGlvbihoKSB7CiAgICAgICAgICByZXR1cm4gZnVuY3Rpb24obCkgewogICAgICAgICAgICAgIGlmIChsIGluc3RhbmNlb2YgRG9jdW1lbnRGcmFnbWVudCkgewogICAgICAgICAgICAgICAgICB2YXIgbSA9IEFycmF5LmZyb20obC5jaGlsZHJlbik7CiAgICAgICAgICAgICAgICAgIGwgPSBoLm5hdGl2ZUFwcGVuZENoaWxkLmNhbGwodGhpcywgbCk7CiAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzQ29ubmVjdGVkKSB7CiAgICAgICAgICAgICAgICAgICAgICBtID0gZyhtKTsKICAgICAgICAgICAgICAgICAgICAgIGZvciAodmFyIHAgPSBtLm5leHQoKTsgIXAuZG9uZTsgcCA9IG0ubmV4dCgpKQogICAgICAgICAgICAgICAgICAgICAgICAgIFlEKHAudmFsdWUpCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgcmV0dXJuIGwKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgbSA9IGwgaW5zdGFuY2VvZiBFbGVtZW50ICYmIGwuaXNDb25uZWN0ZWQ7CiAgICAgICAgICAgICAgcCA9IGgubmF0aXZlQXBwZW5kQ2hpbGQuY2FsbCh0aGlzLCBsKTsKICAgICAgICAgICAgICBtICYmIFpEKGwpOwogICAgICAgICAgICAgIHRoaXMuaXNDb25uZWN0ZWQgJiYgWUQobCk7CiAgICAgICAgICAgICAgcmV0dXJuIHAKICAgICAgICAgIH0KICAgICAgfShlKSwKCiAgICAqLwoKICAgIENIQU5HRV9hcHBlbmRDaGlsZCAmJiAhTm9kZS5wcm90b3R5cGUuYXBwZW5kQ2hpbGQ3MyAmJiBOb2RlLnByb3RvdHlwZS5hcHBlbmRDaGlsZCAmJiAoKCkgPT4gewoKICAgICAgbGV0IF9fc3JjX18gPSAnJzsKICAgICAgY29uc3QgaGFuZGxlckNhbnBsYXkgPSAoZXZ0KSA9PiB7CiAgICAgICAgY29uc3QgYSA9IGV2dC50YXJnZXQ7CiAgICAgICAgY29uc29sZS5sb2coJ1t5dC1qcy1lbmdpbmUtdGFtZXJdJywgYHZpZGVvIGVsZW1lbnQgYWRkZWQgdG8gZG9tIHwgY2FucGxheWAsIG1XZWFrUmVmKGEpLCBhLnJlYWR5U3RhdGUsIGEubmV0d29ya1N0YXRlLCBhLmN1cnJlbnRUaW1lKTsKICAgICAgICBpZiAoYS5jdXJyZW50VGltZSA8IDFlLTggJiYgYS5jdXJyZW50VGltZSA+IC0xZS05ICYmIGEuYXV0b3BsYXkgPT09IGZhbHNlKSBhLmN1cnJlbnRUaW1lICs9IDFlLTg7CiAgICAgIH07CgogICAgICBjb25zdCBoYW5kbGVyVGltZXVwZGF0ZSA9IChldnQpID0+IHsKICAgICAgICBjb25zdCBhID0gZXZ0LnRhcmdldDsKICAgICAgICBjb25zb2xlLmxvZygnW3l0LWpzLWVuZ2luZS10YW1lcl0nLCBgdmlkZW8gZWxlbWVudCBhZGRlZCB0byBkb20gfCBvbnRpbWV1cGRhdGVgLCBtV2Vha1JlZihhKSwgYS5yZWFkeVN0YXRlLCBhLm5ldHdvcmtTdGF0ZSwgYS5jdXJyZW50VGltZSk7CiAgICAgICAgaWYgKGEuZHVyYXRpb24gPCAyLjAxICYmIGEuZHVyYXRpb24gPiAxLjk5ICYmIGEuY3VycmVudFNyYyA9PT0gX19zcmNfXykgewogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgVVJMLnJldm9rZU9iamVjdFVSTChfX3NyY19fKTsKICAgICAgICAgICAgX19zcmNfXyA9ICcnOwogICAgICAgICAgfSBmaW5hbGx5IHsKICAgICAgICAgICAgY29uc29sZS5sb2coJ1t5dC1qcy1lbmdpbmUtdGFtZXJdJywgYHZpZGVvIGVsZW1lbnQgYWRkZWQgdG8gZG9tIHwgcmV2b2tlT2JqZWN0VVJMYCwgbVdlYWtSZWYoYSksIGEucmVhZHlTdGF0ZSwgYS5uZXR3b3JrU3RhdGUsIGEuY3VycmVudFRpbWUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfTsKCiAgICAgIGNvbnN0IGYgPSBOb2RlLnByb3RvdHlwZS5hcHBlbmRDaGlsZDczID0gTm9kZS5wcm90b3R5cGUuYXBwZW5kQ2hpbGQ7CiAgICAgIGlmIChmKSBOb2RlLnByb3RvdHlwZS5hcHBlbmRDaGlsZCA9IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgaWYgKHRoaXMgaW5zdGFuY2VvZiBFbGVtZW50KSB7IC8vIGV4Y2x1ZGUgRG9jdW1lbnRGcmFnbWVudAogICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYgKGEgaW5zdGFuY2VvZiBIVE1MVmlkZW9FbGVtZW50ICYmIEZJWF9WSURFT19CTE9DS0lORyAmJiB0eXBlb2YgQWJvcnRTaWduYWwgIT09ICd1bmRlZmluZWQnKSB7CiAgICAgICAgICAgICAgY29uc3Qgc3JjID0gYCR7YS5zcmN9YDsKICAgICAgICAgICAgICBjb25zdCBiID0gc3JjLmxlbmd0aCA+IDUgJiYgc3JjLnN0YXJ0c1dpdGgoJ2Jsb2I6JykgJiYgdHlwZW9mIGEub250aW1ldXBkYXRlID09PSAnZnVuY3Rpb24nICYmIGEuYXV0b3BsYXkgPT09IGZhbHNlICYmIGEucGF1c2VkID09PSB0cnVlICYmIGEuaXNDb25uZWN0ZWQgPT09IGZhbHNlOwogICAgICAgICAgICAgIGlmIChiKSB7CiAgICAgICAgICAgICAgICBfX3NyY19fID0gc3JjOwogICAgICAgICAgICAgICAgYS5hZGRFdmVudExpc3RlbmVyKCdjYW5wbGF5JywgaGFuZGxlckNhbnBsYXksIHsgb25jZTogdHJ1ZSwgcGFzc2l2ZTogdHJ1ZSwgY2FwdHVyZTogZmFsc2UgfSk7CiAgICAgICAgICAgICAgICBhLmFkZEV2ZW50TGlzdGVuZXIoJ3RpbWV1cGRhdGUnLCBoYW5kbGVyVGltZXVwZGF0ZSwgeyBvbmNlOiB0cnVlLCBwYXNzaXZlOiB0cnVlLCBjYXB0dXJlOiBmYWxzZSB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1t5dC1qcy1lbmdpbmUtdGFtZXJdJywgYHZpZGVvIGVsZW1lbnQgYWRkZWQgdG8gZG9tIHwgdHJlYXRtZW50ID0gJHtifWAsIG1XZWFrUmVmKGEpLCBhLnJlYWR5U3RhdGUsIGEubmV0d29ya1N0YXRlKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBsZXQgY2hlY2tGcmFnbWVudEEgPSAoYSBpbnN0YW5jZW9mIERvY3VtZW50RnJhZ21lbnQpOwogICAgICAgICAgICAgIGlmICghTk9fUFJFTE9BRF9HRU5FUkFURV8yMDRfQllQQVNTICYmIGRvY3VtZW50LmhlYWQgPT09IHRoaXMpIHsKICAgICAgICAgICAgICAgIGlmIChoZWFkTGlua0NvbGxlY3Rpb24gPT09IG51bGwpIGhlYWRMaW5rQ29sbGVjdGlvbiA9IGRvY3VtZW50LmhlYWQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ0xJTksnKTsKICAgICAgICAgICAgICAgIGZvciAoY29uc3Qgbm9kZSBvZiBoZWFkTGlua0NvbGxlY3Rpb24pIHsKICAgICAgICAgICAgICAgICAgaWYgKG5vZGUucmVsID09PSAncHJlbG9hZCcgJiYgbm9kZS5hcyA9PT0gJ2ZldGNoJykgewogICAgICAgICAgICAgICAgICAgIG5vZGUucmVsID0gJ3ByZWZldGNoJzsgLy8gc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9Hb29nbGVDaHJvbWVMYWJzL3F1aWNrbGluawogICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChjaGVja0ZyYWdtZW50QSAmJiB0aGlzLm5vZGVOYW1lLnN0YXJ0c1dpdGgoJ1lULScpKSB7IC8vIHl0LWFuaW1hdGVkLXJvbGxpbmctbnVtYmVyLCB5dC1hdHRyaWJ1dGVkLXN0cmluZwogICAgICAgICAgICAgICAgY2hlY2tGcmFnbWVudEEgPSBmYWxzZTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKGNoZWNrRnJhZ21lbnRBICYmIGEuZmlyc3RFbGVtZW50Q2hpbGQgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgIC8vIG5vIGVsZW1lbnQgaW4gZnJhZ21lbnRBCiAgICAgICAgICAgICAgICBsZXQgZG9Ob3JtYWwgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGZvciAobGV0IGNoaWxkID0gYS5maXJzdENoaWxkOyBjaGlsZCBpbnN0YW5jZW9mIE5vZGU7IGNoaWxkID0gY2hpbGQubmV4dFNpYmxpbmcpIHsKICAgICAgICAgICAgICAgICAgaWYgKGNoaWxkLm5vZGVUeXBlID09PSAzKSB7IGRvTm9ybWFsID0gdHJ1ZTsgYnJlYWs7IH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICghZG9Ob3JtYWwpIHJldHVybiBhOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmxvZyhlKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFyZ3VtZW50cy5sZW5ndGggPT09IDEgPyBmLmNhbGwodGhpcywgYSkgOiBmLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgIH0KCgogICAgfSkoKTsKCiAgICBpZiAoRklYX1NoYWR5KSB7CgogICAgICBvYnNlcnZhYmxlUHJvbWlzZSgoKSA9PiB7CiAgICAgICAgY29uc3QgeyBTaGFkeURPTSwgU2hhZHlDU1MgfSA9IHdpbmRvdzsKICAgICAgICBpZiAoU2hhZHlET00pIHsKICAgICAgICAgIFNoYWR5RE9NLmhhbmRsZXNEeW5hbWljU2NvcGluZyA9IGZhbHNlOyAvLyA5IG9mIDEwCiAgICAgICAgICBTaGFkeURPTS5ub1BhdGNoID0gdHJ1ZTsgLy8gMSBvZiAxMAogICAgICAgICAgU2hhZHlET00ucGF0Y2hPbkRlbWFuZCA9IGZhbHNlOyAvLyAxIG9mIDEwCiAgICAgICAgICBTaGFkeURPTS5wcmVmZXJQZXJmb3JtYW5jZSA9IHRydWU7IC8vIDEgb2YgMTAKICAgICAgICAgIFNoYWR5RE9NLnF1ZXJ5U2VsZWN0b3JJbXBsZW1lbnRhdGlvbiA9IHVuZGVmaW5lZDsgLy8gMSBvZiAxMAogICAgICAgIH0KICAgICAgICBpZiAoU2hhZHlDU1MpIHsKICAgICAgICAgIFNoYWR5Q1NTLm5hdGl2ZUNzcyA9IHRydWU7IC8vIDEgb2YgMTAKICAgICAgICAgIFNoYWR5Q1NTLm5hdGl2ZVNoYWRvdyA9IHRydWU7IC8vIDYgb2YgMTAKICAgICAgICAgIFNoYWR5Q1NTLmNzc0J1aWxkID0gdW5kZWZpbmVkOyAvLyAxIG9mIDEwCiAgICAgICAgICBTaGFkeUNTUy5kaXNhYmxlUnVudGltZSA9IHRydWU7IC8vIDEgb2YgMTAKICAgICAgICB9CiAgICAgICAgaWYgKFNoYWR5RE9NICYmIFNoYWR5Q1NTKSByZXR1cm4gMTsKICAgICAgfSwgcHJvbWlzZUZvclRhbWVyVGltZW91dCkub2J0YWluKCk7IC8vIGNsZWFyIHVudGlsIDEgaXMgcmV0dXJuCgogICAgfQoKCiAgICAvLyBsZXQgc2NoZWR1bGVySW5zdGFuY2VQcm9wT2ZUaW1lclR5cGUgPSAnJzsKICAgIC8vIGxldCBzY2hlZHVsZXJJbnN0YW5jZVByb3BPZlRpbWVySWQgPSAnJzsKICAgIChGSVhfc2NoZWR1bGVySW5zdGFuY2VJbnN0YW5jZSAmIDIpICYmIChhc3luYyAoKSA9PiB7CgogICAgICBjb25zdCBzY2hlZHVsZXJJbnN0YW5jZUluc3RhbmNlXyA9IGF3YWl0IHNjaGVkdWxlckluc3RhbmNlT2JzZXJ2YWJsZS5vYnRhaW4oKTsKCiAgICAgIGlmICghc2NoZWR1bGVySW5zdGFuY2VJbnN0YW5jZV8pIHJldHVybjsKCiAgICAgIGNvbnN0IGNoZWNrT0sgPSB0eXBlb2Ygc2NoZWR1bGVySW5zdGFuY2VJbnN0YW5jZV8uc3RhcnQgPT09ICdmdW5jdGlvbicgJiYgIXNjaGVkdWxlckluc3RhbmNlSW5zdGFuY2VfLnN0YXJ0OTkzICYmICFzY2hlZHVsZXJJbnN0YW5jZUluc3RhbmNlXy5zdG9wICYmICFzY2hlZHVsZXJJbnN0YW5jZUluc3RhbmNlXy5jYW5jZWwgJiYgIXNjaGVkdWxlckluc3RhbmNlSW5zdGFuY2VfLnRlcm1pbmF0ZSAmJiAhc2NoZWR1bGVySW5zdGFuY2VJbnN0YW5jZV8uaW50ZXJ1cHQ7CiAgICAgIGlmIChjaGVja09LKSB7CgogICAgICAgIHNjaGVkdWxlckluc3RhbmNlSW5zdGFuY2VfLnN0YXJ0OTkzID0gc2NoZWR1bGVySW5zdGFuY2VJbnN0YW5jZV8uc3RhcnQ7CgogICAgICAgIGxldCByZXF1ZXN0aW5nRm4gPSBudWxsOwogICAgICAgIGxldCByZXF1ZXN0aW5nQXJncyA9IG51bGw7CgogICAgICAgIGNvbnN0IGYgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgICByZXF1ZXN0aW5nRm4gPSB0aGlzLmZuOwogICAgICAgICAgcmVxdWVzdGluZ0FyZ3MgPSBbLi4uYXJndW1lbnRzXTsKICAgICAgICAgIHJldHVybiAxMjM3MzsKICAgICAgICB9OwoKICAgICAgICBjb25zdCBmYWtlRm5zID0gWwogICAgICAgICAgZi5iaW5kKHsgZm46IHJlcXVlc3RBbmltYXRpb25GcmFtZSB9KSwKICAgICAgICAgIGYuYmluZCh7IGZuOiBzZXRJbnRlcnZhbCB9KSwKICAgICAgICAgIGYuYmluZCh7IGZuOiBzZXRUaW1lb3V0IH0pLAogICAgICAgICAgZi5iaW5kKHsgZm46IHJlcXVlc3RJZGxlQ2FsbGJhY2sgfSkKICAgICAgICBdOwoKICAgICAgICBsZXQgbXp0ID0gMDsKCiAgICAgICAgbGV0IF9mblNlbGVjdG9yUHJvcCA9IG51bGw7CiAgICAgICAgY29uc3QgbWtGbnMgPSBuZXcgQXJyYXkoNCk7CgogICAgICAgIC8qCiAgICAgICAgICBjYXNlIDE6CiAgICAgICAgICAgICAgdmFyIGEgPSB0aGlzLks7CiAgICAgICAgICAgICAgdGhpcy5nID0gdGhpcy5JID8gd2luZG93LnJlcXVlc3RJZGxlQ2FsbGJhY2soYSwgewogICAgICAgICAgICAgICAgICB0aW1lb3V0OiAzRTMKICAgICAgICAgICAgICB9KSA6IHdpbmRvdy5zZXRUaW1lb3V0KGEsIG1hKTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgIGNhc2UgMjoKICAgICAgICAgICAgICB0aGlzLmcgPSB3aW5kb3cuc2V0VGltZW91dCh0aGlzLk0sIHRoaXMuTik7CiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICBjYXNlIDM6CiAgICAgICAgICAgICAgdGhpcy5nID0gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSh0aGlzLkwpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgY2FzZSA0OgogICAgICAgICAgICAgIHRoaXMuZyA9IHdpbmRvdy5zZXRUaW1lb3V0KHRoaXMuSiwgMCkKICAgICAgICAgIH0KCiAgICAgICAgKi8KICAgICAgICBjb25zdCBzdGFydEZuSGFuZGxlciA9IHsKICAgICAgICAgIGdldCh0YXJnZXQsIHByb3AsIHJlY2VpdmVyKSB7CiAgICAgICAgICAgIGlmIChwcm9wID09PSAnJCQxMjM3NyQkJykgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIGlmIChwcm9wID09PSAnJCQxMjM3OCQkJykgcmV0dXJuIHRhcmdldDsKCiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCdnZXQnLHByb3ApCiAgICAgICAgICAgIHJldHVybiB0YXJnZXRbcHJvcF0KICAgICAgICAgIH0sCiAgICAgICAgICBzZXQodGFyZ2V0LCBwcm9wLCB2YWx1ZSwgcmVjZWl2ZXIpIHsKICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ3NldCcsIHByb3AsIHZhbHVlKQoKICAgICAgICAgICAgaWYgKHZhbHVlID49IDEgJiYgdmFsdWUgPD0gNCkgX2ZuU2VsZWN0b3JQcm9wID0gcHJvcDsKICAgICAgICAgICAgaWYgKHZhbHVlID09PSAxMjM3MyAmJiBfZm5TZWxlY3RvclByb3ApIHsKCiAgICAgICAgICAgICAgY29uc3Qgc2NoZWR1bGVyVHlwZVNlbGVjdGlvbiA9IHRhcmdldFtfZm5TZWxlY3RvclByb3BdOwogICAgICAgICAgICAgIGNvbnN0IHRpbWVySWRQcm9wID0gcHJvcDsKCiAgICAgICAgICAgICAgLy8gaWYgKHNjaGVkdWxlclR5cGVTZWxlY3Rpb24gJiYgc2NoZWR1bGVyVHlwZVNlbGVjdGlvbiA+PSAxICYmIHNjaGVkdWxlclR5cGVTZWxlY3Rpb24gPD0gNCAmJiB0aW1lcklkUHJvcCkgewogICAgICAgICAgICAgIC8vICAgc2NoZWR1bGVySW5zdGFuY2VQcm9wT2ZUaW1lclR5cGUgPSBfZm5TZWxlY3RvclByb3AgfHwgJyc7CiAgICAgICAgICAgICAgLy8gICBzY2hlZHVsZXJJbnN0YW5jZVByb3BPZlRpbWVySWQgPSB0aW1lcklkUHJvcCB8fCAnJzsKICAgICAgICAgICAgICAvLyB9CgogICAgICAgICAgICAgIGlmIChzY2hlZHVsZXJUeXBlU2VsZWN0aW9uID09PSAzICYmIHJlcXVlc3RpbmdGbiA9PT0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKSB7IC8vIHJBRihmbikKICAgICAgICAgICAgICAgIHRhcmdldFt0aW1lcklkUHJvcF0gPSBiYXNlUkFGLmFwcGx5KHdpbmRvdywgcmVxdWVzdGluZ0FyZ3MpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoc2NoZWR1bGVyVHlwZVNlbGVjdGlvbiA9PT0gMiAmJiByZXF1ZXN0aW5nRm4gPT09IHNldFRpbWVvdXQpIHsgLy8gc2V0VGltZW91dChmbiwgZGVsYXkpCiAgICAgICAgICAgICAgICAvLyByYXJlCiAgICAgICAgICAgICAgICB0YXJnZXRbdGltZXJJZFByb3BdID0gbWtGbnNbMl0uYXBwbHkod2luZG93LCByZXF1ZXN0aW5nQXJncyk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChzY2hlZHVsZXJUeXBlU2VsZWN0aW9uID09PSA0ICYmIHJlcXVlc3RpbmdGbiA9PT0gc2V0VGltZW91dCAmJiAhcmVxdWVzdGluZ0FyZ3NbMV0pIHsgLy8gc2V0VGltZW91dChmbiwgMCkKICAgICAgICAgICAgICAgIC8vIG9mdGVuCiAgICAgICAgICAgICAgICBpZiAoKEZJWF9zY2hlZHVsZXJJbnN0YW5jZUluc3RhbmNlICYgNCkgJiYgdHlwZW9mIG5leHRCcm93c2VyVGljayA9PSAnZnVuY3Rpb24nKSB7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGYgPSByZXF1ZXN0aW5nQXJnc1swXTsKICAgICAgICAgICAgICAgICAgY29uc3QgdGlyID0gKyttenQ7CiAgICAgICAgICAgICAgICAgIG5leHRCcm93c2VyVGljaygoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRhcmdldFt0aW1lcklkUHJvcF0gPT09IC10aXIpIGYoKTsKICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgIHRhcmdldFtfZm5TZWxlY3RvclByb3BdID0gOTQwOwogICAgICAgICAgICAgICAgICB0YXJnZXRbdGltZXJJZFByb3BdID0gLXRpcjsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIGNvbnN0IGYgPSByZXF1ZXN0aW5nQXJnc1swXTsKICAgICAgICAgICAgICAgICAgY29uc3QgdGlyID0gKyttenQ7CiAgICAgICAgICAgICAgICAgIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gewogICAgICAgICAgICAgICAgICAgIGlmICh0YXJnZXRbdGltZXJJZFByb3BdID09PSAtdGlyKSBmKCk7CiAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICB0YXJnZXRbX2ZuU2VsZWN0b3JQcm9wXSA9IDkzMDsKICAgICAgICAgICAgICAgICAgdGFyZ2V0W3RpbWVySWRQcm9wXSA9IC10aXI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfSBlbHNlIGlmIChzY2hlZHVsZXJUeXBlU2VsZWN0aW9uID09PSAxICYmIChyZXF1ZXN0aW5nRm4gPT09IHJlcXVlc3RJZGxlQ2FsbGJhY2sgfHwgcmVxdWVzdGluZ0ZuID09PSBzZXRUaW1lb3V0KSkgeyAvLyBzZXRUaW1lb3V0KHJlcXVlc3RJZGxlQ2FsbGJhY2spCiAgICAgICAgICAgICAgICAvLyBvZnRlbgogICAgICAgICAgICAgICAgaWYgKHJlcXVlc3RpbmdGbiA9PT0gcmVxdWVzdElkbGVDYWxsYmFjaykgewogICAgICAgICAgICAgICAgICB0YXJnZXRbdGltZXJJZFByb3BdID0gcmVxdWVzdElkbGVDYWxsYmFjay5hcHBseSh3aW5kb3csIHJlcXVlc3RpbmdBcmdzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgIHRhcmdldFt0aW1lcklkUHJvcF0gPSBta0Zuc1syXS5hcHBseSh3aW5kb3csIHJlcXVlc3RpbmdBcmdzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGFyZ2V0W19mblNlbGVjdG9yUHJvcF0gPSAwOwogICAgICAgICAgICAgICAgdGFyZ2V0W3RpbWVySWRQcm9wXSA9IDA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIHRhcmdldFtwcm9wXSA9IHZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGxldCBzdGFydEJ1c3kgPSBmYWxzZTsKICAgICAgICBzY2hlZHVsZXJJbnN0YW5jZUluc3RhbmNlXy5zdGFydCA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIGlmIChzdGFydEJ1c3kpIHJldHVybjsKICAgICAgICAgIHN0YXJ0QnVzeSA9IHRydWU7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICBta0Zuc1swXSA9IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWU7CiAgICAgICAgICAgIG1rRm5zWzFdID0gd2luZG93LnNldEludGVydmFsOwogICAgICAgICAgICBta0Zuc1syXSA9IHdpbmRvdy5zZXRUaW1lb3V0OwogICAgICAgICAgICBta0Zuc1szXSA9IHdpbmRvdy5yZXF1ZXN0SWRsZUNhbGxiYWNrOwogICAgICAgICAgICBjb25zdCB0VGhpcyA9IHRoaXNbJyQkMTIzNzgkJCddIHx8IHRoaXM7CiAgICAgICAgICAgIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPSBmYWtlRm5zWzBdCiAgICAgICAgICAgIHdpbmRvdy5zZXRJbnRlcnZhbCA9IGZha2VGbnNbMV0KICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQgPSBmYWtlRm5zWzJdCiAgICAgICAgICAgIHdpbmRvdy5yZXF1ZXN0SWRsZUNhbGxiYWNrID0gZmFrZUZuc1szXQogICAgICAgICAgICBfZm5TZWxlY3RvclByb3AgPSBudWxsOwogICAgICAgICAgICB0VGhpcy5zdGFydDk5My5jYWxsKG5ldyBQcm94eSh0VGhpcywgc3RhcnRGbkhhbmRsZXIpKTsKICAgICAgICAgICAgX2ZuU2VsZWN0b3JQcm9wID0gbnVsbDsKICAgICAgICAgICAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSA9IG1rRm5zWzBdOwogICAgICAgICAgICB3aW5kb3cuc2V0SW50ZXJ2YWwgPSBta0Zuc1sxXTsKICAgICAgICAgICAgd2luZG93LnNldFRpbWVvdXQgPSBta0Zuc1syXTsKICAgICAgICAgICAgd2luZG93LnJlcXVlc3RJZGxlQ2FsbGJhY2sgPSBta0Zuc1szXTsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS53YXJuKGUpOwogICAgICAgICAgfQogICAgICAgICAgc3RhcnRCdXN5ID0gZmFsc2U7CiAgICAgICAgfQoKICAgICAgICBzY2hlZHVsZXJJbnN0YW5jZUluc3RhbmNlXy5zdGFydC50b1N0cmluZyA9IHNjaGVkdWxlckluc3RhbmNlSW5zdGFuY2VfLnN0YXJ0OTkzLnRvU3RyaW5nLmJpbmQoc2NoZWR1bGVySW5zdGFuY2VJbnN0YW5jZV8uc3RhcnQ5OTMpOwoKICAgICAgfQogICAgfSkoKTsKCiAgICBGSVhfeXRfcGxheWVyICYmIChhc3luYyAoKSA9PiB7CiAgICAgIC8vIHJBZiBzY2hlZHVsaW5nCgogICAgICBjb25zdCBfeXRfcGxheWVyID0gYXdhaXQgX3l0X3BsYXllcl9vYnNlcnZhYmxlLm9idGFpbigpOwoKICAgICAgaWYgKCFfeXRfcGxheWVyIHx8IHR5cGVvZiBfeXRfcGxheWVyICE9PSAnb2JqZWN0JykgcmV0dXJuOwoKICAgICAgbGV0IGtleVpxT3UgPSBnZXRacU91KF95dF9wbGF5ZXIpOwoKCiAgICAgIGlmICgha2V5WnFPdSkgcmV0dXJuOwoKCiAgICAgIGNvbnN0IGcgPSBfeXRfcGxheWVyCiAgICAgIGxldCBrID0ga2V5WnFPdQoKICAgICAgY29uc3QgZ2sgPSBnW2tdOwogICAgICBpZiAodHlwZW9mIGdrICE9PSAnZnVuY3Rpb24nKSByZXR1cm47CiAgICAgIGNvbnN0IGdrcCA9IGdrLnByb3RvdHlwZTsKCiAgICAgIGxldCBkdW1teU9iamVjdCA9IG5ldyBnazsKICAgICAgbGV0IG5pbEZ1bmMgPSAoKSA9PiB7IH07CgogICAgICBsZXQgbmlsT2JqID0ge307CgogICAgICAvLyBjb25zb2xlLmxvZygxMTExMTExMTExKQoKICAgICAgbGV0IGtleUJvb2xEID0gJyc7CiAgICAgIGxldCBrZXlXaW5kb3cgPSAnJzsKICAgICAgbGV0IGtleUZ1bmNDID0gJyc7CiAgICAgIGxldCBrZXlDaWRqID0gJyc7CgogICAgICBmb3IgKGNvbnN0IFt0LCB5XSBvZiBPYmplY3QuZW50cmllcyhkdW1teU9iamVjdCkpIHsKICAgICAgICBpZiAoeSBpbnN0YW5jZW9mIFdpbmRvdykga2V5V2luZG93ID0gdDsKICAgICAgfQoKICAgICAgY29uc3QgZHVtbXlPYmplY3RQcm94eUhhbmRsZXIgPSB7CiAgICAgICAgZ2V0KHRhcmdldCwgcHJvcCkgewogICAgICAgICAgbGV0IHYgPSB0YXJnZXRbcHJvcF0KICAgICAgICAgIGlmICh2IGluc3RhbmNlb2YgV2luZG93ICYmICFrZXlXaW5kb3cpIHsKICAgICAgICAgICAga2V5V2luZG93ID0gdDsKICAgICAgICAgIH0KICAgICAgICAgIGxldCB5ID0gdHlwZW9mIHYgPT09ICdmdW5jdGlvbicgPyBuaWxGdW5jIDogdHlwZW9mIHYgPT09ICdvYmplY3QnID8gbmlsT2JqIDogdjsKICAgICAgICAgIGlmIChwcm9wID09PSBrZXlXaW5kb3cpIHkgPSB7CiAgICAgICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZShmKSB7CiAgICAgICAgICAgICAgcmV0dXJuIDM7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNhbmNlbEFuaW1hdGlvbkZyYW1lKCkgewoKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgICAgaWYgKCFrZXlGdW5jQyAmJiB0eXBlb2YgdiA9PT0gJ2Z1bmN0aW9uJyAmJiAhKHByb3AgaW4gdGFyZ2V0LmNvbnN0cnVjdG9yLnByb3RvdHlwZSkpIHsKICAgICAgICAgICAga2V5RnVuY0MgPSBwcm9wOwogICAgICAgICAgfQogICAgICAgICAgLy8gY29uc29sZS5sb2coJ1tnZXRdJywgcHJvcCwgdHlwZW9mIHRhcmdldFtwcm9wXSkKCgogICAgICAgICAgcmV0dXJuIHk7CiAgICAgICAgfSwKICAgICAgICBzZXQodGFyZ2V0LCBwcm9wLCB2YWx1ZSkgewoKICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdib29sZWFuJyAmJiAha2V5Qm9vbEQpIHsKICAgICAgICAgICAga2V5Qm9vbEQgPSBwcm9wOwogICAgICAgICAgfQogICAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicgJiYgIWtleUNpZGogJiYgdmFsdWUgPj0gMikgewogICAgICAgICAgICBrZXlDaWRqID0gcHJvcDsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBjb25zb2xlLmxvZygnW3NldF0nLCBwcm9wLCB2YWx1ZSkKICAgICAgICAgIHRhcmdldFtwcm9wXSA9IHZhbHVlCgogICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgZHVtbXlPYmplY3Quc3RhcnQuY2FsbChuZXcgUHJveHkoZHVtbXlPYmplY3QsIGR1bW15T2JqZWN0UHJveHlIYW5kbGVyKSk7CgogICAgICAvLyBjb25zb2xlLmxvZygnZ2twLnN0YXJ0Jyxna3Auc3RhcnQpOwogICAgICAvLyBjb25zb2xlLmxvZygnZ2twLnN0b3AnLGdrcC5zdG9wKTsKICAgICAgZ2twLl9hY3RpdmF0aW9uID0gZmFsc2U7CgogICAgICBna3Auc3RhcnQgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgLy8gcDU5IHx8IGNvbnNvbGUubG9nKDEyMTAwKQogICAgICAgIGlmICghdGhpcy5fYWN0aXZhdGlvbikgewogICAgICAgICAgdGhpcy5fYWN0aXZhdGlvbiA9IHRydWU7CiAgICAgICAgICBmb3JlZ3JvdW5kUHJvbWlzZUZuKCkudGhlbigoKSA9PiB7CiAgICAgICAgICAgIHRoaXMuX2FjdGl2YXRpb24gPSBmYWxzZTsKICAgICAgICAgICAgaWYgKHRoaXNba2V5Q2lkal0pIHsKICAgICAgICAgICAgICBQcm9taXNlLnJlc29sdmUoKS50aGVuKHRoaXNba2V5RnVuY0NdKTsKICAgICAgICAgICAgfQogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHRoaXNba2V5Q2lkal0gPSAxOwogICAgICAgIHRoaXNba2V5Qm9vbERdID0gdHJ1ZTsKICAgICAgfQogICAgICAgIDsKICAgICAgZ2twLnN0b3AgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgdGhpc1trZXlDaWRqXSA9IG51bGwKICAgICAgfQoKCiAgICAgIC8qCiAgICAgICAgZ1trXS5zdGFydCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLnN0b3AoKTsKICAgICAgICAgICAgdGhpcy5EID0gdHJ1ZTsKICAgICAgICAgICAgdmFyIGEgPSByZXF1ZXN0QW5pbWF0aW9uRnJhbWUKICAgICAgICAgICAgICAsIGIgPSBjYW5jZWxBbmltYXRpb25GcmFtZTsKICAgICAgICAgICAgdGhpcy5qID0gIGEuY2FsbCh0aGlzLkIsIHRoaXMuQykKICAgICAgICB9CiAgICAgICAgOwogICAgICAgIGdba10uc3RvcCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICBpZiAodGhpcy5pc0FjdGl2ZSgpKSB7CiAgICAgICAgICAgICAgICB2YXIgYSA9IHJlcXVlc3RBbmltYXRpb25GcmFtZQogICAgICAgICAgICAgICAgICAsIGIgPSBjYW5jZWxBbmltYXRpb25GcmFtZTsKICAgICAgICAgICAgICAgIGIuY2FsbCh0aGlzLkIsIHRoaXMuaikKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmogPSBudWxsCiAgICAgICAgfQogICAgICAqLwoKICAgICAgY29uc3Qga2V5em8gPSBQRVJGXzQ3MTQ4OV8gPyBnZXR6byhfeXRfcGxheWVyKSA6IG51bGw7CgogICAgICBpZiAoa2V5em8pIHsKCiAgICAgICAgayA9IGtleXpvOwoKICAgICAgICBjb25zdCBhdHRyVXBkYXRlRm4gPSBnW2tdOwogICAgICAgIC8vIGNvbnNvbGUubG9nKDU5OTIsIGF0dHJVcGRhdGVGbikKICAgICAgICBnWyckJG9yaWdpbmFsJCQnICsga10gPSBhdHRyVXBkYXRlRm47CiAgICAgICAgY29uc3Qgem9UcmFuc2Zvcm0gPSBhc3luYyAoYSwgYykgPT4gewoKICAgICAgICAgIGxldCB0cmFuc2Zvcm1UeXBlID0gJyc7CiAgICAgICAgICBsZXQgdHJhbnNmb3JtVmFsdWUgPSAwOwogICAgICAgICAgbGV0IHRyYW5zZm9ybVVuaXQgPSAnJzsKICAgICAgICAgIGxldCB0cmFuc2Zvcm1UeXBlSSA9IDA7CgogICAgICAgICAgY29uc3QgYVN0eWxlID0gYS5zdHlsZTsKCiAgICAgICAgICBpZiAoYy5sZW5ndGggPCA5KSB7CgogICAgICAgICAgfSBlbHNlIGlmIChjLnN0YXJ0c1dpdGgoJ3NjYWxleCgwLicpIHx8IChjID09PSAnc2NhbGV4KDApJyB8fCBjID09PSAnc2NhbGV4KDEpJykpIHsKICAgICAgICAgICAgbGV0IHAgPSBjLnN1YnN0cmluZyg3LCBjLmxlbmd0aCAtIDEpOwogICAgICAgICAgICBsZXQgcSA9IHAubGVuZ3RoID49IDEgPyBwYXJzZUZsb2F0KHApIDogLTE7CiAgICAgICAgICAgIGlmIChxID4gLTFlLTUgJiYgcSA8IDEgKyAxZS01KSB7CiAgICAgICAgICAgICAgdHJhbnNmb3JtVHlwZSA9ICdzY2FsZVgnCiAgICAgICAgICAgICAgdHJhbnNmb3JtVmFsdWUgPSBxOwogICAgICAgICAgICAgIHRyYW5zZm9ybVVuaXQgPSAnJzsKICAgICAgICAgICAgICB0cmFuc2Zvcm1UeXBlSSA9IDE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoYy5zdGFydHNXaXRoKCd0cmFuc2xhdGVYKCcpICYmIGMuZW5kc1dpdGgoJ3B4KScpKSB7CiAgICAgICAgICAgIGxldCBwID0gYy5zdWJzdHJpbmcoMTEsIGMubGVuZ3RoIC0gMyk7CiAgICAgICAgICAgIGxldCBxID0gcC5sZW5ndGggPj0gMSA/IHBhcnNlRmxvYXQocCkgOiBOYU47CiAgICAgICAgICAgIGlmICh0eXBlb2YgcSA9PT0gJ251bWJlcicgJiYgIWlzTmFOKHEpKSB7CiAgICAgICAgICAgICAgdHJhbnNmb3JtVHlwZSA9ICd0cmFuc2xhdGVYJwogICAgICAgICAgICAgIHRyYW5zZm9ybVZhbHVlID0gcTsKICAgICAgICAgICAgICB0cmFuc2Zvcm1Vbml0ID0gJ3B4JzsKICAgICAgICAgICAgICB0cmFuc2Zvcm1UeXBlSSA9IDI7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocCA9PT0gJ05hTicpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgIH0gZWxzZSBpZiAoYy5zdGFydHNXaXRoKCdzY2FsZXkoMC4nKSB8fCAoYyA9PT0gJ3NjYWxleSgwKScgfHwgYyA9PT0gJ3NjYWxleSgxKScpKSB7CiAgICAgICAgICAgIGxldCBwID0gYy5zdWJzdHJpbmcoNywgYy5sZW5ndGggLSAxKTsKICAgICAgICAgICAgbGV0IHEgPSBwLmxlbmd0aCA+PSAxID8gcGFyc2VGbG9hdChwKSA6IC0xOwogICAgICAgICAgICBpZiAocSA+IC0xZS01ICYmIHEgPCAxICsgMWUtNSkgewogICAgICAgICAgICAgIHRyYW5zZm9ybVR5cGUgPSAnc2NhbGVZJwogICAgICAgICAgICAgIHRyYW5zZm9ybVZhbHVlID0gcTsKICAgICAgICAgICAgICB0cmFuc2Zvcm1Vbml0ID0gJyc7CiAgICAgICAgICAgICAgdHJhbnNmb3JtVHlwZUkgPSAxOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGMuc3RhcnRzV2l0aCgndHJhbnNsYXRlWSgnKSAmJiBjLmVuZHNXaXRoKCdweCknKSkgewogICAgICAgICAgICBsZXQgcCA9IGMuc3Vic3RyaW5nKDExLCBjLmxlbmd0aCAtIDMpOwogICAgICAgICAgICBsZXQgcSA9IHAubGVuZ3RoID49IDEgPyBwYXJzZUZsb2F0KHApIDogTmFOOwogICAgICAgICAgICBpZiAodHlwZW9mIHEgPT09ICdudW1iZXInICYmICFpc05hTihxKSkgewogICAgICAgICAgICAgIHRyYW5zZm9ybVR5cGUgPSAndHJhbnNsYXRlWScKICAgICAgICAgICAgICB0cmFuc2Zvcm1WYWx1ZSA9IHE7CiAgICAgICAgICAgICAgdHJhbnNmb3JtVW5pdCA9ICdweCc7CiAgICAgICAgICAgICAgdHJhbnNmb3JtVHlwZUkgPSAyOwogICAgICAgICAgICB9IGVsc2UgaWYgKHAgPT09ICdOYU4nKSB7CiAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICB9CiAgICAgICAgICB9IGVsc2UgaWYgKGMuc3RhcnRzV2l0aCgnc2NhbGV4KCcpICYmIGMuaW5jbHVkZXMoJ2UtJykpIHsKICAgICAgICAgICAgLy8gc2NhbGV4KDEuMjUyMDU3Njg0MTU4NzY3ZS0xNikKICAgICAgICAgICAgLy8gc2NhbGV4KDMuMDM5MzYzMjA2OTczNDk0OGUtOSkKICAgICAgICAgICAgbGV0IHAgPSBjLnN1YnN0cmluZyg3LCBjLmxlbmd0aCAtIDEpOwogICAgICAgICAgICBsZXQgcSA9IHAubGVuZ3RoID49IDEgPyBwYXJzZUZsb2F0KHApIDogLTE7CiAgICAgICAgICAgIGlmIChxID4gLTFlLTUgJiYgcSA8IDFlLTUpIHsKICAgICAgICAgICAgICB0cmFuc2Zvcm1UeXBlID0gJ3NjYWxlWCcKICAgICAgICAgICAgICB0cmFuc2Zvcm1WYWx1ZSA9IDA7CiAgICAgICAgICAgICAgdHJhbnNmb3JtVW5pdCA9ICcnOwogICAgICAgICAgICAgIHRyYW5zZm9ybVR5cGVJID0gMTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChjLnN0YXJ0c1dpdGgoJ3NjYWxleSgnKSAmJiBjLmluY2x1ZGVzKCdlLScpKSB7CiAgICAgICAgICAgIGxldCBwID0gYy5zdWJzdHJpbmcoNywgYy5sZW5ndGggLSAxKTsKICAgICAgICAgICAgbGV0IHEgPSBwLmxlbmd0aCA+PSAxID8gcGFyc2VGbG9hdChwKSA6IC0xOwogICAgICAgICAgICBpZiAocSA+IC0xZS01ICYmIHEgPCAxZS01KSB7CiAgICAgICAgICAgICAgdHJhbnNmb3JtVHlwZSA9ICdzY2FsZVknCiAgICAgICAgICAgICAgdHJhbnNmb3JtVmFsdWUgPSAwOwogICAgICAgICAgICAgIHRyYW5zZm9ybVVuaXQgPSAnJzsKICAgICAgICAgICAgICB0cmFuc2Zvcm1UeXBlSSA9IDE7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBpZiAodHJhbnNmb3JtVHlwZUkgPT09IDEpIHsKICAgICAgICAgICAgY29uc3QgcSA9IE1hdGgucm91bmQodHJhbnNmb3JtVmFsdWUgKiBzdGVwcGluZ1NjYWxlTikgLyBzdGVwcGluZ1NjYWxlTjsKICAgICAgICAgICAgY29uc3QgdnogPSB0b0ZpeGVkMihxLCAzKTsKICAgICAgICAgICAgYyA9IGAke3RyYW5zZm9ybVR5cGV9KCR7dnp9KWA7CiAgICAgICAgICAgIGNvbnN0IGN2ID0gYVN0eWxlLnRyYW5zZm9ybTsKICAgICAgICAgICAgaWYgKGMgPT09IGN2KSByZXR1cm47CiAgICAgICAgICAgIGFTdHlsZS50cmFuc2Zvcm0gPSBjOwogICAgICAgICAgfSBlbHNlIGlmICh0cmFuc2Zvcm1UeXBlSSA9PT0gMikgewogICAgICAgICAgICBjb25zdCBxID0gdHJhbnNmb3JtVmFsdWU7CiAgICAgICAgICAgIGNvbnN0IHZ6ID0gdG9GaXhlZDIocSwgMSk7CiAgICAgICAgICAgIGMgPSBgJHt0cmFuc2Zvcm1UeXBlfSgke3Z6fSR7dHJhbnNmb3JtVW5pdH0pYDsKICAgICAgICAgICAgY29uc3QgY3YgPSBhU3R5bGUudHJhbnNmb3JtOwogICAgICAgICAgICBpZiAoYyA9PT0gY3YpIHJldHVybjsKICAgICAgICAgICAgYVN0eWxlLnRyYW5zZm9ybSA9IGM7CiAgICAgICAgICB9IGVsc2UgeyAvLyBlZyBlbXB0eQogICAgICAgICAgICBjb25zdCBjdiA9IGFTdHlsZS50cmFuc2Zvcm07CiAgICAgICAgICAgIGlmICghYyAmJiAhY3YpIHJldHVybjsKICAgICAgICAgICAgZWxzZSBpZiAoYyA9PT0gY3YpIHJldHVybjsKICAgICAgICAgICAgYVN0eWxlLnRyYW5zZm9ybSA9IGM7CiAgICAgICAgICB9CgogICAgICAgIH07CgogICAgICAgIGNvbnN0IGVsbVRyYW5zZm9ybVRlbXAgPSBuZXcgV2Vha01hcCgpOwogICAgICAgIGNvbnN0IGVsbVByb3BUZW1wcyA9IHsKICAgICAgICAgICdkaXNwbGF5JzogbmV3IFdlYWtNYXAoKSwKICAgICAgICAgICd3aWR0aCc6IG5ldyBXZWFrTWFwKCksCiAgICAgICAgICAnaGVpZ2h0JzogbmV3IFdlYWtNYXAoKSwKICAgICAgICAgICdvdXRsaW5lV2lkdGgnOiBuZXcgV2Vha01hcCgpLAogICAgICAgICAgJ3Bvc2l0aW9uJzogbmV3IFdlYWtNYXAoKSwKICAgICAgICAgICdwYWRkaW5nJzogbmV3IFdlYWtNYXAoKSwKICAgICAgICAgICJjc3NUZXh0IjogbmV3IFdlYWtNYXAoKSwKICAgICAgICAgICJyaWdodCI6IG5ldyBXZWFrTWFwKCksCiAgICAgICAgICAibGVmdCI6IG5ldyBXZWFrTWFwKCksCiAgICAgICAgICAidG9wIjogbmV3IFdlYWtNYXAoKSwKICAgICAgICAgICJib3R0b20iOiBuZXcgV2Vha01hcCgpLAogICAgICAgICAgInRyYW5zaXRpb25EZWxheSI6IG5ldyBXZWFrTWFwKCksCiAgICAgICAgICAibWFyZ2luTGVmdCI6IG5ldyBXZWFrTWFwKCksCiAgICAgICAgICAibWFyZ2luVG9wIjogbmV3IFdlYWtNYXAoKSwKICAgICAgICAgICJtYXJnaW5SaWdodCI6IG5ldyBXZWFrTWFwKCksCiAgICAgICAgICAibWFyZ2luQm90dG9tIjogbmV3IFdlYWtNYXAoKSwKICAgICAgICB9CgogICAgICAgIGNvbnN0IG5zNSA9IFN5bWJvbCgpOwogICAgICAgIGNvbnN0IG5leHRNb2RpZnkgPSAoYSwgYywgbSwgZiwgaW1tZWRpYXRlKSA9PiB7CiAgICAgICAgICBjb25zdCBhXyA9IGE7CiAgICAgICAgICBjb25zdCBtXyA9IG07CiAgICAgICAgICBjb25zdCBub0tleSA9ICFtXy5oYXMoYV8pOwogICAgICAgICAgaWYgKGltbWVkaWF0ZSB8fCBub0tleSkgewogICAgICAgICAgICBtXy5zZXQoYV8sIG5zNSk7CiAgICAgICAgICAgIGYoYV8sIGMpOwogICAgICAgICAgICBub0tleSAmJiBuZXh0QnJvd3NlclRpY2tfKCgpID0+IHsKICAgICAgICAgICAgICBjb25zdCBkID0gbV8uZ2V0KGFfKTsKICAgICAgICAgICAgICBpZiAoZCA9PT0gdW5kZWZpbmVkKSByZXR1cm47CiAgICAgICAgICAgICAgbV8uZGVsZXRlKGFfKTsKICAgICAgICAgICAgICBpZiAoZCAhPT0gbnM1KSBmKGFfLCBkKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBtXy5zZXQoYV8sIGMpOwogICAgICAgICAgfQogICAgICAgIH07CgogICAgICAgIGNvbnN0IHNldDY2ID0gbmV3IFNldCgpOwogICAgICAgIC8vIGNvbnN0IHNldDc3ID0gbmV3IFNldChbJ3RvcCcsICdsZWZ0JywgJ2JvdHRvbScsICdyaWdodCddKTsgLy8gY2FwdGlvbiBwb3NpdGlvbmluZyAtIGltbWVkaWF0ZSBjaGFuZ2UKCiAgICAgICAgY29uc3QgbW9kaWZpZWRGbiA9IGZ1bmN0aW9uIChhLCBiLCBjLCBpbW1lZGlhdGVDaGFuZ2UgPSBmYWxzZSkgeyAvLyBhcnJvdyBmdW5jdGlvbiBkb2VzIG5vdCBoYXZlIGZ1bmN0aW9uLnByb3RvdHlwZQoKICAgICAgICAgIC8vIGNvbnNvbGUubG9nKDE0MDAwMCwgYSwgYiwgYyk7CiAgICAgICAgICBpZiAodHlwZW9mIGMgPT09ICdudW1iZXInICYmIHR5cGVvZiBiID09PSAnc3RyaW5nJyAmJiBhIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpIHsKICAgICAgICAgICAgY29uc3QgbnVtID0gYzsKICAgICAgICAgICAgYyA9IGAke251bX1gOwogICAgICAgICAgICBpZiAoYy5sZW5ndGggPiA1KSBjID0gKG51bSA8IDEwICYmIG51bSA+IC0xMCkgPyB0b0ZpeGVkMihudW0sIDMpIDogdG9GaXhlZDIobnVtLCAxKTsKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAodHlwZW9mIGIgPT09ICdzdHJpbmcnICYmIHR5cGVvZiBjID09PSAnc3RyaW5nJyAmJiBhIGluc3RhbmNlb2YgSFRNTEVsZW1lbnQpIHsKCiAgICAgICAgICAgIGxldCBlbG1Qcm9wVGVtcCA9IG51bGw7CgogICAgICAgICAgICBpZiAoYiA9PT0gInRyYW5zZm9ybSIpIHsKCiAgICAgICAgICAgICAgbmV4dE1vZGlmeShhLCBjLCBlbG1UcmFuc2Zvcm1UZW1wLCB6b1RyYW5zZm9ybSwgaW1tZWRpYXRlQ2hhbmdlKTsKICAgICAgICAgICAgICByZXR1cm47CgogICAgICAgICAgICB9IGVsc2UgaWYgKGVsbVByb3BUZW1wID0gZWxtUHJvcFRlbXBzW2JdKSB7CgogICAgICAgICAgICAgIC8vIGlmIChjLmxlbmd0aCA+IDUgJiYgYy5pbmNsdWRlcygnLicpKSB7CiAgICAgICAgICAgICAgLy8gICBjb25zb2xlLmxvZygxMjMyMTMsIGMpCiAgICAgICAgICAgICAgLy8gfQoKICAgICAgICAgICAgICBjb25zdCBiXyA9IGI7CiAgICAgICAgICAgICAgbmV4dE1vZGlmeShhLCBjLCBlbG1Qcm9wVGVtcCwgKGEsIGMpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IHN0eWxlID0gYS5zdHlsZTsKICAgICAgICAgICAgICAgIGNvbnN0IGN2ID0gc3R5bGVbYl9dOwogICAgICAgICAgICAgICAgaWYgKCFjdiAmJiAhYykgcmV0dXJuOwogICAgICAgICAgICAgICAgaWYgKGN2ID09PSBjKSByZXR1cm47CiAgICAgICAgICAgICAgICBzdHlsZVtiX10gPSBjOwogICAgICAgICAgICAgIH0sIGltbWVkaWF0ZUNoYW5nZSk7CiAgICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgICAgfSBlbHNlIGlmIChiID09PSAib3V0bGluZS13aWR0aCIpIHsKCiAgICAgICAgICAgICAgY29uc3QgYl8gPSAnb3V0bGluZVdpZHRoJzsKICAgICAgICAgICAgICBlbG1Qcm9wVGVtcCA9IGVsbVByb3BUZW1wc1tiX107CiAgICAgICAgICAgICAgbmV4dE1vZGlmeShhLCBjLCBlbG1Qcm9wVGVtcCwgKGEsIGMpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IHN0eWxlID0gYS5zdHlsZTsKICAgICAgICAgICAgICAgIGNvbnN0IGN2ID0gc3R5bGVbYl9dOwogICAgICAgICAgICAgICAgaWYgKCFjdiAmJiAhYykgcmV0dXJuOwogICAgICAgICAgICAgICAgaWYgKGN2ID09PSBjKSByZXR1cm47CiAgICAgICAgICAgICAgICBzdHlsZVtiX10gPSBjOwogICAgICAgICAgICAgIH0sIGltbWVkaWF0ZUNoYW5nZSk7CiAgICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgICAgfSBlbHNlIGlmIChiID09PSAnbWF4V2lkdGgnIHx8IGIgPT09ICdtYXhIZWlnaHQnKSB7CiAgICAgICAgICAgICAgLy8gSSB0aGluayB0aGVzZSBjYW4gYmUgZGlyZWN0bHkgYXNzaWduZWQuCgogICAgICAgICAgICAgIGNvbnN0IGJfID0gYjsKICAgICAgICAgICAgICBjb25zdCBzdHlsZSA9IGEuc3R5bGU7CiAgICAgICAgICAgICAgY29uc3QgY3YgPSBzdHlsZVtiX107CiAgICAgICAgICAgICAgaWYgKCFjdiAmJiAhYykgcmV0dXJuOwogICAgICAgICAgICAgIGlmIChjdiA9PT0gYykgcmV0dXJuOwogICAgICAgICAgICAgIHN0eWxlW2JfXSA9IGM7CiAgICAgICAgICAgICAgcmV0dXJuOwoKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAvLyBpZihpbW1lZGlhdGUgJiYgZWxtUHJvcFRlbXBzW2JdKXsKICAgICAgICAgICAgICAvLyAgIGNvbnNvbGUubG9nKDUxOTEsIGIpCiAgICAgICAgICAgICAgLy8gfQogICAgICAgICAgICAgIC8vIGNhcHRpb24td2luZG93CiAgICAgICAgICAgICAgLy8gbWFyZ2luLWxlZnQgbWF4LWhlaWdodCBtYXgtd2lkdGggZm9udC1mYW1pbHkgZmlsbCBjb2xvciBmb250LXNpemUgYmFja2dyb3VuZCB3aGl0ZS1zcGFjZSBtYXJnaW4KICAgICAgICAgICAgICAvLyB0ZXh0LWFsaWduIGJhY2tncm91bmQtY29sb3IKICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygyNzMwNCwgYSwgYiwgYykKICAgICAgICAgICAgICBpZiAoIXNldDY2LmhhcyhiKSkgewogICAgICAgICAgICAgICAgc2V0NjYuYWRkKGIpOwogICAgICAgICAgICAgICAgbmV4dEJyb3dzZXJUaWNrXygoKSA9PiB7CiAgICAgICAgICAgICAgICAgIGlmICghYS5jbGFzc0xpc3QuY29udGFpbnMoJ2NhcHRpb24td2luZG93JykgJiYgIWEuY2xhc3NMaXN0LmNvbnRhaW5zKCd5dHAtY2FwdGlvbi1zZWdtZW50JykpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygyNzMwNCwgYSwgYiwgYykKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGF0dHJVcGRhdGVGbi5jYWxsKHRoaXMsIGEsIGIsIGMpOwogICAgICAgICAgICByZXR1cm47CiAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiAoYiB8fCAwKSA9PT0gJ29iamVjdCcpIHsKCiAgICAgICAgICAgIC8vIHRoaXMgaXMgdG8gZml4IGNhcHRpb24gcG9zaXRpb25pbmcKICAgICAgICAgICAgLy8gY29uc3QgaW1tZWRpYXRlID0gKGEuaWQgfHwgMCkubGVuZ3RoID4gMTQgJiYgKCgndG9wJyBpbiBiKSB8fCAoJ2xlZnQnIGluIGIpIHx8ICgncmlnaHQnIGluIGIpIHx8ICgnYm90dG9tJyBpbiBiKSk7CiAgICAgICAgICAgIGNvbnN0IGltbWVkaWF0ZSA9IChhLmlkIHx8IDApLmxlbmd0aCA+IDE0OwogICAgICAgICAgICBmb3IgKGNvbnN0IFtrLCB2XSBvZiBPYmplY3QuZW50cmllcyhiKSkgewogICAgICAgICAgICAgIG1vZGlmaWVkRm4uY2FsbCh0aGlzLCBhLCBrLCB2LCBpbW1lZGlhdGUpOwogICAgICAgICAgICB9CgogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc29sZS5sb2coMjczMDYsIGEsIGIsIGMpOwoKICAgICAgICAgICAgYXR0clVwZGF0ZUZuLmNhbGwodGhpcywgYSwgYiwgYyk7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgIH0KCiAgICAgICAgICAvLyBjb25zb2xlLmxvZygxMzAwMDAsIGEsIGIsIGMpOwoKICAgICAgICB9OwogICAgICAgIGdba10gPSBtb2RpZmllZEZuOwoKCiAgICAgICAgLyoKCiAgICAgICAgICAgIGcuem8gPSBmdW5jdGlvbihhLCBiLCBjKSB7CiAgICAgICAgICAgICAgICBpZiAoInN0cmluZyIgPT09IHR5cGVvZiBiKQogICAgICAgICAgICAgICAgICAgIChiID0geW8oYSwgYikpICYmIChhLnN0eWxlW2JdID0gYyk7CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgZCBpbiBiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGMgPSBhOwogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZSA9IGJbZF0KICAgICAgICAgICAgICAgICAgICAgICAgICAsIGYgPSB5byhjLCBkKTsKICAgICAgICAgICAgICAgICAgICAgICAgZiAmJiAoYy5zdHlsZVtmXSA9IGUpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CgoKICAgICAgICAqLwoKCiAgICAgIH0KCgoKICAgICAgY29uc3Qga2V5dUcgPSBQRVJGXzQ3MTQ4OV8gPyBnZXR1RyhfeXRfcGxheWVyKSA6IG51bGw7CgogICAgICBpZiAoa2V5dUcpIHsKCiAgICAgICAgayA9IGtleXVHOwoKICAgICAgICBjb25zdCBnayA9IGdba107CiAgICAgICAgY29uc3QgZ2twID0gZ2sucHJvdG90eXBlOwoKCiAgICAgICAgLyoqIEB0eXBlIHsgTWFwPHN0cmluZywgV2Vha01hcDxhbnksIGFueT4+IH0gKi8KICAgICAgICBjb25zdCBudExvZ3MgPSBuZXcgTWFwKCk7CgogICAgICAgIGlmICh0eXBlb2YgZ2twLnVwZGF0ZVZhbHVlID09PSAnZnVuY3Rpb24nICYmIGdrcC51cGRhdGVWYWx1ZS5sZW5ndGggPT09IDIgJiYgIWdrcC51cGRhdGVWYWx1ZTMxKSB7CgogICAgICAgICAgZ2twLnVwZGF0ZVZhbHVlMzEgPSBna3AudXBkYXRlVmFsdWU7CiAgICAgICAgICBna3AudXBkYXRlVmFsdWUgPSBmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICBpZiAodHlwZW9mIGEgIT09ICdzdHJpbmcnKSByZXR1cm4gdGhpcy51cGRhdGVWYWx1ZTMxKGEsIGIpOwoKICAgICAgICAgICAgY29uc3QgZWxlbWVudCA9IHRoaXMuZWxlbWVudDsKICAgICAgICAgICAgaWYgKCEoZWxlbWVudCBpbnN0YW5jZW9mIEhUTUxFbGVtZW50KSkgcmV0dXJuIHRoaXMudXBkYXRlVmFsdWUzMShhLCBiKTsKCiAgICAgICAgICAgIGxldCBudExvZyA9IG50TG9ncy5nZXQoYSk7CiAgICAgICAgICAgIGlmICghbnRMb2cpIG50TG9ncy5zZXQoYSwgKG50TG9nID0gbmV3IFdlYWtNYXAoKSkpOwoKICAgICAgICAgICAgbGV0IGNhY2hlID0gbnRMb2cuZ2V0KGVsZW1lbnQpOwogICAgICAgICAgICBpZiAoY2FjaGUgJiYgY2FjaGUudmFsdWUgPT09IGIpIHsKICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFjYWNoZSkgewogICAgICAgICAgICAgIHRoaXMuX19vbGRWYWx1ZUJ5VXBkYXRlVmFsdWVfXyA9IG51bGw7CiAgICAgICAgICAgICAgbnRMb2cuc2V0KGVsZW1lbnQsIGNhY2hlID0geyB2YWx1ZTogYiB9KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICB0aGlzLl9fb2xkVmFsdWVCeVVwZGF0ZVZhbHVlX18gPSBjYWNoZS52YWx1ZTsKICAgICAgICAgICAgICBjYWNoZS52YWx1ZSA9IGI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB0aGlzLnVwZGF0ZVZhbHVlMzEoYSwgYik7CiAgICAgICAgICB9CgogICAgICAgICAgLyoKICAgICAgICAgICAgZy5rLnVwZGF0ZSA9IGZ1bmN0aW9uKGEpIHsKICAgICAgICAgICAgICAgIGZvciAodmFyIGIgPSBnLnUoT2JqZWN0LmtleXMoYSkpLCBjID0gYi5uZXh0KCk7ICFjLmRvbmU7IGMgPSBiLm5leHQoKSkKICAgICAgICAgICAgICAgICAgICBjID0gYy52YWx1ZSwKICAgICAgICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVZhbHVlKGMsIGFbY10pCiAgICAgICAgICAgIH0KICAgICAgICAgICAgOwogICAgICAgICAgICBnLmsudXBkYXRlVmFsdWUgPSBmdW5jdGlvbihhLCBiKSB7CiAgICAgICAgICAgICAgICAoYSA9IHRoaXMuVGRbInt7IiArIGEgKyAifX0iXSkgJiYgd0codGhpcywgYVswXSwgYVsxXSwgYikKICAgICAgICAgICAgfQogICAgICAgICAgKi8KCiAgICAgICAgfQoKCiAgICAgIH0KCgoKCiAgICB9KSgpOwoKCiAgICBGSVhfeXRfcGxheWVyICYmIEZJWF9TSE9SVENVVEtFWVMgPiAwICYmIChhc3luYyAoKSA9PiB7CiAgICAgIC8vIGtleWJvYXJkIHNob3J0Y3V0IGtleXMgY29udHJvbGxlcgoKICAgICAgY29uc3QgX3l0X3BsYXllciA9IGF3YWl0IF95dF9wbGF5ZXJfb2JzZXJ2YWJsZS5vYnRhaW4oKTsKCiAgICAgIGlmICghX3l0X3BsYXllciB8fCB0eXBlb2YgX3l0X3BsYXllciAhPT0gJ29iamVjdCcpIHJldHVybjsKCiAgICAgIGtleWJvYXJkQ29udHJvbGxlcihfeXRfcGxheWVyKTsKCiAgICB9KSgpOwoKICAgIEZJWF95dF9wbGF5ZXIgJiYgKGFzeW5jICgpID0+IHsKICAgICAgLy8gdGltZXIgc2NoZWR1bGluZwoKICAgICAgY29uc3QgX3l0X3BsYXllciA9IGF3YWl0IF95dF9wbGF5ZXJfb2JzZXJ2YWJsZS5vYnRhaW4oKTsKCiAgICAgIGlmICghX3l0X3BsYXllciB8fCB0eXBlb2YgX3l0X3BsYXllciAhPT0gJ29iamVjdCcpIHJldHVybjsKCiAgICAgIGxldCBrZXlacVF1ID0gZ2V0WnFRdShfeXRfcGxheWVyKTsKCiAgICAgIGlmICgha2V5WnFRdSkgcmV0dXJuOwoKICAgICAgY29uc3QgZyA9IF95dF9wbGF5ZXIKICAgICAgbGV0IGsgPSBrZXlacVF1CgogICAgICBjb25zdCBnayA9IGdba107CiAgICAgIGlmICh0eXBlb2YgZ2sgIT09ICdmdW5jdGlvbicpIHJldHVybjsKICAgICAgY29uc3QgZ2twID0gZ2sucHJvdG90eXBlOwoKICAgICAgY29uc3QgZXh0cmFjdEtleXNacVF1ID0gKCkgPT4gewoKCiAgICAgICAgbGV0IF9rZXllQyA9ICcnOwogICAgICAgIHRyeSB7CiAgICAgICAgICBna3Auc3RvcC5jYWxsKG5ldyBQcm94eSh7CiAgICAgICAgICAgIGlzQWN0aXZlOiAoKSA9PiB7IH0KICAgICAgICAgIH0sIHsKICAgICAgICAgICAgc2V0KHRhcmdldCwgcHJvcCwgdmFsdWUpIHsKICAgICAgICAgICAgICBpZiAodmFsdWUgPT09IDApIF9rZXllQyA9IHByb3A7CiAgICAgICAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICAgIH0pKTsKICAgICAgICB9IGNhdGNoIChlKSB7IH0KICAgICAgICBpZiAoIV9rZXllQykgcmV0dXJuOwogICAgICAgIGNvbnN0IGtleWVDID0gX2tleWVDOwoKICAgICAgICBsZXQga2V5QyA9ICcnOyAvLyB0aGlzLkMgPSB0aGlzLlNULmJpbmQodGhpcykKICAgICAgICBsZXQga2V5aGogPSAnJzsgLy8gMTAwMG1zCiAgICAgICAgdHJ5IHsKICAgICAgICAgIGdrcC5zdGFydC5jYWxsKG5ldyBQcm94eSh7CiAgICAgICAgICAgIHN0b3A6ICgpID0+IHsgfSwKICAgICAgICAgICAgW2tleWVDXTogMCwKICAgICAgICAgIH0sIHsKICAgICAgICAgICAgZ2V0KHRhcmdldCwgcHJvcCkgewogICAgICAgICAgICAgIGlmIChwcm9wIGluIHRhcmdldCkgcmV0dXJuIHRhcmdldFtwcm9wXTsKICAgICAgICAgICAgICBpZiAoIWtleUMpIHsKICAgICAgICAgICAgICAgIGtleUMgPSBwcm9wOwogICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7IC8vIHRocm93IGVycm9yCiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGVsc2UgaWYgKCFrZXloaikgewogICAgICAgICAgICAgICAga2V5aGogPSBwcm9wOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgIH0KICAgICAgICAgIH0pKTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICBpZiAoIWtleUMgfHwgIWtleWhqKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpCiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAoIWtleUMgfHwgIWtleWhqKSByZXR1cm47CiAgICAgICAgbGV0IGtleVNUID0gJyc7CiAgICAgICAgbGV0IGtleWogPSAnJzsKICAgICAgICBsZXQga2V5QiA9ICcnOwogICAgICAgIGxldCBrZXl4YSA9ICcnOwoKICAgICAgICBjb25zdCBwb3NzaWJsZUtzID0gbmV3IFNldCgpOwoKICAgICAgICBmb3IgKGNvbnN0IFtrLCB2XSBvZiBPYmplY3QuZW50cmllcyhna3ApKSB7CiAgICAgICAgICBpZiAoayA9PT0gJ3N0b3AnIHx8IGsgPT09ICdzdGFydCcgfHwgayA9PT0gJ2lzQWN0aXZlJyB8fCBrID09PSAnY29uc3RydWN0b3InIHx8IGsgPT09IGtleWVDIHx8IGsgPT09IGtleUMgfHwgayA9PT0ga2V5aGopIHsKICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICB9CiAgICAgICAgICBpZiAodHlwZW9mIHYgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgY29uc3QgbSA9IC90aGlzXC4oXHcrKVwuY2FsbFwodGhpc1wuKFx3KylcKS8uZXhlYyh2ICsgJycpOwogICAgICAgICAgICBpZiAobSkgewogICAgICAgICAgICAgIGtleVNUID0gazsKICAgICAgICAgICAgICBrZXlqID0gbVsxXTsKICAgICAgICAgICAgICBrZXlCID0gbVsyXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICBwb3NzaWJsZUtzLmFkZChrKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgKCFrZXlTVCB8fCAha2V5aiB8fCAha2V5QikgcmV0dXJuOwoKICAgICAgICBmb3IgKGNvbnN0IGsgb2YgcG9zc2libGVLcykgewogICAgICAgICAgaWYgKGsgPT09IGtleVNUIHx8IGsgPT09IGtleWogfHwgayA9PT0ga2V5QikgewogICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgIH0KICAgICAgICAgIGNvbnN0IHYgPSBna3Bba107CiAgICAgICAgICBpZiAodHlwZW9mIHYgPT09ICdmdW5jdGlvbicgJiYgKHYgKyAnJykuaW5jbHVkZXMoYHRoaXMuc3RvcCgpO2RlbGV0ZSB0aGlzLiR7a2V5an07ZGVsZXRlIHRoaXMuJHtrZXlCfWApKSB7CiAgICAgICAgICAgIGtleXhhID0gazsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIHJldHVybiBba2V5ZUMsIGtleUMsIGtleWhqLCBrZXlTVCwga2V5aiwga2V5Qiwga2V5eGFdOwoKICAgICAgfQoKICAgICAgY29uc3Qga2V5cyA9IGV4dHJhY3RLZXlzWnFRdSgpOwogICAgICBpZiAoIWtleXMgfHwgIWtleXMubGVuZ3RoKSByZXR1cm47CiAgICAgIGNvbnN0IFtrZXllQywga2V5Qywga2V5aGosIGtleVNULCBrZXlqLCBrZXlCLCBrZXl4YV0gPSBrZXlzOyAvLyBbdGltZXJJZCwgYmluZGVkIGV4ZWN1dG9yRm4sIDEwMDBtcywgZXhlY3V0b3JGbiwgZGF0YUosIG9iamVjdEIsIGRpc3Bvc2VGbl0KCiAgICAgIGlmICgha2V5ZUMgfHwgIWtleUMgfHwgIWtleWhqIHx8ICFrZXlTVCB8fCAha2V5aiB8fCAha2V5QiB8fCAha2V5eGEpIHJldHVybjsKCiAgICAgIGxldCBkaXNwb3NlS2V5cyA9IG51bGw7CgogICAgICBna3Bba2V5eGFdID0gZnVuY3Rpb24gKCkgewogICAgICAgIC8vIGRpc3Bvc2UKICAgICAgICBpZiAoIWRpc3Bvc2VLZXlzKSB7CiAgICAgICAgICBkaXNwb3NlS2V5cyA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHRoaXMpLmZpbHRlcihrZXkgPT4gewogICAgICAgICAgICBpZiAoa2V5ICE9IGtleWVDICYmIGtleSAhPSBrZXlDICYmIGtleSAhPSBrZXloaiAmJiBrZXkgIT0ga2V5U1QgJiYga2V5ICE9IGtleWogJiYga2V5ICE9IGtleUIgJiYga2V5ICE9IGtleXhhKSB7CiAgICAgICAgICAgICAgY29uc3QgdCA9IHR5cGVvZiB0aGlzW2tleV07CiAgICAgICAgICAgICAgcmV0dXJuIHQgPT09ICd1bmRlZmluZWQnIHx8IHQgPT09ICdvYmplY3QnCiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGZvciAoY29uc3Qga2V5IG9mIGRpc3Bvc2VLZXlzKSB7CiAgICAgICAgICBjb25zdCB2ID0gdGhpc1trZXldOwogICAgICAgICAgaWYgKCh2IHx8IDApLmxlbmd0aCA+PSAxKSB2Lmxlbmd0aCA9IDA7IC8vIGZ1bmN0aW9uICgpe2lmKHRoaXMuZm4pZm9yKDt0aGlzLmZuLmxlbmd0aDspdGhpcy5mbi5zaGlmdCgpKCl9CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzW2tleWVDXSA+IDApIHRoaXMuc3RvcCgpOwogICAgICAgIHRoaXNba2V5al0gPSBudWxsOwogICAgICAgIHRoaXNba2V5Ql0gPSBudWxsOwogICAgICB9OwoKICAgICAgZ2twLnN0YXJ0ID0gZnVuY3Rpb24gKGEpIHsKICAgICAgICBpZiAodGhpc1trZXllQ10gPiAwKSB0aGlzLnN0b3AoKTsKICAgICAgICBjb25zdCBkZWxheSA9IHZvaWQgMCAhPT0gYSA/IGEgOiB0aGlzW2tleWhqXTsKICAgICAgICB0aGlzW2tleWVDXSA9IHdpbmRvdy5zZXRUaW1lb3V0KHRoaXNba2V5Q10sIGRlbGF5KTsKICAgICAgfTsKICAgICAgZ2twLnN0b3AgPSBmdW5jdGlvbiAoKSB7CiAgICAgICAgaWYgKHRoaXNba2V5ZUNdID4gMCkgewogICAgICAgICAgd2luZG93LmNsZWFyVGltZW91dCh0aGlzW2tleWVDXSk7CiAgICAgICAgICB0aGlzW2tleWVDXSA9IDA7CiAgICAgICAgfQogICAgICB9OwoKICAgICAgZ2twLmlzQWN0aXZlID0gZnVuY3Rpb24gKCkgewogICAgICAgIHJldHVybiB0aGlzW2tleWVDXSA+IDA7CiAgICAgIH07CgogICAgICBna3Bba2V5U1RdID0gZnVuY3Rpb24gKCkgewogICAgICAgIHRoaXMuc3RvcCgpOyAvLyB0aGlzW2tleWVDXSA9IDA7CiAgICAgICAgY29uc3QgZm4gPSB0aGlzW2tleWpdOwogICAgICAgIGNvbnN0IG9iaiA9IHRoaXNba2V5Ql07CiAgICAgICAgbGV0IHNraXAgPSBmYWxzZTsKICAgICAgICBpZiAoIWZuKSBza2lwID0gdHJ1ZTsKICAgICAgICBlbHNlIGlmIChJR05PUkVfYnVmZmVyaGVhbHRoX0NIRUNLICYmIG9iaikgewogICAgICAgICAgbGV0IG07CiAgICAgICAgICBpZiAoKG0gPSBvYmpba2V5Q10pIGluc3RhbmNlb2YgTWFwIHx8IChtID0gb2JqW2tleWpdKSBpbnN0YW5jZW9mIE1hcCkgewogICAgICAgICAgICBpZiAobS5oYXMoImJ1ZmZlcmhlYWx0aCIpKSBza2lwID0gdHJ1ZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCFza2lwKSB7CiAgICAgICAgICBmbi5jYWxsKG9iaik7CiAgICAgICAgfQogICAgICB9OwoKCgoKICAgICAgLyoKCiAgICAgIGcuay5lQyA9IDA7CiAgICAgIGcuay54YSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgZy5RdS5WZi54YS5jYWxsKHRoaXMpOwogICAgICAgICAgdGhpcy5zdG9wKCk7CiAgICAgICAgICBkZWxldGUgdGhpcy5qOwogICAgICAgICAgZGVsZXRlIHRoaXMuQgogICAgICB9CiAgICAgIDsKICAgICAgZy5rLnN0YXJ0ID0gZnVuY3Rpb24oYSkgewogICAgICAgICAgdGhpcy5zdG9wKCk7CiAgICAgICAgICB0aGlzLmVDID0gZy5nZyh0aGlzLkMsIHZvaWQgMCAhPT0gYSA/IGEgOiB0aGlzLmhqKQogICAgICB9CiAgICAgIDsKICAgICAgZy5rLnN0b3AgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHRoaXMuaXNBY3RpdmUoKSAmJiBnLlNhLmNsZWFyVGltZW91dCh0aGlzLmVDKTsKICAgICAgICAgIHRoaXMuZUMgPSAwCiAgICAgIH0KICAgICAgOwogICAgICBnLmsuaXNBY3RpdmUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgIHJldHVybiAwICE9IHRoaXMuZUMKICAgICAgfQogICAgICA7CiAgICAgIGcuay5TVCA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgdGhpcy5lQyA9IDA7CiAgICAgICAgICB0aGlzLmogJiYgdGhpcy5qLmNhbGwodGhpcy5CKQogICAgICB9CiAgICAgIDsKICAgICAgKi8KCgoKCiAgICB9KSgpOwoKICAgIEZJWF9BbmltYXRpb25fbl90aW1lbGluZSAmJiAoYXN5bmMgKCkgPT4gewoKICAgICAgY29uc3QgW3RpbWVsaW5lLCBBbmltYXRpb25dID0gYXdhaXQgUHJvbWlzZS5hbGwoW3RpbWVsaW5lT2JzZXJ2YWJsZS5vYnRhaW4oKSwgYW5pbWF0aW9uT2JzZXJ2YWJsZS5vYnRhaW4oKV0pOwoKICAgICAgaWYgKCF0aW1lbGluZSB8fCAhQW5pbWF0aW9uKSByZXR1cm47CgogICAgICBjb25zdCBhbmlQcm90byA9IEFuaW1hdGlvbi5wcm90b3R5cGU7CiAgICAgIC8vIGFuaVByb3RvLnNlcXVlbmNlTnVtYmVyID0gMDsgLy8gbmF0aXZlIFlvdVR1YmUgZW5naW5lIGJ1ZyAtIHNlcXVlbmNlTnVtYmVyIGlzIG5vdCBzZXQKCiAgICAgIGNvbnN0IGdldFhyb3RvID0gKHgpID0+IHsKICAgICAgICB0cnkgewogICAgICAgICAgcmV0dXJuIHguX19wcm90b19fOwogICAgICAgIH0gY2F0Y2ggKGUpIHsgfQogICAgICAgIHJldHVybiBudWxsOwogICAgICB9CiAgICAgIGNvbnN0IHRpbVByb3RvID0gZ2V0WHJvdG8odGltZWxpbmUpOwogICAgICBpZiAoIXRpbVByb3RvKSByZXR1cm47CiAgICAgIGlmICgKICAgICAgICAoCiAgICAgICAgICB0eXBlb2YgdGltUHJvdG8uZ2V0QW5pbWF0aW9ucyA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgdGltUHJvdG8ucGxheSA9PT0gJ2Z1bmN0aW9uJyAmJgogICAgICAgICAgdHlwZW9mIHRpbVByb3RvLl9kaXNjYXJkQW5pbWF0aW9ucyA9PT0gJ2Z1bmN0aW9uJyAmJiB0eXBlb2YgdGltUHJvdG8uX3BsYXkgPT09ICdmdW5jdGlvbicgJiYKICAgICAgICAgIHR5cGVvZiB0aW1Qcm90by5fdXBkYXRlQW5pbWF0aW9uc1Byb21pc2VzID09PSAnZnVuY3Rpb24nICYmICF0aW1Qcm90by5ub2ZDUSAmJgogICAgICAgICAgdHlwZW9mIGFuaVByb3RvLl91cGRhdGVQcm9taXNlcyA9PT0gJ2Z1bmN0aW9uJyAmJiAhYW5pUHJvdG8ubm9mWUgKICAgICAgICApCgogICAgICApIHsKCiAgICAgICAgdGltUHJvdG8ubm9mQ1EgPSAxOwogICAgICAgIGFuaVByb3RvLm5vZllIID0gMTsKCiAgICAgICAgY29uc3Qgb3JpZ2luYWxBbmltYXRpb25zV2l0aFByb21pc2VzID0gKChfdXBkYXRlQW5pbWF0aW9uc1Byb21pc2VzKSA9PiB7CgoKICAgICAgICAgIC8qCiAgICAgICAgICAgIHYuYW5pbWF0aW9uc1dpdGhQcm9taXNlcyA9IHYuYW5pbWF0aW9uc1dpdGhQcm9taXNlcy5maWx0ZXIoZnVuY3Rpb24gKGMpIHsKICAgICAgICAgICAgICByZXR1cm4gYy5fdXBkYXRlUHJvbWlzZXMoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAqLwoKICAgICAgICAgIGNvbnN0IHAgPSBBcnJheS5wcm90b3R5cGUuZmlsdGVyOwoKICAgICAgICAgIGxldCByZXMgPSBudWxsOwogICAgICAgICAgQXJyYXkucHJvdG90eXBlLmZpbHRlciA9IGZ1bmN0aW9uICgpIHsKCiAgICAgICAgICAgIHJlcyA9IHRoaXM7CiAgICAgICAgICAgIHJldHVybiB0aGlzOwoKICAgICAgICAgIH07CgogICAgICAgICAgX3VwZGF0ZUFuaW1hdGlvbnNQcm9taXNlcy5jYWxsKHt9KTsKCiAgICAgICAgICBBcnJheS5wcm90b3R5cGUuZmlsdGVyID0gcDsKCiAgICAgICAgICBpZiAocmVzICYmIHR5cGVvZiByZXMubGVuZ3RoID09PSAnbnVtYmVyJykgewogICAgICAgICAgICAvKiogQHR5cGUge2FueVtdfSAqLwogICAgICAgICAgICBjb25zdCBfcmVzID0gcmVzOwogICAgICAgICAgICByZXR1cm4gX3JlczsKICAgICAgICAgIH0KCgogICAgICAgICAgcmV0dXJuIG51bGw7CgoKCgogICAgICAgIH0pKHRpbVByb3RvLl91cGRhdGVBbmltYXRpb25zUHJvbWlzZXMpOwoKICAgICAgICBpZiAoIW9yaWdpbmFsQW5pbWF0aW9uc1dpdGhQcm9taXNlcyB8fCB0eXBlb2Ygb3JpZ2luYWxBbmltYXRpb25zV2l0aFByb21pc2VzLmxlbmd0aCAhPT0gJ251bWJlcicpIHJldHVybjsKCiAgICAgICAgLy8gY29uc29sZS5sb2coJ29yaWdpbmFsQW5pbWF0aW9uc1dpdGhQcm9taXNlcycsIG9yaWdpbmFsQW5pbWF0aW9uc1dpdGhQcm9taXNlcykKCiAgICAgICAgYW5pUHJvdG8uX3VwZGF0ZVByb21pc2VzMzEgPSBhbmlQcm90by5fdXBkYXRlUHJvbWlzZXM7CgogICAgICAgIC8qCiAgICAgICAgYW5pUHJvdG8uX3VwZGF0ZVByb21pc2VzID0gZnVuY3Rpb24oKXsKICAgICAgICAgIGNvbnNvbGUubG9nKCdlZmYnLHRoaXMuX29sZFBsYXlTdGF0ZSwgdGhpcy5wbGF5U3RhdGUpCiAgICAgICAgICByZXR1cm4gdGhpcy5fdXBkYXRlUHJvbWlzZXMzMS5hcHBseSh0aGlzLCBhcmd1bWVudHMpCiAgICAgICAgfQogICAgICAgICovCgogICAgICAgIGFuaVByb3RvLl91cGRhdGVQcm9taXNlcyA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgIHZhciBvbGRQbGF5U3RhdGUgPSB0aGlzLl9vbGRQbGF5U3RhdGU7CiAgICAgICAgICB2YXIgbmV3UGxheVN0YXRlID0gdGhpcy5wbGF5U3RhdGU7CiAgICAgICAgICAvLyBjb25zb2xlLmxvZygnZXR0Jywgb2xkUGxheVN0YXRlLCBuZXdQbGF5U3RhdGUpCiAgICAgICAgICBpZiAobmV3UGxheVN0YXRlICE9PSBvbGRQbGF5U3RhdGUpIHsKICAgICAgICAgICAgdGhpcy5fb2xkUGxheVN0YXRlID0gbmV3UGxheVN0YXRlOwogICAgICAgICAgICBpZiAodGhpcy5fcmVhZHlQcm9taXNlKSB7CiAgICAgICAgICAgICAgaWYgKCJpZGxlIiA9PSBuZXdQbGF5U3RhdGUpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3JlamVjdFJlYWR5UHJvbWlzZSgpOwogICAgICAgICAgICAgICAgdGhpcy5fcmVhZHlQcm9taXNlID0gdm9pZCAwOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoInBlbmRpbmciID09IG9sZFBsYXlTdGF0ZSkgewogICAgICAgICAgICAgICAgdGhpcy5fcmVzb2x2ZVJlYWR5UHJvbWlzZSgpOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoInBlbmRpbmciID09IG5ld1BsYXlTdGF0ZSkgewogICAgICAgICAgICAgICAgdGhpcy5fcmVhZHlQcm9taXNlID0gdm9pZCAwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodGhpcy5fZmluaXNoZWRQcm9taXNlKSB7CiAgICAgICAgICAgICAgaWYgKCJpZGxlIiA9PSBuZXdQbGF5U3RhdGUpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3JlamVjdEZpbmlzaGVkUHJvbWlzZSgpOwogICAgICAgICAgICAgICAgdGhpcy5fZmluaXNoZWRQcm9taXNlID0gdm9pZCAwOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAoImZpbmlzaGVkIiA9PSBuZXdQbGF5U3RhdGUpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3Jlc29sdmVGaW5pc2hlZFByb21pc2UoKTsKICAgICAgICAgICAgICB9IGVsc2UgaWYgKCJmaW5pc2hlZCIgPT0gb2xkUGxheVN0YXRlKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9maW5pc2hlZFByb21pc2UgPSB2b2lkIDA7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gdGhpcy5fcmVhZHlQcm9taXNlIHx8IHRoaXMuX2ZpbmlzaGVkUHJvbWlzZTsKICAgICAgICB9OwoKCiAgICAgICAgbGV0IHJlc3RhcnRXZWJBbmltYXRpb25zTmV4dFRpY2tGbGFnID0gZmFsc2U7CgogICAgICAgIGNvbnN0IGxvb3Blck1ldGhvZFQgPSAoKSA9PiB7CgogICAgICAgICAgY29uc3QgcnVubmVyRm4gPSAoaFJlcykgPT4gewogICAgICAgICAgICB2YXIgYiA9IHRpbWVsaW5lOwogICAgICAgICAgICBiLmN1cnJlbnRUaW1lID0gaFJlczsKICAgICAgICAgICAgYi5fZGlzY2FyZEFuaW1hdGlvbnMoKTsKICAgICAgICAgICAgaWYgKDAgPT0gYi5fYW5pbWF0aW9ucy5sZW5ndGgpIHsKICAgICAgICAgICAgICByZXN0YXJ0V2ViQW5pbWF0aW9uc05leHRUaWNrRmxhZyA9IGZhbHNlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgIGdldFJhZlByb21pc2UoKS50aGVuKHJ1bm5lckZuKTsKICAgICAgICAgICAgfQogICAgICAgICAgfQoKICAgICAgICAgIGNvbnN0IHJlc3RhcnRXZWJBbmltYXRpb25zTmV4dFRpY2sgPSAoKSA9PiB7CiAgICAgICAgICAgIGlmICghcmVzdGFydFdlYkFuaW1hdGlvbnNOZXh0VGlja0ZsYWcpIHsKICAgICAgICAgICAgICByZXN0YXJ0V2ViQW5pbWF0aW9uc05leHRUaWNrRmxhZyA9IHRydWU7CiAgICAgICAgICAgICAgZ2V0UmFmUHJvbWlzZSgpLnRoZW4ocnVubmVyRm4pOwogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIHsgcmVzdGFydFdlYkFuaW1hdGlvbnNOZXh0VGljayB9CiAgICAgICAgfTsKCgogICAgICAgIGNvbnN0IGxvb3Blck1ldGhvZE4gPSAoKSA9PiB7CgogICAgICAgICAgY29uc3QgYWNzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYS1mJyk7CiAgICAgICAgICBhY3MuaWQgPSAnYS1mJzsKCiAgICAgICAgICBpZiAoIWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhZnNjcmlwdCcpKSB7CiAgICAgICAgICAgIGNvbnN0IHN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3R5bGUnKTsKICAgICAgICAgICAgc3R5bGUuaWQgPSAnYWZzY3JpcHQnOwogICAgICAgICAgICBzdHlsZS50ZXh0Q29udGVudCA9IGAKICAgICAgICAgICAgICBAa2V5RnJhbWVzIGFGMSB7CiAgICAgICAgICAgICAgICAwJSB7CiAgICAgICAgICAgICAgICAgIG9yZGVyOiAwOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgMTAwJSB7CiAgICAgICAgICAgICAgICAgIG9yZGVyOiAxOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAjYS1mW2lkXSB7CiAgICAgICAgICAgICAgICB2aXNpYmlsaXR5OiBjb2xsYXBzZSAhaW1wb3J0YW50OwogICAgICAgICAgICAgICAgcG9zaXRpb246IGZpeGVkICFpbXBvcnRhbnQ7CiAgICAgICAgICAgICAgICBkaXNwbGF5OiBibG9jayAhaW1wb3J0YW50OwogICAgICAgICAgICAgICAgdG9wOiAtMTAwcHggIWltcG9ydGFudDsKICAgICAgICAgICAgICAgIGxlZnQ6IC0xMDBweCAhaW1wb3J0YW50OwogICAgICAgICAgICAgICAgbWFyZ2luOjAgIWltcG9ydGFudDsKICAgICAgICAgICAgICAgIHBhZGRpbmc6MCAhaW1wb3J0YW50OwogICAgICAgICAgICAgICAgb3V0bGluZTowICFpbXBvcnRhbnQ7CiAgICAgICAgICAgICAgICBib3JkZXI6MCAhaW1wb3J0YW50OwogICAgICAgICAgICAgICAgei1pbmRleDotMSAhaW1wb3J0YW50OwogICAgICAgICAgICAgICAgd2lkdGg6IDBweCAhaW1wb3J0YW50OwogICAgICAgICAgICAgICAgaGVpZ2h0OiAwcHggIWltcG9ydGFudDsKICAgICAgICAgICAgICAgIGNvbnRhaW46IHN0cmljdCAhaW1wb3J0YW50OwogICAgICAgICAgICAgICAgcG9pbnRlci1ldmVudHM6IG5vbmUgIWltcG9ydGFudDsKICAgICAgICAgICAgICAgIGFuaW1hdGlvbjogMW1zIHN0ZXBzKDIsIGp1bXAtbm9uZSkgMG1zIGluZmluaXRlIGFsdGVybmF0ZSBmb3J3YXJkcyBydW5uaW5nIGFGMSAhaW1wb3J0YW50OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgYDsKICAgICAgICAgICAgKGRvY3VtZW50LmhlYWQgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KS5hcHBlbmRDaGlsZChzdHlsZSk7CiAgICAgICAgICB9CgogICAgICAgICAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50Lmluc2VydEJlZm9yZShhY3MsIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5maXJzdENoaWxkKTsKCiAgICAgICAgICBjb25zdCBfb25hbmltYXRpb25pdGVyYXRpb24gPSBmdW5jdGlvbiAoZXZ0KSB7CiAgICAgICAgICAgIGNvbnN0IGhSZXMgPSBldnQudGltZVN0YW1wOwogICAgICAgICAgICB2YXIgYiA9IHRpbWVsaW5lOwogICAgICAgICAgICBiLmN1cnJlbnRUaW1lID0gaFJlczsKICAgICAgICAgICAgYi5fZGlzY2FyZEFuaW1hdGlvbnMoKTsKICAgICAgICAgICAgaWYgKDAgPT0gYi5fYW5pbWF0aW9ucy5sZW5ndGgpIHsKICAgICAgICAgICAgICByZXN0YXJ0V2ViQW5pbWF0aW9uc05leHRUaWNrRmxhZyA9IGZhbHNlOwogICAgICAgICAgICAgIGFjcy5vbmFuaW1hdGlvbml0ZXJhdGlvbiA9IG51bGw7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYWNzLm9uYW5pbWF0aW9uaXRlcmF0aW9uID0gX29uYW5pbWF0aW9uaXRlcmF0aW9uOwogICAgICAgICAgICB9CgogICAgICAgICAgfQoKCgogICAgICAgICAgY29uc3QgcmVzdGFydFdlYkFuaW1hdGlvbnNOZXh0VGljayA9ICgpID0+IHsKICAgICAgICAgICAgaWYgKCFyZXN0YXJ0V2ViQW5pbWF0aW9uc05leHRUaWNrRmxhZykgewogICAgICAgICAgICAgIHJlc3RhcnRXZWJBbmltYXRpb25zTmV4dFRpY2tGbGFnID0gdHJ1ZTsKICAgICAgICAgICAgICBhY3Mub25hbmltYXRpb25pdGVyYXRpb24gPSBfb25hbmltYXRpb25pdGVyYXRpb247CgogICAgICAgICAgICB9CiAgICAgICAgICB9CgogICAgICAgICAgcmV0dXJuIHsgcmVzdGFydFdlYkFuaW1hdGlvbnNOZXh0VGljayB9CiAgICAgICAgfTsKCgoKICAgICAgICBjb25zdCB7IHJlc3RhcnRXZWJBbmltYXRpb25zTmV4dFRpY2sgfSA9ICgnb25hbmltYXRpb25pdGVyYXRpb24nIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCkgPyBsb29wZXJNZXRob2ROKCkgOiBsb29wZXJNZXRob2RUKCk7CgoKICAgICAgICAvLyBjb25zb2xlLmxvZyg1NzEsIHRpbVByb3RvKTsKICAgICAgICB0aW1Qcm90by5fcGxheSA9IGZ1bmN0aW9uIChjKSB7CiAgICAgICAgICBjID0gbmV3IEFuaW1hdGlvbihjLCB0aGlzKTsKICAgICAgICAgIHRoaXMuX2FuaW1hdGlvbnMucHVzaChjKTsKICAgICAgICAgIHJlc3RhcnRXZWJBbmltYXRpb25zTmV4dFRpY2soKTsKICAgICAgICAgIGMuX3VwZGF0ZVByb21pc2VzKCk7CiAgICAgICAgICBjLl9hbmltYXRpb24ucGxheSgpOwogICAgICAgICAgYy5fdXBkYXRlUHJvbWlzZXMoKTsKICAgICAgICAgIHJldHVybiBjCiAgICAgICAgfQoKICAgICAgICBjb25zdCBhbmltYXRpb25zV2l0aFByb21pc2VzTWFwID0gbmV3IFNldChvcmlnaW5hbEFuaW1hdGlvbnNXaXRoUHJvbWlzZXMpOwogICAgICAgIG9yaWdpbmFsQW5pbWF0aW9uc1dpdGhQcm9taXNlcy5sZW5ndGggPSAwOwogICAgICAgIG9yaWdpbmFsQW5pbWF0aW9uc1dpdGhQcm9taXNlcy5wdXNoID0gbnVsbDsKICAgICAgICBvcmlnaW5hbEFuaW1hdGlvbnNXaXRoUHJvbWlzZXMuc3BsaWNlID0gbnVsbDsKICAgICAgICBvcmlnaW5hbEFuaW1hdGlvbnNXaXRoUHJvbWlzZXMuc2xpY2UgPSBudWxsOwogICAgICAgIG9yaWdpbmFsQW5pbWF0aW9uc1dpdGhQcm9taXNlcy5pbmRleE9mID0gbnVsbDsKICAgICAgICBvcmlnaW5hbEFuaW1hdGlvbnNXaXRoUHJvbWlzZXMudW5zaGlmdCA9IG51bGw7CiAgICAgICAgb3JpZ2luYWxBbmltYXRpb25zV2l0aFByb21pc2VzLnNoaWZ0ID0gbnVsbDsKICAgICAgICBvcmlnaW5hbEFuaW1hdGlvbnNXaXRoUHJvbWlzZXMucG9wID0gbnVsbDsKICAgICAgICBvcmlnaW5hbEFuaW1hdGlvbnNXaXRoUHJvbWlzZXMuZmlsdGVyID0gbnVsbDsKICAgICAgICBvcmlnaW5hbEFuaW1hdGlvbnNXaXRoUHJvbWlzZXMuZm9yRWFjaCA9IG51bGw7CiAgICAgICAgb3JpZ2luYWxBbmltYXRpb25zV2l0aFByb21pc2VzLm1hcCA9IG51bGw7CgoKICAgICAgICBjb25zdCBfdXBkYXRlQW5pbWF0aW9uc1Byb21pc2VzID0gKCkgPT4gewogICAgICAgICAgYW5pbWF0aW9uc1dpdGhQcm9taXNlc01hcC5mb3JFYWNoKGMgPT4gewogICAgICAgICAgICBpZiAoIWMuX3VwZGF0ZVByb21pc2VzKCkpIGFuaW1hdGlvbnNXaXRoUHJvbWlzZXNNYXAuZGVsZXRlKGMpOwogICAgICAgICAgfSk7CiAgICAgICAgICAvKgogICAgICAgICAgdi5hbmltYXRpb25zV2l0aFByb21pc2VzID0gdi5hbmltYXRpb25zV2l0aFByb21pc2VzLmZpbHRlcihmdW5jdGlvbiAoYykgewogICAgICAgICAgICByZXR1cm4gYy5fdXBkYXRlUHJvbWlzZXMoKTsKICAgICAgICAgIH0pOwogICAgICAgICAgKi8KICAgICAgICB9CgogICAgICAgIHRpbVByb3RvLl91cGRhdGVBbmltYXRpb25zUHJvbWlzZXMzMSA9IHRpbVByb3RvLl91cGRhdGVBbmltYXRpb25zUHJvbWlzZXM7CgogICAgICAgIHRpbVByb3RvLl91cGRhdGVBbmltYXRpb25zUHJvbWlzZXMgPSBfdXBkYXRlQW5pbWF0aW9uc1Byb21pc2VzOwoKICAgICAgICBkZWxldGUgdGltUHJvdG8uX3VwZGF0ZUFuaW1hdGlvbnNQcm9taXNlczsKICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGltUHJvdG8sICdfdXBkYXRlQW5pbWF0aW9uc1Byb21pc2VzJywgewogICAgICAgICAgZ2V0KCkgewogICAgICAgICAgICBpZiAoYW5pbWF0aW9uc1dpdGhQcm9taXNlc01hcC5zaXplID09PSAwKSByZXR1cm4gbmlsRm47CiAgICAgICAgICAgIHJldHVybiBfdXBkYXRlQW5pbWF0aW9uc1Byb21pc2VzOwogICAgICAgICAgfSwKICAgICAgICAgIHNldChudikgewogICAgICAgICAgICBkZWxldGUgdGhpcy5fdXBkYXRlQW5pbWF0aW9uc1Byb21pc2VzOwogICAgICAgICAgICB0aGlzLl91cGRhdGVBbmltYXRpb25zUHJvbWlzZXMgPSBudjsKICAgICAgICAgIH0sCiAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgIH0pOwoKCiAgICAgICAgbGV0IHBkRmluaXNoZWQgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKGFuaVByb3RvLCAnZmluaXNoZWQnKTsKICAgICAgICBhbmlQcm90by5fX2ZpbmlzaGVkX25hdGl2ZV9nZXRfXyA9IHBkRmluaXNoZWQuZ2V0OwogICAgICAgIGlmICh0eXBlb2YgcGRGaW5pc2hlZC5nZXQgPT09ICdmdW5jdGlvbicgJiYgIXBkRmluaXNoZWQuc2V0ICYmIHBkRmluaXNoZWQuY29uZmlndXJhYmxlID09PSB0cnVlICYmIHBkRmluaXNoZWQuZW51bWVyYWJsZSA9PT0gdHJ1ZSkgewoKCiAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkoYW5pUHJvdG8sICdmaW5pc2hlZCcsIHsKICAgICAgICAgICAgZ2V0KCkgewogICAgICAgICAgICAgIHRoaXMuX2ZpbmlzaGVkUHJvbWlzZSB8fCAoIWFuaW1hdGlvbnNXaXRoUHJvbWlzZXNNYXAuaGFzKHRoaXMpICYmIGFuaW1hdGlvbnNXaXRoUHJvbWlzZXNNYXAuYWRkKHRoaXMpLAogICAgICAgICAgICAgICAgdGhpcy5fZmluaXNoZWRQcm9taXNlID0gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICAgICAgICAgICAgICB0aGlzLl9yZXNvbHZlRmluaXNoZWRQcm9taXNlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJlc29sdmUodGhpcykKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgdGhpcy5fcmVqZWN0RmluaXNoZWRQcm9taXNlID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgICAgICAgIHJlamVjdCh7CiAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBET01FeGNlcHRpb24uQUJPUlRfRVJSLAogICAgICAgICAgICAgICAgICAgICAgbmFtZTogIkFib3J0RXJyb3IiCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0pLAogICAgICAgICAgICAgICAgImZpbmlzaGVkIiA9PSB0aGlzLnBsYXlTdGF0ZSAmJiB0aGlzLl9yZXNvbHZlRmluaXNoZWRQcm9taXNlKCkpOwogICAgICAgICAgICAgIHJldHVybiB0aGlzLl9maW5pc2hlZFByb21pc2UKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0OiB1bmRlZmluZWQsCiAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUsCiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZQogICAgICAgICAgfSk7CgogICAgICAgIH0KCgoKICAgICAgICBsZXQgcGRSZWFkeSA9IE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IoYW5pUHJvdG8sICdyZWFkeScpOwogICAgICAgIGFuaVByb3RvLl9fcmVhZHlfbmF0aXZlX2dldF9fID0gcGRSZWFkeS5nZXQ7CiAgICAgICAgaWYgKHR5cGVvZiBwZFJlYWR5LmdldCA9PT0gJ2Z1bmN0aW9uJyAmJiAhcGRSZWFkeS5zZXQgJiYgcGRSZWFkeS5jb25maWd1cmFibGUgPT09IHRydWUgJiYgcGRSZWFkeS5lbnVtZXJhYmxlID09PSB0cnVlKSB7CgogICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGFuaVByb3RvLCAncmVhZHknLCB7CiAgICAgICAgICAgIGdldCgpIHsKICAgICAgICAgICAgICB0aGlzLl9yZWFkeVByb21pc2UgfHwgKCFhbmltYXRpb25zV2l0aFByb21pc2VzTWFwLmhhcyh0aGlzKSAmJiBhbmltYXRpb25zV2l0aFByb21pc2VzTWFwLmFkZCh0aGlzKSwKICAgICAgICAgICAgICAgIHRoaXMuX3JlYWR5UHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgICAgICAgICAgICAgdGhpcy5fcmVzb2x2ZVJlYWR5UHJvbWlzZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZXNvbHZlKHRoaXMpCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgIHRoaXMuX3JlamVjdFJlYWR5UHJvbWlzZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICByZWplY3QoewogICAgICAgICAgICAgICAgICAgICAgdHlwZTogRE9NRXhjZXB0aW9uLkFCT1JUX0VSUiwKICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICJBYm9ydEVycm9yIgogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9KSwKICAgICAgICAgICAgICAgICJwZW5kaW5nIiAhPT0gdGhpcy5wbGF5U3RhdGUgJiYgdGhpcy5fcmVzb2x2ZVJlYWR5UHJvbWlzZSgpKTsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5fcmVhZHlQcm9taXNlCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldDogdW5kZWZpbmVkLAogICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICAgIH0pOwoKICAgICAgICB9CgoKICAgICAgICBpZiAoSUdOT1JFX2JpbmRBbmltYXRpb25Gb3JDdXN0b21FZmZlY3QgJiYgdHlwZW9mIGFuaVByb3RvLl9yZWJ1aWxkVW5kZXJseWluZ0FuaW1hdGlvbiA9PT0gJ2Z1bmN0aW9uJyAmJiAhYW5pUHJvdG8uX3JlYnVpbGRVbmRlcmx5aW5nQW5pbWF0aW9uMjEgJiYgYW5pUHJvdG8uX3JlYnVpbGRVbmRlcmx5aW5nQW5pbWF0aW9uLmxlbmd0aCA9PT0gMCkgewoKICAgICAgICAgIGFuaVByb3RvLl9yZWJ1aWxkVW5kZXJseWluZ0FuaW1hdGlvbjIxID0gYW5pUHJvdG8uX3JlYnVpbGRVbmRlcmx5aW5nQW5pbWF0aW9uOwogICAgICAgICAgY29uc3QgX3JlYnVpbGRVbmRlcmx5aW5nQW5pbWF0aW9uID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICAvLyBpZiAoaXNOYU4odGhpcy5fc2VxdWVuY2VOdW1iZXIpKSByZXR1cm47IC8vIGRvIG5vdCByZWJ1aWxkIHVuZGVybHlpbmcgYW5pbWF0aW9uIGlmIG5hdGl2ZSBhbmltYXRpb24gaXMgdXNlZC4KICAgICAgICAgICAgdGhpcy5lZmZlY3QgJiYgdGhpcy5lZmZlY3QuX29uc2FtcGxlICYmICh0aGlzLmVmZmVjdC5fb25zYW1wbGUgPSBudWxsKTsKICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3JlYnVpbGRVbmRlcmx5aW5nQW5pbWF0aW9uMjEoKTsKICAgICAgICAgIH0KICAgICAgICAgIGFuaVByb3RvLl9yZWJ1aWxkVW5kZXJseWluZ0FuaW1hdGlvbiA9IF9yZWJ1aWxkVW5kZXJseWluZ0FuaW1hdGlvbjsKICAgICAgICAgIC8vIGRlbGV0ZSBhbmlQcm90by5fcmVidWlsZFVuZGVybHlpbmdBbmltYXRpb247CiAgICAgICAgICAvLyBPYmplY3QuZGVmaW5lUHJvcGVydHkoYW5pUHJvdG8sICdfcmVidWlsZFVuZGVybHlpbmdBbmltYXRpb24nLCB7CiAgICAgICAgICAvLyAgIGdldCgpIHsKICAgICAgICAgIC8vICAgICBpZiAoaXNOYU4odGhpcy5fc2VxdWVuY2VOdW1iZXIpKSByZXR1cm4gbmlsRm47CiAgICAgICAgICAvLyAgICAgcmV0dXJuIHRoaXMuX3JlYnVpbGRVbmRlcmx5aW5nQW5pbWF0aW9uMjE7CiAgICAgICAgICAvLyAgIH0sCiAgICAgICAgICAvLyAgIHNldChudikgewogICAgICAgICAgLy8gICAgIGRlbGV0ZSB0aGlzLl9yZWJ1aWxkVW5kZXJseWluZ0FuaW1hdGlvbjsKICAgICAgICAgIC8vICAgICB0aGlzLl9yZWJ1aWxkVW5kZXJseWluZ0FuaW1hdGlvbiA9IG52OwogICAgICAgICAgLy8gICB9LAogICAgICAgICAgLy8gICBlbnVtZXJhYmxlOiB0cnVlLAogICAgICAgICAgLy8gICBjb25maWd1cmFibGU6IHRydWUKICAgICAgICAgIC8vIH0pOwogICAgICAgIH0KCgogICAgICAgIC8qCgoKICAgICAgICAgIGZ1bmN0aW9uIGYoYykgewogICAgICAgICAgICAgIHZhciBiID0gdi50aW1lbGluZTsKICAgICAgICAgICAgICBiLmN1cnJlbnRUaW1lID0gYzsKICAgICAgICAgICAgICBiLl9kaXNjYXJkQW5pbWF0aW9ucygpOwogICAgICAgICAgICAgIDAgPT0gYi5fYW5pbWF0aW9ucy5sZW5ndGggPyBkID0gITEgOiByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZikKICAgICAgICAgIH0KICAgICAgICAgIHZhciBoID0gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZTsKICAgICAgICAgIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgPSBmdW5jdGlvbihjKSB7CiAgICAgICAgICAgICAgcmV0dXJuIGgoZnVuY3Rpb24oYikgewogICAgICAgICAgICAgICAgICB2LnRpbWVsaW5lLl91cGRhdGVBbmltYXRpb25zUHJvbWlzZXMoKTsKICAgICAgICAgICAgICAgICAgYyhiKTsKICAgICAgICAgICAgICAgICAgdi50aW1lbGluZS5fdXBkYXRlQW5pbWF0aW9uc1Byb21pc2VzKCkKICAgICAgICAgICAgICB9KQogICAgICAgICAgfQogICAgICAgICAgOwogICAgICAgICAgdi5BbmltYXRpb25UaW1lbGluZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHRoaXMuX2FuaW1hdGlvbnMgPSBbXTsKICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRUaW1lID0gdm9pZCAwCiAgICAgICAgICB9CiAgICAgICAgICA7CiAgICAgICAgICB2LkFuaW1hdGlvblRpbWVsaW5lLnByb3RvdHlwZSA9IHsKICAgICAgICAgICAgICBnZXRBbmltYXRpb25zOiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgdGhpcy5fZGlzY2FyZEFuaW1hdGlvbnMoKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX2FuaW1hdGlvbnMuc2xpY2UoKQogICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgX3VwZGF0ZUFuaW1hdGlvbnNQcm9taXNlczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHYuYW5pbWF0aW9uc1dpdGhQcm9taXNlcyA9IHYuYW5pbWF0aW9uc1dpdGhQcm9taXNlcy5maWx0ZXIoZnVuY3Rpb24oYykgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGMuX3VwZGF0ZVByb21pc2VzKCkKICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgIF9kaXNjYXJkQW5pbWF0aW9uczogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZUFuaW1hdGlvbnNQcm9taXNlcygpOwogICAgICAgICAgICAgICAgICB0aGlzLl9hbmltYXRpb25zID0gdGhpcy5fYW5pbWF0aW9ucy5maWx0ZXIoZnVuY3Rpb24oYykgewogICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICJmaW5pc2hlZCIgIT0gYy5wbGF5U3RhdGUgJiYgImlkbGUiICE9IGMucGxheVN0YXRlCiAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBfcGxheTogZnVuY3Rpb24oYykgewogICAgICAgICAgICAgICAgICBjID0gbmV3IHYuQW5pbWF0aW9uKGMsdGhpcyk7CiAgICAgICAgICAgICAgICAgIHRoaXMuX2FuaW1hdGlvbnMucHVzaChjKTsKICAgICAgICAgICAgICAgICAgdi5yZXN0YXJ0V2ViQW5pbWF0aW9uc05leHRUaWNrKCk7CiAgICAgICAgICAgICAgICAgIGMuX3VwZGF0ZVByb21pc2VzKCk7CiAgICAgICAgICAgICAgICAgIGMuX2FuaW1hdGlvbi5wbGF5KCk7CiAgICAgICAgICAgICAgICAgIGMuX3VwZGF0ZVByb21pc2VzKCk7CiAgICAgICAgICAgICAgICAgIHJldHVybiBjCiAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICBwbGF5OiBmdW5jdGlvbihjKSB7CiAgICAgICAgICAgICAgICAgIGMgJiYgYy5yZW1vdmUoKTsKICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuX3BsYXkoYykKICAgICAgICAgICAgICB9CiAgICAgICAgICB9OwogICAgICAgICAgdmFyIGQgPSAhMTsKICAgICAgICAgIHYucmVzdGFydFdlYkFuaW1hdGlvbnNOZXh0VGljayA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIGQgfHwgKGQgPSAhMCwKICAgICAgICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZikpCiAgICAgICAgICB9CiAgICAgICAgICA7CiAgICAgICAgICB2YXIgYSA9IG5ldyB2LkFuaW1hdGlvblRpbWVsaW5lOwogICAgICAgICAgdi50aW1lbGluZSA9IGE7CiAgICAgICAgICB0cnkgewogICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh3aW5kb3cuZG9jdW1lbnQsICJ0aW1lbGluZSIsIHsKICAgICAgICAgICAgICAgICAgY29uZmlndXJhYmxlOiAhMCwKICAgICAgICAgICAgICAgICAgZ2V0OiBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhCiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KQogICAgICAgICAgfSBjYXRjaCAoYykge30KICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgd2luZG93LmRvY3VtZW50LnRpbWVsaW5lID0gYQogICAgICAgICAgfSBjYXRjaCAoYykge30KCiAgICAgICAgKi8KCgoKICAgICAgICAvKgoKICAgICAgdmFyIGcgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZTsKICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHdpbmRvdywgImdldENvbXB1dGVkU3R5bGUiLCB7CiAgICAgICAgICBjb25maWd1cmFibGU6ICEwLAogICAgICAgICAgZW51bWVyYWJsZTogITAsCiAgICAgICAgICB2YWx1ZTogZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdi50aW1lbGluZS5fdXBkYXRlQW5pbWF0aW9uc1Byb21pc2VzKCk7CiAgICAgICAgICAgICAgdmFyIGUgPSBnLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7CiAgICAgICAgICAgICAgaCgpICYmIChlID0gZy5hcHBseSh0aGlzLCBhcmd1bWVudHMpKTsKICAgICAgICAgICAgICB2LnRpbWVsaW5lLl91cGRhdGVBbmltYXRpb25zUHJvbWlzZXMoKTsKICAgICAgICAgICAgICByZXR1cm4gZQogICAgICAgICAgfQogICAgICB9KTsKCiAgICAgICovCgoKCgogICAgICB9CgoKCgogICAgfSkoKTsKCiAgICAhaXNVcmxJbkVtYmVkICYmIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4gewoKICAgICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IEZJWF9hdm9pZF9pbmNvcnJlY3RfdmlkZW9fbWV0YSA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KCgoKICAgICAgY2xhc3MgTGltaXRlZFNpemVTZXQgZXh0ZW5kcyBTZXQgewogICAgICAgIGNvbnN0cnVjdG9yKG4pIHsKICAgICAgICAgIHN1cGVyKCk7CiAgICAgICAgICB0aGlzLmxpbWl0ID0gbjsKICAgICAgICB9CgogICAgICAgIGFkZChrZXkpIHsKICAgICAgICAgIGlmICghc3VwZXIuaGFzKGtleSkpIHsKICAgICAgICAgICAgc3VwZXIuYWRkKGtleSk7CiAgICAgICAgICAgIGxldCBuID0gc3VwZXIuc2l6ZSAtIHRoaXMubGltaXQ7CiAgICAgICAgICAgIGlmIChuID4gMCkgewogICAgICAgICAgICAgIGNvbnN0IGl0ZXJhdG9yID0gc3VwZXIudmFsdWVzKCk7CiAgICAgICAgICAgICAgZG8gewogICAgICAgICAgICAgICAgY29uc3QgZmlyc3RLZXkgPSBpdGVyYXRvci5uZXh0KCkudmFsdWU7IC8vIEdldCB0aGUgZmlyc3QgKG9sZGVzdCkga2V5CiAgICAgICAgICAgICAgICBzdXBlci5kZWxldGUoZmlyc3RLZXkpOyAvLyBEZWxldGUgdGhlIG9sZGVzdCBrZXkKICAgICAgICAgICAgICB9IHdoaWxlICgtLW4gPiAwKQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICByZW1vdmVBZGQoa2V5KSB7CiAgICAgICAgICBzdXBlci5kZWxldGUoa2V5KTsKICAgICAgICAgIHRoaXMuYWRkKGtleSk7CiAgICAgICAgfQoKICAgICAgfQoKICAgICAgLy8gY29uc3Qgd2szID0gbmV3IFdlYWtNYXAoKTsKCiAgICAgIC8vIGxldCBtdHhWaWRlb0lkID0gJyc7CiAgICAgIC8vIGxldCBhamUzID0gW107CiAgICAgIGNvbnN0IG1mdkNvbnRpbnVhdGlvblJlY29yZGVkID0gbmV3IExpbWl0ZWRTaXplU2V0KDgpOyAgICAgIC8vIHJlY29yZCBhbGwgc3VjY2VzcyBjb250aW51YXRpb24ga2V5cwogICAgICBjb25zdCBtZnlDb250aW51YXRpb25JZ25vcmVkID0gbmV3IExpbWl0ZWRTaXplU2V0KDgpOyAgICAgICAvLyBpZ25vcmUgY29udGludWF0aW9uIGtleXMgYnkgY29weWluZyB0aGUga2V5cyBpbiB0aGUgcGFzdAogICAgICBsZXQgbXR6bGFzdEFsbG93ZWRDb250aW51YXRpb24gPSAnJzsgIC8vIHRoZSBrZXkgc3RvcmVkIGF0IHRoZSBsYXN0IHN1Y2Nlc3M7IGNsZWFyIHdoZW4gc2NoZWR1bGluZyBjaGFuZ2VzCiAgICAgIGxldCBtdHpDb3VudCA9IDA7ICAgICAgICAgICAgIC8vIHRoZSBrZXkga2VlcHMgdW5jaGFuZ2VkCiAgICAgIC8vIGxldCBtanROZXh0TWFpbktleSA9ICcnOwogICAgICBsZXQgbWp0UmVjb3JkZWRQcmV2S2V5ID0gJyc7IC8vIHRoZSBrZXkgc3RvcmVkIGF0IHRoZSBsYXN0IHN1Y2Nlc3MgKG5vIGNsZWFyKQogICAgICBsZXQgbWp0TG9ja1ByZXZpb3VzS2V5ID0gJyc7IC8vIHRoZSBrZXkgYmVmb3JlIGZldGNoKCkgc2hvdWxkIGJlIGRpc2NhcmRlZC4gKHVuY2VydGFpbiBjb250aW51YXRpb24pCiAgICAgIGxldCBtYkNJZDMyMiA9IDA7ICAgICAgICAgICAgICAvLyBjaWQgZm9yIGRlbGF5IGZldGNoVXBkYXRlZE1ldGFkYXRhCiAgICAgIC8vIGxldCBhbGxvd05vRGVsYXkzMjI9ZmFsc2U7CiAgICAgIGxldCBtYkRlbGF5QmVsb3dOQ2FsbHMgPSAwOyAgIC8vIGFmdGVyIE4gY2FsbHMsIGJ5IHBhc3MgZGVsYXk7IHJlc2V0IHdoZW4gc2NoZWR1bGluZyBjaGFuZ2VzCgogICAgICBsZXQgbXBLZXkyMiA9ICcnOyAgICAgICAgICAgLy8gbGFzdCBzdWNjZXNzIGNvbnRpbnV0YXRpb24ga2V5ICYgdXJsIHBhaXIKICAgICAgbGV0IG1wVXJsMjIgPSAnJzsgICAgICAgICAgLy8gbGFzdCBzdWNjZXNzIGNvbnRpbnV0YXRpb24ga2V5ICYgdXJsIHBhaXIKICAgICAgbGV0IG1wS2V5MjEgPSAnJzsgICAgICAgICAgIC8vIGxhdGVzdCByZXF1ZXN0ZWQgY29udGludXRhdGlvbiBrZXkgJiB1cmwgcGFpcgogICAgICBsZXQgbXBVcmwyMSA9ICcnOyAgICAgICAgIC8vIGxhdGVzdCByZXF1ZXN0ZWQgY29udGludXRhdGlvbiBrZXkgJiB1cmwgcGFpcgoKCiAgICAgIGFzeW5jIGZ1bmN0aW9uIHNoYTFIZXgobWVzc2FnZSkgewogICAgICAgIGNvbnN0IG1zZ1VpbnQ4ID0gbmV3IFRleHRFbmNvZGVyKCkuZW5jb2RlKG1lc3NhZ2UpOyAvLyBlbmNvZGUgYXMgKHV0Zi04KSBVaW50OEFycmF5CiAgICAgICAgY29uc3QgaGFzaEJ1ZmZlciA9IGF3YWl0IGNyeXB0by5zdWJ0bGUuZGlnZXN0KCJTSEEtMSIsIG1zZ1VpbnQ4KTsgLy8gaGFzaCB0aGUgbWVzc2FnZQogICAgICAgIGNvbnN0IGhhc2hBcnJheSA9IEFycmF5LmZyb20obmV3IFVpbnQ4QXJyYXkoaGFzaEJ1ZmZlcikpOyAvLyBjb252ZXJ0IGJ1ZmZlciB0byBieXRlIGFycmF5CiAgICAgICAgY29uc3QgaGFzaEhleCA9IGhhc2hBcnJheQogICAgICAgICAgLm1hcCgoYikgPT4gYi50b1N0cmluZygxNikucGFkU3RhcnQoMiwgIjAiKSkKICAgICAgICAgIC5qb2luKCIiKTsgLy8gY29udmVydCBieXRlcyB0byBoZXggc3RyaW5nCiAgICAgICAgcmV0dXJuIGhhc2hIZXg7CiAgICAgIH0KCiAgICAgIGFzeW5jIGZ1bmN0aW9uIGNvbnRpbnVhdGlvbkxvZyhhLCAuLi5hcmdzKSB7CiAgICAgICAgbGV0IGIgPSBhOwogICAgICAgIHRyeSB7CiAgICAgICAgICBpZiAoYWR2YW5jZUxvZ2dpbmcpIGIgPSBhd2FpdCBzaGExSGV4KGEpOwogICAgICAgICAgbGV0IGMgPSBhcmdzLm1hcChlID0+IHsKICAgICAgICAgICAgcmV0dXJuIGUgPT09IGEgPyBiIDogZQogICAgICAgICAgfSk7CiAgICAgICAgICBjb25zb2xlLmxvZyguLi5jKQogICAgICAgIH0gY2F0Y2ggKGUpIHsgY29uc29sZS53YXJuKGUpIH0KICAgICAgfQoKICAgICAgZnVuY3Rpb24gY29weVByZXZpb3VzQ29udGl1YXRpb25Ub0lnbm9yZWQzNzQodG9DbGVhclJlY29yZGVkKSB7CgoKICAgICAgICBpZiAobWZ2Q29udGludWF0aW9uUmVjb3JkZWQubGVuZ3RoID4gMCkgewogICAgICAgICAgZm9yIChjb25zdCBbZSwgZF0gb2YgbWZ2Q29udGludWF0aW9uUmVjb3JkZWQpIHsKICAgICAgICAgICAgbWZ5Q29udGludWF0aW9uSWdub3JlZC5yZW1vdmVBZGQoZSk7CiAgICAgICAgICB9CiAgICAgICAgICB0b0NsZWFyUmVjb3JkZWQgJiYgbWZ2Q29udGludWF0aW9uUmVjb3JkZWQuY2xlYXIoKTsKICAgICAgICB9CgogICAgICB9CgogICAgICBmdW5jdGlvbiBzZXR1cF95dFRhc2tFbWl0dGVyQmVoYXZpb3JfVGFza01ncjM3NCh0YXNrTWdyKSB7CgogICAgICAgIGNvbnN0IHRtUHJvdG8gPSB0YXNrTWdyLmNvbnN0cnVjdG9yLnByb3RvdHlwZTsKICAgICAgICBpZiAodG1Qcm90byAmJiB0eXBlb2YgdG1Qcm90by5hZGRKb2IgPT09ICdmdW5jdGlvbicgJiYgdG1Qcm90by5hZGRKb2IubGVuZ3RoID09PSAzICYmIHR5cGVvZiB0bVByb3RvLmNhbmNlbEpvYiA9PT0gJ2Z1bmN0aW9uJyAmJiB0bVByb3RvLmNhbmNlbEpvYi5sZW5ndGggPT09IDEpIHsKCiAgICAgICAgICBpZiAoIXRtUHJvdG8uYWRkSm9iNzE0KSB7CgogICAgICAgICAgICB0bVByb3RvLmFkZEpvYjcxNCA9IHRtUHJvdG8uYWRkSm9iOwoKICAgICAgICAgICAgdG1Qcm90by5hZGRKb2IgPSBmdW5jdGlvbiAoYSwgYiwgYykgewogICAgICAgICAgICAgIGNvbnN0IGpvYklkID0gdGhpcy5hZGRKb2I3MTQoYSwgYiwgYyk7CiAgICAgICAgICAgICAgaWYgKGpvYklkID4gMCkgewogICAgICAgICAgICAgICAgLy8gY29uc3QgZXogPSB3azMuZ2V0KHRoaXMpOwogICAgICAgICAgICAgICAgLy8gY29uc3QgZHogPSBleiA/IGV6LmRhdGE/LnVwZGF0ZWRNZXRhZGF0YUVuZHBvaW50Py51cGRhdGVkTWV0YWRhdGFFbmRwb2ludCA6IG51bGw7CiAgICAgICAgICAgICAgICAvLyBhamUzLnB1c2goe210eCwgam9iSWQsIGEsYixjLCBlbGVtZW50OiB0aGlzLCBkeiwgZGF0YTogKGV6Py5kYXRhIHx8IG51bGwpIH0pCgogICAgICAgICAgICAgICAgdGhpcy5fX2xhc3RKb2JJZDg2M19fID0gam9iSWQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIHJldHVybiBqb2JJZDsKICAgICAgICAgICAgfQoKICAgICAgICAgIH0KCiAgICAgICAgICBpZiAoIXRtUHJvdG8uY2FuY2VsSm9iNzE0KSB7CgogICAgICAgICAgICB0bVByb3RvLmNhbmNlbEpvYjcxNCA9IHRtUHJvdG8uY2FuY2VsSm9iOwoKICAgICAgICAgICAgdG1Qcm90by5jYW5jZWxKb2IgPSBmdW5jdGlvbiAoYSkgewogICAgICAgICAgICAgIGNvbnN0IHJlcyA9IHRoaXMuY2FuY2VsSm9iNzE0KGEpOwogICAgICAgICAgICAgIC8vIGlmIChhID4gMCkgewogICAgICAgICAgICAgIC8vICAgZm9yIChjb25zdCBlIG9mIGFqZTMpIHsKICAgICAgICAgICAgICAvLyAgICAgaWYgKGUuam9iSWQgPT09IGEpIGUuY2FuY2VsbGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAvLyAgIH0KICAgICAgICAgICAgICAvLyB9CiAgICAgICAgICAgICAgcmV0dXJuIHJlczsKICAgICAgICAgICAgfQoKICAgICAgICAgIH0KCiAgICAgICAgfQogICAgICB9CgoKICAgICAgY29uc3QgRklYX2F2b2lkX2luY29ycmVjdF92aWRlb19tZXRhX2Jvb2wgPSBGSVhfYXZvaWRfaW5jb3JyZWN0X3ZpZGVvX21ldGEgJiYgaXNQcmVwYXJlQ2FjaGVkViAmJiBjaGVja19mb3Jfc2V0X2tleV9vcmRlcjsKCgogICAgICBGSVhfYXZvaWRfaW5jb3JyZWN0X3ZpZGVvX21ldGFfYm9vbCAmJiB3aGVuQ0VEZWZpbmVkKCd5dGQtdmlkZW8tcHJpbWFyeS1pbmZvLXJlbmRlcmVyJykudGhlbigoKSA9PiB7CiAgICAgICAgbGV0IGR1bW15OwogICAgICAgIGxldCBjUHJvdG87CiAgICAgICAgLy8gbGV0IG1jID0gNDsKICAgICAgICAvLyBkdW1teSA9IGF3YWl0IG9ic2VydmFibGVQcm9taXNlKCgpID0+IHsKICAgICAgICAvLyAgIGNvbnN0IHIgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCd5dGQtdmlkZW8tcHJpbWFyeS1pbmZvLXJlbmRlcmVyJyk7CiAgICAgICAgLy8gICBpZiAoIXIpIHJldHVybjsKICAgICAgICAvLyAgIGxldCBjUHJvdG8gPSBpbnNwKHIpLmNvbnN0cnVjdG9yLnByb3RvdHlwZTsKICAgICAgICAvLyAgIGlmIChjUHJvdG8uZmV0Y2hVcGRhdGVkTWV0YWRhdGEpIHJldHVybiByOwogICAgICAgIC8vICAgaWYgKC0tbWMgPCAwKSByZXR1cm4gLTE7CiAgICAgICAgLy8gICByZXR1cm4gbnVsbDsKICAgICAgICAvLyB9KS5vYnRhaW4oKTsKICAgICAgICBkdW1teSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3l0ZC12aWRlby1wcmltYXJ5LWluZm8tcmVuZGVyZXInKTsKICAgICAgICBpZiAoIShkdW1teSBpbnN0YW5jZW9mIEVsZW1lbnQpKSByZXR1cm47CiAgICAgICAgLy8gY29uc29sZS5sb2coNTAyMiwgZHVtbXkpCiAgICAgICAgY1Byb3RvID0gaW5zcChkdW1teSkuY29uc3RydWN0b3IucHJvdG90eXBlOwoKICAgICAgICBjUHJvdG8uX19nZXRFbWl0dG9yVGFza01ncjg1OV9fID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgbGV0IHRhc2tNZ3JfID0gbnVsbDsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIHRhc2tNZ3JfID0gKHRoaXMueXRUYXNrRW1pdHRlckJlaGF2aW9yIHx8IDApLmdldFRhc2tNYW5hZ2VyKCkgfHwgbnVsbDsKICAgICAgICAgIH0gY2F0Y2ggKGUpIHsgfQogICAgICAgICAgcmV0dXJuIHRhc2tNZ3JfOwogICAgICAgIH0KICAgICAgICBpZiAodHlwZW9mIGNQcm90by5mZXRjaFVwZGF0ZWRNZXRhZGF0YSA9PT0gJ2Z1bmN0aW9uJyAmJiBjUHJvdG8uZmV0Y2hVcGRhdGVkTWV0YWRhdGEubGVuZ3RoID09PSAxICYmICFjUHJvdG8uZmV0Y2hVcGRhdGVkTWV0YWRhdGE3MTcpIHsKICAgICAgICAgIC8vIGNvbnNvbGUubG9nKDEyMzQsIGNQcm90bywgY1Byb3RvLmlzKQogICAgICAgICAgY1Byb3RvLmZldGNoVXBkYXRlZE1ldGFkYXRhNzE3ID0gY1Byb3RvLmZldGNoVXBkYXRlZE1ldGFkYXRhOwoKICAgICAgICAgIGxldCBjXzsKICAgICAgICAgIGNQcm90by5mZXRjaFVwZGF0ZWRNZXRhZGF0YTcxOCA9IGZ1bmN0aW9uIChhKSB7CiAgICAgICAgICAgIC8vIGRlbGF5IG9yIGltbWVkaWF0ZSBjYWxsIHRoZSBhY3R1YWwgZmV0Y2hVcGRhdGVkTWV0YWRhdGEKCiAgICAgICAgICAgIGxldCBkb0ltbWVkaWF0ZWx5ID0gZmFsc2U7CiAgICAgICAgICAgIGlmIChhICYmIHR5cGVvZiBhID09PSAnc3RyaW5nJyAmJiBtanRSZWNvcmRlZFByZXZLZXkgJiYgbWp0UmVjb3JkZWRQcmV2S2V5ID09PSBtcEtleTIyICYmIGEgPT09IG1wS2V5MjIgJiYgKCFwYWdlU2V0dXBWaWRlb0lkIHx8IHBhZ2VTZXR1cFZpZGVvSWQgIT09IG1wVXJsMjIpKSB7CgogICAgICAgICAgICAgIGlmICghcGFnZVNldHVwVmlkZW9JZCAmJiB2aWRlb1BsYXlpbmdZLnZpZGVvSWQgPT09IG1wVXJsMjIpIGRvSW1tZWRpYXRlbHkgPSB0cnVlOwoKICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYSAhPT0gJ3N0cmluZycgfHwgbWJEZWxheUJlbG93TkNhbGxzID4gMyB8fCAhbXBLZXkyMiB8fCAobXBLZXkyMiA9PT0gYSAmJiBtcEtleTIyICE9PSBtanRMb2NrUHJldmlvdXNLZXkpIHx8IChtanRMb2NrUHJldmlvdXNLZXkgJiYgbWp0TG9ja1ByZXZpb3VzS2V5ICE9PSBhKSkgewoKICAgICAgICAgICAgICBkb0ltbWVkaWF0ZWx5ID0gdHJ1ZTsKCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIChtYkNJZDMyMikgewogICAgICAgICAgICAgIGNsZWFyVGltZW91dChtYkNJZDMyMik7CiAgICAgICAgICAgICAgbWJDSWQzMjIgPSAwOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoZG9JbW1lZGlhdGVseSkgcmV0dXJuIHRoaXMuZmV0Y2hVcGRhdGVkTWV0YWRhdGE3MTcoYSk7CgogICAgICAgICAgICBsZXQgZGVsYXkgPSBtanRMb2NrUHJldmlvdXNLZXkgPT09IGEgPyA4MDAwIDogODAwOwoKICAgICAgICAgICAgbWJDSWQzMjIgPSBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgICB0aGlzLmZldGNoVXBkYXRlZE1ldGFkYXRhNzE3KGEpOwogICAgICAgICAgICB9LCBkZWxheSk7CgogICAgICAgICAgICBjb25zb2xlLmxvZygnW3l0LWpzLWVuZ2luZS10YW1lcl0nLCAnNTE5MCBkZWxheWVkIGZldGNoVXBkYXRlZE1ldGFkYXRhJywgZGVsYXkpOwoKICAgICAgICAgIH0KCiAgICAgICAgICBjUHJvdG8uZmV0Y2hVcGRhdGVkTWV0YWRhdGEgPSBmdW5jdGlvbiAoYSkgewoKICAgICAgICAgICAgaWYgKCFwYWdlU2V0dXBTdGF0ZSkgewogICAgICAgICAgICAgIGlmIChjXykgY2xlYXJUaW1lb3V0KGNfKTsKICAgICAgICAgICAgICBjXyA9IHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgICAgICAgICAgdGhpcy5mZXRjaFVwZGF0ZWRNZXRhZGF0YTcxOChhKTsKICAgICAgICAgICAgICB9LCAzMDApOwogICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gcGFnZVNldHVwU3RhdGUgPT0gMAoKICAgICAgICAgICAgdHJ5IHsKCiAgICAgICAgICAgICAgbWJEZWxheUJlbG93TkNhbGxzKys7CgogICAgICAgICAgICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMSB8fCAhKGEgPT09IHVuZGVmaW5lZCB8fCAodHlwZW9mIGEgPT09ICdzdHJpbmcnICYmIGEpKSkgewogICAgICAgICAgICAgICAgY29uc29sZS53YXJuKCJDQVVUSU9OOiBmZXRjaFVwZGF0ZWRNZXRhZGF0YSBjb2RpbmcgbWlnaHQgaGF2ZSB0byBiZSB1cGRhdGVkLiIpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coJ2Z1bTM3NycsIGEpCiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBhID09PSAnc3RyaW5nJyAmJiBtZnlDb250aW51YXRpb25JZ25vcmVkLmhhcyhhKSkgewogICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ1t5dC1qcy1lbmdpbmUtdGFtZXJdJywgJzUwNDAgc2tpcCBmZXRjaFVwZGF0ZWRNZXRhZGF0YScsIGEpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYgKCFhICYmICh0aGlzLmRhdGEgfHwgMCkudXBkYXRlZE1ldGFkYXRhRW5kcG9pbnQpIHsKICAgICAgICAgICAgICAgIGlmIChtanRSZWNvcmRlZFByZXZLZXkgJiYgbWp0TG9ja1ByZXZpb3VzS2V5ICE9PSBtanRSZWNvcmRlZFByZXZLZXkpIHsKICAgICAgICAgICAgICAgICAgbWp0TG9ja1ByZXZpb3VzS2V5ID0gbWp0UmVjb3JkZWRQcmV2S2V5OwogICAgICAgICAgICAgICAgICBMT0dfRkVUQ0hNRVRBX1VQREFURSAmJiBjb250aW51YXRpb25Mb2cobWp0TG9ja1ByZXZpb3VzS2V5LCAnNTE1MCBMb2NrIEtleScsIG1qdExvY2tQcmV2aW91c0tleSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAvLyBtanROZXh0TWFpbktleSA9IHRydWU7CiAgICAgICAgICAgICAgICBtdHpsYXN0QWxsb3dlZENvbnRpbnVhdGlvbiA9ICcnOwogICAgICAgICAgICAgICAgbXR6Q291bnQgPSAwOwogICAgICAgICAgICAgICAgLy8gYWxsb3dOb0RlbGF5MzIyID0gZmFsc2U7CiAgICAgICAgICAgICAgICAvLyBmZXRjaCBuZXcgbWV0YWRhdGEsIGNhbmNlbCBhbGwgcHJldmlvdXMgY29udGludWF0aW9ucwogICAgICAgICAgICAgICAgY29weVByZXZpb3VzQ29udGl1YXRpb25Ub0lnbm9yZWQzNzQodHJ1ZSk7CiAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHZpZGVvUGxheWluZ0lkID0gdmlkZW9QbGF5aW5nWS52aWRlb0lkOwoKICAgICAgICAgICAgICAgIC8vIGlmKG1qdE5leHRNYWluS2V5ID09PSB0cnVlKSBtanROZXh0TWFpbktleSA9IGE7CgogICAgICAgICAgICAgICAgbGV0IHVwZGF0ZTIxID0gISFwYWdlU2V0dXBWaWRlb0lkOwogICAgICAgICAgICAgICAgaWYgKG1wS2V5MjIgPT09IGEgJiYgbXBVcmwyMiA9PT0gdmlkZW9QbGF5aW5nSWQgJiYgbXBVcmwyMiAmJiB2aWRlb1BsYXlpbmdJZCAmJiAoIXBhZ2VTZXR1cFZpZGVvSWQgfHwgcGFnZVNldHVwVmlkZW9JZCA9PT0gdmlkZW9QbGF5aW5nSWQpKSB7CiAgICAgICAgICAgICAgICAgIHVwZGF0ZTIxID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobXBLZXkyMiA9PT0gYSAmJiBtcFVybDIyICE9PSBwYWdlU2V0dXBWaWRlb0lkKSB7CiAgICAgICAgICAgICAgICAgIExPR19GRVRDSE1FVEFfVVBEQVRFICYmIGNvbnRpbnVhdGlvbkxvZyhtcEtleTIyLCAnNTA2MCBtcFVybDIyIG1pc21hdGNoZWQnLCBtcEtleTIyLCBtcFVybDIyLCBwYWdlU2V0dXBWaWRlb0lkIHx8ICcobnVsbCknLCB2aWRlb1BsYXlpbmdJZCB8fCAnKG51bGwpJyk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh1cGRhdGUyMSkgewogICAgICAgICAgICAgICAgICBtcEtleTIxID0gYTsKICAgICAgICAgICAgICAgICAgbXBVcmwyMSA9IHBhZ2VTZXR1cFZpZGVvSWQgfHwgdmlkZW9QbGF5aW5nSWQ7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYgKCFtZnZDb250aW51YXRpb25SZWNvcmRlZC5oYXMoYSkpIG1mdkNvbnRpbnVhdGlvblJlY29yZGVkLmFkZChhKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgTE9HX0ZFVENITUVUQV9VUERBVEUgJiYgY29udGludWF0aW9uTG9nKGEsICc1MTgwIGZldGNoVXBkYXRlZE1ldGFkYXRhXHQnLCBhLCBwYWdlU2V0dXBWaWRlb0lkIHx8ICcobnVsbCknLCB2aWRlb1BsYXlpbmdZLnZpZGVvSWQgfHwgJyhudWxsKScpOwogICAgICAgICAgICAgIC8vIGlmICghcGFnZVNldHVwVmlkZW9JZCAmJiB0eXBlb2YgYSA9PT0gJ3N0cmluZycgJiYgYS5sZW5ndGggPiA0MCkgcmV0dXJuOyAvLyBpZ25vcmUgaW5jb3JyZWN0IGNvbnRpbnVhdGlvbgogICAgICAgICAgICAgIC8vIGlmKGEgPT09IG1qdE5leHRNYWluS2V5KSBhbGxvd05vRGVsYXkzMjIgPSBmYWxzZTsKICAgICAgICAgICAgICByZXR1cm4gdGhpcy5mZXRjaFVwZGF0ZWRNZXRhZGF0YTcxOChhKTsKCiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICBjb25zb2xlLmxvZygnQ29kZSBFcnJvciBpbiBmZXRjaFVwZGF0ZWRNZXRhZGF0YScsIGUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB0aGlzLmZldGNoVXBkYXRlZE1ldGFkYXRhNzE3KGEpCiAgICAgICAgICB9CiAgICAgICAgfQoKCiAgICAgICAgaWYgKHR5cGVvZiBjUHJvdG8uc2NoZWR1bGVJbml0aWFsVXBkYXRlZE1ldGFkYXRhUmVxdWVzdCA9PT0gJ2Z1bmN0aW9uJyAmJiBjUHJvdG8uc2NoZWR1bGVJbml0aWFsVXBkYXRlZE1ldGFkYXRhUmVxdWVzdC5sZW5ndGggPT09IDAgJiYgIWNQcm90by5zY2hlZHVsZUluaXRpYWxVcGRhdGVkTWV0YWRhdGFSZXF1ZXN0NzE3KSB7CiAgICAgICAgICAvLyBjb25zb2xlLmxvZygxMjM0LCBjUHJvdG8sIGNQcm90by5pcykKICAgICAgICAgIGNQcm90by5zY2hlZHVsZUluaXRpYWxVcGRhdGVkTWV0YWRhdGFSZXF1ZXN0NzE3ID0gY1Byb3RvLnNjaGVkdWxlSW5pdGlhbFVwZGF0ZWRNZXRhZGF0YVJlcXVlc3Q7CiAgICAgICAgICBsZXQgbUpvYiA9IG51bGw7CgogICAgICAgICAgY1Byb3RvLnNjaGVkdWxlSW5pdGlhbFVwZGF0ZWRNZXRhZGF0YVJlcXVlc3QgPSBmdW5jdGlvbiAoKSB7CgogICAgICAgICAgICB0cnkgewoKICAgICAgICAgICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQ0FVVElPTjogc2NoZWR1bGVJbml0aWFsVXBkYXRlZE1ldGFkYXRhUmVxdWVzdCBjb2RpbmcgbWlnaHQgaGF2ZSB0byBiZSB1cGRhdGVkLiIpOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAvLyBtZnkgPSBtZnY7CgogICAgICAgICAgICAgIC8vIG1qdE5leHRNYWluS2V5ID0gJyc7CiAgICAgICAgICAgICAgbXR6bGFzdEFsbG93ZWRDb250aW51YXRpb24gPSAnJzsKICAgICAgICAgICAgICBtdHpDb3VudCA9IDA7CiAgICAgICAgICAgICAgaWYgKG1iQ0lkMzIyKSB7CiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQobWJDSWQzMjIpOwogICAgICAgICAgICAgICAgbWJDSWQzMjIgPSAwOwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBtYkRlbGF5QmVsb3dOQ2FsbHMgPSAwOwogICAgICAgICAgICAgIC8vIGFsbG93Tm9EZWxheTMyMiA9IGZhbHNlOwogICAgICAgICAgICAgIGNvcHlQcmV2aW91c0NvbnRpdWF0aW9uVG9JZ25vcmVkMzc0KHRydWUpOwoKICAgICAgICAgICAgICBjb25zdCB0YXNrTWdyID0gdGhpcy5fX2dldEVtaXR0b3JUYXNrTWdyODU5X18oKTsKICAgICAgICAgICAgICBpZiAoRklYX2F2b2lkX2luY29ycmVjdF92aWRlb19tZXRhX2VtaXR0ZXJCZWhhdmlvciAmJiB0YXNrTWdyICYmICF0YXNrTWdyLmFkZEpvYjcxNCAmJiB0YXNrTWdyLmFkZEpvYiAmJiB0YXNrTWdyLmNhbmNlbEpvYikgc2V0dXBfeXRUYXNrRW1pdHRlckJlaGF2aW9yX1Rhc2tNZ3IzNzQodGFza01ncik7CiAgICAgICAgICAgICAgaWYgKEZJWF9hdm9pZF9pbmNvcnJlY3RfdmlkZW9fbWV0YV9lbWl0dGVyQmVoYXZpb3IgJiYgdGFza01nciAmJiAhdGFza01nci5hZGRKb2I3MTQpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdbeXQtanMtZW5naW5lLXRhbWVyXScsICdzY2hlZHVsZUluaXRpYWxVcGRhdGVkTWV0YWRhdGFSZXF1ZXN0IGVycm9yIDUwNycpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgLy8gcHJldmVudCBkZXB1bGljYXRlZCBzY2hlZHVsZSBqb2IgYnkgY2xlYXJpbmcgcHJldmlvdXMgSm9iSWQKICAgICAgICAgICAgICBpZiAodGFza01nciAmJiB0eXBlb2YgdGFza01nci5hZGRMb3dQcmlvcml0eUpvYiA9PT0gJ2Z1bmN0aW9uJyAmJiB0YXNrTWdyLmFkZExvd1ByaW9yaXR5Sm9iLmxlbmd0aCA9PT0gMiAmJiB0eXBlb2YgdGFza01nci5jYW5jZWxKb2IgPT09ICdmdW5jdGlvbicgJiYgdGFza01nci5jYW5jZWxKb2IubGVuZ3RoID09PSAxKSB7CgogICAgICAgICAgICAgICAgbGV0IHJlczsKCiAgICAgICAgICAgICAgICBpZiAobUpvYikgewogICAgICAgICAgICAgICAgICBjb25zdCBqb2IgPSBtSm9iOwogICAgICAgICAgICAgICAgICBtSm9iID0gbnVsbDsKICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2NhbmNlbEpvYicsIGpvYikKICAgICAgICAgICAgICAgICAgdGFza01nci5jYW5jZWxKb2Ioam9iKTsgLy8gY2xlYXIgcHJldmlvdXMgW0ludGVydmFsIE1ldGEgVXBkYXRlXSBqb2IKICAgICAgICAgICAgICAgICAgLy8gcC5jYW5jZWxKb2IoYSxiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBjb25zdCB1cGRhdGVkTWV0YWRhdGFFbmRwb2ludCA9IHRoaXMuZGF0YT8udXBkYXRlZE1ldGFkYXRhRW5kcG9pbnQ/LnVwZGF0ZWRNZXRhZGF0YUVuZHBvaW50CgogICAgICAgICAgICAgICAgbGV0IHB6YSA9IHRhc2tNZ3IuX19sYXN0Sm9iSWQ4NjNfXzsKICAgICAgICAgICAgICAgIHRyeSB7IHJlcyA9IHRoaXMuc2NoZWR1bGVJbml0aWFsVXBkYXRlZE1ldGFkYXRhUmVxdWVzdDcxNygpOyB9IGNhdGNoIChlKSB7IH0KICAgICAgICAgICAgICAgIGxldCBwemIgPSB0YXNrTWdyLl9fbGFzdEpvYklkODYzX18KICAgICAgICAgICAgICAgIGlmIChwemEgIT09IHB6YikgewogICAgICAgICAgICAgICAgICBtSm9iID0gcHpiOyAvLyBzZXQgW0ludGVydmFsIE1ldGEgVXBkYXRlXSBqb2JJZAogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIC8vIGlmICh1cGRhdGVkTWV0YWRhdGFFbmRwb2ludCAmJiB1cGRhdGVkTWV0YWRhdGFFbmRwb2ludC52aWRlb0lkKSB7CiAgICAgICAgICAgICAgICAvLyAgIG10eFZpZGVvSWQgPSB1cGRhdGVkTWV0YWRhdGFFbmRwb2ludC52aWRlb0lkIHx8ICcnOyAvLyBzZXQgdGhlIGN1cnJlbnQgdGFyZ2V0IFZpZGVvSWQKICAgICAgICAgICAgICAgIC8vIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAvLyAgIG10eFZpZGVvSWQgPSAnJzsgLy8gc29tZXRpbWVzIHVwZGF0ZWRNZXRhZGF0YUVuZHBvaW50IGlzIG5vdCByZWFkeQogICAgICAgICAgICAgICAgLy8gfQoKICAgICAgICAgICAgICAgIHJldHVybiByZXM7CgogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnW3l0LWpzLWVuZ2luZS10YW1lcl0nLCAnc2NoZWR1bGVJbml0aWFsVXBkYXRlZE1ldGFkYXRhUmVxdWVzdCBlcnJvciA2MDEnKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0NvZGUgRXJyb3IgaW4gc2NoZWR1bGVJbml0aWFsVXBkYXRlZE1ldGFkYXRhUmVxdWVzdCcsIGUpOwogICAgICAgICAgICB9CgoKICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2NoZWR1bGVJbml0aWFsVXBkYXRlZE1ldGFkYXRhUmVxdWVzdDcxNygpOwogICAgICAgICAgfQogICAgICAgIH0KCgogICAgICB9KTsKCiAgICAgIEZJWF9hdm9pZF9pbmNvcnJlY3RfdmlkZW9fbWV0YV9ib29sICYmIHByb21pc2VGb3JZdEFjdGlvbkNhbGxlZC50aGVuKCh5dEFwcERvbSkgPT4gewogICAgICAgIGxldCBkdW1teTsKICAgICAgICBsZXQgY1Byb3RvOwogICAgICAgIGR1bW15ID0geXRBcHBEb207CiAgICAgICAgaWYgKCEoZHVtbXkgaW5zdGFuY2VvZiBFbGVtZW50KSkgcmV0dXJuOwogICAgICAgIGNQcm90byA9IGluc3AoZHVtbXkpLmNvbnN0cnVjdG9yLnByb3RvdHlwZTsKICAgICAgICBpZiAodHlwZW9mIGNQcm90by5zZW5kU2VydmljZUFqYXhfID09PSAnZnVuY3Rpb24nICYmIGNQcm90by5zZW5kU2VydmljZUFqYXhfLmxlbmd0aCA9PT0gNCAmJiAhY1Byb3RvLnNlbmRTZXJ2aWNlQWpheDcxN18pIHsKICAgICAgICAgIC8vIGNvbnNvbGUubG9nKDEyMzQsIGNQcm90bywgY1Byb3RvLmlzKTsKICAgICAgICAgIC8vIGNQcm90by5oYW5kbGVTZXJ2aWNlUmVxdWVzdDcxN18gPSBjUHJvdG8uaGFuZGxlU2VydmljZVJlcXVlc3RfOwogICAgICAgICAgLy8gY1Byb3RvLmhhbmRsZVNlcnZpY2VSZXF1ZXN0XyA9IGZ1bmN0aW9uIChhLCBiLCBjLCBkKSB7CiAgICAgICAgICAvLyAgIGNvbnNvbGUubG9nKDEyMzQwMSwgYXJndW1lbnRzKTsKICAgICAgICAgIC8vICAgcmV0dXJuIHRoaXMuaGFuZGxlU2VydmljZVJlcXVlc3Q3MTdfKGEsIGIsIGMsIGQpOwogICAgICAgICAgLy8gfQoKICAgICAgICAgIC8vIGNQcm90by5oYW5kbGVTZXJ2aWNlUmVxdWVzdDcxN18gPSBjUHJvdG8uaGFuZGxlU2VydmljZVJlcXVlc3RfOwoKICAgICAgICAgIC8vIGNQcm90by5oYW5kbGVTZXJ2aWNlUmVxdWVzdF8gPSBmdW5jdGlvbihhLGIsYyxkKXsKICAgICAgICAgIC8vICAgY29uc29sZS5sb2coNTk5MDEsIGE/LmlzLCBiPy51cGRhdGVkTWV0YWRhdGFFbmRwb2ludD8udmlkZW9JZCwgYz8uY29udGludWF0aW9uKQogICAgICAgICAgLy8gICBpZihhPy5pcyA9PT0gJ3l0ZC12aWRlby1wcmltYXJ5LWluZm8tcmVuZGVyZXInICYmIGI/LnVwZGF0ZWRNZXRhZGF0YUVuZHBvaW50Py52aWRlb0lkICYmIGM/LmNvbnRpbnVhdGlvbiAmJiB0eXBlb2YgYz8uY29udGludWF0aW9uID09PSdzdHJpbmcnKXsKICAgICAgICAgIC8vICAgICBjb25zb2xlLmxvZygnbWZ2JywgYy5jb250aW51YXRpb24pOwogICAgICAgICAgLy8gICAgIG1mdi5hZGQoIGMuY29udGludWF0aW9uKTsKICAgICAgICAgIC8vICAgfQogICAgICAgICAgLy8gICByZXR1cm4gdGhpcy5oYW5kbGVTZXJ2aWNlUmVxdWVzdDcxN18oYSxiLGMsZCk7CiAgICAgICAgICAvLyB9CgogICAgICAgICAgZnVuY3Rpb24gZXh0cmFBcmd1bWVudHMzMjIoYSwgYiwgYykgewogICAgICAgICAgICBsZXQgaXMgPSAoYSB8fCAwKS5pczsKICAgICAgICAgICAgbGV0IHZpZGVvSWQgPSAoKGIgfHwgMCkudXBkYXRlZE1ldGFkYXRhRW5kcG9pbnQgfHwgMCkudmlkZW9JZDsKICAgICAgICAgICAgbGV0IGNvbnRpbnVhdGlvbiA9IChjIHx8IDApLmNvbnRpbnVhdGlvbjsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpcyAhPT0gJ3N0cmluZycpIGlzID0gbnVsbDsKICAgICAgICAgICAgaWYgKHR5cGVvZiB2aWRlb0lkICE9PSAnc3RyaW5nJykgdmlkZW9JZCA9IG51bGw7CiAgICAgICAgICAgIGlmICh0eXBlb2YgY29udGludWF0aW9uICE9PSAnc3RyaW5nJykgY29udGludWF0aW9uID0gbnVsbDsKICAgICAgICAgICAgcmV0dXJuIHsgaXMsIHZpZGVvSWQsIGNvbnRpbnVhdGlvbiB9OwogICAgICAgICAgfQoKICAgICAgICAgIGNQcm90by5zZW5kU2VydmljZUFqYXg3MTdfID0gY1Byb3RvLnNlbmRTZXJ2aWNlQWpheF87CiAgICAgICAgICBjUHJvdG8uc2VuZFNlcnZpY2VBamF4XyA9IGZ1bmN0aW9uIChhLCBiLCBjLCBkKSB7CgogICAgICAgICAgICAvLyBjb25zb2xlLmxvZyg4MDAxKQogICAgICAgICAgICB0cnkgewoKICAgICAgICAgICAgICBjb25zdCB7IGlzLCB2aWRlb0lkLCBjb250aW51YXRpb24gfSA9IGV4dHJhQXJndW1lbnRzMzIyKGEsIGIsIGMpOwoKICAgICAgICAgICAgICBpZiAoKHZpZGVvSWQgfHwgY29udGludWF0aW9uKSAmJiAoaXMgIT09ICd5dGQtdmlkZW8tcHJpbWFyeS1pbmZvLXJlbmRlcmVyJykpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQ0FVVElPTjogc2VuZFNlcnZpY2VBamF4XyBjb2RpbmcgbWlnaHQgaGF2ZSB0byBiZSB1cGRhdGVkLiIpOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgaWYgKHBhZ2VTZXR1cFZpZGVvSWQgJiYgdmlkZW9JZCAmJiBjb250aW51YXRpb24pIHsKICAgICAgICAgICAgICAgIGlmIChtcEtleTIxICYmIG1wVXJsMjEgJiYgbXBLZXkyMSA9PT0gY29udGludWF0aW9uICYmIG1wVXJsMjEgIT09IHBhZ2VTZXR1cFZpZGVvSWQpIHsKICAgICAgICAgICAgICAgICAgbWZ5Q29udGludWF0aW9uSWdub3JlZC5yZW1vdmVBZGQoY29udGludWF0aW9uKTsKICAgICAgICAgICAgICAgICAgbWZ2Q29udGludWF0aW9uUmVjb3JkZWQuZGVsZXRlKGNvbnRpbnVhdGlvbik7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGlmIChtanRMb2NrUHJldmlvdXNLZXkgJiYgbWp0TG9ja1ByZXZpb3VzS2V5ICE9PSBjb250aW51YXRpb24gJiYgY29udGludWF0aW9uKSB7CiAgICAgICAgICAgICAgICBjb3B5UHJldmlvdXNDb250aXVhdGlvblRvSWdub3JlZDM3NChmYWxzZSk7CiAgICAgICAgICAgICAgICBtZnlDb250aW51YXRpb25JZ25vcmVkLmRlbGV0ZShjb250aW51YXRpb24pOwogICAgICAgICAgICAgICAgbWZ2Q29udGludWF0aW9uUmVjb3JkZWQucmVtb3ZlQWRkKGNvbnRpbnVhdGlvbik7CiAgICAgICAgICAgICAgICBtZnlDb250aW51YXRpb25JZ25vcmVkLnJlbW92ZUFkZChtanRMb2NrUHJldmlvdXNLZXkpOwogICAgICAgICAgICAgICAgbWZ2Q29udGludWF0aW9uUmVjb3JkZWQuZGVsZXRlKG1qdExvY2tQcmV2aW91c0tleSk7CiAgICAgICAgICAgICAgICBtanRMb2NrUHJldmlvdXNLZXkgPSAnJzsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgLy8gaWYgKG1qdE5leHRNYWluS2V5ID09PSBjb250aW51YXRpb24pIHsKICAgICAgICAgICAgICAvLyAgIGNvcHlQcmV2aW91c0NvbnRpdWF0aW9uVG9JZ25vcmVkKGZhbHNlKTsKICAgICAgICAgICAgICAvLyAgIG1meUNvbnRpbnVhdGlvbklnbm9yZWQuZGVsZXRlKGNvbnRpbnVhdGlvbik7CiAgICAgICAgICAgICAgLy8gICBtZnZDb250aW51YXRpb25SZWNvcmRlZC5hZGQoY29udGludWF0aW9uKTsKICAgICAgICAgICAgICAvLyB9CgoKICAgICAgICAgICAgICBpZiAobWZ5Q29udGludWF0aW9uSWdub3JlZCAmJiBjb250aW51YXRpb24pIHsKICAgICAgICAgICAgICAgIGlmIChtZnlDb250aW51YXRpb25JZ25vcmVkLmhhcyhjb250aW51YXRpb24pKSB7CiAgICAgICAgICAgICAgICAgIExPR19GRVRDSE1FVEFfVVBEQVRFICYmIGNvbnRpbnVhdGlvbkxvZyhjb250aW51YXRpb24sICc1MjYwIG1hdGNoZWQwMScsIGNvbnRpbnVhdGlvbikKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coNTk5MDIsIGE/LmlzLCBiLGMsZCkKICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyg1OTkwMywgYT8uaXMsIGI/LnVwZGF0ZWRNZXRhZGF0YUVuZHBvaW50Py52aWRlb0lkLCBjPy5jb250aW51YXRpb24pCiAgICAgICAgICAgICAgaWYgKGlzID09PSAneXRkLXZpZGVvLXByaW1hcnktaW5mby1yZW5kZXJlcicgJiYgdmlkZW9JZCAmJiBjb250aW51YXRpb24gJiYgIW1mdkNvbnRpbnVhdGlvblJlY29yZGVkLmhhcyhjb250aW51YXRpb24pKSB7CiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZygnbWZ2Mzc3JywgY29udGludWF0aW9uKTsKICAgICAgICAgICAgICAgIG1mdkNvbnRpbnVhdGlvblJlY29yZGVkLmFkZChjb250aW51YXRpb24pOwogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgLy8gaWYgKHZpZGVvSWQpIHsKICAgICAgICAgICAgICAvLyAgIGlmICghcGFnZVNldHVwVmlkZW9JZCkgcmV0dXJuOyAvLyBpZ25vcmUgcGFnZSBub3QgcmVhZHkKICAgICAgICAgICAgICAvLyAgIC8vIGlmIChtdHhWaWRlb0lkICYmIGIudXBkYXRlZE1ldGFkYXRhRW5kcG9pbnQudmlkZW9JZCAhPT0gbXR4VmlkZW9JZCkgcmV0dXJuOyAvLyBpZ25vcmUgdmlkZW9JRCBub3QgbWF0Y2hlZAogICAgICAgICAgICAgIC8vICAgaWYgKHZpZGVvSWQgIT09IHBhZ2VTZXR1cFZpZGVvSWQpIHsKICAgICAgICAgICAgICAvLyAgICAgcmV0dXJuOwogICAgICAgICAgICAgIC8vICAgfQogICAgICAgICAgICAgIC8vIH0KCiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICBjb25zb2xlLmxvZygnQ29kaW5nIEVycm9yIGluIHNlbmRTZXJ2aWNlQWpheF8nLCBlKQogICAgICAgICAgICB9CiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKDgwMDIpCiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKDEyMzQwMiwgYXJndW1lbnRzKTsKICAgICAgICAgICAgLy8gY29uc29sZS5sb2coNTE2MiwgJ2EnLGE/LmlzLCdiJyxiLCdjJyxjLCdkJyxkKTsKCiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKDUyMTEsIGI/LnVwZGF0ZWRNZXRhZGF0YUVuZHBvaW50Py5rZGt3MzMpOwogICAgICAgICAgICAvLyBpZihiICYmYi51cGRhdGVkTWV0YWRhdGFFbmRwb2ludCAmJiAhYi51cGRhdGVkTWV0YWRhdGFFbmRwb2ludC5rZGt3MzMpewogICAgICAgICAgICAvLyAgIGIudXBkYXRlZE1ldGFkYXRhRW5kcG9pbnQgPSBuZXcgUHJveHkoYi51cGRhdGVkTWV0YWRhdGFFbmRwb2ludCwgewogICAgICAgICAgICAvLyAgICAgZ2V0KHRhcmdldCwgcHJvcCwgcmVjZWl2ZXIpewogICAgICAgICAgICAvLyAgICAgICBjb25zb2xlLmxvZygneHhzOTknLCB0YXJnZXQudmlkZW9JZCwgbXR4KQogICAgICAgICAgICAvLyAgICAgICBpZihwcm9wID09PSdrZGt3MzMnKSByZXR1cm4gMTsKICAgICAgICAgICAgLy8gICAgICAgY29uc29sZS5sb2coMzMyMiwgcHJvcCwgdGFyZ2V0KQogICAgICAgICAgICAvLyAgICAgICBpZihwcm9wID09PSAnaW5pdGlhbERlbGF5TXMnKSB7CiAgICAgICAgICAgIC8vICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJBQkNDIik7CiAgICAgICAgICAgIC8vICAgICAgIH0KICAgICAgICAgICAgLy8gICAgICAgcmV0dXJuIHRhcmdldFtwcm9wXTsKICAgICAgICAgICAgLy8gICAgIH0sCiAgICAgICAgICAgIC8vICAgICBzZXQodGFyZ2V0LCBwcm9wLCB2YWx1ZSwgcmVjZWl2ZXIpewoKICAgICAgICAgICAgLy8gICAgICAgaWYocHJvcCA9PT0na2RrdzMzJykgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIC8vICAgICAgIHRhcmdldFtwcm9wXT12YWx1ZTsKICAgICAgICAgICAgLy8gICAgICAgcmV0dXJuIHRydWU7CiAgICAgICAgICAgIC8vICAgICB9CiAgICAgICAgICAgIC8vICAgfSk7CiAgICAgICAgICAgIC8vIH0KICAgICAgICAgICAgLy8gY29uc29sZS5sb2coNTUzMywgYj8udXBkYXRlZE1ldGFkYXRhRW5kcG9pbnQ/Lmtka3czMykKICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2VuZFNlcnZpY2VBamF4NzE3XyhhLCBiLCBjLCBkKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZ1bmN0aW9uIGRlbGF5Q2xlYXJPdGhlcktleXMobHp0Q29udGludWF0aW9uKSB7CiAgICAgICAgICAvLyAvLyBzY2hlZHVsZSBkZWxheWVkIHJlbW92YWwgaWYgbWZ5Q29udGludWF0aW9uSWdub3JlZCBpcyBub3QgZW1wdHkKICAgICAgICAgIC8vIGdldFJhZlByb21pc2UoKS50aGVuKCgpID0+IHsKICAgICAgICAgIC8vICAgLy8gYXNzdW1lIHRoZSByZXBlYXQgY29udGludWF0aW9uIGNvdWxkIGJlIG9ubHkgZm9yIHBvcHN0YXRlIHdoaWNoIGlzIHRyaWdnZXJlZCBieSB1c2VyIGludGVyYWN0aW9uCiAgICAgICAgICAvLyAgIC8vIGZvcmVncm91bmQgcGFnZSBvbmx5CgogICAgICAgICAgLy8gfSk7CgoKICAgICAgICAgIGlmIChsenRDb250aW51YXRpb24gIT09IG10emxhc3RBbGxvd2VkQ29udGludWF0aW9uKSByZXR1cm47CiAgICAgICAgICBpZiAobHp0Q29udGludWF0aW9uICE9PSBtcEtleTIxIHx8IGx6dENvbnRpbnVhdGlvbiAhPT0gbXBLZXkyMikgcmV0dXJuOwogICAgICAgICAgaWYgKCFtZnlDb250aW51YXRpb25JZ25vcmVkLnNpemUpIHJldHVybjsKICAgICAgICAgIGlmIChtZnlDb250aW51YXRpb25JZ25vcmVkLnNpemUgPiAxKSB7CiAgICAgICAgICAgIExPR19GRVRDSE1FVEFfVVBEQVRFICYmIGNvbnRpbnVhdGlvbkxvZyhsenRDb250aW51YXRpb24sICdkZWxheUNsZWFyT3RoZXJLZXlzLCBjdXJyZW50ID0gJywgbHp0Q29udGludWF0aW9uKTsKICAgICAgICAgIH0KICAgICAgICAgIG1meUNvbnRpbnVhdGlvbklnbm9yZWQuZm9yRWFjaCgodmFsdWUsIGtleSkgPT4gewogICAgICAgICAgICBpZiAoa2V5ICE9PSBsenRDb250aW51YXRpb24pIHsKICAgICAgICAgICAgICBtZnlDb250aW51YXRpb25JZ25vcmVkLmRlbGV0ZShrZXkpOwogICAgICAgICAgICAgIExPR19GRVRDSE1FVEFfVVBEQVRFICYmIGNvbnRpbnVhdGlvbkxvZyhrZXksICdwcmV2aW91cyBjb250aW51YXRpb24gcmVtb3ZlZCBmcm9tIGlnbm9yZWQgc3RvcmUnLCBrZXkpOwogICAgICAgICAgICB9CiAgICAgICAgICB9KTsKCiAgICAgICAgfQogICAgICAgIGlmICh0eXBlb2YgY1Byb3RvLmdldENhbmNlbGxhYmxlTmV0d29ya1Byb21pc2VfID09PSAnZnVuY3Rpb24nICYmIGNQcm90by5nZXRDYW5jZWxsYWJsZU5ldHdvcmtQcm9taXNlXy5sZW5ndGggPT09IDUgJiYgIWNQcm90by5nZXRDYW5jZWxsYWJsZU5ldHdvcmtQcm9taXNlNzE3XykgewogICAgICAgICAgY1Byb3RvLmdldENhbmNlbGxhYmxlTmV0d29ya1Byb21pc2U3MTdfID0gY1Byb3RvLmdldENhbmNlbGxhYmxlTmV0d29ya1Byb21pc2VfOwogICAgICAgICAgY1Byb3RvLmdldENhbmNlbGxhYmxlTmV0d29ya1Byb21pc2VfID0gZnVuY3Rpb24gKGEsIGIsIGMsIGQsIGUpIHsKCiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKDgwMDMpCiAgICAgICAgICAgIHRyeSB7CgoKICAgICAgICAgICAgICBjb25zdCB7IGlzLCB2aWRlb0lkLCBjb250aW51YXRpb24gfSA9IGV4dHJhQXJndW1lbnRzMzIyKGIsIGMsIGQpOwoKICAgICAgICAgICAgICBpZiAoKHZpZGVvSWQgfHwgY29udGludWF0aW9uKSAmJiAoaXMgIT09ICd5dGQtdmlkZW8tcHJpbWFyeS1pbmZvLXJlbmRlcmVyJykpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybigiQ0FVVElPTjogZ2V0Q2FuY2VsbGFibGVOZXR3b3JrUHJvbWlzZV8gY29kaW5nIG1pZ2h0IGhhdmUgdG8gYmUgdXBkYXRlZC4iKTsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGlmIChwYWdlU2V0dXBWaWRlb0lkICYmIHZpZGVvSWQgJiYgY29udGludWF0aW9uKSB7CiAgICAgICAgICAgICAgICBpZiAobXBLZXkyMSAmJiBtcFVybDIxICYmIG1wS2V5MjEgPT09IGNvbnRpbnVhdGlvbiAmJiBtcFVybDIxICE9PSBwYWdlU2V0dXBWaWRlb0lkKSB7CiAgICAgICAgICAgICAgICAgIG1meUNvbnRpbnVhdGlvbklnbm9yZWQucmVtb3ZlQWRkKGNvbnRpbnVhdGlvbik7CiAgICAgICAgICAgICAgICAgIG1mdkNvbnRpbnVhdGlvblJlY29yZGVkLmRlbGV0ZShjb250aW51YXRpb24pOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICBpZiAobWp0TG9ja1ByZXZpb3VzS2V5ICYmIG1qdExvY2tQcmV2aW91c0tleSAhPT0gY29udGludWF0aW9uICYmIGNvbnRpbnVhdGlvbikgewogICAgICAgICAgICAgICAgY29weVByZXZpb3VzQ29udGl1YXRpb25Ub0lnbm9yZWQzNzQoZmFsc2UpOwogICAgICAgICAgICAgICAgbWZ5Q29udGludWF0aW9uSWdub3JlZC5kZWxldGUoY29udGludWF0aW9uKTsKICAgICAgICAgICAgICAgIG1mdkNvbnRpbnVhdGlvblJlY29yZGVkLnJlbW92ZUFkZChjb250aW51YXRpb24pOwogICAgICAgICAgICAgICAgbWZ5Q29udGludWF0aW9uSWdub3JlZC5yZW1vdmVBZGQobWp0TG9ja1ByZXZpb3VzS2V5KTsKICAgICAgICAgICAgICAgIG1mdkNvbnRpbnVhdGlvblJlY29yZGVkLmRlbGV0ZShtanRMb2NrUHJldmlvdXNLZXkpOwogICAgICAgICAgICAgICAgbWp0TG9ja1ByZXZpb3VzS2V5ID0gJyc7CiAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAvLyBpZiAobWp0TmV4dE1haW5LZXkgPT09IGNvbnRpbnVhdGlvbikgewogICAgICAgICAgICAgIC8vICAgY29weVByZXZpb3VzQ29udGl1YXRpb25Ub0lnbm9yZWQoZmFsc2UpOwogICAgICAgICAgICAgIC8vICAgbWZ5Q29udGludWF0aW9uSWdub3JlZC5kZWxldGUoY29udGludWF0aW9uKTsKICAgICAgICAgICAgICAvLyAgIG1mdkNvbnRpbnVhdGlvblJlY29yZGVkLmFkZChjb250aW51YXRpb24pOwogICAgICAgICAgICAgIC8vIH0KCiAgICAgICAgICAgICAgY29uc3QgbHp0Q29udGludWF0aW9uID0gY29udGludWF0aW9uOwoKICAgICAgICAgICAgICBpZiAobWZ5Q29udGludWF0aW9uSWdub3JlZCAmJiBsenRDb250aW51YXRpb24gJiYgdHlwZW9mIGx6dENvbnRpbnVhdGlvbiA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIGlmIChtZnlDb250aW51YXRpb25JZ25vcmVkLmhhcyhsenRDb250aW51YXRpb24pKSB7CiAgICAgICAgICAgICAgICAgIExPR19GRVRDSE1FVEFfVVBEQVRFICYmIGNvbnRpbnVhdGlvbkxvZyhsenRDb250aW51YXRpb24sICc1MzYwIG1hdGNoZWQwMicsIGx6dENvbnRpbnVhdGlvbikKICAgICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgLy8gaWYgKHZpZGVvSWQpIHsKICAgICAgICAgICAgICAvLyAgIGlmICghcGFnZVNldHVwVmlkZW9JZCkgcmV0dXJuOyAvLyBpZ25vcmUgcGFnZSBub3QgcmVhZHkKICAgICAgICAgICAgICAvLyAgIC8vIGlmIChtdHhWaWRlb0lkICYmIGMudXBkYXRlZE1ldGFkYXRhRW5kcG9pbnQudmlkZW9JZCAhPT0gbXR4VmlkZW9JZCkgcmV0dXJuOyAvLyBpZ25vcmUgdmlkZW9JRCBub3QgbWF0Y2hlZAogICAgICAgICAgICAgIC8vICAgaWYgKHZpZGVvSWQgIT09IHBhZ2VTZXR1cFZpZGVvSWQpIHsKICAgICAgICAgICAgICAvLyAgICAgcmV0dXJuOwogICAgICAgICAgICAgIC8vICAgfQogICAgICAgICAgICAgIC8vIH0KCiAgICAgICAgICAgICAgaWYgKHR5cGVvZiBsenRDb250aW51YXRpb24gPT09ICdzdHJpbmcnICYmIG10emxhc3RBbGxvd2VkQ29udGludWF0aW9uICE9PSBsenRDb250aW51YXRpb24pIHsKICAgICAgICAgICAgICAgIG10emxhc3RBbGxvd2VkQ29udGludWF0aW9uID0gbHp0Q29udGludWF0aW9uOwogICAgICAgICAgICAgICAgLy8gY29uc29sZS5sb2coNzA0MDEsIGx6dENvbnRpbnVhdGlvbiwgbWZ5Q29udGludWF0aW9uSWdub3JlZC5zaXplKQoKICAgICAgICAgICAgICAgIExPR19GRVRDSE1FVEFfVVBEQVRFICYmIGNvbnRpbnVhdGlvbkxvZyhsenRDb250aW51YXRpb24sICc1MzgyIENvbnRpbnVhdGlvbiBzZXRzIHRvXHQnLCBsenRDb250aW51YXRpb24sIGBDJHttdHpDb3VudH0uUiR7bWZ2Q29udGludWF0aW9uUmVjb3JkZWQuc2l6ZX0uSSR7bWZ5Q29udGludWF0aW9uSWdub3JlZC5zaXplfWApOwogICAgICAgICAgICAgICAgbWp0UmVjb3JkZWRQcmV2S2V5ID0gbHp0Q29udGludWF0aW9uOwogICAgICAgICAgICAgICAgaWYgKG1qdExvY2tQcmV2aW91c0tleSA9PT0gbHp0Q29udGludWF0aW9uKSBtanRMb2NrUHJldmlvdXNLZXkgPSAnJzsKICAgICAgICAgICAgICAgIC8vIGlmIChtZnlDb250aW51YXRpb25JZ25vcmVkLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgICAvLyAgIGRlbGF5Q2xlYXJPdGhlcktleXMobHp0Q29udGludWF0aW9uKTsKICAgICAgICAgICAgICAgIC8vIH0KICAgICAgICAgICAgICAgIG10ekNvdW50ID0gMDsKICAgICAgICAgICAgICAgIC8vIGFsbG93Tm9EZWxheTMyMiA9IGZhbHNlOwogICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGx6dENvbnRpbnVhdGlvbiA9PT0gJ3N0cmluZycgJiYgbXR6bGFzdEFsbG93ZWRDb250aW51YXRpb24gJiYgbXR6bGFzdEFsbG93ZWRDb250aW51YXRpb24gPT09IGx6dENvbnRpbnVhdGlvbikgewogICAgICAgICAgICAgICAgLy8gcmVwZWF0ZWQKICAgICAgICAgICAgICAgIGlmIChtdHpDb3VudCA+IDFlOSkgbXR6Q291bnQgPSAxZTQ7CiAgICAgICAgICAgICAgICArK210ekNvdW50OwogICAgICAgICAgICAgICAgTE9HX0ZFVENITUVUQV9VUERBVEUgJiYgY29udGludWF0aW9uTG9nKGx6dENvbnRpbnVhdGlvbiwgJzUzODYgU2FtZSBDb250aW51YXRpb25cdFx0JywgbHp0Q29udGludWF0aW9uLCBgQyR7bXR6Q291bnR9LlIke21mdkNvbnRpbnVhdGlvblJlY29yZGVkLnNpemV9Lkkke21meUNvbnRpbnVhdGlvbklnbm9yZWQuc2l6ZX1gKTsKCiAgICAgICAgICAgICAgICAvLyBpZiAobXR6Q291bnQgPj0gMykgYWxsb3dOb0RlbGF5MzIyID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmIChtdHpDb3VudCA+PSAzICYmIG1meUNvbnRpbnVhdGlvbklnbm9yZWQuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgICAgUHJvbWlzZS5yZXNvbHZlKGx6dENvbnRpbnVhdGlvbikudGhlbihkZWxheUNsZWFyT3RoZXJLZXlzKS5jYXRjaChjb25zb2xlLndhcm4pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG10ekNvdW50ID09PSA1KSB7CiAgICAgICAgICAgICAgICAgIG1mdkNvbnRpbnVhdGlvblJlY29yZGVkLmNsZWFyKCk7CiAgICAgICAgICAgICAgICAgIG1mdkNvbnRpbnVhdGlvblJlY29yZGVkLmFkZChsenRDb250aW51YXRpb24pOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGlmICh0eXBlb2YgbHp0Q29udGludWF0aW9uID09PSAnc3RyaW5nJyAmJiBsenRDb250aW51YXRpb24gJiYgKHBhZ2VTZXR1cFZpZGVvSWQgfHwgdmlkZW9QbGF5aW5nWS52aWRlb0lkKSkgewogICAgICAgICAgICAgICAgbXBLZXkyMiA9IGx6dENvbnRpbnVhdGlvbjsKICAgICAgICAgICAgICAgIG1wVXJsMjIgPSBwYWdlU2V0dXBWaWRlb0lkIHx8IHZpZGVvUGxheWluZ1kudmlkZW9JZDsKICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgIGlmIChtYkNJZDMyMikgewogICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KG1iQ0lkMzIyKTsKICAgICAgICAgICAgICAgIG1iQ0lkMzIyID0gMDsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICBjb25zb2xlLmxvZygnQ29kaW5nIEVycm9yIGluIGdldENhbmNlbGxhYmxlTmV0d29ya1Byb21pc2VfJywgZSkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy8gY29uc29sZS5sb2coODAwNCkKICAgICAgICAgICAgLy8gY29uc29sZS5sb2coMTIzNDAzLCBhcmd1bWVudHMpOwogICAgICAgICAgICAvLyBpZihjLnVwZGF0ZWRNZXRhZGF0YUVuZHBvaW50KSBjb25zb2xlLmxvZygxMjM0MDQsIHBhZ2VTZXR1cFZpZGVvSWQsIEpTT04uc3RyaW5naWZ5KGMudXBkYXRlZE1ldGFkYXRhRW5kcG9pbnQpKQoKICAgICAgICAgICAgLy8gY29uc29sZS5sb2coNTE2MywgYT8uaXMsYixjLGQsZSk7CiAgICAgICAgICAgIHJldHVybiB0aGlzLmdldENhbmNlbGxhYmxlTmV0d29ya1Byb21pc2U3MTdfKGEsIGIsIGMsIGQsIGUpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CgogICAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gRklYX2F2b2lkX2luY29ycmVjdF92aWRlb19tZXRhID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQoKCiAgICAgIEZJWF95dGRFeHBhbmRlcl9jaGlsZHJlbkNoYW5nZWQgJiYgd2hlbkNFRGVmaW5lZCgneXRkLWV4cGFuZGVyJykudGhlbigoKSA9PiB7CgogICAgICAgIGxldCBkdW1teTsKICAgICAgICBsZXQgY1Byb3RvOwoKICAgICAgICBkdW1teSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3l0ZC1leHBhbmRlcicpOwogICAgICAgIGNQcm90byA9IGluc3AoZHVtbXkpLmNvbnN0cnVjdG9yLnByb3RvdHlwZTsKCiAgICAgICAgaWYgKGZuSW50ZWdyaXR5KGNQcm90by5pbml0Q2hpbGRyZW5PYnNlcnZlciwgJzAuNDguMjEnKSAmJiBmbkludGVncml0eShjUHJvdG8uY2hpbGRyZW5DaGFuZ2VkLCAnMC40MC4yMicpKSB7CgogICAgICAgICAgY1Byb3RvLmluaXRDaGlsZHJlbk9ic2VydmVyMTQgPSBjUHJvdG8uaW5pdENoaWxkcmVuT2JzZXJ2ZXI7CiAgICAgICAgICBjUHJvdG8uY2hpbGRyZW5DaGFuZ2VkMTQgPSBjUHJvdG8uY2hpbGRyZW5DaGFuZ2VkOwoKICAgICAgICAgIGNQcm90by5pbml0Q2hpbGRyZW5PYnNlcnZlciA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgdmFyIGEgPSB0aGlzOwogICAgICAgICAgICB0aGlzLm9ic2VydmVyID0gbmV3IE11dGF0aW9uT2JzZXJ2ZXIoZnVuY3Rpb24gKCkgewogICAgICAgICAgICAgIGEuY2hpbGRyZW5DaGFuZ2VkKCkKICAgICAgICAgICAgfQogICAgICAgICAgICApOwogICAgICAgICAgICB0aGlzLm9ic2VydmVyLm9ic2VydmUodGhpcy5jb250ZW50LCB7CiAgICAgICAgICAgICAgc3VidHJlZTogITAsCiAgICAgICAgICAgICAgY2hpbGRMaXN0OiAhMCwKICAgICAgICAgICAgICBhdHRyaWJ1dGVzOiAhMCwKICAgICAgICAgICAgICBjaGFyYWN0ZXJEYXRhOiAhMAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5jaGlsZHJlbkNoYW5nZWQoKQogICAgICAgICAgfQogICAgICAgICAgICA7CiAgICAgICAgICBjUHJvdG8uY2hpbGRyZW5DaGFuZ2VkID0gZnVuY3Rpb24gKCkgewogICAgICAgICAgICBpZiAodGhpcy5hbHdheXNUb2dnbGVhYmxlKSB7CiAgICAgICAgICAgICAgdGhpcy5jYW5Ub2dnbGUgPSB0aGlzLmFsd2F5c1RvZ2dsZWFibGU7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoIXRoaXMuY2FuVG9nZ2xlSm9iSWQpIHsKICAgICAgICAgICAgICB0aGlzLmNhblRvZ2dsZUpvYklkID0gMTsKICAgICAgICAgICAgICBmb3JlZ3JvdW5kUHJvbWlzZUZuKCkudGhlbigoKSA9PiB7CiAgICAgICAgICAgICAgICB0aGlzLmNhblRvZ2dsZUpvYklkID0gMDsKICAgICAgICAgICAgICAgIHRoaXMuY2FsY3VsYXRlQ2FuQ29sbGFwc2UoKQogICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICAvLyBjb25zb2xlLmxvZyhjUHJvdG8uaW5pdENoaWxkcmVuT2JzZXJ2ZXIpCiAgICAgICAgICBjb25zb2xlLmRlYnVnKCd5dGQtZXhwYW5kZXItZml4LWNoaWxkcmVuQ2hhbmdlZCcpOwoKICAgICAgICB9CgogICAgICB9KTsKCgogICAgICBGSVhfcGFwZXJfcmlwcGxlX2FuaW1hdGUgJiYgd2hlbkNFRGVmaW5lZCgncGFwZXItcmlwcGxlJykudGhlbigoKSA9PiB7CgogICAgICAgIGxldCBkdW1teTsKICAgICAgICBsZXQgY1Byb3RvOwogICAgICAgIGR1bW15ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgncGFwZXItcmlwcGxlJyk7CiAgICAgICAgY1Byb3RvID0gaW5zcChkdW1teSkuY29uc3RydWN0b3IucHJvdG90eXBlOwoKICAgICAgICBpZiAoZm5JbnRlZ3JpdHkoY1Byb3RvLmFuaW1hdGUsICcwLjc0LjUnKSkgewoKCiAgICAgICAgICBjUHJvdG8uYW5pbWF0ZTM0ID0gY1Byb3RvLmFuaW1hdGU7CiAgICAgICAgICBjUHJvdG8uYW5pbWF0ZSA9IGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgaWYgKHRoaXMuX2FuaW1hdGluZykgewogICAgICAgICAgICAgIHZhciBhOwogICAgICAgICAgICAgIGNvbnN0IHJpcHBsZXMgPSB0aGlzLnJpcHBsZXM7CiAgICAgICAgICAgICAgZm9yIChhID0gMDsgYSA8IHJpcHBsZXMubGVuZ3RoOyArK2EpIHsKICAgICAgICAgICAgICAgIHZhciBiID0gcmlwcGxlc1thXTsKICAgICAgICAgICAgICAgIGIuZHJhdygpOwogICAgICAgICAgICAgICAgdGhpcy4kLmJhY2tncm91bmQuc3R5bGUub3BhY2l0eSA9IGIub3V0ZXJPcGFjaXR5OwogICAgICAgICAgICAgICAgYi5pc09wYWNpdHlGdWxseURlY2F5ZWQgJiYgIWIuaXNSZXN0aW5nQXRNYXhSYWRpdXMgJiYgdGhpcy5yZW1vdmVSaXBwbGUoYikKICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgaWYgKCh0aGlzLnNob3VsZEtlZXBBbmltYXRpbmcgfHwgMCkgIT09IHJpcHBsZXMubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2JvdW5kQW5pbWF0ZTM4KSB0aGlzLl9ib3VuZEFuaW1hdGUzOCA9IHRoaXMuYW5pbWF0ZS5iaW5kKHRoaXMpOwogICAgICAgICAgICAgICAgZm9yZWdyb3VuZFByb21pc2VGbigpLnRoZW4odGhpcy5fYm91bmRBbmltYXRlMzgpOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLm9uQW5pbWF0aW9uQ29tcGxldGUoKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KCiAgICAgICAgICBjb25zb2xlLmRlYnVnKCdGSVhfcGFwZXJfcmlwcGxlX2FuaW1hdGUnKQoKICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGNQcm90by5hbmltYXRlKQoKICAgICAgICB9CgogICAgICB9KTsKCiAgICAgIGlmIChGSVhfZG9JZG9tUmVuZGVyKSB7CgogICAgICAgIGNvbnN0IHhzZXRUaW1lb3V0ID0gZnVuY3Rpb24gKGYsIGQpIHsKICAgICAgICAgIGlmICh4c2V0VGltZW91dC5tNTExID09PSAxICYmICFkKSB7CiAgICAgICAgICAgIHhzZXRUaW1lb3V0Lm01MTEgPSAyOwogICAgICAgICAgICB4c2V0VGltZW91dC5tNTY4ID0gZjsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBzZXRUaW1lb3V0LmFwcGx5KHdpbmRvdywgYXJndW1lbnRzKQogICAgICAgICAgfQoKICAgICAgICB9CgogICAgICAgIC8qKgogICAgICAgICAqCiAgICAgICAgICAgIElHYiA9IGZ1bmN0aW9uKGEpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgYiwgYyA9IG51bGwgPT0gKGIgPSBhLnJlcXVlc3RBbmlubWF0aW9uRnJhbWVSZXNvbHZlcikgPyB2b2lkIDAgOiBiLnByb21pc2U7CiAgICAgICAgICAgICAgICAgICAgYyB8fCAoYS5yZXF1ZXN0QW5pbm1hdGlvbkZyYW1lUmVzb2x2ZXIgPSBuZXcgVmksCiAgICAgICAgICAgICAgICAgICAgYyA9IGEucmVxdWVzdEFuaW5tYXRpb25GcmFtZVJlc29sdmVyLnByb21pc2UsCiAgICAgICAgICAgICAgICAgICAgRGEucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgZDsKICAgICAgICAgICAgICAgICAgICAgICAgbnVsbCA9PSAoZCA9IGEucmVxdWVzdEFuaW5tYXRpb25GcmFtZVJlc29sdmVyKSB8fCBkLnJlc29sdmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgYS5yZXF1ZXN0QW5pbm1hdGlvbkZyYW1lUmVzb2x2ZXIgPSBudWxsCiAgICAgICAgICAgICAgICAgICAgfSkpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBjCiAgICAgICAgICAgICAgICB9CgoKICAgICAgICAgKi8KCiAgICAgICAgY29uc3QgeHJlcXVlc3RBbmltYXRpb25GcmFtZSA9IGZ1bmN0aW9uIChmKSB7CiAgICAgICAgICBjb25zdCBoID0gZiArICIiOwogICAgICAgICAgaWYgKGguc3RhcnRzV2l0aCgiZnVuY3Rpb24oKXtzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7IikgJiYgaC5lbmRzV2l0aCgifSl9IikpIHsKICAgICAgICAgICAgbGV0IHQgPSBudWxsOwogICAgICAgICAgICB4c2V0VGltZW91dC5tNTExID0gMTsKICAgICAgICAgICAgZigpOwogICAgICAgICAgICBpZiAoeHNldFRpbWVvdXQubTUxMSA9PT0gMikgewogICAgICAgICAgICAgIHQgPSB4c2V0VGltZW91dC5tNTY4OwogICAgICAgICAgICAgIHhzZXRUaW1lb3V0Lm01NjggPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHhzZXRUaW1lb3V0Lm01MTEgPSAwOwogICAgICAgICAgICBpZiAodHlwZW9mIHQgPT09ICdmdW5jdGlvbicpIHsKICAgICAgICAgICAgICBmb3JlZ3JvdW5kUHJvbWlzZUZuKCkudGhlbih0KTsKICAgICAgICAgICAgfQogICAgICAgICAgfSBlbHNlIGlmIChoLmluY2x1ZGVzKCJyZXF1ZXN0QW5pbm1hdGlvbkZyYW1lUmVzb2x2ZXIiKSkgewogICAgICAgICAgICBmb3JlZ3JvdW5kUHJvbWlzZUZuKCkudGhlbihmKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiByZXF1ZXN0QW5pbWF0aW9uRnJhbWUuYXBwbHkod2luZG93LCBhcmd1bWVudHMpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgbGV0IGJ1c3kgPSBmYWxzZTsKICAgICAgICBjb25zdCBkb0lkb21SZW5kZXIgPSBmdW5jdGlvbiAoKSB7CgogICAgICAgICAgaWYgKCF0aGlzKSByZXR1cm47CiAgICAgICAgICBpZiAoYnVzeSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5kb0lkb21SZW5kZXIxMyguLi5hcmd1bWVudHMpOwogICAgICAgICAgfQogICAgICAgICAgYnVzeSA9IHRydWU7CiAgICAgICAgICBjb25zdCB7IHJlcXVlc3RBbmltYXRpb25GcmFtZSwgc2V0VGltZW91dCB9ID0gd2luZG93OwogICAgICAgICAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSA9IHhyZXF1ZXN0QW5pbWF0aW9uRnJhbWU7CiAgICAgICAgICB3aW5kb3cuc2V0VGltZW91dCA9IHhzZXRUaW1lb3V0OwogICAgICAgICAgbGV0IHIgPSB0aGlzLmRvSWRvbVJlbmRlcjEzKC4uLmFyZ3VtZW50cyk7CiAgICAgICAgICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lOwogICAgICAgICAgd2luZG93LnNldFRpbWVvdXQgPSBzZXRUaW1lb3V0OwogICAgICAgICAgYnVzeSA9IGZhbHNlOwogICAgICAgICAgcmV0dXJuIHI7CiAgICAgICAgfTsKICAgICAgICBmb3IgKGNvbnN0IHl0VGFnIG9mIFsneXRkLWxvdHRpZS1wbGF5ZXInLCAneXQtYXR0cmlidXRlZC1zdHJpbmcnLCAneXQtaW1hZ2UnLCAneXQtaWNvbi1zaGFwZScsICd5dC1idXR0b24tc2hhcGUnLCAneXQtYnV0dG9uLXZpZXctbW9kZWwnLCAneXQtaWNvbi1iYWRnZS1zaGFwZSddKSB7CgoKICAgICAgICAgIHdoZW5DRURlZmluZWQoeXRUYWcpLnRoZW4oKCkgPT4gewoKICAgICAgICAgICAgbGV0IGR1bW15OwogICAgICAgICAgICBsZXQgY1Byb3RvOwogICAgICAgICAgICBkdW1teSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoeXRUYWcpOwogICAgICAgICAgICBjUHJvdG8gPSBpbnNwKGR1bW15KS5jb25zdHJ1Y3Rvci5wcm90b3R5cGU7CgogICAgICAgICAgICBjUHJvdG8uZG9JZG9tUmVuZGVyMTMgPSBjUHJvdG8uZG9JZG9tUmVuZGVyOwogICAgICAgICAgICBjUHJvdG8uZG9JZG9tUmVuZGVyID0gZG9JZG9tUmVuZGVyOwoKICAgICAgICAgICAgaWYgKGNQcm90by5kb0lkb21SZW5kZXIxMyA9PT0gY1Byb3RvLnRlbXBsYXRpbmdGbikgY1Byb3RvLnRlbXBsYXRpbmdGbiA9IGRvSWRvbVJlbmRlcjsKCiAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoJ1t5dC1qcy1lbmdpbmUtdGFtZXJdIEZJWF9kb0lkb21SZW5kZXInLCB5dFRhZykKCgoKICAgICAgICAgIH0pOwoKICAgICAgICB9CgogICAgICB9CgoKCiAgICB9KTsKCiAgfSk7CgoKCgogIGlmIChpc01haW5XaW5kb3cpIHsKCiAgICBjb25zb2xlLmdyb3VwQ29sbGFwc2VkKAogICAgICAiJWNZb3VUdWJlIEpTIEVuZ2luZSBUYW1lciIsCiAgICAgICJiYWNrZ3JvdW5kLWNvbG9yOiAjRURFNDNCIDsgY29sb3I6ICMwMDAgOyBmb250LXdlaWdodDogYm9sZCA7IHBhZGRpbmc6IDRweCA7IgogICAgKTsKCgoKICAgIGNvbnNvbGUubG9nKCJTY3JpcHQgaXMgbG9hZGVkLiIpOwogICAgY29uc29sZS5sb2coIlRoaXMgc2NyaXB0IGNoYW5nZXMgdGhlIGNvcmUgbWVjaGFuaXNtcyBvZiB0aGUgWW91VHViZSBKUyBlbmdpbmUuIik7CgogICAgY29uc29sZS5sb2coIlRoaXMgc2NyaXB0IGlzIGV4cGVyaW1lbnRhbCBhbmQgc3ViamVjdCB0byBmdXJ0aGVyIGNoYW5nZXMuIik7CgogICAgY29uc29sZS5sb2coIlRoaXMgbWlnaHQgYm9vc3QgeW91ciBZb3VUdWJlIHBlcmZvcm1hbmNlLiIpOwoKICAgIGNvbnNvbGUubG9nKCJDQVVUSU9OOiBUaGlzIG1pZ2h0IGJyZWFrIHlvdXIgWW91VHViZS4iKTsKCgogICAgaWYgKHByZXBhcmVMb2dzLmxlbmd0aCA+PSAxKSB7CiAgICAgIGNvbnNvbGUubG9nKCIgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICIpOwoKICAgICAgZm9yIChjb25zdCBtc2cgb2YgcHJlcGFyZUxvZ3MpIHsKICAgICAgICBjb25zb2xlLmxvZyhtc2cpCiAgICAgIH0KCiAgICAgIGNvbnNvbGUubG9nKCIgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICIpOwogICAgfQoKICAgIGNvbnNvbGUuZ3JvdXBFbmQoKTsKCiAgfQoKCgp9KSgpOwo=","requires":[{"meta":{"name":"nextBrowserTick.min.js","url":"https://cdn.jsdelivr.net/gh/cyfung1031/userscript-supports@7221a4efffd49d852de0074ec503d4febb99f28b/library/nextBrowserTick.min.js","ts":1722482169056,"mimetype":"text/javascript"},"source":"LyoqCiAqIE1pbmlmaWVkIGJ5IGpzRGVsaXZyIHVzaW5nIFRlcnNlciB2NS4xOS4yLgogKiBPcmlnaW5hbCBmaWxlOiAvZ2gvY3lmdW5nMTAzMS91c2Vyc2NyaXB0LXN1cHBvcnRzQDcyMjFhNGVmZmZkNDlkODUyZGUwMDc0ZWM1MDNkNGZlYmI5OWYyOGIvbGlicmFyeS9uZXh0QnJvd3NlclRpY2suanMKICoKICogRG8gTk9UIHVzZSBTUkkgd2l0aCBkeW5hbWljYWxseSBnZW5lcmF0ZWQgZmlsZXMhIE1vcmUgaW5mb3JtYXRpb246IGh0dHBzOi8vd3d3LmpzZGVsaXZyLmNvbS91c2luZy1zcmktd2l0aC1keW5hbWljLWZpbGVzCiAqLwohZnVuY3Rpb24oZSl7InVzZSBzdHJpY3QiO2lmKGUubmV4dEJyb3dzZXJUaWNrKXJldHVybjtpZighZnVuY3Rpb24oKXtpZihlLnBvc3RNZXNzYWdlJiYhZS5pbXBvcnRTY3JpcHRzJiZlLmFkZEV2ZW50TGlzdGVuZXIpe2xldCB0PSEwLHM9KCk9Pnt0PSExfTtyZXR1cm4gZS5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIixzLCExKSxlLnBvc3RNZXNzYWdlKCIiLCIqIiksZS5yZW1vdmVFdmVudExpc3RlbmVyKCJtZXNzYWdlIixzLCExKSx0fX0oKSlyZXR1cm4gdm9pZCBjb25zb2xlLndhcm4oIllvdXIgYnJvd3NlciBlbnZpcm9ubWVudCBjYW5ub3QgdXNlIG5leHRCcm93c2VyVGljayIpO2NvbnN0IHQ9KGFzeW5jKCk9Pnt9KSgpLmNvbnN0cnVjdG9yLHM9KChlLHMpPT57Y29uc3Qgbj0odCxuKT0+e2U9dCxzPW59O3JldHVybiBjbGFzcyBleHRlbmRzIHR7Y29uc3RydWN0b3IodD1uKXtzdXBlcih0KSx0PT09biYmKHRoaXMucmVzb2x2ZT1lLHRoaXMucmVqZWN0PXMpfX19KSgpO2xldCBuLHI9bnVsbDtkb3tuPWAkJG5leHRCcm93c2VyVGljayQkJHsoTWF0aC5yYW5kb20oKSs4KS50b1N0cmluZygpLnNsaWNlKDIpfSQkYH13aGlsZShuIGluIGUpO2NvbnN0IG89bjtlW29dPTE7ZS5hZGRFdmVudExpc3RlbmVyKCJtZXNzYWdlIiwoZT0+eyhudWxsIT09cj8oZXx8MCkuZGF0YTowKT09PW8mJmUuc291cmNlPT09KGUudGFyZ2V0fHwxKSYmci5yZXNvbHZlKHI9bnVsbCl9KSwhMSksZS5uZXh0QnJvd3NlclRpY2s9dD0+e3J8fChyPW5ldyBzLGUucG9zdE1lc3NhZ2UobywiKiIpKSxyLnRoZW4odCkuY2F0Y2goY29uc29sZS53YXJuKX19KCJ1bmRlZmluZWQiPT10eXBlb2Ygc2VsZj8idW5kZWZpbmVkIj09dHlwZW9mIGdsb2JhbD90aGlzOmdsb2JhbDpzZWxmKTsKLy8jIHNvdXJjZU1hcHBpbmdVUkw9L3NtLzFlYWY0MTVjYjA2NWIwOGE4MTA1ZWFkY2ZiMjhlNGFhNjNmNGMxZGIyYmM0ODAxMmJkYmE0OTU5OTE5YWQ1NzMubWFw"}]}]}